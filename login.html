<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Sign in ‚Äî ScaleVest</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box;font-family:Inter}
body{margin:0;color:#fff}

/* VIDEO BG */
#bgVideo{
  position:fixed;
  inset:0;
  width:100%;
  height:100%;
  object-fit:cover;
  z-index:-2;
}
body::before{
  content:"";
  position:fixed;
  inset:0;
  background:rgba(10,15,25,.45);
  z-index:-1;
}

/* AUTH BUTTONS */
.auth-btn{
  display:flex;
  align-items:center;
  gap:12px;
  width:100%;
  padding:13px 16px;
  margin-bottom:12px;
  border-radius:10px;
  border:1px solid #e5e7eb;
  background:#fff;
  font-weight:600;
  cursor:pointer;
  color:#000;
  font-size:14px;
}
.auth-btn img{width:18px;height:18px}
.auth-btn:hover{background:#f9fafb}
.auth-btn:disabled{opacity:0.5;cursor:not-allowed}

/* MODALS */
.modal-overlay,.email-overlay{
  position:fixed;
  inset:0;
  display:flex;
  justify-content:center;
  align-items:center;
}
.email-overlay{
  background:rgba(0,0,0,.45);
  backdrop-filter:blur(8px);
  display:none;
  z-index:100;
}
.email-glass{
  width:360px;
  padding:28px;
  border-radius:20px;
  background:rgba(255,255,255,.15);
  backdrop-filter:blur(20px);
}
.email-glass h3{margin-top:0;color:#fff}
.email-glass input{
  width:100%;
  padding:12px;
  margin-bottom:10px;
  border-radius:10px;
  border:none;
  background:rgba(255,255,255,.2);
  color:#fff;
  font-size:14px;
}
.email-glass input::placeholder{color:rgba(255,255,255,.6)}
.email-glass button{
  width:100%;
  padding:12px;
  border:none;
  border-radius:12px;
  background:#2563eb;
  color:#fff;
  font-weight:600;
  cursor:pointer;
  font-size:14px;
}
.email-glass button:hover{background:#1d4ed8}
.email-glass button:disabled{opacity:0.5;cursor:not-allowed}

.modal{
  width:900px;
  height:520px;
  background:#fff;
  border-radius:16px;
  display:flex;
  overflow:hidden;
}
.modal-left{
  width:50%;
  background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  position:relative;
}
.modal-left::after{
  content:"";
  position:absolute;
  inset:0;
  background:rgba(0,0,0,.25);
}
.overlay-text{
  position:relative;
  z-index:2;
  padding:42px;
  color:#fff;
}
.modal-right{
  width:50%;
  padding:40px;
  color:#000;
}
.modal-right h3{margin-top:0;font-size:24px}
.modal-right p{font-size:14px;color:#6b7280}

.divider{
  text-align:center;
  margin:18px 0;
  position:relative;
}
.divider span{
  background:#fff;
  padding:0 10px;
  font-size:12px;
  color:#6b7280;
}
.divider::before{
  content:"";
  position:absolute;
  top:50%;
  left:0;
  right:0;
  height:1px;
  background:#e5e7eb;
  z-index:-1;
}

.loader{
  width:42px;
  height:42px;
  border:4px solid rgba(255,255,255,.3);
  border-top:4px solid #60a5fa;
  border-radius:50%;
  animation:spin 1s linear infinite;
  margin:0 auto 14px;
}
@keyframes spin{to{transform:rotate(360deg)}}

.error-msg{
  background:rgba(239,68,68,.1);
  border:1px solid rgba(239,68,68,.3);
  color:#ef4444;
  padding:10px;
  border-radius:8px;
  font-size:13px;
  margin-bottom:12px;
  display:none;
}

.success-msg{
  background:rgba(34,197,94,.1);
  border:1px solid rgba(34,197,94,.3);
  color:#22c55e;
  padding:10px;
  border-radius:8px;
  font-size:13px;
  margin-bottom:12px;
  display:none;
}

.otp-inputs{
  display:flex;
  gap:8px;
  justify-content:center;
  margin:20px 0;
}

.otp-inputs input{
  width:45px;
  height:50px;
  text-align:center;
  font-size:24px;
  font-weight:bold;
  border-radius:8px;
  background:rgba(255,255,255,.25);
  color:#fff;
  border:2px solid transparent;
  padding:0;
}

.otp-inputs input:focus{
  border-color:#60a5fa;
  outline:none;
}

.timer{
  text-align:center;
  font-size:12px;
  color:#93c5fd;
  margin-top:10px;
}
</style>
</head>

<body>

<video id="bgVideo" autoplay muted loop playsinline>
  <source src="loginpage.mp4" type="video/mp4">
</video>

<div class="modal-overlay">
  <div class="modal">
    <div class="modal-left">
      <div class="overlay-text">
        <h2>Verified ‚Ä¢ Secure ‚Ä¢ Scalable</h2>
        <p>Join thousands of businesses scaling with confidence</p>
      </div>
    </div>

    <div class="modal-right">
      <h3>Welcome to ScaleVest</h3>
      <p>Sign in or create your account</p>

      <button class="auth-btn" onclick="showEmailAuth()">
        <span>‚úâÔ∏è</span> Continue with Email
      </button>

      <div class="divider"><span>or</span></div>

      <button class="auth-btn" onclick="googleLogin()">
        <span>üîµ</span> Continue with Google
      </button>
      <button class="auth-btn" onclick="appleLogin()">
        <span>üçé</span> Continue with Apple
      </button>
      <button class="auth-btn" onclick="facebookLogin()">
        <span>üìò</span> Continue with Facebook
      </button>
    </div>
  </div>
</div>

<!-- EMAIL INPUT -->
<div class="email-overlay" id="emailModal">
  <div class="email-glass">
    <h3>Enter your email</h3>
    <div class="error-msg" id="emailError"></div>
    <div class="success-msg" id="emailSuccess"></div>
    <input id="emailInput" type="email" placeholder="your@email.com" autocomplete="email">
    <button id="sendOtpBtn" onclick="sendOTP()">Send verification code</button>
    <p style="text-align:center;font-size:12px;margin-top:12px;color:#fff;">
      <span style="cursor:pointer" onclick="closeModals()">‚Üê Back</span>
    </p>
  </div>
</div>

<!-- OTP VERIFICATION -->
<div class="email-overlay" id="otpModal">
  <div class="email-glass">
    <h3>Enter verification code</h3>
    <p style="font-size:12px;color:#fff;text-align:center;">
      We sent a 6-digit code to<br><strong id="otpEmail"></strong>
    </p>
    <div class="error-msg" id="otpError"></div>
    
    <div class="otp-inputs">
      <input type="text" maxlength="1" id="otp1" oninput="moveToNext(this, 'otp2')" onkeydown="handleBackspace(event, this, null)">
      <input type="text" maxlength="1" id="otp2" oninput="moveToNext(this, 'otp3')" onkeydown="handleBackspace(event, this, 'otp1')">
      <input type="text" maxlength="1" id="otp3" oninput="moveToNext(this, 'otp4')" onkeydown="handleBackspace(event, this, 'otp2')">
      <input type="text" maxlength="1" id="otp4" oninput="moveToNext(this, 'otp5')" onkeydown="handleBackspace(event, this, 'otp3')">
      <input type="text" maxlength="1" id="otp5" oninput="moveToNext(this, 'otp6')" onkeydown="handleBackspace(event, this, 'otp4')">
      <input type="text" maxlength="1" id="otp6" oninput="verifyOTP()" onkeydown="handleBackspace(event, this, 'otp5')">
    </div>

    <div class="timer" id="timer"></div>

    <button id="resendBtn" onclick="resendOTP()" style="background:#6b7280;margin-top:12px" disabled>
      Resend code
    </button>

    <p style="text-align:center;font-size:12px;margin-top:12px;color:#fff;">
      <span style="cursor:pointer" onclick="backToEmail()">‚Üê Change email</span>
    </p>
  </div>
</div>

<!-- VERIFYING -->
<div class="email-overlay" id="verifyingModal">
  <div class="email-glass" style="text-align:center">
    <div class="loader"></div>
    <h3>Verifying...</h3>
    <p>Please wait while we verify your code</p>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>

<script>
// Initialize Firebase
firebase.initializeApp({
  apiKey:"AIzaSyD6PdrKp2XLfRqjC587lMpdKTaWD4MBens",
  authDomain:"scalevest-163a0.firebaseapp.com",
  projectId:"scalevest-163a0"
});

const auth = firebase.auth();
const functions = firebase.functions();
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

let currentEmail = '';
let timerInterval = null;

/* UI HELPERS */
function closeModals(){
  emailModal.style.display="none";
  otpModal.style.display="none";
  verifyingModal.style.display="none";
  clearTimer();
}

function showEmailAuth(){
  emailModal.style.display="flex";
  emailError.style.display="none";
  emailSuccess.style.display="none";
  emailInput.value = '';
}

function backToEmail(){
  otpModal.style.display="none";
  emailModal.style.display="flex";
  clearOTPInputs();
  clearTimer();
}

function clearOTPInputs(){
  for(let i=1; i<=6; i++){
    document.getElementById('otp'+i).value = '';
  }
  document.getElementById('otp1').focus();
}

function showError(elementId, message){
  const el = document.getElementById(elementId);
  el.innerText = message;
  el.style.display = "block";
}

function showSuccess(elementId, message){
  const el = document.getElementById(elementId);
  el.innerText = message;
  el.style.display = "block";
}

/* OTP INPUT NAVIGATION */
function moveToNext(current, nextId){
  if(current.value.length === 1 && nextId){
    document.getElementById(nextId).focus();
  }
}

function handleBackspace(event, current, prevId){
  if(event.key === 'Backspace' && current.value === '' && prevId){
    document.getElementById(prevId).focus();
  }
}

/* COUNTDOWN TIMER */
function startTimer(seconds){
  clearTimer();
  
  let remaining = seconds;
  const resendBtn = document.getElementById('resendBtn');
  const timerEl = document.getElementById('timer');
  
  resendBtn.disabled = true;
  
  timerInterval = setInterval(() => {
    remaining--;
    
    const mins = Math.floor(remaining / 60);
    const secs = remaining % 60;
    timerEl.innerText = `Code expires in ${mins}:${secs.toString().padStart(2, '0')}`;
    
    if(remaining <= 0){
      clearTimer();
      timerEl.innerText = 'Code expired';
      resendBtn.disabled = false;
      resendBtn.innerText = 'Resend code';
    }
  }, 1000);
}

function clearTimer(){
  if(timerInterval){
    clearInterval(timerInterval);
    timerInterval = null;
  }
}

/* SEND OTP */
async function sendOTP(){
  const email = emailInput.value.trim();
  
  if(!email){
    showError('emailError', 'Please enter your email');
    return;
  }
  
  if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){
    showError('emailError', 'Please enter a valid email address');
    return;
  }
  
  const btn = document.getElementById('sendOtpBtn');
  btn.disabled = true;
  btn.innerText = 'Sending...';
  emailError.style.display = 'none';
  emailSuccess.style.display = 'none';
  
  try {
    const generateOTP = functions.httpsCallable('generateOTP');
    const result = await generateOTP({ email: email });
    
    currentEmail = email;
    
    showSuccess('emailSuccess', '‚úÖ Code sent! Check your email.');
    
    setTimeout(() => {
      emailModal.style.display = 'none';
      otpModal.style.display = 'flex';
      otpEmail.innerText = email;
      clearOTPInputs();
      startTimer(300); // 5 minutes
    }, 1500);
    
  } catch(error) {
    console.error('Error sending OTP:', error);
    showError('emailError', error.message || 'Failed to send code. Please try again.');
    btn.disabled = false;
    btn.innerText = 'Send verification code';
  }
}

/* RESEND OTP */
async function resendOTP(){
  const btn = document.getElementById('resendBtn');
  btn.disabled = true;
  btn.innerText = 'Sending...';
  otpError.style.display = 'none';
  
  try {
    const generateOTP = functions.httpsCallable('generateOTP');
    await generateOTP({ email: currentEmail });
    
    clearOTPInputs();
    startTimer(300);
    
    showError('otpError', '‚úÖ New code sent!');
    setTimeout(() => {
      otpError.style.display = 'none';
    }, 3000);
    
  } catch(error) {
    console.error('Error resending OTP:', error);
    showError('otpError', 'Failed to resend code. Please try again.');
    btn.disabled = false;
    btn.innerText = 'Resend code';
  }
}

/* VERIFY OTP */
async function verifyOTP(){
  let otp = '';
  for(let i=1; i<=6; i++){
    const val = document.getElementById('otp'+i).value;
    if(!val) return; // Wait for all digits
    otp += val;
  }
  
  otpError.style.display = 'none';
  otpModal.style.display = 'none';
  verifyingModal.style.display = 'flex';
  
  try {
    const verifyOTPFunc = functions.httpsCallable('verifyOTP');
    const result = await verifyOTPFunc({ 
      email: currentEmail, 
      otp: otp 
    });
    
    // Sign in with custom token
    await auth.signInWithCustomToken(result.data.customToken);
    
    // Redirect to main hub
    window.location.href = "mainbusinesshub.html";
    
  } catch(error) {
    console.error('Error verifying OTP:', error);
    verifyingModal.style.display = 'none';
    otpModal.style.display = 'flex';
    
    showError('otpError', error.message || 'Invalid code. Please try again.');
    clearOTPInputs();
  }
}

/* GOOGLE LOGIN */
async function googleLogin(){
  try {
    const provider = new firebase.auth.GoogleAuthProvider();
    await auth.signInWithPopup(provider);
    window.location.href = "mainbusinesshub.html";
  } catch(err) {
    console.error('Google sign-in error:', err);
    alert("Google sign-in failed: " + err.message);
  }
}

/* FACEBOOK LOGIN */
async function facebookLogin(){
  try {
    const provider = new firebase.auth.FacebookAuthProvider();
    provider.addScope('email');
    await auth.signInWithPopup(provider);
    window.location.href = "mainbusinesshub.html";
  } catch(err) {
    console.error('Facebook sign-in error:', err);
    if(err.code === "auth/popup-closed-by-user") return;
    alert("Facebook sign-in failed: " + err.message);
  }
}

/* APPLE LOGIN */
async function appleLogin(){
  try {
    const provider = new firebase.auth.OAuthProvider('apple.com');
    provider.addScope('email');
    provider.addScope('name');
    await auth.signInWithPopup(provider);
    window.location.href = "mainbusinesshub.html";
  } catch(err) {
    console.error('Apple sign-in error:', err);
    if(err.code === "auth/popup-closed-by-user") return;
    alert("Apple sign-in failed: " + err.message);
  }
}

/* AUTH STATE LISTENER */
auth.onAuthStateChanged(user => {
  if(user && user.emailVerified){
    window.location.href = "mainbusinesshub.html";
  }
});

// Auto-focus first OTP input when modal opens
const observer = new MutationObserver(() => {
  if(otpModal.style.display === 'flex'){
    document.getElementById('otp1').focus();
  }
});
observer.observe(otpModal, { attributes: true, attributeFilter: ['style'] });
</script>

</body>
</html>
