
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AI Inventory Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
*{box-sizing:border-box;font-family:Inter}
body{margin:0;background:#f6f7fb;padding:30px}

/* HEADER */
.top{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;flex-wrap:wrap;gap:15px}
.top h2{margin:0;font-size:26px;font-weight:700}
.top .actions{display:flex;gap:10px;flex-wrap:wrap}
.top button{padding:12px 18px;border:none;border-radius:14px;background:#000;color:#fff;font-weight:600;cursor:pointer}
#scannerModal button:active {
    transform: scale(0.95);
    background: #e5e7eb !important;
}
/* SEARCH */
.search-container {width:100%; margin-bottom:20px;}
#searchInput {
  width:100%; padding:16px 20px; border-radius:16px; border:1px solid #ddd;
  font-size:16px; outline:none; box-shadow:0 10px 20px rgba(0,0,0,0.03);
}
/* Modern Scanner Viewport */
#reader {
    width: 100%;
    max-width: 500px;
    margin: 0 auto;
    border-radius: 20px;
    overflow: hidden;
    border: none !important;
}

#reader__dashboard_section_csr button {
    background: #2563eb !important;
    color: white !important;
    border-radius: 8px !important;
    padding: 10px 20px !important;
    text-transform: uppercase;
    font-weight: bold;
}

/* This makes it look like PhonePe */
#reader__scan_region {
    background: #000;
}

.action-buttons {
    display: flex;
    align-items: center;
    gap: 8px;
}

.step-btn {
    width: 32px;
    height: 32px;
    border-radius: 10px;
    border: 1px solid #e2e8f0;
    background: white;
    color: #7c3aed;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: 0.2s;
}

.step-btn:hover {
    background: #f5f3ff;
    border-color: #7c3aed;
    transform: translateY(-2px);
}

.remove-btn {
    width: 32px;
    height: 32px;
    border-radius: 10px;
    border: 1px solid #fee2e2;
    background: #fff;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-left: 10px;
    transition: 0.2s;
}

.remove-btn:hover {
    background: #ef4444;
}

.remove-btn:hover svg {
    stroke: white; /* Trash icon turns white on hover */
}
/* STATS */
.stats-container {
    display: flex; /* Use flex instead of grid for easier side-by-side control */
    justify-content: space-between;
    gap: 8px; /* Tighter gap so they don't hit the screen edges */
    margin-bottom: 30px;
    width: 100%;
}

.stat-card {
    background: white;
    padding: 12px 10px; /* Reduced padding slightly so icons fit next to text */
    border-radius: 20px; /* Same luxury curves */
    display: flex;
    align-items: center;
    gap: 8px; /* Space between icon and text */
    border: 1px solid #f1f5f9;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
    flex: 1; /* This forces all 3 cards to be equal width */
    min-width: 0; /* Prevents cards from "leaking" off screen */
    transition: transform 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
}

.stat-icon {
    width: 35px; /* Scaled down slightly for mobile to keep them side-by-side */
    height: 35px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0; /* Prevents the icon from getting crushed */
}

.stat-icon svg {
    width: 18px;
    height: 18px;
}

/* Your Exact Colors */
.total-bg { background: #f5f3ff; color: #7c3aed; }
.low-bg { background: #fffbeb; color: #d97706; }
.out-bg { background: #fef2f2; color: #ef4444; }

.stat-details {
    display: flex;
    flex-direction: column;
    overflow: hidden; /* Safety for long numbers */
}

.stat-label {
    font-size: 9px; /* Shrunk for mobile side-by-side */
    font-weight: 600;
    color: #64748b;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    white-space: nowrap;
}

.stat-details h3 {
    margin: 0;
    font-size: 16px; /* High-end bold number */
    font-weight: 700;
    color: #1e293b;
}

/* Hide the sub-text only on very small screens to save space */
.stat-sub {
    display: none;
}

/* DESKTOP UPGRADE: Makes them bigger when there is room */
@media (min-width: 768px) {
    .stats-container { gap: 20px; }
    .stat-card { padding: 24px; gap: 16px; }
    .stat-icon { width: 48px; height: 48px; }
    .stat-icon svg { width: 24px; height: 24px; }
    .stat-label { font-size: 13px; }
    .stat-details h3 { font-size: 24px; }
    .stat-sub { display: block; font-size: 11px; color: #94a3b8; font-weight: 500; }
}
.inventory-grid-wrapper {
    background: white;
    border-radius: 24px;
    border: 1px solid #f1f5f9;
    box-shadow: 0 4px 20px rgba(0,0,0,0.03);
    overflow: hidden; /* Clips the corners of the inner rows */
    margin-top: 20px;
}

.grid-header {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 1fr;
    background: #f8fafc;
    padding: 16px 24px;
    border-bottom: 1px solid #f1f5f9;
    color: #64748b;
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.grid-body {
    max-height: 60vh; /* Scrollable body */
    overflow-y: auto;
}

/* Individual Row Styling */
.row {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 1fr;
    align-items: center;
    padding: 18px 24px;
    border-bottom: 1px solid #f8fafc;
    transition: all 0.2s ease;
}

.row:hover {
    background-color: #f5f3ff; /* Very soft purple tint */
    transform: scale(1.005);
}

.row:last-child { border-bottom: none; }

/* Status Pill Styling */
.status {
    padding: 6px 12px;
    border-radius: 100px;
    font-size: 11px;
    font-weight: 700;
    text-align: center;
    width: fit-content;
}

.status.ok { background: #ecfdf5; color: #10b981; }
.status.low { background: #fffbeb; color: #d97706; }
.status.out { background: #fef2f2; color: #ef4444; }

/* Action Button Container */
.action-buttons {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
}

/* Mobile Responsiveness */
@media (max-width: 768px) {
    .grid-header { display: none; } /* Hide header on small screens */
    .row {
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        padding: 20px;
    }
    .col-actions { grid-column: span 2; justify-content: flex-start; }
}
/* TABLE */
.table{background:#fff;border-radius:22px;box-shadow:0 15px 35px rgba(0,0,0,.08);overflow:hidden}
.head,.row{display:grid;grid-template-columns:2fr 1fr 1fr 2fr;padding:16px 22px;align-items:center}
.head{background:#f1f3f7;font-weight:600}
.row:not(:last-child){border-bottom:1px solid #eee}

/* STATUS */
.status.ok{color:#16a34a}
.status.low{color:#d97706}
.status.out{color:#dc2626}
/* ADD PRODUCT MODAL & CHOICES */
.choice-menu {
  position: absolute;
  background: white;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.15);
  display: none;
  flex-direction: column;
  z-index: 2000;
  overflow: hidden;
  margin-top: 5px;
}
.choice-menu button {
  background: white !important;
  color: #333 !important;
  border-radius: 0 !important;
  text-align: left;
  padding: 12px 20px !important;
  border-bottom: 1px solid #eee !important;
}
.choice-menu button:hover { background: #f9f9f9 !important; }

.manual-modal-box {
  width: 100%;
  max-width: 450px;
  background: #fff;
  padding: 40px;
  border-radius: 30px;
  position: relative;
}
.manual-modal-box input, .manual-modal-box select {
  width: 100%;
  padding: 14px;
  margin: 10px 0;
  border: 1px solid #ddd;
  border-radius: 12px;
  font-size: 16px;
}
.modal-actions {
  display: flex;
  gap: 10px;
  margin-top: 20px;
}
.btn-save { background: #16a34a !important; flex: 2; }
.btn-close { background: #666 !important; flex: 1; }
/* MODERN MODAL UPDATES */
.modal-box, .manual-modal-box {
    background: #fff;
    border-radius: 28px;
    padding: 35px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    border: 1px solid rgba(255,255,255,0.3);
}

/* CHOICE MODAL BUTTONS */
.choice-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 20px;
}
.choice-card {
    padding: 30px 20px;
    border: 2px solid #f0f0f0;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
}
.choice-card:hover {
    border-color: #2563eb;
    background: #f8faff;
    transform: translateY(-5px);
}
.choice-card i { font-size: 32px; display: block; margin-bottom: 10px; }
.choice-card span { font-weight: 700; color: #333; }

/* BEAUTIFIED FORM INPUTS */
input, select, textarea {
    background: #f9fafb !important;
    border: 1px solid #e5e7eb !important;
    transition: all 0.2s ease;
}
input:focus, select:focus, textarea:focus {
    background: #fff !important;
    border-color: #2563eb !important;
    box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1) !important;
}

/* BUTTON STYLES */
.btn-save, .btn-import { 
    background: #000 !important; 
    color: white !important; 
    border-radius: 14px !important;
    height: 50px;
    font-size: 16px;
}
.btn-close { 
    background: #f3f4f6 !important; 
    color: #4b5563 !important; 
    border-radius: 14px !important;
    height: 50px;
}
.btn-save:hover { opacity: 0.9; }

/* BULK ADD MODAL STYLES */
.bulk-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin: 20px 0;
}
.bulk-box {
  display: flex;
  flex-direction: column;
  text-align: left;
}
.bulk-box label {
  font-weight: 600;
  font-size: 14px;
  margin-bottom: 8px;
  color: #444;
}
.bulk-box textarea {
  width: 100%;
  height: 200px;
  padding: 15px;
  border-radius: 15px;
  border: 1px solid #ddd;
  resize: none;
  font-size: 14px;
  background: #fcfcfc;
}
.bulk-box textarea:focus {
  outline: 2px solid #2563eb;
  border-color: transparent;
}
/* VOICE MODAL & ANIMATION */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:1000;backdrop-filter:blur(8px)}
.modal-box{width:400px;background:#fff;padding:30px;border-radius:30px;text-align:center;box-shadow:0 20px 50px rgba(0,0,0,0.3)}

.ai-visualizer {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 5px;
  height: 60px;
  margin: 20px 0;
}
.bar {
  width: 6px;
  height: 10px;
  background: #2563eb;
  border-radius: 10px;
  animation: bounce 1s ease-in-out infinite;
}
.bar:nth-child(2) { animation-delay: 0.1s; background: #3b82f6; }
.bar:nth-child(3) { animation-delay: 0.2s; background: #60a5fa; }
.bar:nth-child(4) { animation-delay: 0.3s; background: #2563eb; }
.bar:nth-child(5) { animation-delay: 0.4s; background: #3b82f6; }

/* Visual cue for confirmation mode */
.confirm-mode .bar { background: #ef4444 !important; animation-duration: 0.4s; }

@keyframes bounce {
  0%, 100% { height: 10px; }
  50% { height: 50px; }
}
.back-nav-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 38px;
    height: 38px;
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    color: #1e293b;
    text-decoration: none;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.back-nav-btn:hover {
    background: #f5f3ff;
    border-color: #7c3aed;
    color: #7c3aed;
    transform: translateX(-3px); /* Subtle nudge to the left */
}

.top h2 {
    margin: 0;
    font-size: 26px;
    font-weight: 800;
    color: #1e293b;
}
/* Matching the other buttons to the elite theme */
.btn-pic { background: #8b5cf6; color: white; border: none; padding: 10px 18px; border-radius: 12px; font-weight: 600; cursor: pointer; }
.btn-primary { background: #1e293b; color: white; border: none; padding: 10px 18px; border-radius: 12px; font-weight: 600; cursor: pointer; }
.btn-standard { background: white; border: 1px solid #e2e8f0; padding: 10px 18px; border-radius: 12px; font-weight: 600; cursor: pointer; }
.custom-modal {
    position: fixed; inset: 0;
    background: rgba(15, 23, 42, 0.4);
    backdrop-filter: blur(8px);
    display: none; justify-content: center; align-items: center;
    z-index: 2000;
}
.modal-content {
    background: white; padding: 30px; border-radius: 28px;
    width: 90%; max-width: 350px; text-align: center;
    box-shadow: 0 20px 40px rgba(0,0,0,0.2);
}
.modal-content h3 { margin: 0; font-size: 20px; font-weight: 700; }
.modal-content p { color: #64748b; font-size: 14px; margin: 8px 0 20px; }
.modal-content input {
    width: 100%; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0;
    font-size: 18px; text-align: center; font-weight: 700; outline: none;
}
.modal-content input:focus { border-color: #7c3aed; box-shadow: 0 0 0 4px rgba(124, 58, 237, 0.1); }
.modal-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px; }
.btn-cancel { padding: 12px; border: none; border-radius: 12px; background: #f1f5f9; color: #64748b; font-weight: 600; cursor: pointer; }
.btn-confirm { padding: 12px; border: none; border-radius: 12px; background: #7c3aed; color: white; font-weight: 600; cursor: pointer; }
/* SUCCESS POPUP */
.success-popup {
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%);
  background: #16a34a;
  color: white;
  padding: 12px 25px;
  border-radius: 50px;
  font-weight: 600;
  display: none;
  z-index: 3000;
  box-shadow: 0 10px 20px rgba(0,0,0,0.2);
  animation: slideUp 0.3s ease;
}
@keyframes slideUp { from { bottom: -50px; opacity: 0; } to { bottom: 30px; opacity: 1; } }

#scanner{position:relative;width:100%;height:240px;background:#000;border-radius:14px;overflow:hidden}
.flash{position:fixed;inset:0;background:rgba(34,197,94,.25);pointer-events:none;z-index:3000;opacity:0;transition:.15s}
.flash.show{opacity:1}
</style>
</head>

<body>

<audio id="beep-ok" preload src="https://assets.mixkit.co/sfx/preview/mixkit-beep-tone-2864.mp3"></audio>
<div id="flash" class="flash"></div>
<div id="successPopup" class="success-popup">Product Updated</div>

<div class="top">
  <div style="display: flex; align-items: center; gap: 15px;">
    <a href="mainbusinesshub.html" class="back-nav-btn">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
    </a>
    <h2>Inventory</h2>
  </div>

  <div class="actions">
    <button style="background:#8b5cf6" onclick="window.location.href='picture.html'">üì∏ PIC (AI Scan)</button>
    <button onclick="openScanner()">üì∑ Scanner</button>
    <div style="position:relative; display:inline-block;">
        <button onclick="toggleAddMenu()">‚ûï Add Product</button>
        <div id="addMenu" class="choice-menu">
            <button onclick="openManualAdd()">üìù Manual Add</button>
            <button onclick="openBulkAdd()">üì¶ Bulk Add</button>
        </div>
    </div>
    <button style="background:#2563eb" onclick="startVoiceAssistant()">üéôÔ∏è AI Voice</button>
  </div>
</div>

<div class="search-container">
  <input type="text" id="searchInput" placeholder="Search inventory..." onkeyup="render()">
</div>

<div class="stats-container">
  <div class="stat-card">
    <div class="stat-icon total-bg">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
    </div>
    <div class="stat-details">
      <span class="stat-label">Total Stock</span>
      <h3 id="total">0</h3>
      <span class="stat-sub">Active Products</span>
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-icon low-bg">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
    </div>
    <div class="stat-details">
      <span class="stat-label">Low Stock</span>
      <h3 id="low" class="text-warning">0</h3>
      <span class="stat-sub">Needs Attention</span>
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-icon out-bg">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
    </div>
    <div class="stat-details">
      <span class="stat-label">Out of Stock</span>
      <h3 id="out" class="text-danger">0</h3>
      <span class="stat-sub">Need Restock</span>
    </div>
  </div>
</div>
<div id="qtyModal" class="custom-modal">
    <div class="modal-content">
        <h3 id="qtyTitle">Adjust Stock</h3>
        <p id="qtySubtitle">Enter amount to update inventory</p>
        <input type="number" id="qtyInput" placeholder="0" autofocus>
        <div class="modal-actions">
            <button class="btn-cancel" onclick="closeQtyModal()">Cancel</button>
            <button class="btn-confirm" id="confirmQtyBtn">Update Stock</button>
        </div>
    </div>
</div>
<div class="inventory-grid-wrapper">
    <div class="grid-header">
        <div class="col-main">Product Identity</div>
        <div class="col-stat">Stock Level</div>
        <div class="col-status">Status</div>
        <div class="col-actions">Control</div>
    </div>
    <div id="products" class="grid-body">
        </div>
</div>
<div id="bulkModal" class="modal">
  <div class="manual-modal-box" style="max-width: 700px;"> <h2 style="margin-top:0">Bulk Add Products</h2>
    <p style="font-size: 13px; color: #666;">Separate items with commas. Ensure the number of names matches the number of quantities.</p>
    
    <div class="bulk-grid">
      <div class="bulk-box">
        <label>Product Names</label>
        <textarea id="b_names" placeholder="Apple, Milk, Bread..."></textarea>
      </div>
      <div class="bulk-box">
        <label>Quantities & Units</label>
        <textarea id="b_qtys" placeholder="10kg, 5, 2 packets..."></textarea>
      </div>
    </div>
    
    <div class="modal-actions">
      <button class="btn-save" onclick="saveBulkProducts()">üöÄ Import All</button>
      <button class="btn-close" onclick="closeBulkAdd()">Close</button>
    </div>
  </div>
</div>
<div id="voiceModal" class="modal">
  <div class="modal-box">
    <h2 style="margin-top:0">AI Voice Assistant</h2>
    <p style="color:#666; font-size:14px">Just speak the product name and quantity.<br>I will add, increase, or decrease it for you.</p>
    
    <div id="viz" class="ai-visualizer">
      <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
    </div>
    
    <div id="speechOutput" style="font-style:italic; color:#2563eb; margin-bottom:20px; min-height:24px">Waiting for you to speak...</div>
    
    <button onclick="stopVoiceAssistant()" style="background:#ef4444">Close Assistant</button>
  </div>
</div>




<div id="manualModal" class="modal">
  <div class="manual-modal-box">
    <h2 style="margin-top:0">Add New Product</h2>
    <input type="text" id="m_name" placeholder="Product Name (e.g. Apple)">
    <input type="number" id="m_qty" placeholder="Quantity (e.g. 50)">
    <select id="m_unit">
        <option value="pcs">Pieces (pcs)</option>
        <option value="kg">Kilograms (kg)</option>
        <option value="gram">Grams (g)</option>
        <option value="liter">Liters (L)</option>
        <option value="packets">Packets</option>
    </select>
    
    <div class="modal-actions">
        <button class="btn-save" onclick="saveManualProduct()">Save Product</button>
        <button class="btn-close" onclick="closeManualAdd()">Close</button>
    </div>
  </div>
</div>



<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyD6PdrKp2XLfRqjC587lMpdKTaWD4MBens",
  authDomain: "scalevest-163a0.firebaseapp.com",
  databaseURL: "https://scalevest-163a0-default-rtdb.firebaseio.com",
  projectId: "scalevest-163a0"
});

const auth = firebase.auth(), db = firebase.database();
let inventory = {}, prices = {}, invRef = null, recognition, isAssistantActive = false;
let pendingAction = null; 

auth.onAuthStateChanged(u => {
  if (!u) { console.log("User not logged in"); return; }
  
  // 1. Inventory Reference
  invRef = db.ref(`Businesses/${u.uid}/inventory`);
  invRef.on("value", s => { 
    inventory = s.val() || {}; 
    render(); 
  });

  // 2. Prices Reference (NEW: Needed for revenue calculation)
  db.ref(`Businesses/${u.uid}/prices`).on("value", s => {
    prices = s.val() || {};
    console.log("Prices loaded:", prices);
  });
});

// --- MANUAL ADD LOGIC ---

function toggleAddMenu() {
    const menu = document.getElementById("addMenu");
    menu.style.display = (menu.style.display === "flex") ? "none" : "flex";
}

function openManualAdd() {
    document.getElementById("addMenu").style.display = "none";
    document.getElementById("manualModal").style.display = "flex";
}

function closeManualAdd() {
    document.getElementById("manualModal").style.display = "none";
    clearManualInputs();
}

function clearManualInputs() {
    document.getElementById("m_name").value = "";
    document.getElementById("m_qty").value = "";
    document.getElementById("m_unit").value = "pcs";
}

function saveManualProduct() {
    const name = document.getElementById("m_name").value.trim();
    const qtyInput = document.getElementById("m_qty").value;
    const unit = document.getElementById("m_unit").value;

    if (!name || qtyInput === "") {
        alert("Please enter both Name and Quantity");
        return;
    }

    const qty = parseFloat(qtyInput);

    // CRITICAL: Check if invRef is ready
    if (!invRef) {
        alert("System still loading or you are not logged in. Please wait a second.");
        return;
    }

    // Visual feedback
    const btn = document.querySelector(".btn-save");
    const originalText = btn.textContent;
    btn.textContent = "Saving...";
    btn.disabled = true;

    invRef.push({
        name: name.charAt(0).toUpperCase() + name.slice(1),
        quantity: qty,
        unit: unit
    }).then(() => {
        triggerSuccess(`Added ${name}`);
        clearManualInputs();
        document.getElementById("m_name").focus();
        
        // Reset button
        btn.textContent = originalText;
        btn.disabled = false;
    }).catch(err => {
        alert("Error saving: " + err.message);
        btn.textContent = originalText;
        btn.disabled = false;
    });
}

// FIXED: Close menu logic to prevent blocking modal clicks
window.onclick = function(event) {
    const menu = document.getElementById("addMenu");
    // Only close the menu if clicking outside the menu button area
    if (!event.target.closest('.actions') && menu.style.display === "flex") {
        menu.style.display = "none";
    }
}
function openBulkAdd() {
    document.getElementById("addMenu").style.display = "none";
    document.getElementById("bulkModal").style.display = "flex";
}

function closeBulkAdd() {
    document.getElementById("bulkModal").style.display = "none";
    document.getElementById("b_names").value = "";
    document.getElementById("b_qtys").value = "";
}

function saveBulkProducts() {
    const namesStr = document.getElementById("b_names").value;
    const qtysStr = document.getElementById("b_qtys").value;

    if (!namesStr || !qtysStr) return alert("Please fill both boxes");

    // Split by comma and clean up whitespace
    const nameList = namesStr.split(',').map(n => n.trim()).filter(n => n !== "");
    const qtyList = qtysStr.split(',').map(q => q.trim()).filter(q => q !== "");

    if (nameList.length !== qtyList.length) {
        return alert(`Mismatch! You have ${nameList.length} names but ${qtyList.length} quantities.`);
    }

    if (!invRef) return alert("Database not ready");

    const btn = document.querySelector("#bulkModal .btn-save");
    btn.textContent = "Processing...";
    btn.disabled = true;

    nameList.forEach((name, index) => {
        const rawQty = qtyList[index];
        
        // Logic to separate number from unit (e.g., "10kg" -> 10 and "kg")
        const numMatch = rawQty.match(/(\d+(\.\d+)?)/);
        const qty = numMatch ? parseFloat(numMatch[0]) : 0;
        
        // Remove the number to find the unit, default to 'pcs' if empty
        let unit = rawQty.replace(/(\d+(\.\d+)?)/, '').trim() || "pcs";

        invRef.push({
            name: name.charAt(0).toUpperCase() + name.slice(1),
            quantity: qty,
            unit: unit
        });
    });

    triggerSuccess(`Successfully imported ${nameList.length} products!`);
    closeBulkAdd();
    btn.textContent = "üöÄ Import All";
    btn.disabled = false;
}
// --- AI VOICE LOGIC ---
function startVoiceAssistant() {
  if (!('webkitSpeechRecognition' in window)) return alert("Voice not supported");
  
  isAssistantActive = true;
  document.getElementById("voiceModal").style.display = "flex";
  
  recognition = new webkitSpeechRecognition();
  recognition.lang = "en-US";
  recognition.continuous = true; 
  recognition.interimResults = true;

  recognition.onresult = (event) => {
    let interimTranscript = '';
    for (let i = event.resultIndex; i < event.results.length; ++i) {
      if (event.results[i].isFinal) {
        const finalTranscript = event.results[i][0].transcript;
        document.getElementById("speechOutput").textContent = `"${finalTranscript}"`;
        processSmartAI(finalTranscript);
      } else {
        interimTranscript += event.results[i][0].transcript;
        document.getElementById("speechOutput").textContent = interimTranscript;
      }
    }
  };

  recognition.onend = () => {
    if (isAssistantActive) {
        try { recognition.start(); } catch(e) {}
    }
  };

  recognition.start();
  speakWithAI("I am listening.");
}

function stopVoiceAssistant() {
  isAssistantActive = false;
  pendingAction = null;
  document.getElementById("viz").classList.remove("confirm-mode");
  if (recognition) recognition.stop();
  document.getElementById("voiceModal").style.display = "none";
}

async function processSmartAI(transcript) {
  const output = document.getElementById("speechOutput");
  output.textContent = "Processing...";

  try {
    // REPLACE the URL below with your actual Vercel deployment URL
    // Example: https://your-project-name.vercel.app/api/voice
  const VERCEL_API_URL = 'https://ai-inventory-pro-sigma.vercel.app/api/voice';

    const res = await fetch(VERCEL_API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt: transcript })
    });

    if (!res.ok) throw new Error(`Server error: ${res.status}`);

    const data = await res.json();
    if (data.error) throw new Error(data.error);

    // 1. AI Logic Execution
    const pName = data.item.toLowerCase();
    const existingEntry = Object.entries(inventory).find(([_, p]) => p.name.toLowerCase() === pName);

    if (data.action === 'delete' && existingEntry) {
        pendingAction = { type: 'delete', id: existingEntry[0], name: pName };
        document.getElementById("viz").classList.add("confirm-mode");
    } 
else if (data.action === 'decrease' && existingEntry) {
        const [id, product] = existingEntry;
        const amount = data.qty;

        // Record the sale first
        recordSale(id, product.name, amount);

        const newVal = Math.max(0, product.quantity - amount);
        invRef.child(id).update({ quantity: newVal });
        triggerSuccess(`Sold ${amount} ${pName}`);
    }
    else if (data.action === 'add' || data.action === 'increase') {
        if (existingEntry) {
            invRef.child(existingEntry[0]).update({ quantity: existingEntry[1].quantity + data.qty });
        } else {
            invRef.push({ name: data.item, quantity: data.qty, unit: data.unit || "pcs" });
        }
        triggerSuccess(`Updated ${pName}`);
    }

    // 2. The "Real Person" Voice Response from your Vercel handler
    speakWithAI(data.reply);
    output.textContent = `"${transcript}"`;

  } catch (err) {
    console.error("Connection Error:", err);
    speakWithAI("Sorry, I had a brain freeze connecting to the server.");
    output.textContent = "Error: " + err.message;
  }
}// --- TEXT TO SPEECH ENGINE ---
function speakWithAI(text) {
  if ('speechSynthesis' in window) {
    window.speechSynthesis.cancel(); // Stop current speech
    const utterance = new SpeechSynthesisUtterance(text);
    const voices = window.speechSynthesis.getVoices();
    const googleVoice = voices.find(v => v.name.includes('Google') && v.lang.includes('en'));
    if (googleVoice) utterance.voice = googleVoice;
    
    utterance.rate = 1.0;
    utterance.pitch = 1.0;
    window.speechSynthesis.speak(utterance);
  }
}

// --- UI HELPERS ---
function triggerSuccess(msg) {
  const popup = document.getElementById("successPopup");
  popup.textContent = msg;
  popup.style.display = "block";
  document.getElementById("flash").classList.add("show");
  setTimeout(() => {
    popup.style.display = "none";
    document.getElementById("flash").classList.remove("show");
  }, 2000);
}
function recordSale(productId, productName, qty) {
    const priceData = prices[productId];
    if (!priceData || !priceData.sellPrice) return;

    const sellPrice = (typeof priceData.sellPrice === 'object') 
        ? (priceData.sellPrice.numericValue || 0) 
        : parseFloat(priceData.sellPrice) || 0;

    db.ref(`Businesses/${auth.currentUser.uid}/sales`).push({
        productId: productId,
        productName: productName,
        quantity: qty,
        revenue: sellPrice * qty,
        timestamp: firebase.database.ServerValue.TIMESTAMP
    });
}
function render() {
  const productsDiv = document.getElementById("products");
  const query = document.getElementById("searchInput").value.toLowerCase();
  productsDiv.innerHTML = "";
  let lowC = 0, outC = 0;

  Object.entries(inventory).forEach(([id, p]) => {
    if (query && !p.name.toLowerCase().includes(query)) return;

    let s = "OK", c = "ok";
    if (p.quantity === 0) { s = "Out"; c = "out"; outC++; }
    else if (p.quantity < 10) { s = "Low"; c = "low"; lowC++; }

productsDiv.innerHTML += `
<div class="row">
  <div class="col-main">
      <div style="font-weight:700; color: #1e293b;">${p.name}</div>
  </div>
  <div class="col-stat" style="font-weight: 600;">
      ${p.quantity} <span style="font-size: 12px; color: #94a3b8; font-weight: 400;">${p.unit}</span>
  </div>
  <div class="col-status">
      <div class="status ${c}">${s}</div>
  </div>
  <div class="action-buttons">
    <button class="step-btn" onclick="askQuantity('${id}', -1)">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"><line x1="5" y1="12" x2="19" y2="12"/></svg>
    </button>
    <button class="step-btn" onclick="askQuantity('${id}', 1)">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
    </button>
    <button class="remove-btn" onclick="handleManualDelete('${id}', '${p.name}')">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
    </button>
  </div>
</div>`;
  });

  document.getElementById("total").textContent = Object.keys(inventory).length;
  document.getElementById("low").textContent = lowC;
  document.getElementById("out").textContent = outC;
}

let currentUpdateId = null;
let currentDirection = 0;

function askQuantity(id, direction) {
    currentUpdateId = id;
    currentDirection = direction;
    const p = inventory[id];
    
    document.getElementById("qtyTitle").textContent = direction > 0 ? `Add to ${p.name}` : `Remove from ${p.name}`;
    document.getElementById("qtyInput").value = ""; // Clear previous
    document.getElementById("qtyModal").style.display = "flex";
    setTimeout(() => document.getElementById("qtyInput").focus(), 100);
}

function closeQtyModal() {
    document.getElementById("qtyModal").style.display = "none";
}

document.getElementById("confirmQtyBtn").onclick = () => {
    const val = document.getElementById("qtyInput").value;
    if (!val || isNaN(val)) return;

    const amount = Math.abs(parseFloat(val));
    const p = inventory[currentUpdateId];
    const priceData = prices[currentUpdateId] || {};
    const costPrice = (typeof priceData.costPrice === 'object') ? priceData.costPrice.numericValue : parseFloat(priceData.costPrice) || 0;
    const sellPrice = (typeof priceData.sellPrice === 'object') ? priceData.sellPrice.numericValue : parseFloat(priceData.sellPrice) || 0;

    if (currentDirection > 0) {
        // INCREASING STOCK: Record a Purchase (Increases Total Spend)
        db.ref(`Businesses/${auth.currentUser.uid}/purchases`).push({
            productId: currentUpdateId,
            productName: p.name,
            quantity: amount,
            totalCost: costPrice * amount,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });
    } else {
        // DECREASING STOCK: Record a Sale (Increases Total Revenue)
        db.ref(`Businesses/${auth.currentUser.uid}/sales`).push({
            productId: currentUpdateId,
            productName: p.name,
            quantity: amount,
            revenue: sellPrice * amount,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });
    }

    // Update the actual inventory count
    const newQty = currentDirection > 0 ? p.quantity + amount : Math.max(0, p.quantity - amount);
    invRef.child(currentUpdateId).update({ quantity: newQty }).then(() => {
        closeQtyModal();
        triggerSuccess(currentDirection > 0 ? `Added ${amount}` : `Sold ${amount}`);
    });
};

// Close modal if user clicks outside
window.onclick = (event) => {
    const modal = document.getElementById("qtyModal");
    if (event.target == modal) closeQtyModal();
}
function handleManualDelete(id, name) {
    if(confirm(`Are you sure you want to permanently delete ${name}?`)) {
        invRef.child(id).remove();
    }
}

function handleManualDelete(id, name) {
    if(confirm(`Delete ${name}?`)) invRef.child(id).remove();
}

function manualChange(id, dir) {
  const p = inventory[id];
  invRef.child(id).update({ quantity: Math.max(0, p.quantity + dir) });
}
// SCANNER PART

let html5QrCode;
let isScanning = false; 
let lastScannedBarcode = null;
let lastScannedTime = 0;
let torchOn = false;

// --- 1. PRO SCANNER: ZOOMED & OPTIMIZED ---
async function openScanner() {
    let scannerModal = document.getElementById('scannerModal');
    if (!scannerModal) {
        scannerModal = document.createElement('div');
        scannerModal.id = 'scannerModal';
        scannerModal.className = 'modal';
        scannerModal.innerHTML = `
            <div class="manual-modal-box" style="padding:20px; max-width: 500px; text-align:center; border: 4px solid #000; background:#fff;">
                <h3 style="margin-top:0">Smart Scanner Pro</h3>
                <p style="font-size:12px; color:#666; margin-bottom:10px;">Hold phone further back; auto-zoom is active</p>
                <div id="reader" style="border-radius:15px; overflow:hidden; background:#000;"></div>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin: 15px 0;">
                    <button id="torch-btn" onclick="toggleTorch()" 
                            style="background:#fbbf24; color:#000; display:none; padding:15px; border-radius:12px; border:none; font-weight:700; cursor:pointer; align-items:center; justify-content:center;">
                        üî¶ Flashlight
                    </button>
                    <button onclick="openTypeModal()" 
                            style="background:#f0f2f5; color:#333; padding:15px; border-radius:12px; border:none; font-weight:700; cursor:pointer;">
                        ‚å®Ô∏è Type Barcode
                    </button>
                </div>

                <button class="btn-close" onclick="stopScanner()" style="width:100%; padding:15px; font-weight:bold;">Close Scanner</button>
            </div>
        `;
        document.body.appendChild(scannerModal);
    }
    
    scannerModal.style.display = "flex";
    html5QrCode = new Html5Qrcode("reader");
    
    const config = { 
        fps: 30, 
        qrbox: { width: 300, height: 150 }, 
        aspectRatio: 1.0,
        experimentalFeatures: { useBarCodeDetectorIfSupported: true }
    };

    const formats = [
        Html5QrcodeSupportedFormats.EAN_13,
        Html5QrcodeSupportedFormats.EAN_8,
        Html5QrcodeSupportedFormats.UPC_A,
        Html5QrcodeSupportedFormats.CODE_128
    ];

    try {
        await html5QrCode.start(
            { facingMode: "environment" }, 
            { ...config, formatsToSupport: formats }, 
            (text) => handleScanSuccess(text)
        );

        setTimeout(async () => {
            try {
                const track = html5QrCode.getRunningTrack();
                const caps = track.getCapabilities();
                
                if (caps.torch) {
                    document.getElementById('torch-btn').style.display = "flex";
                }

                if (caps.zoom) {
                    await track.applyConstraints({
                        advanced: [{ zoom: 4.0 }, { focusMode: "continuous" }]
                    });
                }
            } catch (hwErr) {
                console.warn("Hardware constraints failed", hwErr);
            }
        }, 1200);

    } catch (err) {
        console.error("Scanner fail:", err);
    }
}

// --- 2. HAPTIC & AUTO-LOOKUP LOGIC ---
function handleScanSuccess(decodedText) {
    const now = Date.now();
    if (decodedText === lastScannedBarcode && (now - lastScannedTime) < 5000) return; 

    lastScannedBarcode = decodedText;
    lastScannedTime = now;
    
    if ("vibrate" in navigator) navigator.vibrate(100); 
    document.getElementById("beep-ok").play();
    processScannedBarcode(decodedText);
}

// --- 3. REWRITTEN FLASHLIGHT ---
async function toggleTorch() {
    try {
        const track = html5QrCode.getRunningTrack();
        torchOn = !torchOn;
        await track.applyConstraints({ advanced: [{ torch: torchOn }] });
        const btn = document.getElementById('torch-btn');
        btn.style.background = torchOn ? "#000" : "#fbbf24";
        btn.style.color = torchOn ? "#fff" : "#000";
        btn.innerText = torchOn ? "üö´ Flash Off" : "üî¶ Flashlight";
    } catch (e) { console.error("Torch error", e); }
}

// --- 4. MANUAL ENTRY ---
function openTypeModal() {
    let tModal = document.getElementById('typeModal');
    if (!tModal) {
        tModal = document.createElement('div');
        tModal.id = 'typeModal';
        tModal.className = 'modal';
        tModal.style.zIndex = "5000";
        document.body.appendChild(tModal);
    }
    tModal.innerHTML = `
        <div class="manual-modal-box" style="border: 3px solid #000; padding:20px; background:#fff;">
            <h3 style="margin-top:0">Manual Entry</h3>
            <input type="number" id="manual_barcode_input" 
                   style="width:90%; padding:15px; font-size:18px; margin:10px 0; border:2px solid #ccc; border-radius:8px;" 
                   placeholder="Enter barcode..." autofocus>
            <div style="display:flex; gap:10px;">
                <button onclick="submitManualCode()" style="flex:1; padding:12px; background:#2563eb; color:#fff; border:none; border-radius:8px;">Process</button>
                <button onclick="document.getElementById('typeModal').style.display='none'" style="flex:1; padding:12px; background:#eee; border:none; border-radius:8px;">Cancel</button>
            </div>
        </div>
    `;
    tModal.style.display = "flex";
    setTimeout(() => document.getElementById('manual_barcode_input').focus(), 150);
}

function submitManualCode() {
    const code = document.getElementById('manual_barcode_input').value.trim();
    if (code) {
        handleScanSuccess(code);
        document.getElementById('typeModal').style.display = 'none';
    }
}

// --- 5. SMART MULTI-API PROCESSING (FIXED) ---
async function processScannedBarcode(code) {
    const entries = Object.entries(inventory || {});
    const existingEntry = entries.find(([_, p]) => p.barcode === code);

    // STEP 1: Check Local Inventory
    if (existingEntry) {
        const [id, product] = existingEntry;
        const newQty = (product.quantity || 0) + 1;
        invRef.child(id).update({ quantity: newQty }).then(() => {
            triggerSuccess(`In: ${product.name} (+1)`);
            speakWithAI(`${product.name} updated.`);
        });
        return;
    }

    speakWithAI("Searching...");

    // STEP 2: Try Open Food Facts (API 1)
    try {
        const offRes = await fetch(`https://world.openfoodfacts.org/api/v0/product/${code}.json?fields=product_name,brands`);
        const offData = await offRes.json();
        
        if (offData.status === 1 && (offData.product.product_name || offData.product.brands)) {
            let finalName = offData.product.brands 
                ? `${offData.product.brands} ${offData.product.product_name || ""}` 
                : offData.product.product_name;
            saveNewProduct(code, finalName.trim());
            return;
        }
    } catch (e) { console.warn("OFF API failed, trying backup..."); }

    // STEP 3: Try UPCitemdb (API 2 - High accuracy for retail)
    try {
        const upcRes = await fetch(`https://api.upcitemdb.com/prod/trial/lookup?upc=${code}`);
        const upcData = await upcRes.json();

        if (upcData.items && upcData.items.length > 0) {
            const item = upcData.items[0];
            saveNewProduct(code, item.title);
            return;
        }
    } catch (e) { console.warn("UPCitemdb failed"); }

    // STEP 4: Fallback to Manual Prompt
    openNamePrompt(code);
}

function openNamePrompt(code) {
    let pModal = document.getElementById('namePromptModal');
    if (!pModal) {
        pModal = document.createElement('div');
        pModal.id = 'namePromptModal';
        pModal.className = 'modal';
        pModal.style.zIndex = "5001";
        document.body.appendChild(pModal);
    }
    pModal.innerHTML = `
        <div class="manual-modal-box" style="border: 3px solid #2563eb; padding:20px; background:#fff;">
            <h3 style="margin-top:0; color:#2563eb;">New Item!</h3>
            <p style="font-size:12px; color:#666;">Barcode: ${code}</p>
            <input type="text" id="custom_name" placeholder="Name of product..." 
                   style="width:90%; padding:15px; font-size:16px; border:2px solid #ccc; border-radius:8px;" autofocus>
            <div style="margin-top:15px; display:flex; gap:10px;">
                <button onclick="submitName('${code}')" style="flex:1; padding:12px; background:#2563eb; color:#fff; border:none; border-radius:8px;">Register</button>
                <button onclick="document.getElementById('namePromptModal').style.display='none'" style="flex:1; padding:12px; background:#eee; border:none; border-radius:8px;">Cancel</button>
            </div>
        </div>
    `;
    pModal.style.display = "flex";
    setTimeout(() => document.getElementById('custom_name').focus(), 150);
}

function submitName(code) {
    const name = document.getElementById('custom_name').value.trim();
    if (name) {
        saveNewProduct(code, name);
        document.getElementById('namePromptModal').style.display = 'none';
    }
}

function saveNewProduct(code, name) {
    const cleanName = name.charAt(0).toUpperCase() + name.slice(1);
    invRef.push({
        name: cleanName,
        barcode: code,
        quantity: 1,
        unit: "pcs",
        createdAt: firebase.database.ServerValue.TIMESTAMP
    }).then(() => {
        triggerSuccess(`Added: ${cleanName}`);
        speakWithAI(`Registered ${cleanName}`);
    });
}

function stopScanner() {
    if (html5QrCode) {
        html5QrCode.stop().then(() => {
            document.getElementById('scannerModal').style.display = "none";
            torchOn = false;
        }).catch(() => {
            document.getElementById('scannerModal').style.display = "none";
        });
    }
}

</script>

</body>
</html>

