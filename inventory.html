
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AI Inventory Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

<style>
*{box-sizing:border-box;font-family:Inter}
body{margin:0;background:#f6f7fb;padding:30px}

/* HEADER */
.top{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;flex-wrap:wrap;gap:15px}
.top h2{margin:0;font-size:26px;font-weight:700}
.top .actions{display:flex;gap:10px;flex-wrap:wrap}
.top button{padding:12px 18px;border:none;border-radius:14px;background:#000;color:#fff;font-weight:600;cursor:pointer}

/* SEARCH */
.search-container {width:100%; margin-bottom:20px;}
#searchInput {
  width:100%; padding:16px 20px; border-radius:16px; border:1px solid #ddd;
  font-size:16px; outline:none; box-shadow:0 10px 20px rgba(0,0,0,0.03);
}

/* STATS */
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;margin-bottom:30px}
.stat{background:#fff;padding:22px;border-radius:20px;box-shadow:0 10px 25px rgba(0,0,0,.06)}
.stat h3{margin:8px 0 0;font-size:26px}

/* TABLE */
.table{background:#fff;border-radius:22px;box-shadow:0 15px 35px rgba(0,0,0,.08);overflow:hidden}
.head,.row{display:grid;grid-template-columns:2fr 1fr 1fr 2fr;padding:16px 22px;align-items:center}
.head{background:#f1f3f7;font-weight:600}
.row:not(:last-child){border-bottom:1px solid #eee}

/* STATUS */
.status.ok{color:#16a34a}
.status.low{color:#d97706}
.status.out{color:#dc2626}
/* ADD PRODUCT MODAL & CHOICES */
.choice-menu {
  position: absolute;
  background: white;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.15);
  display: none;
  flex-direction: column;
  z-index: 2000;
  overflow: hidden;
  margin-top: 5px;
}
.choice-menu button {
  background: white !important;
  color: #333 !important;
  border-radius: 0 !important;
  text-align: left;
  padding: 12px 20px !important;
  border-bottom: 1px solid #eee !important;
}
.choice-menu button:hover { background: #f9f9f9 !important; }

.manual-modal-box {
  width: 100%;
  max-width: 450px;
  background: #fff;
  padding: 40px;
  border-radius: 30px;
  position: relative;
}
.manual-modal-box input, .manual-modal-box select {
  width: 100%;
  padding: 14px;
  margin: 10px 0;
  border: 1px solid #ddd;
  border-radius: 12px;
  font-size: 16px;
}
.modal-actions {
  display: flex;
  gap: 10px;
  margin-top: 20px;
}
.btn-save { background: #16a34a !important; flex: 2; }
.btn-close { background: #666 !important; flex: 1; }
/* MODERN MODAL UPDATES */
.modal-box, .manual-modal-box {
    background: #fff;
    border-radius: 28px;
    padding: 35px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    border: 1px solid rgba(255,255,255,0.3);
}

/* CHOICE MODAL BUTTONS */
.choice-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 20px;
}
.choice-card {
    padding: 30px 20px;
    border: 2px solid #f0f0f0;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
}
.choice-card:hover {
    border-color: #2563eb;
    background: #f8faff;
    transform: translateY(-5px);
}
.choice-card i { font-size: 32px; display: block; margin-bottom: 10px; }
.choice-card span { font-weight: 700; color: #333; }

/* BEAUTIFIED FORM INPUTS */
input, select, textarea {
    background: #f9fafb !important;
    border: 1px solid #e5e7eb !important;
    transition: all 0.2s ease;
}
input:focus, select:focus, textarea:focus {
    background: #fff !important;
    border-color: #2563eb !important;
    box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1) !important;
}

/* BUTTON STYLES */
.btn-save, .btn-import { 
    background: #000 !important; 
    color: white !important; 
    border-radius: 14px !important;
    height: 50px;
    font-size: 16px;
}
.btn-close { 
    background: #f3f4f6 !important; 
    color: #4b5563 !important; 
    border-radius: 14px !important;
    height: 50px;
}
.btn-save:hover { opacity: 0.9; }

/* BULK ADD MODAL STYLES */
.bulk-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin: 20px 0;
}
.bulk-box {
  display: flex;
  flex-direction: column;
  text-align: left;
}
.bulk-box label {
  font-weight: 600;
  font-size: 14px;
  margin-bottom: 8px;
  color: #444;
}
.bulk-box textarea {
  width: 100%;
  height: 200px;
  padding: 15px;
  border-radius: 15px;
  border: 1px solid #ddd;
  resize: none;
  font-size: 14px;
  background: #fcfcfc;
}
.bulk-box textarea:focus {
  outline: 2px solid #2563eb;
  border-color: transparent;
}
/* VOICE MODAL & ANIMATION */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:1000;backdrop-filter:blur(8px)}
.modal-box{width:400px;background:#fff;padding:30px;border-radius:30px;text-align:center;box-shadow:0 20px 50px rgba(0,0,0,0.3)}

.ai-visualizer {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 5px;
  height: 60px;
  margin: 20px 0;
}
.bar {
  width: 6px;
  height: 10px;
  background: #2563eb;
  border-radius: 10px;
  animation: bounce 1s ease-in-out infinite;
}
.bar:nth-child(2) { animation-delay: 0.1s; background: #3b82f6; }
.bar:nth-child(3) { animation-delay: 0.2s; background: #60a5fa; }
.bar:nth-child(4) { animation-delay: 0.3s; background: #2563eb; }
.bar:nth-child(5) { animation-delay: 0.4s; background: #3b82f6; }

/* Visual cue for confirmation mode */
.confirm-mode .bar { background: #ef4444 !important; animation-duration: 0.4s; }

@keyframes bounce {
  0%, 100% { height: 10px; }
  50% { height: 50px; }
}

/* SUCCESS POPUP */
.success-popup {
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%);
  background: #16a34a;
  color: white;
  padding: 12px 25px;
  border-radius: 50px;
  font-weight: 600;
  display: none;
  z-index: 3000;
  box-shadow: 0 10px 20px rgba(0,0,0,0.2);
  animation: slideUp 0.3s ease;
}
@keyframes slideUp { from { bottom: -50px; opacity: 0; } to { bottom: 30px; opacity: 1; } }

#scanner{position:relative;width:100%;height:240px;background:#000;border-radius:14px;overflow:hidden}
.flash{position:fixed;inset:0;background:rgba(34,197,94,.25);pointer-events:none;z-index:3000;opacity:0;transition:.15s}
.flash.show{opacity:1}
</style>
</head>

<body>

<audio id="beep-ok" preload src="https://assets.mixkit.co/sfx/preview/mixkit-beep-tone-2864.mp3"></audio>
<div id="flash" class="flash"></div>
<div id="successPopup" class="success-popup">Product Updated</div>

<div class="top">
  <h2>Inventory</h2>
  <div class="actions">
    <button onclick="openScanner()">üì∑ Scanner</button>
   <div style="position:relative; display:inline-block;">
    <button onclick="toggleAddMenu()">‚ûï Add Product</button>
    <div id="addMenu" class="choice-menu">
        <button onclick="openManualAdd()">üìù Manual Add</button>
        <button onclick="openBulkAdd()">üì¶ Bulk Add</button>
    </div>
</div>
    <button style="background:#2563eb" onclick="startVoiceAssistant()">üéôÔ∏è AI Voice</button>
  </div>
</div>

<div class="search-container">
  <input type="text" id="searchInput" placeholder="Search inventory..." onkeyup="render()">
</div>

<div class="stats">
  <div class="stat"><span>Total</span><h3 id="total">0</h3></div>
  <div class="stat"><span>Low</span><h3 id="low">0</h3></div>
  <div class="stat"><span>Out</span><h3 id="out">0</h3></div>
</div>

<div class="table">
  <div class="head"><div>Product</div><div>Quantity</div><div>Status</div><div>Actions</div></div>
  <div id="products"></div>
</div>
<div id="bulkModal" class="modal">
  <div class="manual-modal-box" style="max-width: 700px;"> <h2 style="margin-top:0">Bulk Add Products</h2>
    <p style="font-size: 13px; color: #666;">Separate items with commas. Ensure the number of names matches the number of quantities.</p>
    
    <div class="bulk-grid">
      <div class="bulk-box">
        <label>Product Names</label>
        <textarea id="b_names" placeholder="Apple, Milk, Bread..."></textarea>
      </div>
      <div class="bulk-box">
        <label>Quantities & Units</label>
        <textarea id="b_qtys" placeholder="10kg, 5, 2 packets..."></textarea>
      </div>
    </div>
    
    <div class="modal-actions">
      <button class="btn-save" onclick="saveBulkProducts()">üöÄ Import All</button>
      <button class="btn-close" onclick="closeBulkAdd()">Close</button>
    </div>
  </div>
</div>
<div id="voiceModal" class="modal">
  <div class="modal-box">
    <h2 style="margin-top:0">AI Voice Assistant</h2>
    <p style="color:#666; font-size:14px">Just speak the product name and quantity.<br>I will add, increase, or decrease it for you.</p>
    
    <div id="viz" class="ai-visualizer">
      <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
    </div>
    
    <div id="speechOutput" style="font-style:italic; color:#2563eb; margin-bottom:20px; min-height:24px">Waiting for you to speak...</div>
    
    <button onclick="stopVoiceAssistant()" style="background:#ef4444">Close Assistant</button>
  </div>
</div>
<div id="manualModal" class="modal">
  <div class="manual-modal-box">
    <h2 style="margin-top:0">Add New Product</h2>
    <input type="text" id="m_name" placeholder="Product Name (e.g. Apple)">
    <input type="number" id="m_qty" placeholder="Quantity (e.g. 50)">
    <select id="m_unit">
        <option value="pcs">Pieces (pcs)</option>
        <option value="kg">Kilograms (kg)</option>
        <option value="gram">Grams (g)</option>
        <option value="liter">Liters (L)</option>
        <option value="packets">Packets</option>
    </select>
    
    <div class="modal-actions">
        <button class="btn-save" onclick="saveManualProduct()">Save Product</button>
        <button class="btn-close" onclick="closeManualAdd()">Close</button>
    </div>
  </div>
</div>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyD6PdrKp2XLfRqjC587lMpdKTaWD4MBens",
  authDomain: "scalevest-163a0.firebaseapp.com",
  databaseURL: "https://scalevest-163a0-default-rtdb.firebaseio.com",
  projectId: "scalevest-163a0"
});

const auth = firebase.auth(), db = firebase.database();
let inventory = {}, invRef = null, recognition, isAssistantActive = false;
let pendingAction = null; 

auth.onAuthStateChanged(u => {
  if (!u) { console.log("User not logged in"); return; }
  // Set the reference globally so saveManualProduct can see it
  invRef = db.ref(`Businesses/${u.uid}/inventory`);
  invRef.on("value", s => { 
    inventory = s.val() || {}; 
    render(); 
  });
});

// --- MANUAL ADD LOGIC ---

function toggleAddMenu() {
    const menu = document.getElementById("addMenu");
    menu.style.display = (menu.style.display === "flex") ? "none" : "flex";
}

function openManualAdd() {
    document.getElementById("addMenu").style.display = "none";
    document.getElementById("manualModal").style.display = "flex";
}

function closeManualAdd() {
    document.getElementById("manualModal").style.display = "none";
    clearManualInputs();
}

function clearManualInputs() {
    document.getElementById("m_name").value = "";
    document.getElementById("m_qty").value = "";
    document.getElementById("m_unit").value = "pcs";
}

function saveManualProduct() {
    const name = document.getElementById("m_name").value.trim();
    const qtyInput = document.getElementById("m_qty").value;
    const unit = document.getElementById("m_unit").value;

    if (!name || qtyInput === "") {
        alert("Please enter both Name and Quantity");
        return;
    }

    const qty = parseFloat(qtyInput);

    // CRITICAL: Check if invRef is ready
    if (!invRef) {
        alert("System still loading or you are not logged in. Please wait a second.");
        return;
    }

    // Visual feedback
    const btn = document.querySelector(".btn-save");
    const originalText = btn.textContent;
    btn.textContent = "Saving...";
    btn.disabled = true;

    invRef.push({
        name: name.charAt(0).toUpperCase() + name.slice(1),
        quantity: qty,
        unit: unit
    }).then(() => {
        triggerSuccess(`Added ${name}`);
        clearManualInputs();
        document.getElementById("m_name").focus();
        
        // Reset button
        btn.textContent = originalText;
        btn.disabled = false;
    }).catch(err => {
        alert("Error saving: " + err.message);
        btn.textContent = originalText;
        btn.disabled = false;
    });
}

// FIXED: Close menu logic to prevent blocking modal clicks
window.onclick = function(event) {
    const menu = document.getElementById("addMenu");
    // Only close the menu if clicking outside the menu button area
    if (!event.target.closest('.actions') && menu.style.display === "flex") {
        menu.style.display = "none";
    }
}
function openBulkAdd() {
    document.getElementById("addMenu").style.display = "none";
    document.getElementById("bulkModal").style.display = "flex";
}

function closeBulkAdd() {
    document.getElementById("bulkModal").style.display = "none";
    document.getElementById("b_names").value = "";
    document.getElementById("b_qtys").value = "";
}

function saveBulkProducts() {
    const namesStr = document.getElementById("b_names").value;
    const qtysStr = document.getElementById("b_qtys").value;

    if (!namesStr || !qtysStr) return alert("Please fill both boxes");

    // Split by comma and clean up whitespace
    const nameList = namesStr.split(',').map(n => n.trim()).filter(n => n !== "");
    const qtyList = qtysStr.split(',').map(q => q.trim()).filter(q => q !== "");

    if (nameList.length !== qtyList.length) {
        return alert(`Mismatch! You have ${nameList.length} names but ${qtyList.length} quantities.`);
    }

    if (!invRef) return alert("Database not ready");

    const btn = document.querySelector("#bulkModal .btn-save");
    btn.textContent = "Processing...";
    btn.disabled = true;

    nameList.forEach((name, index) => {
        const rawQty = qtyList[index];
        
        // Logic to separate number from unit (e.g., "10kg" -> 10 and "kg")
        const numMatch = rawQty.match(/(\d+(\.\d+)?)/);
        const qty = numMatch ? parseFloat(numMatch[0]) : 0;
        
        // Remove the number to find the unit, default to 'pcs' if empty
        let unit = rawQty.replace(/(\d+(\.\d+)?)/, '').trim() || "pcs";

        invRef.push({
            name: name.charAt(0).toUpperCase() + name.slice(1),
            quantity: qty,
            unit: unit
        });
    });

    triggerSuccess(`Successfully imported ${nameList.length} products!`);
    closeBulkAdd();
    btn.textContent = "üöÄ Import All";
    btn.disabled = false;
}
// --- AI VOICE LOGIC ---
function startVoiceAssistant() {
  if (!('webkitSpeechRecognition' in window)) return alert("Voice not supported");
  
  isAssistantActive = true;
  document.getElementById("voiceModal").style.display = "flex";
  
  recognition = new webkitSpeechRecognition();
  recognition.lang = "en-US";
  recognition.continuous = true; 
  recognition.interimResults = true;

  recognition.onresult = (event) => {
    let interimTranscript = '';
    for (let i = event.resultIndex; i < event.results.length; ++i) {
      if (event.results[i].isFinal) {
        const finalTranscript = event.results[i][0].transcript;
        document.getElementById("speechOutput").textContent = `"${finalTranscript}"`;
        processSmartAI(finalTranscript);
      } else {
        interimTranscript += event.results[i][0].transcript;
        document.getElementById("speechOutput").textContent = interimTranscript;
      }
    }
  };

  recognition.onend = () => {
    if (isAssistantActive) {
        try { recognition.start(); } catch(e) {}
    }
  };

  recognition.start();
  speakWithAI("I am listening. Just tell me what to do.");
}

function stopVoiceAssistant() {
  isAssistantActive = false;
  pendingAction = null;
  document.getElementById("viz").classList.remove("confirm-mode");
  if (recognition) recognition.stop();
  document.getElementById("voiceModal").style.display = "none";
}

async function processSmartAI(cmd) {
  cmd = cmd.toLowerCase();

  // 1. Handle Pending Confirmation
  if (pendingAction) {
    if (cmd.includes("yes") || cmd.includes("confirm") || cmd.includes("do it")) {
        if (pendingAction.type === 'delete') {
            invRef.child(pendingAction.id).remove();
            triggerSuccess(`Removed ${pendingAction.name}`);
            speakWithAI(`Successfully deleted ${pendingAction.name}.`);
        }
        pendingAction = null;
        document.getElementById("viz").classList.remove("confirm-mode");
        return;
    } else if (cmd.includes("no") || cmd.includes("cancel")) {
        speakWithAI("Action cancelled.");
        pendingAction = null;
        document.getElementById("viz").classList.remove("confirm-mode");
        return;
    }
  }
  
  // 2. Extract Numbers (Support for digits and basic words)
  const numberMap = { 'one': 1, 'two': 2, 'three': 3, 'four': 4, 'five': 5, 'ten': 10 };
  let qty = 1;
  const numMatch = cmd.match(/(\d+(\.\d+)?)/);
  if (numMatch) {
      qty = parseFloat(numMatch[0]);
  } else {
      Object.keys(numberMap).forEach(word => { if(cmd.includes(word)) qty = numberMap[word]; });
  }

  // 3. Extract Units
  const units = ["kg", "kilogram", "gram", " g ", "liter", " ml ", "packets", "pcs", "boxes"];
  let detectedUnit = "pcs";
  units.forEach(u => { if(cmd.includes(u)) detectedUnit = u.trim(); });

  // 4. Extract Product Name
  let pName = cmd
    .replace(/(\d+(\.\d+)?)/g, '')
    .replace(new RegExp(units.join("|"), "g"), '')
    .replace(/(add|remove|delete|increase|decrease|minus|plus|update|to|of|set|the)/g, '')
    .trim();

  if (pName.length < 2) return;

  const existingEntry = Object.entries(inventory).find(([_, p]) => p.name.toLowerCase() === pName);

  // 5. Action Logic
  if (cmd.includes("remove") || cmd.includes("delete")) {
    if (existingEntry) {
      pendingAction = { type: 'delete', id: existingEntry[0], name: pName };
      document.getElementById("viz").classList.add("confirm-mode");
      speakWithAI(`Are you sure you want to delete ${pName}? Say yes to confirm.`);
    } else {
      speakWithAI(`I couldn't find ${pName} in your inventory.`);
    }
  } 
  else if (cmd.includes("decrease") || cmd.includes("minus") || cmd.includes("less") || cmd.includes("reduce")) {
    if (existingEntry) {
      const newVal = Math.max(0, existingEntry[1].quantity - qty);
      invRef.child(existingEntry[0]).update({ quantity: newVal });
      triggerSuccess(`Decreased ${pName}`);
      speakWithAI(`Decreased ${pName} by ${qty}. New total is ${newVal}.`);
    } else {
      speakWithAI(`Product ${pName} not found to decrease.`);
    }
  }
  else {
    // Implicit Add or Increase
    if (existingEntry) {
      const newVal = existingEntry[1].quantity + qty;
      invRef.child(existingEntry[0]).update({ quantity: newVal });
      triggerSuccess(`Increased ${pName}`);
      speakWithAI(`Added ${qty} to ${pName}. Total is now ${newVal}.`);
    } else {
      invRef.push({ 
        name: pName.charAt(0).toUpperCase() + pName.slice(1), 
        quantity: qty, 
        unit: detectedUnit 
      });
      triggerSuccess(`Added ${pName}`);
      speakWithAI(`Added ${qty} ${detectedUnit} of ${pName} as a new product.`);
    }
  }
}

// --- TEXT TO SPEECH ENGINE ---
function speakWithAI(text) {
  if ('speechSynthesis' in window) {
    window.speechSynthesis.cancel(); // Stop current speech
    const utterance = new SpeechSynthesisUtterance(text);
    const voices = window.speechSynthesis.getVoices();
    const googleVoice = voices.find(v => v.name.includes('Google') && v.lang.includes('en'));
    if (googleVoice) utterance.voice = googleVoice;
    
    utterance.rate = 1.0;
    utterance.pitch = 1.0;
    window.speechSynthesis.speak(utterance);
  }
}

// --- UI HELPERS ---
function triggerSuccess(msg) {
  const popup = document.getElementById("successPopup");
  popup.textContent = msg;
  popup.style.display = "block";
  document.getElementById("flash").classList.add("show");
  setTimeout(() => {
    popup.style.display = "none";
    document.getElementById("flash").classList.remove("show");
  }, 2000);
}

function render(){
  const productsDiv = document.getElementById("products");
  const query = document.getElementById("searchInput").value.toLowerCase();
  productsDiv.innerHTML="";
  let lowC=0, outC=0;

  Object.entries(inventory).forEach(([id,p])=>{
    if(query && !p.name.toLowerCase().includes(query)) return;

    let s="OK", c="ok";
    if(p.quantity===0){s="Out"; c="out"; outC++}
    else if(p.quantity<10){s="Low"; c="low"; lowC++}

    productsDiv.innerHTML+=`
    <div class="row">
      <div style="font-weight:600">${p.name}</div>
      <div>${p.quantity} <small>${p.unit}</small></div>
      <div class="status ${c}">${s}</div>
      <div>
        <button onclick="manualChange('${id}', 1)">+</button>
        <button class="remove" onclick="handleManualDelete('${id}', '${p.name}')">üóëÔ∏è</button>
      </div>
    </div>`;
  });
  document.getElementById("total").textContent=Object.keys(inventory).length;
  document.getElementById("low").textContent=lowC;
  document.getElementById("out").textContent=outC;
}

function handleManualDelete(id, name) {
    if(confirm(`Delete ${name}?`)) invRef.child(id).remove();
}

function manualChange(id, dir) {
  const p = inventory[id];
  invRef.child(id).update({ quantity: Math.max(0, p.quantity + dir) });
}
</script>

</body>
</html>
