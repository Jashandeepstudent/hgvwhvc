<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Supermarket-Speed Barcode Scanner</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  margin: 0;
  font-family: Inter, sans-serif;
  background: #111;
  color: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  padding: 20px;
  height: 100vh;
}

h1 {
  margin-bottom: 20px;
  font-size: 24px;
}

#scanner {
  width: 100%;
  max-width: 600px;
  height: 400px;
  position: relative;
  border-radius: 16px;
  overflow: hidden;
  border: 3px solid #0f0;
}

.scan-zone {
  position: absolute;
  inset: 20%;
  border: 2px dashed #0f0;
  border-radius: 12px;
  z-index: 10;
}

.laser {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 3px;
  background: red;
  box-shadow: 0 0 15px red;
  animation: scan 1s linear infinite;
}

@keyframes scan {
  0% { top: 0; }
  50% { top: 100%; }
  100% { top: 0; }
}

#log {
  margin-top: 20px;
  width: 100%;
  max-width: 600px;
  background: #222;
  padding: 12px;
  border-radius: 12px;
  min-height: 120px;
  overflow-y: auto;
}

#log div {
  margin-bottom: 6px;
}

button {
  margin-top: 20px;
  padding: 12px 20px;
  font-weight: 600;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  background: #0f0;
  color: #000;
}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
</head>
<body>

<h1>Supermarket-Speed Barcode Scanner</h1>

<div id="scanner">
  <div class="scan-zone"></div>
  <div class="laser"></div>
</div>

<div id="log"></div>

<button onclick="startScanner()">Start Scanner</button>
<button onclick="stopScanner()">Stop Scanner</button>

<script>
let scannerRunning = false;
let lastScanned = {};
let scanCounts = {};

function logScan(text) {
  const log = document.getElementById('log');
  const div = document.createElement('div');
  div.textContent = `${new Date().toLocaleTimeString()}: ${text}`;
  log.prepend(div);
}

// Start super-powered scanner
function startScanner() {
  if (scannerRunning) return;

  const isLaptop = !/Android|iPhone/i.test(navigator.userAgent);

  Quagga.init({
    inputStream: {
      type: "LiveStream",
      target: document.getElementById("scanner"),
      constraints: {
        facingMode: isLaptop ? "user" : "environment",
        width: { ideal: 1920 },
        height: { ideal: 1080 }
      }
    },
    locator: { patchSize: "medium", halfSample: false },
    numOfWorkers: navigator.hardwareConcurrency || 4,
    frequency: 20, // SUPER FAST scan rate
    decoder: { readers: ["ean_reader", "upc_reader", "code_128_reader", "code_39_reader"] },
    locate: true
  }, function(err) {
    if (err) { alert("Camera / HTTPS error: " + err); return; }
    Quagga.start();
    scannerRunning = true;
    logScan("Scanner started ✅");
  });

  Quagga.onDetected(d => {
    if (d.codeResult.confidence < 0.7) return; // allow lower confidence for speed

    const code = d.codeResult.code;
    const now = Date.now();

    // Count repeated scans within 1 second
    if (!scanCounts[code]) scanCounts[code] = { time: now, count: 0 };
    if (now - scanCounts[code].time < 1000) {
      scanCounts[code].count++;
    } else {
      scanCounts[code].count = 1;
    }
    scanCounts[code].time = now;

    // Show scan with quantity
    logScan(`Scanned: ${code} x${scanCounts[code].count} (confidence: ${Math.round(d.codeResult.confidence * 100)}%)`);
  });
}

// Stop scanner
function stopScanner() {
  if (!scannerRunning) return;
  Quagga.stop();
  scannerRunning = false;
  logScan("Scanner stopped ⏹️");
}
</script>

</body>
</html>
