<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Smart Inventory Pro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

    <style>
        *{box-sizing:border-box;font-family:Inter}
        body{margin:0;background:#f6f7fb;padding:30px}
        .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px}
        .top h2{margin:0;font-size:22px}
        .top .actions{display:flex;gap:10px}
        .top button{padding:12px 18px;border:none;border-radius:14px;background:#000;color:#fff;font-weight:600;cursor:pointer;transition:0.2s}
        .top button:hover{opacity:0.8}

        .search-container{margin-bottom:20px; display:flex; gap:10px;}
        .search-bar{flex:1; padding:15px 20px; border-radius:15px; border:1px solid #ddd; font-size:16px; box-shadow:0 4px 12px rgba(0,0,0,0.03); outline:none; transition:0.3s;}
        .search-bar:focus{border-color:#4f46e5; box-shadow:0 4px 12px rgba(79,70,229,0.1);}

        .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;margin-bottom:30px}
        .stat{background:#fff;padding:22px;border-radius:20px;box-shadow:0 10px 25px rgba(0,0,0,.06)}
        .stat span{color:#666;font-size:14px}
        .stat h3{margin:8px 0 0;font-size:26px}

        .table{background:#fff;border-radius:22px;box-shadow:0 15px 35px rgba(0,0,0,.08);overflow:hidden}
        .head,.row{display:grid;grid-template-columns:2fr 1fr 1fr 2fr;padding:16px 22px;align-items:center}
        .head{background:#f1f3f7;font-weight:600}
        .row:not(:last-child){border-bottom:1px solid #eee}
        .status.ok{color:#16a34a}
        .status.low{color:#d97706}
        .status.out{color:#dc2626}
        .row button{padding:6px 12px;border-radius:10px;border:1px solid #ddd;background:#fff;cursor:pointer;margin-right:5px}
        .remove{color:#dc2626;border-color:#dc2626}

        .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:1000}
        .modal-box{width:380px;background:#fff;padding:26px;border-radius:22px;text-align:center}
        .modal-box input{width:100%;padding:14px;border-radius:14px;border:1px solid #ddd;margin-bottom:12px}
        .modal-box button{width:100%;padding:14px;border:none;border-radius:14px;background:#000;color:#fff;font-weight:600;cursor:pointer}

        #scanner{position:relative;width:100%;height:240px;background:#000;border-radius:14px;overflow:hidden}
        .scan-zone{position:absolute;inset:25% 10%;border:2px dashed rgba(0,255,0,.7);border-radius:10px;z-index:10}
        .laser{position:absolute;top:0;left:0;width:100%;height:2px;background:red;box-shadow:0 0 10px red;animation:scan 1.2s linear infinite}
        @keyframes scan{0%{top:0}50%{top:100%}100%{top:0}}
        
        #liveTranscript{min-height:24px;margin-top:15px;color:#4f46e5;font-weight:500;font-style:italic}
    </style>
</head>
<body>

<div class="top">
    <h2>Inventory Pro <span style="font-size:11px;background:#4f46e5;color:white;padding:4px 8px;border-radius:8px;margin-left:5px">V2.3 PRO</span></h2>
    <div class="actions">
        <button onclick="openScanner()" style="background:#333">ðŸ“· Scan Barcode</button>
        <button onclick="openAdd()">Add Product</button>
        <button onclick="startVoice()" style="background:#4f46e5">ðŸŽ™ Talk to Partner</button>
    </div>
</div>

<div class="stats">
    <div class="stat"><span>Total Products</span><h3 id="total">0</h3></div>
    <div class="stat"><span>Low Stock</span><h3 id="low">0</h3></div>
    <div class="stat"><span>Out of Stock</span><h3 id="out">0</h3></div>
</div>

<div class="search-container">
    <input type="text" id="searchInput" class="search-bar" placeholder="Search products by name..." oninput="render()">
</div>

<div class="table">
    <div class="head"><div>Product</div><div>Quantity</div><div>Status</div><div>Actions</div></div>
    <div id="products"></div>
</div>

<div id="addModal" class="modal">
    <div class="modal-box">
        <h3>Add Product</h3>
        <input id="pname" placeholder="Product name">
        <input id="pqty" type="number" placeholder="Quantity">
        <input id="punit" placeholder="Unit (kg, pcs, L)">
        <button onclick="addProduct()">Save Product</button>
        <button onclick="closeModals()" style="background:none;color:#666;margin-top:10px">Cancel</button>
    </div>
</div>

<div id="voiceModal" class="modal">
    <div class="modal-box">
        <h3 id="voiceStatus">ðŸŽ™ Listening...</h3>
        <canvas id="waveform" width="300" height="100" style="width:100%;height:100px;background:#f9fafb;border-radius:15px;margin:10px 0"></canvas>
        <p id="liveTranscript">Preparing Microphone...</p>
        <button onclick="stopVoice()" style="background:#dc2626">Stop Listening</button>
    </div>
</div>

<div id="scannerModal" class="modal">
    <div class="modal-box">
        <h3>Scan Barcode</h3>
        <div id="scanner">
            <div class="scan-zone"></div>
            <div class="laser"></div>
        </div>
        <button onclick="closeModals()" style="margin-top:10px; background:#666">Close Scanner</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// --- CONFIG ---
const GEMINI_API_KEY = "AIzaSyD7ynlghvBtwQxbxbPnKSUhI6wkVZvWfVc"; 
firebase.initializeApp({
    apiKey:"AIzaSyD6PdrKp2XLfRqjC587lMpdKTaWD4MBens",
    authDomain:"scalevest-163a0.firebaseapp.com",
    databaseURL:"https://scalevest-163a0-default-rtdb.firebaseio.com",
    projectId:"scalevest-163a0"
});

const auth=firebase.auth(), db=firebase.database();
let inventory={}, invRef, recognition, audioContext, analyser, animationId;
let isProcessing = false;
let recognitionActive = false;

auth.onAuthStateChanged(u=>{
    if(!u) return;
    invRef=db.ref(`Businesses/${u.uid}/inventory`);
    invRef.on("value",s=>{inventory=s.val()||{};render()});
});

function render(){
    const productsDiv = document.getElementById("products");
    const searchTerm = document.getElementById("searchInput").value.toLowerCase();
    productsDiv.innerHTML="";
    let lowC=0, outC=0, totalCount=0;

    Object.entries(inventory).forEach(([id,p])=>{
        if(p.name.toLowerCase().includes(searchTerm)) {
            totalCount++;
            let s="In Stock", c="ok";
            if(p.quantity <= 0){s="Out of Stock";c="out";outC++}
            else if(p.quantity < 10){s="Low Stock";c="low";lowC++}
            
            productsDiv.innerHTML += `
                <div class="row">
                    <div>${p.name}</div>
                    <div>${p.quantity} ${p.unit || 'pcs'}</div>
                    <div class="status ${c}">${s}</div>
                    <div>
                        <button onclick="updateQty('${id}', 1)">+</button>
                        <button onclick="updateQty('${id}', -1)">-</button>
                        <button class="remove" onclick="invRef.child('${id}').remove()">Del</button>
                    </div>
                </div>`;
        }
    });
    document.getElementById("total").textContent = totalCount;
    document.getElementById("low").textContent = lowC;
    document.getElementById("out").textContent = outC;
}

function updateQty(id, diff){
    const p = inventory[id];
    invRef.child(id).update({quantity: Math.max(0, p.quantity + diff)});
}

function openAdd(){document.getElementById("addModal").style.display="flex"}
function closeModals(){
    document.querySelectorAll('.modal').forEach(m=>m.style.display='none');
    if(typeof Quagga !== 'undefined') Quagga.stop();
    recognitionActive = false;
    if(recognition) recognition.stop();
}

function addProduct(){
    const n=document.getElementById("pname"), q=document.getElementById("pqty"), u=document.getElementById("punit");
    if(!n.value) return;
    invRef.push({name:capitalizeWords(n.value), quantity:+q.value||0, unit:u.value||"pcs"});
    n.value=""; q.value=""; u.value=""; closeModals();
}

// --- VOICE LOGIC (REFACTORED FOR CHROME/SAFARI) ---
function startVoice() {
    const SpeechRecognition =
        window.SpeechRecognition || window.webkitSpeechRecognition;

    if (!SpeechRecognition) {
        alert("Speech recognition not supported.");
        return;
    }

    // UI
    document.getElementById("voiceModal").style.display = "flex";
    document.getElementById("liveTranscript").textContent =
        "Say: Add 5 Apples / Sold 2 Milk";

    // State
    recognitionActive = true;

    // Safari: resume audio context ONLY after user gesture
    if (audioContext && audioContext.state === "suspended") {
        audioContext.resume();
    }

    startVisualizer();

    // ðŸ”´ IMPORTANT: delay mic start (Chrome + Safari fix)
    setTimeout(() => {
        initRecognition();
    }, 500);
}


function initRecognition() {
    if (!recognitionActive) return;

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();

    recognition.lang = "en-US";
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.onresult = async (event) => {
        const transcript = event.results[0][0].transcript;
        document.getElementById("liveTranscript").textContent = transcript;

        // ðŸ”´ STOP mic immediately (critical)
        recognition.stop();

        try {
            await processVoice(transcript);
        } catch (e) {
            console.error(e);
            restartListening();
        }
    };

    recognition.onerror = (e) => {
        console.warn("Speech error:", e.error);
        restartListening();
    };

    recognition.onend = () => {
        // âŒ DO NOTHING HERE
        // Restart is handled manually after speak()
    };

    try {
        recognition.start();
    } catch (e) {}
}


async function processVoice(userSpeech){
    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
    try {
        const response = await fetch(API_URL, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                contents: [{parts: [{text: `Rules: Detect item, number, and action. If user says 'sold' or 'minus', use REMOVE. Else use UPDATE. User said: ${userSpeech}. Respond JSON only: {"action":"UPDATE"|"REMOVE","product":"item","quantity":10,"unit":"kg"}`}]}]
            })
        });
        const data = await response.json();
        const rawText = data.candidates[0].content.parts[0].text.replace(/```json|```/g, "").trim();
        const dec = JSON.parse(rawText);
        executeDecision(dec);
    } catch (err) { 
        console.log("Gemini Error, falling back to manual parse");
        manualParse(userSpeech); 
    }
}

function executeDecision(dec){
    const existingId = Object.keys(inventory).find(id=>inventory[id].name.toLowerCase() === dec.product.toLowerCase());
    if(dec.action === "UPDATE"){
        if(existingId) updateQty(existingId, dec.quantity);
        else invRef.push({name:capitalizeWords(dec.product), quantity:dec.quantity, unit:dec.unit||"pcs"});
        speak(`Updated ${dec.product}`);
    } else {
        if(existingId) updateQty(existingId, -dec.quantity);
        speak(`Removed ${dec.quantity} ${dec.product}`);
    }
}

function manualParse(s){
    const qty = parseInt(s.replace(/[^0-9]/g, '')) || 1;
    const productName = s.toLowerCase().replace(/[0-9]/g, '').replace('add', '').replace('remove', '').trim();
    if(!productName) { isProcessing=false; return; }
    invRef.push({name: capitalizeWords(productName), quantity: qty, unit: "pcs"});
    speak(`Added ${productName}`);
}

function speak(text) {
    if (!recognitionActive) return;

    if (recognition) recognition.stop(); // ðŸ”´ stop mic first
    window.speechSynthesis.cancel();

    const u = new SpeechSynthesisUtterance(text);

    u.onend = () => {
        restartListening(); // âœ… restart AFTER speaking
    };

    window.speechSynthesis.speak(u);
}
function restartListening() {
    if (!recognitionActive) return;
    setTimeout(() => initRecognition(), 700); // Safari-safe delay
}



function stopVoice(){
    recognitionActive = false;

    if (recognition) recognition.stop();
    window.speechSynthesis.cancel();

    closeModals();
}



function capitalizeWords(s){return s.replace(/\b\w/g, l=>l.toUpperCase())}

// --- SCANNER LOGIC ---
function openScanner() {
    document.getElementById("scannerModal").style.display="flex";
    Quagga.init({
        inputStream: { type: "LiveStream", target: document.getElementById("scanner"), constraints: { facingMode: "environment" } },
        decoder: { readers: ["ean_reader", "upc_reader", "code_128_reader"] }
    }, err => {
        if(err) return alert("Camera Error");
        Quagga.start();
    });
}

Quagga.onDetected(res => {
    const code = res.codeResult.code;
    const found = Object.entries(inventory).find(([_, p]) => p.barcode === code);
    if (found) {
        updateQty(found[0], 1);
        speak(`Added ${found[1].name}`);
    } else {
        invRef.push({ name: "New Item", quantity: 1, barcode: code, unit: "pcs" });
        speak("New item scanned");
    }
    closeModals();
});

async function startVisualizer(){
    try{
        if(!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const stream = await navigator.mediaDevices.getUserMedia({audio:true});
        const source = audioContext.createMediaStreamSource(stream);
        analyser = audioContext.createAnalyser();
        analyser.fftSize=64; source.connect(analyser);
        const dataArray = new Uint8Array(analyser.frequencyBinCount);
        const canvas=document.getElementById("waveform"), ctx=canvas.getContext("2d");
        function draw(){
            if(!recognitionActive) return;
            animationId=requestAnimationFrame(draw);
            analyser.getByteFrequencyData(dataArray);
            ctx.clearRect(0,0,canvas.width,canvas.height);
            ctx.fillStyle="#4f46e5";
            let x=0;
            dataArray.forEach(v=>{
                const h=(v/255)*canvas.height;
                ctx.fillRect(x,canvas.height-h,6,h); x+=10;
            });
        }
        draw();
    }catch(e){}
}
</script>
</body>
</html>
