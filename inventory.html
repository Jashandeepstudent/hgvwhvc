<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ScaleVest Inventory</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
*{box-sizing:border-box;font-family:Inter}
body{margin:0;background:#f6f7fb;padding:30px}

/* HEADER */
.top{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;flex-wrap:wrap;gap:15px}
.top h2{margin:0;font-size:26px;font-weight:700}
.top .actions{display:flex;gap:10px;flex-wrap:wrap}
.top button{padding:12px 18px;border:none;border-radius:14px;background:#000;color:#fff;font-weight:600;cursor:pointer}
#scannerModal button:active {
    transform: scale(0.95);
    background: #e5e7eb !important;
}
/* SEARCH */
.search-container {width:100%; margin-bottom:20px;}
#searchInput {
  width:100%; padding:16px 20px; border-radius:16px; border:1px solid #ddd;
  font-size:16px; outline:none; box-shadow:0 10px 20px rgba(0,0,0,0.03);
}
/* Modern Scanner Viewport */
#reader {
    width: 100%;
    max-width: 500px;
    margin: 0 auto;
    border-radius: 20px;
    overflow: hidden;
    border: none !important;
}

#reader__dashboard_section_csr button {
    background: #2563eb !important;
    color: white !important;
    border-radius: 8px !important;
    padding: 10px 20px !important;
    text-transform: uppercase;
    font-weight: bold;
}

/* This makes it look like PhonePe */
#reader__scan_region {
    background: #000;
}
.action-buttons {
    display: flex;
    align-items: center;
    gap: 6px;
    flex-wrap: wrap;
}

.action-text-btn {
    padding: 6px 10px;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
    background: white;
    color: #475569;
    cursor: pointer;
    font-size: 11px;
    font-weight: 600;
    transition: all 0.2s;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 4px;
}

.action-text-btn svg {
    width: 14px;
    height: 14px;
    flex-shrink: 0;
}

.action-text-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.12);
}
.pdf-type-card {
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 16px;
    padding: 25px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.pdf-type-card:hover {
    border-color: #3b82f6;
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(59, 130, 246, 0.2);
}

.pdf-type-card.premium:hover {
    border-color: #d97706;
    box-shadow: 0 10px 30px rgba(217, 119, 6, 0.2);
}

.pdf-type-icon {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 20px;
}

.pdf-type-card h3 {
    font-size: 20px;
    font-weight: 700;
    color: #1e293b;
    margin: 0 0 10px 0;
}

.pdf-type-card p {
    font-size: 13px;
    color: #64748b;
    margin-bottom: 15px;
}

.pdf-type-card ul {
    text-align: left;
    padding-left: 20px;
    margin: 15px 0;
}

.pdf-type-card ul li {
    font-size: 12px;
    color: #475569;
    margin-bottom: 6px;
}

.select-pdf-btn {
    width: 100%;
    padding: 12px;
    border: none;
    border-radius: 10px;
    font-weight: 700;
    cursor: pointer;
    margin-top: 15px;
    transition: 0.2s;
}

.select-pdf-btn.standard {
    background: #2563eb;
    color: white;
}

.select-pdf-btn.standard:hover {
    background: #1d4ed8;
}

.select-pdf-btn.premium {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
}

.select-pdf-btn.premium:hover {
    transform: scale(1.05);
}
.expiry-text-btn {
    border-color: #dbeafe;
    color: #3b82f6;
}

.expiry-text-btn:hover {
    background: #dbeafe;
    border-color: #3b82f6;
}

.expiry-text-btn.set {
    background: #dbeafe;
    border-color: #3b82f6;
}

.decrease-text-btn {
    border-color: #fef3c7;
    color: #f59e0b;
}
/* FORCE CLOSE BUTTON TO ALWAYS WORK */
.btn-close {
    position: relative !important;
    z-index: 9999 !important;
    pointer-events: auto !important;
}

.manual-modal-box {
    position: relative;
    z-index: 9998;
}

.decrease-text-btn:hover {
    background: #fef3c7;
    border-color: #f59e0b;
}

.restock-text-btn {
    border-color: #d1fae5;
    color: #10b981;
}

.restock-text-btn:hover {
    background: #d1fae5;
    border-color: #10b981;
}

.remove-text-btn {
    border-color: #fee2e2;
    color: #ef4444;
}

.remove-text-btn:hover {
    background: #fee2e2;
    border-color: #ef4444;
}

.step-btn {
    width: 32px;
    height: 32px;
    border-radius: 10px;
    border: 1px solid #e2e8f0;
    background: white;
    color: #7c3aed;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: 0.2s;
}

.step-btn:hover {
    background: #f5f3ff;
    border-color: #7c3aed;
    transform: translateY(-2px);
}

.remove-btn {
    width: 32px;
    height: 32px;
    border-radius: 10px;
    border: 1px solid #fee2e2;
    background: #fff;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-left: 10px;
    transition: 0.2s;
}

.remove-btn:hover {
    background: #ef4444;
}

.remove-btn:hover svg {
    stroke: white;
}

.expiry-btn {
    width: 32px;
    height: 32px;
    border-radius: 10px;
    border: 1px solid #dbeafe;
    background: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: 0.2s;
}

.expiry-btn:hover {
    background: #dbeafe;
    border-color: #3b82f6;
    transform: translateY(-2px);
}

.expiry-btn.set {
    background: #dbeafe;
    border-color: #3b82f6;
}

/* STATS */
.stats-container {
    display: flex;
    justify-content: space-between;
    gap: 8px;
    margin-bottom: 30px;
    width: 100%;
}

.stat-card {
    background: white;
    padding: 12px 10px;
    border-radius: 20px;
    display: flex;
    align-items: center;
    gap: 8px;
    border: 1px solid #f1f5f9;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
    flex: 1;
    min-width: 0;
    transition: transform 0.3s ease;
    cursor: pointer;
}

.stat-card:hover {
    transform: translateY(-5px);
}

.stat-icon {
    width: 35px;
    height: 35px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.stat-icon svg {
    width: 18px;
    height: 18px;
}

/* Your Exact Colors */
.total-bg { background: #f5f3ff; color: #7c3aed; }
.low-bg { background: #fffbeb; color: #d97706; }
.out-bg { background: #fef2f2; color: #ef4444; }
.expiry-bg { background: #fef3c7; color: #f59e0b; }

.stat-details {
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.stat-label {
    font-size: 9px;
    font-weight: 600;
    color: #64748b;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    white-space: nowrap;
}

.stat-details h3 {
    margin: 0;
    font-size: 16px;
    font-weight: 700;
    color: #1e293b;
}

.stat-sub {
    display: none;
}

/* DESKTOP UPGRADE */
@media (min-width: 768px) {
    .stats-container { gap: 20px; }
    .stat-card { padding: 24px; gap: 16px; }
    .stat-icon { width: 48px; height: 48px; }
    .stat-icon svg { width: 24px; height: 24px; }
    .stat-label { font-size: 13px; }
    .stat-details h3 { font-size: 24px; }
    .stat-sub { display: block; font-size: 11px; color: #94a3b8; font-weight: 500; }
}

.inventory-grid-wrapper {
    background: white;
    border-radius: 24px;
    border: 1px solid #f1f5f9;
    box-shadow: 0 4px 20px rgba(0,0,0,0.03);
    overflow: hidden;
    margin-top: 20px;
}

.grid-header {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 1fr;
    background: #f8fafc;
    padding: 16px 24px;
    border-bottom: 1px solid #f1f5f9;
    color: #64748b;
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    gap: 15px;
}

.grid-header > div:nth-child(2),
.grid-header > div:nth-child(3) {
    text-align: center;
}

.grid-header > div:nth-child(4) {
    text-align: right;
}

.grid-body {
    max-height: 60vh;
    overflow-y: auto;
}

/* Individual Row Styling */
.row {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 1fr;
    align-items: center;
    padding: 18px 24px;
    border-bottom: 1px solid #f8fafc;
    transition: all 0.2s ease;
}

.row:hover {
    background-color: #f5f3ff;
    transform: scale(1.005);
}

.row:last-child { border-bottom: none; }

/* Status Pill Styling */
.status {
    padding: 6px 12px;
    border-radius: 100px;
    font-size: 11px;
    font-weight: 700;
    text-align: center;
    width: fit-content;
}

.status.ok { background: #ecfdf5; color: #10b981; }
.status.low { background: #fffbeb; color: #d97706; }
.status.out { background: #fef2f2; color: #ef4444; }
.status.expiring { background: #fef3c7; color: #f59e0b; }

.expiry-tag {
    padding: 4px 10px;
    border-radius: 100px;
    font-size: 10px;
    font-weight: 700;
    margin-left: 8px;
    display: inline-block;
}

.expiry-tag.warning { 
    background: #fff4ed; 
    color: #f97316;
    animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

/* Mobile Responsiveness */
@media (max-width: 768px) {
    .grid-header { display: none; }
    .row {
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        padding: 20px;
    }
    .col-actions { grid-column: span 2; justify-content: flex-start; }
}

/* TABLE */
.table{background:#fff;border-radius:22px;box-shadow:0 15px 35px rgba(0,0,0,.08);overflow:hidden}
.head,/* Individual Row Styling */
.row {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 1fr;
    align-items: center;
    padding: 18px 24px;
    border-bottom: 1px solid #f8fafc;
    transition: all 0.2s ease;
    gap: 15px;
}

.row > * {
    display: flex;
    align-items: center;
}

.col-main {
    justify-content: flex-start;
}

.col-stat {
    justify-content: center;
    text-align: center;
}

.col-status {
    justify-content: center;
    text-align: center;
}

.col-actions {
    justify-content: flex-end;
}
.head{background:#f1f3f7;font-weight:600}
.row:not(:last-child){border-bottom:1px solid #eee}

/* ADD PRODUCT MODAL & CHOICES */
.choice-menu {
  position: absolute;
  background: white;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.15);
  display: none;
  flex-direction: column;
  z-index: 2000;
  overflow: hidden;
  margin-top: 5px;
}
.choice-menu button {
  background: white !important;
  color: #333 !important;
  border-radius: 0 !important;
  text-align: left;
  padding: 12px 20px !important;
  border-bottom: 1px solid #eee !important;
}
.choice-menu button:hover { background: #f9f9f9 !important; }

.manual-modal-box {
  width: 100%;
  max-width: 450px;
  background: #fff;
  padding: 40px;
  border-radius: 30px;
  position: relative;
}
.manual-modal-box input, .manual-modal-box select {
  width: 100%;
  padding: 14px;
  margin: 10px 0;
  border: 1px solid #ddd;
  border-radius: 12px;
  font-size: 16px;
}
.modal-actions {
  display: flex;
  gap: 10px;
  margin-top: 20px;
}
.btn-save { background: #16a34a !important; flex: 2; }
.btn-close { background: #666 !important; flex: 1; }

/* MODERN MODAL UPDATES */
.modal-box, .manual-modal-box {
    background: #fff;
    border-radius: 28px;
    padding: 35px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    border: 1px solid rgba(255,255,255,0.3);
}

/* CHOICE MODAL BUTTONS */
.choice-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 20px;
}
.choice-card {
    padding: 30px 20px;
    border: 2px solid #f0f0f0;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
}
.choice-card:hover {
    border-color: #2563eb;
    background: #f8faff;
    transform: translateY(-5px);
}
.choice-card i { font-size: 32px; display: block; margin-bottom: 10px; }
.choice-card span { font-weight: 700; color: #333; }

/* BEAUTIFIED FORM INPUTS */
input, select, textarea {
    background: #f9fafb !important;
    border: 1px solid #e5e7eb !important;
    transition: all 0.2s ease;
}
input:focus, select:focus, textarea:focus {
    background: #fff !important;
    border-color: #2563eb !important;
    box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1) !important;
}
.report-modal-content {
    background: white;
    padding: 40px;
    border-radius: 24px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 25px 50px rgba(0,0,0,0.3);
}

.report-modal-content h2 {
    margin: 0 0 10px 0;
    font-size: 26px;
    font-weight: 800;
    color: #1e293b;
    display: flex;
    align-items: center;
    gap: 12px;
}

.report-modal-content p {
    color: #64748b;
    font-size: 14px;
    margin-bottom: 25px;
}

.report-input-group {
    margin-bottom: 20px;
}

.report-input-group label {
    display: block;
    font-weight: 600;
    font-size: 13px;
    color: #475569;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.report-input-group input {
    width: 100%;
    padding: 14px 18px;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    font-size: 15px;
    transition: all 0.2s;
}

.report-input-group input:focus {
    border-color: #059669;
    box-shadow: 0 0 0 4px rgba(5, 150, 105, 0.1);
}

.report-input-group input:disabled {
    background: #f1f5f9;
    color: #64748b;
}

.report-actions {
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: 12px;
    margin-top: 30px;
}

.btn-generate-report {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
    color: white;
    border: none;
    padding: 15px;
    border-radius: 12px;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: 0.3s;
}

.btn-generate-report:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(5, 150, 105, 0.3);
}

.btn-cancel-report {
    background: #f1f5f9;
    color: #64748b;
    border: none;
    padding: 15px;
    border-radius: 12px;
    font-weight: 700;
    cursor: pointer;
}
/* BUTTON STYLES */
.btn-save, .btn-import { 
    background: #000 !important; 
    color: white !important; 
    border-radius: 14px !important;
    height: 50px;
    font-size: 16px;
}
.btn-close { 
    background: #f3f4f6 !important; 
    color: #4b5563 !important; 
    border-radius: 14px !important;
    height: 50px;
}
.btn-save:hover { opacity: 0.9; }

/* BULK ADD MODAL STYLES */
.bulk-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin: 20px 0;
}
.bulk-box {
  display: flex;
  flex-direction: column;
  text-align: left;
}
.bulk-box label {
  font-weight: 600;
  font-size: 14px;
  margin-bottom: 8px;
  color: #444;
}
.bulk-box textarea {
  width: 100%;
  height: 200px;
  padding: 15px;
  border-radius: 15px;
  border: 1px solid #ddd;
  resize: none;
  font-size: 14px;
  background: #fcfcfc;
}
.bulk-box textarea:focus {
  outline: 2px solid #2563eb;
  border-color: transparent;
}

/* VOICE MODAL & ANIMATION */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:1000;backdrop-filter:blur(8px)}
.modal-box{width:400px;background:#fff;padding:30px;border-radius:30px;text-align:center;box-shadow:0 20px 50px rgba(0,0,0,0.3)}

.ai-visualizer {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 5px;
  height: 60px;
  margin: 20px 0;
}
.bar {
  width: 6px;
  height: 10px;
  background: #2563eb;
  border-radius: 10px;
  animation: bounce 1s ease-in-out infinite;
}
.bar:nth-child(2) { animation-delay: 0.1s; background: #3b82f6; }
.bar:nth-child(3) { animation-delay: 0.2s; background: #60a5fa; }
.bar:nth-child(4) { animation-delay: 0.3s; background: #2563eb; }
.bar:nth-child(5) { animation-delay: 0.4s; background: #3b82f6; }

.confirm-mode .bar { background: #ef4444 !important; animation-duration: 0.4s; }

@keyframes bounce {
  0%, 100% { height: 10px; }
  50% { height: 50px; }
}

.back-nav-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 38px;
    height: 38px;
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    color: #1e293b;
    text-decoration: none;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.back-nav-btn:hover {
    background: #f5f3ff;
    border-color: #7c3aed;
    color: #7c3aed;
    transform: translateX(-3px);
}

.top h2 {
    margin: 0;
    font-size: 26px;
    font-weight: 800;
    color: #1e293b;
}

.btn-pic { background: #8b5cf6; color: white; border: none; padding: 10px 18px; border-radius: 12px; font-weight: 600; cursor: pointer; }
.btn-primary { background: #1e293b; color: white; border: none; padding: 10px 18px; border-radius: 12px; font-weight: 600; cursor: pointer; }
.btn-standard { background: white; border: 1px solid #e2e8f0; padding: 10px 18px; border-radius: 12px; font-weight: 600; cursor: pointer; }

.custom-modal {
    position: fixed; inset: 0;
    background: rgba(15, 23, 42, 0.4);
    backdrop-filter: blur(8px);
    display: none; justify-content: center; align-items: center;
    z-index: 2000;
}
.modal-content {
    background: white; padding: 30px; border-radius: 28px;
    width: 90%; max-width: 350px; text-align: center;
    box-shadow: 0 20px 40px rgba(0,0,0,0.2);
}
.modal-content h3 { margin: 0; font-size: 20px; font-weight: 700; }
.modal-content p { color: #64748b; font-size: 14px; margin: 8px 0 20px; }
.modal-content input {
    width: 100%; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0;
    font-size: 18px; text-align: center; font-weight: 700; outline: none;
}
.modal-content input:focus { border-color: #7c3aed; box-shadow: 0 0 0 4px rgba(124, 58, 237, 0.1); }
.modal-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px; }
.btn-cancel { padding: 12px; border: none; border-radius: 12px; background: #f1f5f9; color: #64748b; font-weight: 600; cursor: pointer; }
.btn-confirm { padding: 12px; border: none; border-radius: 12px; background: #7c3aed; color: white; font-weight: 600; cursor: pointer; }

/* SUCCESS POPUP */
.success-popup {
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%);
  background: #16a34a;
  color: white;
  padding: 12px 25px;
  border-radius: 50px;
  font-weight: 600;
  display: none;
  z-index: 3000;
  box-shadow: 0 10px 20px rgba(0,0,0,0.2);
  animation: slideUp 0.3s ease;
}
@keyframes slideUp { from { bottom: -50px; opacity: 0; } to { bottom: 30px; opacity: 1; } }

/* BULK EXPIRY TABLE */
.bulk-expiry-table {
    width: 100%;
    max-height: 400px;
    overflow-y: auto;
    margin: 20px 0;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
}

.bulk-expiry-table table {
    width: 100%;
    border-collapse: collapse;
}

.bulk-expiry-table th {
    background: #f8fafc;
    padding: 12px;
    text-align: left;
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    color: #64748b;
    position: sticky;
    top: 0;
    z-index: 10;
}

.bulk-expiry-table td {
    padding: 12px;
    border-bottom: 1px solid #f1f5f9;
}

.bulk-expiry-table input[type="date"] {
    width: 100%;
    padding: 8px;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    font-size: 14px;
}
.master-select-container {
    background: #f8fafc;
    padding: 15px;
    border-radius: 12px;
    margin-bottom: 20px;
    border: 2px dashed #cbd5e1;
    display: none;
}

.master-select-container.active {
    display: block;
    border-color: #3b82f6;
    background: #eff6ff;
}

.master-select-row {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 10px;
}

.master-select-row input[type="date"] {
    flex: 1;
    padding: 12px;
    border: 2px solid #cbd5e1;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 600;
}

.master-select-row button {
    padding: 12px 24px;
    background: #3b82f6;
    color: white;
    border: none;
    border-radius: 10px;
    font-weight: 700;
    cursor: pointer;
    transition: 0.2s;
}

.master-select-row button:hover {
    background: #2563eb;
    transform: scale(1.05);
}

.master-toggle-btn {
    padding: 10px 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 10px;
    font-weight: 700;
    cursor: pointer;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: 0.3s;
}

.master-toggle-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 8px 16px rgba(102, 126, 234, 0.4);
}

.master-toggle-btn.active {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
}

.selectable-row {
    cursor: pointer;
    transition: background 0.2s;
}

.selectable-row.selected {
    background: #eff6ff !important;
    border-left: 4px solid #3b82f6;
}

.select-checkbox {
    width: 20px;
    height: 20px;
    cursor: pointer;
    accent-color: #3b82f6;
}

.expiry-tag.expired {
    background: #fee2e2;
    color: #dc2626;
    animation: none;
    font-weight: 800;
}

.date-saved {
    background: #d1fae5 !important;
    pointer-events: none;
    opacity: 0.7;
}

.date-saved input {
    background: #d1fae5 !important;
    border-color: #10b981 !important;
    color: #065f46 !important;
    font-weight: 700;
}
#scanner{position:relative;width:100%;height:240px;background:#000;border-radius:14px;overflow:hidden}
.flash{position:fixed;inset:0;background:rgba(34,197,94,.25);pointer-events:none;z-index:3000;opacity:0;transition:.15s}
.flash.show{opacity:1}

@media (max-width: 768px) {
    .manual-modal-box {
        padding: 25px;
        max-width: 95% !important;
    }
    
    .bulk-expiry-table {
        font-size: 12px;
    }
    
    .bulk-expiry-table th,
    .bulk-expiry-table td {
        padding: 8px;
    }
}
</style>
</head>

<body>

<audio id="beep-ok" preload src="https://assets.mixkit.co/sfx/preview/mixkit-beep-tone-2864.mp3"></audio>
<div id="flash" class="flash"></div>
<div id="successPopup" class="success-popup">Product Updated</div>

<div class="top">
  <div style="display: flex; align-items: center; gap: 15px;">
    <a href="mainbusinesshub.html" class="back-nav-btn">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
    </a>
    <h2>Inventory</h2>
  </div>

  <div class="actions">
    <button style="background:#059669" onclick="openReportModal()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:inline-block; vertical-align:middle; margin-right:5px">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/>
        </svg>
        Product Report
    </button>
    <button style="background:#8b5cf6" onclick="window.location.href='picture.html'">üì∏ PIC (AI Scan)</button>
    <button onclick="openScanner()">üì∑ Scanner</button>
    <div style="position:relative; display:inline-block;">
        <button onclick="toggleAddMenu()">‚ûï Add Product</button>
        <div id="addMenu" class="choice-menu">
            <button onclick="openManualAdd()">üìù Manual Add</button>
            <button onclick="openBulkAdd()">üì¶ Bulk Add</button>
        </div>
    </div>
    <button style="background:#f59e0b" onclick="openBulkExpiryModal()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:inline-block; vertical-align:middle; margin-right:5px">
            <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
        </svg>
        Add Expiry Dates
    </button>
    <button style="background:#2563eb" onclick="startVoiceAssistant()">üéôÔ∏è AI Voice</button>
  </div>
</div>

<div class="search-container">
  <input type="text" id="searchInput" placeholder="Search inventory..." onkeyup="render()">
</div>

<div class="stats-container">
  <div class="stat-card">
    <div class="stat-icon total-bg">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
    </div>
    <div class="stat-details">
      <span class="stat-label">Total Stock</span>
      <h3 id="total">0</h3>
      <span class="stat-sub">Active Products</span>
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-icon low-bg">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
    </div>
    <div class="stat-details">
      <span class="stat-label">Low Stock</span>
      <h3 id="low" class="text-warning">0</h3>
      <span class="stat-sub">Needs Attention</span>
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-icon out-bg">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
    </div>
    <div class="stat-details">
      <span class="stat-label">Out of Stock</span>
      <h3 id="out" class="text-danger">0</h3>
      <span class="stat-sub">Need Restock</span>
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-icon expiry-bg">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
      </svg>
    </div>
    <div class="stat-details">
      <span class="stat-label">About to Expire</span>
      <h3 id="expiring" class="text-warning">0</h3>
      <span class="stat-sub">Urgent Action</span>
    </div>
  </div>
</div>

<div id="qtyModal" class="custom-modal">
    <div class="modal-content">
        <h3 id="qtyTitle">Adjust Stock</h3>
        <p id="qtySubtitle">Enter amount to update inventory</p>
        <input type="number" id="qtyInput" placeholder="0" autofocus>
        <div class="modal-actions">
            <button class="btn-cancel" onclick="closeQtyModal()">Cancel</button>
            <button class="btn-confirm" id="confirmQtyBtn">Update Stock</button>
        </div>
    </div>
</div>

<!-- EXPIRY DATE MODAL -->
<div id="expiryModal" class="custom-modal">
    <div class="modal-content" style="max-width: 400px;">
        <div style="text-align: center; margin-bottom: 20px;">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2" style="display: inline-block;">
                <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
            </svg>
        </div>
        <h3 id="expiryTitle">Set Expiry Date</h3>
        <p id="expirySubtitle" style="margin-bottom: 20px;">Product: <strong id="expiryProductName"></strong></p>
        <input type="date" id="expiryDateInput" style="width: 100%; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0; font-size: 16px; margin-bottom: 15px;">
        <div class="modal-actions">
            <button class="btn-cancel" onclick="closeExpiryModal()">Cancel</button>
            <button class="btn-confirm" onclick="saveExpiryDate()">Save Date</button>
        </div>
    </div>
</div>

<!-- NOTIFICATION PREFERENCE MODAL -->
<div id="notificationModal" class="custom-modal">
    <div class="modal-content" style="max-width: 450px;">
        <div style="text-align: center; margin-bottom: 20px;">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2" style="display: inline-block;">
                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/>
            </svg>
        </div>
        <h3>Expiry Notification Settings</h3>
        <p style="margin-bottom: 20px;">How many days before expiry would you like to be notified?</p>
        <input type="number" id="notificationDaysInput" placeholder="Enter days (e.g., 3)" min="1" max="30" style="width: 100%; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0; font-size: 18px; text-align: center; margin-bottom: 15px;">
        <div class="modal-actions">
            <button class="btn-cancel" onclick="closeNotificationModal()">Cancel</button>
            <button class="btn-confirm" onclick="saveNotificationPreference()">Save Settings</button>
        </div>
    </div>
</div>

<!-- BULK EXPIRY DATES MODAL -->
<div id="bulkExpiryModal" class="modal">
    <div class="manual-modal-box" style="max-width: 800px;">
        <h2 style="margin-top:0; display: flex; align-items: center; gap: 10px;">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2">
                <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
            </svg>
            Bulk Add Expiry Dates
        </h2>
        <p style="font-size: 13px; color: #666; margin-bottom: 15px;">Set expiry dates for products that don't have one yet</p>
        
        <!-- MASTER SELECT TOGGLE BUTTON -->
        <button class="master-toggle-btn" id="masterToggleBtn" onclick="toggleMasterSelect()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
            </svg>
            <span id="masterToggleText">Enable Master Select</span>
        </button>
        
        <!-- MASTER SELECT FEATURE -->
        <div class="master-select-container" id="masterSelectContainer">
            <div class="master-select-row">
                <input type="date" id="masterExpiryDate" placeholder="Select common expiry date">
                <button onclick="applyMasterExpiry()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:inline-block; vertical-align:middle; margin-right:5px">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                    Set Dates to Selected
                </button>
            </div>
            <p style="font-size: 11px; color: #64748b; margin: 5px 0 0 0;">
                ‚úì Select products below ‚Üí Pick a date ‚Üí Click "Set Dates to Selected"
            </p>
        </div>
        
        <div class="bulk-expiry-table" id="bulkExpiryTableContainer">
            <table>
                <thead>
                    <tr>
                        <th style="width: 40px;" id="checkboxHeader">
                            <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()" class="select-checkbox" style="display:none;">
                        </th>
                        <th>Product Name</th>
                        <th>Current Stock</th>
                        <th>Expiry Date</th>
                    </tr>
                </thead>
                <tbody id="bulkExpiryTableBody">
                </tbody>
            </table>
        </div>
        
        <div class="modal-actions" style="margin-top: 20px;">
            <button class="btn-save" onclick="saveBulkExpiryDates()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:inline-block; vertical-align:middle; margin-right:5px">
                    <polyline points="20 6 9 17 4 12"/>
                </svg>
                Save Expiry Dates
            </button>
            <button class="btn-close" onclick="closeBulkExpiryModal()">Close</button>
        </div>
    </div>
</div>

<!-- PRODUCT REPORT MODAL -->
<div id="reportModal" class="custom-modal">
    <div class="report-modal-content">
        <h2>
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#059669" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>
            </svg>
            Generate Product Report
        </h2>
        <p>Fill in the details below to create a professional PDF report</p>
        
        <div class="report-input-group">
            <label>Business Name</label>
            <input type="text" id="reportBusinessName" placeholder="Enter your business name">
        </div>
        
        <div class="report-input-group">
            <label>Full Name</label>
            <input type="text" id="reportFullName" placeholder="Enter your full name">
        </div>
        
        <div class="report-input-group">
            <label>Report Date</label>
            <input type="date" id="reportDate" disabled>
        </div>
        
        <div class="report-actions">
            <button class="btn-cancel-report" onclick="closeReportModal()">Cancel</button>
            <button class="btn-generate-report" onclick="showPDFTypeModal()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                Generate PDF Report
            </button>
        </div>
    </div>
</div>

<!-- PDF TYPE SELECTION MODAL -->
<div id="pdfTypeModal" class="custom-modal" style="z-index: 3000;">
    <div class="report-modal-content" style="max-width: 600px;">
        <h2 style="margin-bottom: 15px;">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#7c3aed" stroke-width="2" style="display: inline-block; vertical-align: middle;">
                <rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/>
            </svg>
            Choose Report Type
        </h2>
        <p style="margin-bottom: 30px;">Select the PDF format that suits your needs</p>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <!-- Standard PDF Card -->
            <div class="pdf-type-card" onclick="generatePDF('standard')">
                <div class="pdf-type-icon" style="background: #dbeafe; color: #2563eb;">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>
                    </svg>
                </div>
                <h3>Standard Report</h3>
                <p>Clean, simple layout with essential information</p>
                <ul>
                    <li>Quick generation</li>
                    <li>Compact format</li>
                    <li>Basic styling</li>
                    <li>Perfect for daily use</li>
                </ul>
                <button class="select-pdf-btn standard">Select Standard</button>
            </div>
            
            <!-- Premium PDF Card -->
            <div class="pdf-type-card premium" onclick="generatePDF('premium')">
                <div class="pdf-type-icon" style="background: #fef3c7; color: #d97706;">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                    </svg>
                </div>
                <h3>Premium Report</h3>
                <p>Stunning design with detailed insights and analytics</p>
                <ul>
                    <li>Beautiful cover page</li>
                    <li>Detailed statistics</li>
                    <li>Color-coded tables</li>
                    <li>Business insights</li>
                </ul>
                <button class="select-pdf-btn premium">Select Premium</button>
            </div>
        </div>
        
        <button class="btn-cancel-report" onclick="closePDFTypeModal()" style="width: 100%; margin-top: 20px;">
            Cancel
        </button>
    </div>
</div>
<div class="inventory-grid-wrapper">
    <div class="grid-header">
        <div class="col-main">Product Identity</div>
        <div class="col-stat">Stock Level</div>
        <div class="col-status">Status</div>
        <div class="col-actions">Control</div>
    </div>
    <div id="products" class="grid-body"></div>
</div>

<div id="bulkModal" class="modal">
  <div class="manual-modal-box" style="max-width: 700px;"> <h2 style="margin-top:0">Bulk Add Products</h2>
    <p style="font-size: 13px; color: #666;">Separate items with commas. Ensure the number of names matches the number of quantities.</p>
    
    <div class="bulk-grid">
      <div class="bulk-box">
        <label>Product Names</label>
        <textarea id="b_names" placeholder="Apple, Milk, Bread..."></textarea>
      </div>
      <div class="bulk-box">
        <label>Quantities & Units</label>
        <textarea id="b_qtys" placeholder="10kg, 5, 2 packets..."></textarea>
      </div>
    </div>
    
    <div class="modal-actions">
      <button class="btn-save" onclick="saveBulkProducts()">üöÄ Import All</button>
      <button class="btn-close" onclick="closeBulkAdd()">Close</button>
    </div>
  </div>
</div>

<div id="voiceModal" class="modal">
  <div class="modal-box">
    <h2 style="margin-top:0">AI Voice Assistant</h2>
    <p style="color:#666; font-size:14px">Just speak the product name and quantity.<br>I will add, increase, or decrease it for you.</p>
    
    <div id="viz" class="ai-visualizer">
      <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
    </div>
    
    <div id="speechOutput" style="font-style:italic; color:#2563eb; margin-bottom:20px; min-height:24px">Waiting for you to speak...</div>
    
    <button onclick="stopVoiceAssistant()" style="background:#ef4444">Close Assistant</button>
  </div>
</div>

<div id="manualModal" class="modal">
  <div class="manual-modal-box">
    <h2 style="margin-top:0">Add New Product</h2>
    <input type="text" id="m_name" placeholder="Product Name (e.g. Apple)">
    <input type="number" id="m_qty" placeholder="Quantity (e.g. 50)">
    <select id="m_unit">
        <option value="pcs">Pieces (pcs)</option>
        <option value="kg">Kilograms (kg)</option>
        <option value="gram">Grams (g)</option>
        <option value="liter">Liters (L)</option>
        <option value="packets">Packets</option>
    </select>
    
    <div class="modal-actions">
        <button class="btn-save" onclick="saveManualProduct()">Save Product</button>
        <button class="btn-close" onclick="closeManualAdd()">Close</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyD6PdrKp2XLfRqjC587lMpdKTaWD4MBens",
  authDomain: "scalevest-163a0.firebaseapp.com",
  databaseURL: "https://scalevest-163a0-default-rtdb.firebaseio.com",
  projectId: "scalevest-163a0"
});

const auth = firebase.auth(), db = firebase.database();
let inventory = {}, prices = {}, invRef = null, recognition, isAssistantActive = false;
let pendingAction = null;
let currentUserId = null;
let notificationDays = 5; // Default notification days
let currentExpiryProductId = null;

auth.onAuthStateChanged(u => {
  if (!u) { console.log("User not logged in"); return; }
  
  currentUserId = u.uid;
  
  // 1. Inventory Reference
  invRef = db.ref(`Businesses/${u.uid}/inventory`);
  invRef.on("value", s => { 
    inventory = s.val() || {}; 
    render(); 
  });

  // 2. Prices Reference
  db.ref(`Businesses/${u.uid}/prices`).on("value", s => {
    prices = s.val() || {};
  });

  // 3. Load notification preference
  db.ref(`BusinessOwners/${u.uid}/expiryDateNotification`).once("value", s => {
    if (s.exists()) {
      notificationDays = s.val();
    }
  });
  // 4. INITIALIZE ANALYTICS NODES
  const analyticsRef = db.ref(`Businesses/${u.uid}/analytics`);
  analyticsRef.once("value", s => {
    if (!s.exists()) {
      analyticsRef.set({
        mostSelling: {},
        leastSelling: {},
        trendingSelling: {}
      });
    }
  });
  
  // 5. AUTO-UPDATE TRENDING (Remove products older than 7 days)
  setInterval(() => updateTrendingProducts(), 3600000); // Every hour
});


// PRODUCT ANALYTICS SYSTEM
// PRODUCT ANALYTICS SYSTEM - FIXED CALCULATION
// PRODUCT ANALYTICS SYSTEM - ONLY ACTIVE PRODUCTS
// PRODUCT ANALYTICS SYSTEM - NO DUPLICATE PRODUCTS
function updateProductAnalytics(productId, productName, quantitySold) {
    if (!currentUserId) {
        console.error("User not authenticated");
        return;
    }
    
    console.log(`üìä Updating analytics after selling ${quantitySold} ${productName}`);
    
    const analyticsRef = db.ref(`Businesses/${currentUserId}/analytics`);
    const salesRef = db.ref(`Businesses/${currentUserId}/sales`);
    const timestamp = Date.now();
    const weekAgo = timestamp - (7 * 24 * 60 * 60 * 1000);
    
    // Get ALL sales data
    salesRef.once('value', salesSnapshot => {
        const sales = salesSnapshot.val() || {};
        
        if (Object.keys(sales).length === 0) {
            console.log("No sales data found");
            return;
        }
        
        // Get current inventory product IDs
        const activeProductIds = new Set(Object.keys(inventory));
        console.log("üîç Active Products:", activeProductIds);
        
        // Calculate TOTAL sales per product (all time) - ONLY ACTIVE PRODUCTS
        const totalSalesPerProduct = {};
        
        // Calculate RECENT sales per product (last 7 days) - ONLY ACTIVE PRODUCTS
        const recentSalesPerProduct = {};
        
        Object.entries(sales).forEach(([saleId, sale]) => {
            const pid = sale.productId;
            const pname = sale.productName;
            const qty = sale.quantity || 0;
            const saleTime = sale.timestamp || 0;
            
            // Only count sales for products that still exist
            if (!activeProductIds.has(pid)) {
                console.log(`‚ö†Ô∏è Skipping deleted product: ${pname} (${pid})`);
                return;
            }
            
            // TOTAL SALES (All Time)
            if (!totalSalesPerProduct[pid]) {
                totalSalesPerProduct[pid] = {
                    name: pname,
                    totalSold: 0
                };
            }
            totalSalesPerProduct[pid].totalSold += qty;
            
            // RECENT SALES (Last 7 Days)
            if (saleTime >= weekAgo) {
                if (!recentSalesPerProduct[pid]) {
                    recentSalesPerProduct[pid] = {
                        name: pname,
                        recentSold: 0,
                        firstSaleDate: saleTime
                    };
                }
                recentSalesPerProduct[pid].recentSold += qty;
                recentSalesPerProduct[pid].firstSaleDate = Math.min(
                    recentSalesPerProduct[pid].firstSaleDate,
                    saleTime
                );
            }
        });
        
        console.log("üìà Total Sales (Active Products Only):", totalSalesPerProduct);
        console.log("üî• Recent Sales (7 days, Active Products Only):", recentSalesPerProduct);
        
        // Convert to arrays for finding max/min
        const totalSalesArray = Object.entries(totalSalesPerProduct).map(([id, data]) => ({
            productId: id,
            ...data
        }));
        
        const recentSalesArray = Object.entries(recentSalesPerProduct).map(([id, data]) => ({
            productId: id,
            ...data
        }));
        
        // ‚úÖ CRITICAL FIX: Only show analytics if there are 2+ products with sales
        if (totalSalesArray.length < 2) {
            console.log("‚ö†Ô∏è Not enough products with sales data (need at least 2)");
            
            // If only 1 product, show it ONLY in Most Selling
            if (totalSalesArray.length === 1) {
                const onlyProduct = totalSalesArray[0];
                
                analyticsRef.child('mostSelling').set({
                    productId: onlyProduct.productId,
                    name: onlyProduct.name,
                    totalSold: onlyProduct.totalSold,
                    lastUpdated: timestamp
                });
                
                // Remove least selling and trending (no point showing same product)
                analyticsRef.child('leastSelling').remove();
                analyticsRef.child('trendingSelling').remove();
                
                console.log("‚úÖ Only 1 product - showing in Most Selling only");
            } else {
                // No products with sales
                analyticsRef.child('mostSelling').remove();
                analyticsRef.child('leastSelling').remove();
                analyticsRef.child('trendingSelling').remove();
            }
            
            return;
        }
        
        // 1. MOST SELLING - Highest TOTAL sales (all time)
        const mostSelling = totalSalesArray.reduce((max, current) => 
            current.totalSold > max.totalSold ? current : max
        );
        
        console.log("ü•á Most Selling:", mostSelling);
        
        analyticsRef.child('mostSelling').set({
            productId: mostSelling.productId,
            name: mostSelling.name,
            totalSold: mostSelling.totalSold,
            lastUpdated: timestamp
        });
        
        // 2. LEAST SELLING - Lowest TOTAL sales (all time)
        // ‚úÖ FIX: Make sure it's DIFFERENT from most selling
        const leastSelling = totalSalesArray
            .filter(p => p.productId !== mostSelling.productId) // Exclude most selling
            .reduce((min, current) => 
                !min || current.totalSold < min.totalSold ? current : min
            , null);
        
        if (leastSelling) {
            console.log("ü•â Least Selling:", leastSelling);
            
            analyticsRef.child('leastSelling').set({
                productId: leastSelling.productId,
                name: leastSelling.name,
                totalSold: leastSelling.totalSold,
                lastUpdated: timestamp
            });
        } else {
            console.log("‚ö†Ô∏è No product qualifies for Least Selling");
            analyticsRef.child('leastSelling').remove();
        }
        
        // 3. TRENDING - Most sales in LAST 7 DAYS
        // ‚úÖ FIX: Different from most and least selling
        if (recentSalesArray.length > 0) {
            const trending = recentSalesArray
                .filter(p => 
                    p.productId !== mostSelling.productId && 
                    (!leastSelling || p.productId !== leastSelling.productId)
                )
                .reduce((max, current) => 
                    !max || current.recentSold > max.recentSold ? current : max
                , null);
            
            if (trending) {
                console.log("üî• Trending (Last 7 Days):", trending);
                
                analyticsRef.child('trendingSelling').set({
                    productId: trending.productId,
                    name: trending.name,
                    recentSold: trending.recentSold,
                    firstSaleDate: trending.firstSaleDate,
                    lastUpdated: timestamp
                });
            } else {
                // All recent sales are from most/least selling products
                console.log("‚ö†Ô∏è No unique product for trending");
                analyticsRef.child('trendingSelling').remove();
            }
        } else {
            console.log("‚ö†Ô∏è No sales in last 7 days - clearing trending");
            analyticsRef.child('trendingSelling').remove();
        }
        
        console.log("‚úÖ Analytics updated successfully!");
    }).catch(error => {
        console.error("‚ùå Error updating analytics:", error);
    });
}
function sortAnalytics() {
    // This function is no longer needed but kept for compatibility
    console.log("sortAnalytics() called - analytics are updated in real-time");
}

function updateTrendingProducts() {
    if (!currentUserId) return;
    
    const timestamp = Date.now();
    const weekAgo = timestamp - (7 * 24 * 60 * 60 * 1000);
    const analyticsRef = db.ref(`Businesses/${currentUserId}/analytics/trendingSelling`);
    
    analyticsRef.once('value', snapshot => {
        const trending = snapshot.val();
        
        if (trending && trending.firstSaleDate && trending.firstSaleDate < weekAgo) {
            console.log("üßπ Clearing outdated trending product (older than 7 days)");
            analyticsRef.remove();
        }
    });
}
// --- EXPIRY DATE FUNCTIONS ---
function openExpiryModal(productId, productName) {
    currentExpiryProductId = productId;
    document.getElementById("expiryProductName").textContent = productName;
    
    // Check if expiry date already exists
    const product = inventory[productId];
    if (product && product.expiryDate) {
        document.getElementById("expiryDateInput").value = product.expiryDate;
    } else {
        document.getElementById("expiryDateInput").value = "";
    }
    
    document.getElementById("expiryModal").style.display = "flex";
    setTimeout(() => document.getElementById("expiryDateInput").focus(), 100);
}

function closeExpiryModal() {
    document.getElementById("expiryModal").style.display = "none";
    currentExpiryProductId = null;
}

function saveExpiryDate() {
    const expiryDate = document.getElementById("expiryDateInput").value;
    
    if (!expiryDate) {
        alert("Please select an expiry date");
        return;
    }
    
    const product = inventory[currentExpiryProductId];
    
    // Save expiry date to inventory
    invRef.child(currentExpiryProductId).update({
        expiryDate: expiryDate
    }).then(() => {
        closeExpiryModal();
        
        // Check if this is the first expiry date being set
        checkAndPromptNotificationSettings();
        
        triggerSuccess(`Expiry date set for ${product.name}`);
    }).catch(err => {
        alert("Error saving expiry date: " + err.message);
    });
}

function checkAndPromptNotificationSettings() {
    // Check if notification preference already exists
    db.ref(`BusinessOwners/${currentUserId}/expiryDateNotification`).once("value", s => {
        if (!s.exists()) {
            // First time setting expiry date, prompt for notification preference
            setTimeout(() => {
                document.getElementById("notificationModal").style.display = "flex";
                document.getElementById("notificationDaysInput").value = "5";
            }, 500);
        }
    });
}

function closeNotificationModal() {
    document.getElementById("notificationModal").style.display = "none";
}

function saveNotificationPreference() {
    const days = parseInt(document.getElementById("notificationDaysInput").value);
    
    if (!days || days < 1 || days > 30) {
        alert("Please enter a valid number of days (1-30)");
        return;
    }
    
    db.ref(`BusinessOwners/${currentUserId}/expiryDateNotification`).set(days).then(() => {
        notificationDays = days;
        closeNotificationModal();
        triggerSuccess(`Notification set for ${days} days before expiry`);
        render(); // Re-render to update expiring count
    }).catch(err => {
        alert("Error saving notification preference: " + err.message);
    });
}

// --- BULK EXPIRY DATES ---
let masterSelectMode = false;
let savedProductDates = new Set(); // Track products with saved dates

function openBulkExpiryModal() {
    const tbody = document.getElementById("bulkExpiryTableBody");
    tbody.innerHTML = "";
    masterSelectMode = false;
    savedProductDates.clear();
    
    document.getElementById("masterSelectContainer").classList.remove("active");
    document.getElementById("masterToggleBtn").classList.remove("active");
    document.getElementById("masterToggleText").textContent = "Enable Master Select";
    document.getElementById("selectAllCheckbox").style.display = "none";
    
    // Get products without expiry dates
    const productsWithoutExpiry = Object.entries(inventory).filter(([_, p]) => !p.expiryDate);
    
    if (productsWithoutExpiry.length === 0) {
        alert("All products already have expiry dates set!");
        return;
    }
    
    productsWithoutExpiry.forEach(([id, product]) => {
        const row = document.createElement("tr");
        row.className = "selectable-row";
        row.setAttribute("data-product-id", id);
        row.innerHTML = `
            <td style="text-align: center;">
                <input type="checkbox" class="select-checkbox product-checkbox" data-product-id="${id}" style="display:none;">
            </td>
            <td style="font-weight: 600;">${product.name}</td>
            <td style="color: #64748b;">${product.quantity} ${product.unit}</td>
            <td>
                <input type="date" class="bulk-expiry-input" data-product-id="${id}" />
            </td>
        `;
        
        tbody.appendChild(row);
    });
    
    document.getElementById("bulkExpiryModal").style.display = "flex";
}
function toggleMasterSelect() {
    masterSelectMode = !masterSelectMode;
    const container = document.getElementById("masterSelectContainer");
    const btn = document.getElementById("masterToggleBtn");
    const checkboxes = document.querySelectorAll(".product-checkbox");
    const selectAll = document.getElementById("selectAllCheckbox");
    
    if (masterSelectMode) {
        container.classList.add("active");
        btn.classList.add("active");
        document.getElementById("masterToggleText").textContent = "Disable Master Select";
        selectAll.style.display = "block";
        checkboxes.forEach(cb => cb.style.display = "block");
    } else {
        container.classList.remove("active");
        btn.classList.remove("active");
        document.getElementById("masterToggleText").textContent = "Enable Master Select";
        selectAll.style.display = "none";
        selectAll.checked = false;
        checkboxes.forEach(cb => {
            cb.style.display = "none";
            cb.checked = false;
        });
        document.querySelectorAll(".selectable-row").forEach(row => row.classList.remove("selected"));
    }
}

function toggleSelectAll() {
    const selectAll = document.getElementById("selectAllCheckbox");
    const checkboxes = document.querySelectorAll(".product-checkbox");
    
    checkboxes.forEach(checkbox => {
        // Only select rows that haven't been saved
        const productId = checkbox.getAttribute("data-product-id");
        if (!savedProductDates.has(productId)) {
            checkbox.checked = selectAll.checked;
            const row = checkbox.closest('.selectable-row');
            row.classList.toggle('selected', selectAll.checked);
        }
    });
}

function applyMasterExpiry() {
    const masterDate = document.getElementById("masterExpiryDate").value;
    
    if (!masterDate) {
        alert("Please select a date first");
        return;
    }
    
    const selectedCheckboxes = Array.from(document.querySelectorAll(".product-checkbox:checked"))
        .filter(cb => !savedProductDates.has(cb.getAttribute("data-product-id")));
    
    if (selectedCheckboxes.length === 0) {
        alert("Please select at least one product");
        return;
    }
    
    // Save to Firebase immediately
    const updates = {};
    selectedCheckboxes.forEach(checkbox => {
        const productId = checkbox.getAttribute("data-product-id");
        updates[productId] = { expiryDate: masterDate };
        savedProductDates.add(productId);
        
        // Update UI
        const row = checkbox.closest('tr');
        row.classList.add('date-saved');
        const dateInput = row.querySelector('.bulk-expiry-input');
        dateInput.value = masterDate;
        dateInput.disabled = true;
        checkbox.disabled = true;
        checkbox.checked = false;
        row.classList.remove('selected');
    });
    
    // Batch update Firebase
    const updatePromises = Object.entries(updates).map(([id, data]) => {
        return invRef.child(id).update(data);
    });
    
    Promise.all(updatePromises).then(() => {
        triggerSuccess(`‚úì Saved ${selectedCheckboxes.length} expiry dates`);
        document.getElementById("masterExpiryDate").value = "";
        checkAndPromptNotificationSettings();
    }).catch(err => {
        alert("Error saving expiry dates: " + err.message);
    });
}
function closeBulkExpiryModal() {
    document.getElementById("bulkExpiryModal").style.display = "none";
}

function saveBulkExpiryDates() {
    const inputs = document.querySelectorAll(".bulk-expiry-input:not(:disabled)");
    let updateCount = 0;
    let updates = {};
    
    inputs.forEach(input => {
        const productId = input.getAttribute("data-product-id");
        const expiryDate = input.value;
        
        // Only save if date is set and not already saved
        if (expiryDate && !savedProductDates.has(productId)) {
            updates[productId] = { expiryDate: expiryDate };
            updateCount++;
        }
    });
    
    if (updateCount === 0) {
        alert("All dates have been saved already, or no new dates entered");
        return;
    }
    
    // Batch update
    const updatePromises = Object.entries(updates).map(([id, data]) => {
        return invRef.child(id).update(data);
    });
    
    Promise.all(updatePromises).then(() => {
        closeBulkExpiryModal();
        triggerSuccess(`‚úì Saved ${updateCount} remaining expiry dates`);
        checkAndPromptNotificationSettings();
    }).catch(err => {
        alert("Error saving expiry dates: " + err.message);
    });
}
// --- CALCULATE DAYS UNTIL EXPIRY ---
function getDaysUntilExpiry(expiryDate) {
    if (!expiryDate) return null;
    
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const expiry = new Date(expiryDate);
    expiry.setHours(0, 0, 0, 0);
    
    const diffTime = expiry - today;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    return diffDays;
}

function isExpired(expiryDate) {
    const daysUntil = getDaysUntilExpiry(expiryDate);
    return daysUntil !== null && daysUntil < 0;
}

function isAboutToExpire(expiryDate) {
    const daysUntil = getDaysUntilExpiry(expiryDate);
    return daysUntil !== null && daysUntil >= 0 && daysUntil <= notificationDays;
}

function render() {
  const productsDiv = document.getElementById("products");
  const query = document.getElementById("searchInput").value.toLowerCase();
  productsDiv.innerHTML = "";
  let lowC = 0, outC = 0, expiringC = 0;

  Object.entries(inventory).forEach(([id, p]) => {
    if (query && !p.name.toLowerCase().includes(query)) return;

    let s = "OK", c = "ok";
    let expiryWarning = "";
    
    // Check expiry status - ONLY if quantity >= 1
    if (p.quantity >= 1 && p.expiryDate) {
        const daysLeft = getDaysUntilExpiry(p.expiryDate);
        
        if (daysLeft < 0) {
            expiryWarning = `<span class="expiry-tag expired">‚ö†Ô∏è EXPIRED</span>`;
        } else if (daysLeft >= 0 && daysLeft <= notificationDays) {
            expiryWarning = `<span class="expiry-tag warning">‚è∞ ${daysLeft}d left</span>`;
            expiringC++;
            if (daysLeft === 0) {
                s = "Expires Today!";
                c = "expiring";
            }
        }
    }
    
    // Check stock status
    if (p.quantity === 0) { s = "Out"; c = "out"; outC++; }
    else if (p.quantity < 10) { s = "Low"; c = "low"; lowC++; }

    const hasExpiry = p.expiryDate ? "set" : "";

    const rowHTML = `
<div class="row">
  <div class="col-main">
      <div style="font-weight:700; color: #1e293b;">
          ${p.name}
          ${expiryWarning}
      </div>
  </div>
  
  <div class="col-stat" style="font-weight: 600;">
      ${p.quantity} <span style="font-size: 12px; color: #94a3b8; font-weight: 400;">${p.unit}</span>
  </div>
  
  <div class="col-status">
      <div class="status ${c}">${s}</div>
  </div>
  
  <div class="col-actions">
      <div class="action-buttons">
        <button class="action-text-btn expiry-text-btn ${hasExpiry}" onclick="openExpiryModal('${id}', '${p.name}')" title="${p.expiryDate ? 'Expiry: ' + p.expiryDate : 'Set expiry date'}">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
            </svg>
            Expiry
        </button>
        <button class="action-text-btn decrease-text-btn" onclick="askQuantity('${id}', -1)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            Decrease
        </button>
        <button class="action-text-btn restock-text-btn" onclick="askQuantity('${id}', 1)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            Restock
        </button>
        <button class="action-text-btn remove-text-btn" onclick="handleManualDelete('${id}', '${p.name}')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
            </svg>
            Remove
        </button>
      </div>
  </div>
</div>`;
    
    productsDiv.innerHTML += rowHTML;
  });

  document.getElementById("total").textContent = Object.keys(inventory).length;
  document.getElementById("low").textContent = lowC;
  document.getElementById("out").textContent = outC;
  document.getElementById("expiring").textContent = expiringC;
}
// --- MANUAL ADD LOGIC ---
function toggleAddMenu() {
    const menu = document.getElementById("addMenu");
    menu.style.display = (menu.style.display === "flex") ? "none" : "flex";
}

function openManualAdd() {
    document.getElementById("addMenu").style.display = "none";
    document.getElementById("manualModal").style.display = "flex";
}

function closeManualAdd() {
    document.getElementById("manualModal").style.display = "none";
    clearManualInputs();
}

function clearManualInputs() {
    document.getElementById("m_name").value = "";
    document.getElementById("m_qty").value = "";
    document.getElementById("m_unit").value = "pcs";
}

function saveManualProduct() {
    const name = document.getElementById("m_name").value.trim();
    const qtyInput = document.getElementById("m_qty").value;
    const unit = document.getElementById("m_unit").value;

    if (!name || qtyInput === "") {
        alert("Please enter both Name and Quantity");
        return;
    }

    const qty = parseFloat(qtyInput);

    if (!invRef) {
        alert("System still loading or you are not logged in. Please wait a second.");
        return;
    }

    // CHECK IF PRODUCT EXISTS
    const existingEntry = Object.entries(inventory).find(([_, p]) => 
        p.name.toLowerCase() === name.toLowerCase()
    );

    if (existingEntry && existingEntry[1].expiryDate) {
        closeManualAdd();
        askExpiryForRestock(existingEntry[0], existingEntry[1], qty);
        return;
    }

    const btn = document.querySelector(".btn-save");
    const originalText = btn.textContent;
    btn.textContent = "Saving...";
    btn.disabled = true;

    invRef.push({
        name: name.charAt(0).toUpperCase() + name.slice(1),
        quantity: qty,
        unit: unit
    }).then(() => {
        triggerSuccess(`Added ${name}`);
        clearManualInputs();
        document.getElementById("m_name").focus();
        
        btn.textContent = originalText;
        btn.disabled = false;
    }).catch(err => {
        alert("Error saving: " + err.message);
        btn.textContent = originalText;
        btn.disabled = false;
    });
}

window.onclick = function(event) {
    const menu = document.getElementById("addMenu");
    if (!event.target.closest('.actions') && menu.style.display === "flex") {
        menu.style.display = "none";
    }
}

// --- BULK ADD ---
function openBulkAdd() {
    document.getElementById("addMenu").style.display = "none";
    document.getElementById("bulkModal").style.display = "flex";
}

function closeBulkAdd() {
    document.getElementById("bulkModal").style.display = "none";
    document.getElementById("b_names").value = "";
    document.getElementById("b_qtys").value = "";
}

function saveBulkProducts() {
    const namesStr = document.getElementById("b_names").value;
    const qtysStr = document.getElementById("b_qtys").value;

    if (!namesStr || !qtysStr) return alert("Please fill both boxes");

    const nameList = namesStr.split(',').map(n => n.trim()).filter(n => n !== "");
    const qtyList = qtysStr.split(',').map(q => q.trim()).filter(q => q !== "");

    if (nameList.length !== qtyList.length) {
        return alert(`Mismatch! You have ${nameList.length} names but ${qtyList.length} quantities.`);
    }

    if (!invRef) return alert("Database not ready");

    const btn = document.querySelector("#bulkModal .btn-save");
    btn.textContent = "Processing...";
    btn.disabled = true;

    nameList.forEach((name, index) => {
        const rawQty = qtyList[index];
        
        const numMatch = rawQty.match(/(\d+(\.\d+)?)/);
        const qty = numMatch ? parseFloat(numMatch[0]) : 0;
        
        let unit = rawQty.replace(/(\d+(\.\d+)?)/, '').trim() || "pcs";

        invRef.push({
            name: name.charAt(0).toUpperCase() + name.slice(1),
            quantity: qty,
            unit: unit
        });
    });

    triggerSuccess(`Successfully imported ${nameList.length} products!`);
    closeBulkAdd();
    btn.textContent = "üöÄ Import All";
    btn.disabled = false;
}

// --- AI VOICE LOGIC ---
function startVoiceAssistant() {
  if (!('webkitSpeechRecognition' in window)) return alert("Voice not supported");
  
  isAssistantActive = true;
  document.getElementById("voiceModal").style.display = "flex";
  
  recognition = new webkitSpeechRecognition();
  recognition.lang = "en-US";
  recognition.continuous = true; 
  recognition.interimResults = true;

  recognition.onresult = (event) => {
    let interimTranscript = '';
    for (let i = event.resultIndex; i < event.results.length; ++i) {
      if (event.results[i].isFinal) {
        const finalTranscript = event.results[i][0].transcript;
        document.getElementById("speechOutput").textContent = `"${finalTranscript}"`;
        processSmartAI(finalTranscript);
      } else {
        interimTranscript += event.results[i][0].transcript;
        document.getElementById("speechOutput").textContent = interimTranscript;
      }
    }
  };

  recognition.onend = () => {
    if (isAssistantActive) {
        try { recognition.start(); } catch(e) {}
    }
  };

  recognition.start();
  speakWithAI("I am listening.");
}

function stopVoiceAssistant() {
  isAssistantActive = false;
  pendingAction = null;
  document.getElementById("viz").classList.remove("confirm-mode");
  if (recognition) recognition.stop();
  document.getElementById("voiceModal").style.display = "none";
}

async function processSmartAI(transcript) {
  const output = document.getElementById("speechOutput");
  output.textContent = "Processing...";

  try {
    const VERCEL_API_URL = 'https://ai-inventory-pro-sigma.vercel.app/api/voice';

    const res = await fetch(VERCEL_API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt: transcript })
    });

    if (!res.ok) throw new Error(`Server error: ${res.status}`);

    const data = await res.json();
    if (data.error) throw new Error(data.error);

    const pName = data.item.toLowerCase();
    const existingEntry = Object.entries(inventory).find(([_, p]) => p.name.toLowerCase() === pName);

    if (data.action === 'delete' && existingEntry) {
        pendingAction = { type: 'delete', id: existingEntry[0], name: pName };
        document.getElementById("viz").classList.add("confirm-mode");
    } 
    else if (data.action === 'decrease' && existingEntry) {
        const [id, product] = existingEntry;
        const amount = data.qty;

        recordSale(id, product.name, amount);

        const newVal = Math.max(0, product.quantity - amount);
        invRef.child(id).update({ quantity: newVal });
        triggerSuccess(`Sold ${amount} ${pName}`);
    }
    else if (data.action === 'add' || data.action === 'increase') {
        if (existingEntry) {
            invRef.child(existingEntry[0]).update({ quantity: existingEntry[1].quantity + data.qty });
        } else {
            invRef.push({ name: data.item, quantity: data.qty, unit: data.unit || "pcs" });
        }
        triggerSuccess(`Updated ${pName}`);
    }

    speakWithAI(data.reply);
    output.textContent = `"${transcript}"`;

  } catch (err) {
    console.error("Connection Error:", err);
    speakWithAI("Sorry, I had a brain freeze connecting to the server.");
    output.textContent = "Error: " + err.message;
  }
}

function speakWithAI(text) {
  if ('speechSynthesis' in window) {
    window.speechSynthesis.cancel();
    const utterance = new SpeechSynthesisUtterance(text);
    const voices = window.speechSynthesis.getVoices();
    const googleVoice = voices.find(v => v.name.includes('Google') && v.lang.includes('en'));
    if (googleVoice) utterance.voice = googleVoice;
    
    utterance.rate = 1.0;
    utterance.pitch = 1.0;
    window.speechSynthesis.speak(utterance);
  }
}

function triggerSuccess(msg) {
  const popup = document.getElementById("successPopup");
  popup.textContent = msg;
  popup.style.display = "block";
  document.getElementById("flash").classList.add("show");
  setTimeout(() => {
    popup.style.display = "none";
    document.getElementById("flash").classList.remove("show");
  }, 2000);
}

function recordSale(productId, productName, qty) {
    const priceData = prices[productId];
    if (!priceData || !priceData.sellPrice) return;

    const sellPrice = (typeof priceData.sellPrice === 'object') 
        ? (priceData.sellPrice.numericValue || 0) 
        : parseFloat(priceData.sellPrice) || 0;

    db.ref(`Businesses/${auth.currentUser.uid}/sales`).push({
        productId: productId,
        productName: productName,
        quantity: qty,
        revenue: sellPrice * qty,
        timestamp: firebase.database.ServerValue.TIMESTAMP
    });
}

let currentUpdateId = null;
let currentDirection = 0;

function askQuantity(id, direction) {
    currentUpdateId = id;
    currentDirection = direction;
    const p = inventory[id];
    
    document.getElementById("qtyTitle").textContent = direction > 0 ? `Add to ${p.name}` : `Remove from ${p.name}`;
    document.getElementById("qtyInput").value = "";
    document.getElementById("qtyModal").style.display = "flex";
    setTimeout(() => document.getElementById("qtyInput").focus(), 100);
}
// EXPIRY DATE BATCH CHECKING
function askExpiryForRestock(productId, product, amount) {
    return new Promise((resolve) => {
        const expiryDate = product.expiryDate;
        const formattedDate = new Date(expiryDate).toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric'
        });
        
        const modal = document.createElement('div');
        modal.className = 'custom-modal';
        modal.style.display = 'flex';
        modal.style.zIndex = '4000';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 450px;">
                <h3>üì¶ New Stock Batch</h3>
                <p style="color: #64748b; margin-bottom: 20px;">
                    Current batch expires on: <strong style="color: #3b82f6;">${formattedDate}</strong>
                </p>
                <p style="font-weight: 600; margin-bottom: 20px;">
                    Does the new stock have the same expiry date?
                </p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <button id="sameBatchBtn" style="padding: 15px; border: none; border-radius: 12px; background: #10b981; color: white; font-weight: 700; cursor: pointer;">
                        ‚úÖ Same Date
                    </button>
                    <button id="newBatchBtn" style="padding: 15px; border: none; border-radius: 12px; background: #f59e0b; color: white; font-weight: 700; cursor: pointer;">
                        üìÖ Different Date
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        document.getElementById('sameBatchBtn').onclick = () => {
            // ADD TO EXISTING BATCH
            const newQty = product.quantity + amount;
            invRef.child(productId).update({ quantity: newQty }).then(() => {
                triggerSuccess(`Added ${amount} to existing batch`);
            });
            document.body.removeChild(modal);
            resolve();
        };
        
        document.getElementById('newBatchBtn').onclick = () => {
            document.body.removeChild(modal);
            
            // ASK FOR NEW EXPIRY DATE
            const dateModal = document.createElement('div');
            dateModal.className = 'custom-modal';
            dateModal.style.display = 'flex';
            dateModal.style.zIndex = '4000';
            dateModal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <h3>üìÖ New Batch Expiry Date</h3>
                    <p style="color: #64748b; margin-bottom: 15px;">
                        Product: <strong>${product.name}</strong><br>
                        Quantity: <strong>${amount} ${product.unit}</strong>
                    </p>
                    <input type="date" id="newBatchExpiry" style="width: 100%; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0; font-size: 16px; margin-bottom: 15px;">
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 12px;">
                        <button onclick="this.closest('.custom-modal').remove()" style="padding: 12px; border: none; border-radius: 12px; background: #f1f5f9; color: #64748b; font-weight: 600; cursor: pointer;">Cancel</button>
                        <button id="saveNewBatchBtn" style="padding: 12px; border: none; border-radius: 12px; background: #7c3aed; color: white; font-weight: 600; cursor: pointer;">Create New Batch</button>
                    </div>
                </div>
            `;
            document.body.appendChild(dateModal);
            
            document.getElementById('saveNewBatchBtn').onclick = () => {
                const newExpiry = document.getElementById('newBatchExpiry').value;
                
                if (!newExpiry) {
                    alert("Please select an expiry date");
                    return;
                }
                
                // CREATE NEW BATCH ENTRY
                invRef.push({
                    name: product.name,
                    quantity: amount,
                    unit: product.unit,
                    expiryDate: newExpiry,
                    barcode: product.barcode || null,
                    batchCreatedAt: firebase.database.ServerValue.TIMESTAMP
                }).then(() => {
                    triggerSuccess(`‚úÖ New batch created with ${amount} ${product.unit}`);
                    document.body.removeChild(dateModal);
                });
            };
            
            resolve();
        };
    });
}

function closeQtyModal() {
    document.getElementById("qtyModal").style.display = "none";
}

document.getElementById("confirmQtyBtn").onclick = () => {
    const val = document.getElementById("qtyInput").value;
    if (!val || isNaN(val)) return;

    const amount = Math.abs(parseFloat(val));
    const p = inventory[currentUpdateId];
    const priceData = prices[currentUpdateId] || {};
    
    if (currentDirection > 0) {
        // RESTOCKING
        
        // ‚úÖ FIX: Only check expiry if it EXISTS
        if (p.expiryDate) {
            closeQtyModal();
            askExpiryForRestock(currentUpdateId, p, amount);
            return;
        }
        
        // NO EXPIRY DATE - ADD NORMALLY (THIS WAS MISSING!)
        const costPrice = (typeof priceData.costPrice === 'object') 
            ? (priceData.costPrice.numericValue || 0) 
            : parseFloat(priceData.costPrice) || 0;
        
        db.ref(`Businesses/${auth.currentUser.uid}/purchases`).push({
            productId: currentUpdateId,
            productName: p.name,
            quantity: amount,
            totalCost: costPrice * amount,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });
        
        const newQty = p.quantity + amount;
        invRef.child(currentUpdateId).update({ quantity: newQty }).then(() => {
            closeQtyModal();
            triggerSuccess(`‚úÖ Added ${amount} ${p.unit}`);
        });
        
    } else {
        // DECREASING STOCK (SELLING)
        const sellPrice = (typeof priceData.sellPrice === 'object') 
            ? (priceData.sellPrice.numericValue || 0) 
            : parseFloat(priceData.sellPrice) || 0;
        
        db.ref(`Businesses/${auth.currentUser.uid}/sales`).push({
            productId: currentUpdateId,
            productName: p.name,
            quantity: amount,
            revenue: sellPrice * amount,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });
        
        const newQty = Math.max(0, p.quantity - amount);
        invRef.child(currentUpdateId).update({ quantity: newQty }).then(() => {
            closeQtyModal();
            triggerSuccess(`‚úÖ Sold ${amount} ${p.unit}`);
            
            // UPDATE ANALYTICS
            updateProductAnalytics(currentUpdateId, p.name, amount);
        });
    }
};
window.onclick = (event) => {
    const modal = document.getElementById("qtyModal");
    if (event.target == modal) closeQtyModal();
}

function handleManualDelete(id, name) {
    if(confirm(`Delete ${name}?`)) invRef.child(id).remove();
}

// --- SCANNER FUNCTIONS ---
let html5QrCode;
let isScanning = false; 
let lastScannedBarcode = null;
let lastScannedTime = 0;
let torchOn = false;

async function openScanner() {
    let scannerModal = document.getElementById('scannerModal');
    if (!scannerModal) {
        scannerModal = document.createElement('div');
        scannerModal.id = 'scannerModal';
        scannerModal.className = 'modal';
        scannerModal.innerHTML = `
            <div class="manual-modal-box" style="padding:20px; max-width: 500px; text-align:center; border: 4px solid #000; background:#fff;">
                <h3 style="margin-top:0">Smart Scanner Pro</h3>
                <p style="font-size:12px; color:#666; margin-bottom:10px;">Ultra-precision scanning enabled</p>
                <div id="reader" style="border-radius:15px; overflow:hidden; background:#000;"></div>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin: 15px 0;">
                    <button id="torch-btn" onclick="toggleTorch()" 
                            style="background:#fbbf24; color:#000; display:none; padding:15px; border-radius:12px; border:none; font-weight:700; cursor:pointer; align-items:center; justify-content:center;">
                        üî¶ Flash
                    </button>
                    <button onclick="openTypeModal()" 
                            style="background:#f0f2f5; color:#333; padding:15px; border-radius:12px; border:none; font-weight:700; cursor:pointer;">
                        ‚å®Ô∏è Type Code
                    </button>
                    <button onclick="connectBarcodeGun()" 
                            style="background:#10b981; color:#fff; padding:15px; border-radius:12px; border:none; font-weight:700; cursor:pointer;">
                        üî´ Gun Mode
                    </button>
                </div>

                <button class="btn-close" onclick="stopScanner()" style="width:100%; padding:15px; font-weight:bold;">Close Scanner</button>
            </div>
        `;
        document.body.appendChild(scannerModal);
    }
    
    scannerModal.style.display = "flex";
    
    // Clear any existing scanner
    if (html5QrCode) {
        try {
            await html5QrCode.stop();
        } catch (e) {
            console.warn("Clearing old scanner:", e);
        }
    }
    
    html5QrCode = new Html5Qrcode("reader");
    
    // ENHANCED CONFIG FOR SMALL BARCODES
    const config = { 
        fps: 60,
        qrbox: { width: 400, height: 200 },
        aspectRatio: 2.0,
        disableFlip: false,
        experimentalFeatures: { 
            useBarCodeDetectorIfSupported: true 
        }
    };

    // ALL BARCODE FORMATS
    const formats = [
        Html5QrcodeSupportedFormats.EAN_13,
        Html5QrcodeSupportedFormats.EAN_8,
        Html5QrcodeSupportedFormats.UPC_A,
        Html5QrcodeSupportedFormats.UPC_E,
        Html5QrcodeSupportedFormats.CODE_128,
        Html5QrcodeSupportedFormats.CODE_39,
        Html5QrcodeSupportedFormats.CODE_93,
        Html5QrcodeSupportedFormats.ITF,
        Html5QrcodeSupportedFormats.CODABAR
    ];

    try {
        await html5QrCode.start(
            { facingMode: "environment" }, 
            { ...config, formatsToSupport: formats }, 
            (text) => handleScanSuccess(text)
        );

        // ENHANCED CAMERA SETTINGS
        setTimeout(async () => {
            try {
                const track = html5QrCode.getRunningTrack();
                const caps = track.getCapabilities();
                
                if (caps.torch) {
                    document.getElementById('torch-btn').style.display = "flex";
                }

                const constraints = { advanced: [] };
                
                if (caps.zoom) {
                    const maxZoom = caps.zoom.max;
                    const optimalZoom = Math.min(maxZoom, 3.5);
                    constraints.advanced.push({ zoom: optimalZoom });
                }
                
                if (caps.focusMode && caps.focusMode.includes('continuous')) {
                    constraints.advanced.push({ focusMode: "continuous" });
                }
                
                if (caps.focusDistance) {
                    constraints.advanced.push({ focusDistance: caps.focusDistance.min });
                }
                
                if (caps.whiteBalanceMode && caps.whiteBalanceMode.includes('continuous')) {
                    constraints.advanced.push({ whiteBalanceMode: "continuous" });
                }
                
                await track.applyConstraints(constraints);
                console.log("‚úÖ Enhanced camera settings applied");
            } catch (hwErr) {
                console.warn("Some camera features unavailable", hwErr);
            }
        }, 1000);

    } catch (err) {
        console.error("‚ùå Scanner failed to start:", err);
        
        // CRITICAL FIX: Show error message and allow closing
        const readerDiv = document.getElementById('reader');
        if (readerDiv) {
            readerDiv.innerHTML = `
                <div style="padding: 40px; text-align: center; color: white; background: #ef4444; border-radius: 15px;">
                    <h3 style="margin: 0 0 10px 0; font-size: 20px;">‚ùå Camera Access Failed</h3>
                    <p style="margin: 0; font-size: 14px; line-height: 1.5;">
                        Please allow camera permissions in your browser settings.
                        <br><br>
                        <strong>Settings ‚Üí Privacy ‚Üí Camera</strong>
                        <br><br>
                        Or use the buttons below to add products manually.
                    </p>
                </div>
            `;
        }
        
        // Clean up failed scanner instance
        html5QrCode = null;
        
        // Alert user with helpful message
        alert("‚ö†Ô∏è Camera Permission Denied\n\n" +
              "To use the scanner:\n" +
              "1. Go to browser Settings\n" +
              "2. Find Privacy/Permissions\n" +
              "3. Allow Camera access for this site\n" +
              "4. Refresh and try again\n\n" +
              "You can still use:\n" +
              "‚Ä¢ ‚å®Ô∏è Type Code - Manual entry\n" +
              "‚Ä¢ üî´ Gun Mode - Barcode gun");
    }
}
// BARCODE GUN CONNECTION WITH VISUAL INDICATOR
let barcodeGunConnected = false;
let barcodeGunBuffer = "";

function connectBarcodeGun() {
    const gunBtn = document.querySelector('button[onclick="connectBarcodeGun()"]');
    
    if (barcodeGunConnected) {
        // DISCONNECT
        barcodeGunConnected = false;
        document.removeEventListener('keypress', handleBarcodeGunInput);
        
        // Reset button style
        gunBtn.style.background = "#10b981";
        gunBtn.innerHTML = "üî´ Gun Mode";
        
        triggerSuccess("üî¥ Barcode Gun Disconnected");
        return;
    }
    
    // CONNECT
    barcodeGunConnected = true;
    barcodeGunBuffer = "";
    
    // Create hidden input for gun scanning
    let gunInput = document.getElementById('gunHiddenInput');
    if (!gunInput) {
        gunInput = document.createElement('input');
        gunInput.id = 'gunHiddenInput';
        gunInput.type = 'text';
        gunInput.style.position = 'absolute';
        gunInput.style.left = '-9999px';
        document.body.appendChild(gunInput);
    }
    
    document.addEventListener('keypress', handleBarcodeGunInput);
    gunInput.focus();
    
    // Keep input focused (important for gun)
    setInterval(() => {
        if (barcodeGunConnected) {
            const input = document.getElementById('gunHiddenInput');
            if (input && document.activeElement !== input) {
                input.focus();
            }
        }
    }, 1000);
    
    // Change button to show connected state
    gunBtn.style.background = "linear-gradient(135deg, #10b981 0%, #059669 100%)";
    gunBtn.innerHTML = "‚úÖ Gun Connected";
    
    triggerSuccess("üü¢ Barcode Gun Connected - Scan products now!");
    speakWithAI("Barcode gun connected. Ready to scan.");
}

function handleBarcodeGunInput(e) {
    if (!barcodeGunConnected) return;
    
    // Barcode guns send Enter key after scanning
    if (e.key === 'Enter' && barcodeGunBuffer.length > 0) {
        console.log(`üî´ Gun scanned: ${barcodeGunBuffer}`);
        processScannedBarcode(barcodeGunBuffer.trim());
        barcodeGunBuffer = "";
        
        // Refocus hidden input
        setTimeout(() => {
            const gunInput = document.getElementById('gunHiddenInput');
            if (gunInput) gunInput.focus();
        }, 100);
    } else if (e.key !== 'Enter') {
        barcodeGunBuffer += e.key;
    }
}
function handleScanSuccess(decodedText) {
    const now = Date.now();
    if (decodedText === lastScannedBarcode && (now - lastScannedTime) < 5000) return; 

    lastScannedBarcode = decodedText;
    lastScannedTime = now;
    
    if ("vibrate" in navigator) navigator.vibrate(100); 
    document.getElementById("beep-ok").play();
    processScannedBarcode(decodedText);
}

async function toggleTorch() {
    try {
        const track = html5QrCode.getRunningTrack();
        torchOn = !torchOn;
        await track.applyConstraints({ advanced: [{ torch: torchOn }] });
        const btn = document.getElementById('torch-btn');
        btn.style.background = torchOn ? "#000" : "#fbbf24";
        btn.style.color = torchOn ? "#fff" : "#000";
        btn.innerText = torchOn ? "üö´ Flash Off" : "üî¶ Flashlight";
    } catch (e) { console.error("Torch error", e); }
}

function openTypeModal() {
    let tModal = document.getElementById('typeModal');
    if (!tModal) {
        tModal = document.createElement('div');
        tModal.id = 'typeModal';
        tModal.className = 'modal';
        tModal.style.zIndex = "5000";
        document.body.appendChild(tModal);
    }
    tModal.innerHTML = `
        <div class="manual-modal-box" style="border: 3px solid #000; padding:20px; background:#fff;">
            <h3 style="margin-top:0">Manual Entry</h3>
            <input type="number" id="manual_barcode_input" 
                   style="width:90%; padding:15px; font-size:18px; margin:10px 0; border:2px solid #ccc; border-radius:8px;" 
                   placeholder="Enter barcode..." autofocus>
            <div style="display:flex; gap:10px;">
                <button onclick="submitManualCode()" style="flex:1; padding:12px; background:#2563eb; color:#fff; border:none; border-radius:8px;">Process</button>
                <button onclick="document.getElementById('typeModal').style.display='none'" style="flex:1; padding:12px; background:#eee; border:none; border-radius:8px;">Cancel</button>
            </div>
        </div>
    `;
    tModal.style.display = "flex";
    setTimeout(() => document.getElementById('manual_barcode_input').focus(), 150);
}

function submitManualCode() {
    const code = document.getElementById('manual_barcode_input').value.trim();
    if (code) {
        handleScanSuccess(code);
        document.getElementById('typeModal').style.display = 'none';
    }
}

async function processScannedBarcode(code) {
    const entries = Object.entries(inventory || {});
    const existingEntry = entries.find(([_, p]) => p.barcode === code);

    if (existingEntry) {
        const [id, product] = existingEntry;
        
        // CHECK EXPIRY DATE BEFORE RESTOCKING
        if (product.expiryDate) {
            await askExpiryForRestock(id, product, 1);
        } else {
            const newQty = (product.quantity || 0) + 1;
            invRef.child(id).update({ quantity: newQty }).then(() => {
                triggerSuccess(`In: ${product.name} (+1)`);
                speakWithAI(`${product.name} updated.`);
            });
        }
        return;
    }

    speakWithAI("Searching product database...");

    // TRY API 1: Open Food Facts
    try {
        const offRes = await fetch(`https://world.openfoodfacts.org/api/v0/product/${code}.json?fields=product_name,brands,generic_name`);
        const offData = await offRes.json();
        
        if (offData.status === 1) {
            const productName = offData.product.product_name || offData.product.generic_name;
            const brandName = offData.product.brands;
            
            if (productName && productName.trim().length > 2) {
                let finalName = brandName ? `${brandName} ${productName}` : productName;
                
                // CONFIRM WITH USER BEFORE SAVING
                if (confirm(`Found: "${finalName}"\n\nIs this correct?`)) {
                    saveNewProduct(code, finalName.trim());
                    return;
                }
            }
        }
    } catch (e) { 
        console.warn("Open Food Facts API failed"); 
    }

    // TRY API 2: UPCitemDB
    try {
        const upcRes = await fetch(`https://api.upcitemdb.com/prod/trial/lookup?upc=${code}`);
        const upcData = await upcRes.json();

        if (upcData.items && upcData.items.length > 0) {
            const item = upcData.items[0];
            
            // CONFIRM WITH USER
            if (confirm(`Found: "${item.title}"\n\nIs this correct?`)) {
                saveNewProduct(code, item.title);
                return;
            }
        }
    } catch (e) { 
        console.warn("UPCitemDB API failed"); 
    }

    // IF BOTH APIS FAIL OR USER REJECTS
    speakWithAI("Product not found. Please enter the name manually.");
    openNamePrompt(code);
}
function openNamePrompt(code) {
    let pModal = document.getElementById('namePromptModal');
    if (!pModal) {
        pModal = document.createElement('div');
        pModal.id = 'namePromptModal';
        pModal.className = 'modal';
        pModal.style.zIndex = "5001";
        document.body.appendChild(pModal);
    }
    pModal.innerHTML = `
        <div class="manual-modal-box" style="border: 3px solid #2563eb; padding:20px; background:#fff;">
            <h3 style="margin-top:0; color:#2563eb;">New Item!</h3>
            <p style="font-size:12px; color:#666;">Barcode: ${code}</p>
            <input type="text" id="custom_name" placeholder="Name of product..." 
                   style="width:90%; padding:15px; font-size:16px; border:2px solid #ccc; border-radius:8px;" autofocus>
            <div style="margin-top:15px; display:flex; gap:10px;">
                <button onclick="submitName('${code}')" style="flex:1; padding:12px; background:#2563eb; color:#fff; border:none; border-radius:8px;">Register</button>
                <button onclick="document.getElementById('namePromptModal').style.display='none'" style="flex:1; padding:12px; background:#eee; border:none; border-radius:8px;">Cancel</button>
            </div>
        </div>
    `;
    pModal.style.display = "flex";
    setTimeout(() => document.getElementById('custom_name').focus(), 150);
}

function submitName(code) {
    const name = document.getElementById('custom_name').value.trim();
    if (name) {
        saveNewProduct(code, name);
        document.getElementById('namePromptModal').style.display = 'none';
    }
}

function saveNewProduct(code, name) {
    const cleanName = name.charAt(0).toUpperCase() + name.slice(1);
    invRef.push({
        name: cleanName,
        barcode: code,
        quantity: 1,
        unit: "pcs",
        createdAt: firebase.database.ServerValue.TIMESTAMP
    }).then(() => {
        triggerSuccess(`Added: ${cleanName}`);
        speakWithAI(`Registered ${cleanName}`);
    });
}

function stopScanner() {
    const scannerModal = document.getElementById('scannerModal');
    
    if (html5QrCode) {
        html5QrCode.stop().then(() => {
            if (scannerModal) scannerModal.style.display = "none";
            torchOn = false;
            html5QrCode = null;
            console.log("‚úÖ Scanner stopped successfully");
        }).catch((err) => {
            console.warn("‚ö†Ô∏è Scanner stop error:", err);
            // Force close anyway
            if (scannerModal) scannerModal.style.display = "none";
            torchOn = false;
            html5QrCode = null;
        });
    } else {
        // No scanner instance, just close modal
        if (scannerModal) scannerModal.style.display = "none";
        console.log("‚úÖ Modal closed (no active scanner)");
    }
}
// --- ULTIMATE PDF REPORT FUNCTIONS ---
let reportCounter = 1;
let businessNameGlobal = "";
let reportFormData = {};

function openReportModal() {
    // Load business name from Firebase
    db.ref(`BusinessOwners/${currentUserId}/businessName`).once("value", s => {
        if (s.exists()) {
            businessNameGlobal = s.val();
            document.getElementById("reportBusinessName").value = businessNameGlobal;
        }
    });
    
    // Set today's date
    const today = new Date().toISOString().split('T')[0];
    document.getElementById("reportDate").value = today;
    
    document.getElementById("reportModal").style.display = "flex";
    setTimeout(() => document.getElementById("reportBusinessName").focus(), 100);
}

function closeReportModal() {
    document.getElementById("reportModal").style.display = "none";
}

function showPDFTypeModal() {
    const businessName = document.getElementById("reportBusinessName").value.trim();
    const fullName = document.getElementById("reportFullName").value.trim();
    const reportDate = document.getElementById("reportDate").value;
    
    if (!businessName || !fullName) {
        alert("Please fill in all required fields");
        return;
    }
    
    // Store form data
    reportFormData = { businessName, fullName, reportDate };
    
    // Close report modal and show type selection
    document.getElementById("reportModal").style.display = "none";
    document.getElementById("pdfTypeModal").style.display = "flex";
}

function closePDFTypeModal() {
    document.getElementById("pdfTypeModal").style.display = "none";
    document.getElementById("reportModal").style.display = "flex";
}

async function generatePDF(type) {
    document.getElementById("pdfTypeModal").style.display = "none";
    
    if (type === 'standard') {
        await generateStandardPDF();
    } else {
        await generatePremiumPDF();
    }
}

// ============================================
// STANDARD PDF (Simple & Clean)
// ============================================
async function generateStandardPDF() {
    const { businessName, fullName, reportDate } = reportFormData;
    
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Blue Banner
        doc.setFillColor(37, 99, 235);
        doc.rect(0, 0, 210, 45, 'F');
        
        // Business Name
        doc.setFont("times", "italic");
        doc.setFontSize(28);
        doc.setTextColor(255, 255, 255);
        const businessNameClean = businessName.replace(/\s+/g, '');
        doc.text(businessNameClean, 105, 25, { align: 'center' });
        
        doc.setFontSize(16);
        doc.text("Product Report", 105, 35, { align: 'center' });
        
        // Details
        doc.setFont("helvetica", "normal");
        doc.setFontSize(11);
        doc.setTextColor(60, 60, 60);
        doc.text(`Name: ${fullName}`, 20, 55);
        
        const formattedDate = new Date(reportDate).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        doc.text(`Date: ${formattedDate}`, 20, 62);
        
        // Table Header
        doc.setFillColor(248, 250, 252);
        doc.rect(15, 72, 180, 10, 'F');
        
        doc.setFont("helvetica", "bold");
        doc.setFontSize(10);
        doc.setTextColor(71, 85, 105);
        doc.text("Product Name", 20, 78);
        doc.text("Quantity", 100, 78);
        doc.text("Expiry Date", 130, 78);
        doc.text("Status", 170, 78);
        
        // Products
        doc.setFont("helvetica", "normal");
        doc.setFontSize(9);
        
        let yPosition = 88;
        const products = Object.values(inventory);
        
        products.forEach((product, index) => {
            if (index % 2 === 0) {
                doc.setFillColor(249, 250, 251);
                doc.rect(15, yPosition - 5, 180, 8, 'F');
            }
            
            doc.setTextColor(30, 41, 59);
            doc.text(product.name.substring(0, 30), 20, yPosition);
            doc.text(`${product.quantity} ${product.unit}`, 100, yPosition);
            
            if (product.expiryDate) {
                const expiryFormatted = new Date(product.expiryDate).toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });
                doc.text(expiryFormatted, 130, yPosition);
            } else {
                doc.setTextColor(156, 163, 175);
                doc.text("Not Set", 130, yPosition);
                doc.setTextColor(30, 41, 59);
            }
            
            let status = "OK";
            let statusColor = [16, 185, 129];
            
            if (product.quantity === 0) {
                status = "Out";
                statusColor = [239, 68, 68];
            } else if (product.quantity < 10) {
                status = "Low";
                statusColor = [217, 119, 6];
            } else if (product.expiryDate && product.quantity >= 1) {
                const daysLeft = getDaysUntilExpiry(product.expiryDate);
                if (daysLeft < 0) {
                    status = "Expired";
                    statusColor = [220, 38, 38];
                } else if (daysLeft >= 0 && daysLeft <= notificationDays) {
                    status = "Expiring";
                    statusColor = [245, 158, 11];
                }
            }
            
            doc.setTextColor(statusColor[0], statusColor[1], statusColor[2]);
            doc.text(status, 170, yPosition);
            doc.setTextColor(30, 41, 59);
            
            yPosition += 8;
            
            if (yPosition > 270) {
                doc.addPage();
                yPosition = 20;
            }
        });
        
        // Footer
        doc.setFontSize(8);
        doc.setTextColor(156, 163, 175);
        doc.text(`Generated on ${new Date().toLocaleString()}`, 105, 285, { align: 'center' });
        doc.text(`Total Products: ${products.length}`, 105, 290, { align: 'center' });
        
        const fileName = `${businessNameClean}ProductReport${reportCounter}.pdf`;
        doc.save(fileName);
        
        reportCounter++;
        triggerSuccess(`Report downloaded: ${fileName}`);
        
    } catch (error) {
        console.error("PDF Error:", error);
        alert("Error generating PDF");
    }
}

// ============================================
// PREMIUM PDF (Beautiful & Detailed) - FIXED ENCODING
// ============================================
async function generatePremiumPDF() {
    const { businessName, fullName, reportDate } = reportFormData;
    
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        
        // ============================================
        // PAGE 1: COVER PAGE
        // ============================================
        
        // Gradient Background
        const gradientSteps = 50;
        for (let i = 0; i < gradientSteps; i++) {
            const r = 37 + (i * (59 - 37) / gradientSteps);
            const g = 99 + (i * (130 - 99) / gradientSteps);
            const b = 235 + (i * (253 - 235) / gradientSteps);
            doc.setFillColor(r, g, b);
            doc.rect(0, i * (pageHeight / gradientSteps), pageWidth, pageHeight / gradientSteps, 'F');
        }
        
        // Decorative Elements
        doc.setFillColor(255, 255, 255, 0.1);
        doc.circle(10, 10, 30, 'F');
        doc.circle(pageWidth - 10, pageHeight - 10, 40, 'F');
        
        // Title Box
        doc.setFillColor(255, 255, 255);
        doc.roundedRect(20, 60, pageWidth - 40, 80, 5, 5, 'F');
        doc.setDrawColor(37, 99, 235);
        doc.setLineWidth(0.5);
        doc.roundedRect(20, 60, pageWidth - 40, 80, 5, 5, 'S');
        
        // Business Name
        doc.setFont("times", "bold");
        doc.setFontSize(38);
        doc.setTextColor(30, 41, 59);
        const businessNameClean = businessName.replace(/\s+/g, ' ');
        doc.text(businessNameClean, pageWidth / 2, 95, { align: 'center' });
        
        // Line
        doc.setDrawColor(37, 99, 235);
        doc.setLineWidth(1);
        doc.line(60, 102, pageWidth - 60, 102);
        
        // Report Title
        doc.setFont("helvetica", "normal");
        doc.setFontSize(20);
        doc.setTextColor(71, 85, 105);
        doc.text("INVENTORY PRODUCT REPORT", pageWidth / 2, 115, { align: 'center' });
        
        // Details Card
        doc.setFillColor(248, 250, 252);
        doc.roundedRect(30, 160, pageWidth - 60, 50, 3, 3, 'F');
        
        doc.setFont("helvetica", "bold");
        doc.setFontSize(11);
        doc.setTextColor(51, 65, 85);
        doc.text("REPORT DETAILS", 40, 172);
        
        doc.setFont("helvetica", "normal");
        doc.setFontSize(10);
        doc.setTextColor(71, 85, 105);
        
        doc.text("Prepared By:", 40, 182);
        doc.setFont("helvetica", "bold");
        doc.text(fullName, 75, 182);
        
        doc.setFont("helvetica", "normal");
        doc.text("Report Date:", 40, 192);
        doc.setFont("helvetica", "bold");
        const formattedDate = new Date(reportDate).toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        doc.text(formattedDate, 75, 192);
        
        doc.setFont("helvetica", "normal");
        doc.text("Report ID:", 40, 202);
        doc.setFont("helvetica", "bold");
        const reportId = `${businessNameClean.substring(0, 3).toUpperCase()}-${Date.now().toString().slice(-6)}`;
        doc.text(reportId, 75, 202);
        
        // Statistics
        const products = Object.values(inventory);
        const totalProducts = products.length;
        const totalStock = products.reduce((sum, p) => sum + p.quantity, 0);
        const lowStockCount = products.filter(p => p.quantity > 0 && p.quantity < 10).length;
        const outOfStockCount = products.filter(p => p.quantity === 0).length;
        const expiringCount = products.filter(p => {
            if (p.quantity >= 1 && p.expiryDate) {
                const daysLeft = getDaysUntilExpiry(p.expiryDate);
                return daysLeft >= 0 && daysLeft <= notificationDays;
            }
            return false;
        }).length;
        
        doc.setFillColor(255, 255, 255);
        doc.roundedRect(30, 225, pageWidth - 60, 45, 3, 3, 'F');
        doc.setDrawColor(226, 232, 240);
        doc.setLineWidth(0.5);
        doc.roundedRect(30, 225, pageWidth - 60, 45, 3, 3, 'S');
        
        doc.setFont("helvetica", "bold");
        doc.setFontSize(11);
        doc.setTextColor(51, 65, 85);
        doc.text("INVENTORY STATISTICS", 40, 237);
        
        const statsY = 248;
        doc.setFont("helvetica", "normal");
        doc.setFontSize(9);
        doc.setTextColor(100, 116, 139);
        
        doc.text("Total Products:", 40, statsY);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(37, 99, 235);
        doc.text(totalProducts.toString(), 80, statsY);
        
        doc.setFont("helvetica", "normal");
        doc.setTextColor(100, 116, 139);
        doc.text("Total Stock Units:", 110, statsY);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(37, 99, 235);
        doc.text(totalStock.toString(), 155, statsY);
        
        doc.setFont("helvetica", "normal");
        doc.setTextColor(100, 116, 139);
        doc.text("Low Stock:", 40, statsY + 8);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(217, 119, 6);
        doc.text(lowStockCount.toString(), 80, statsY + 8);
        
        doc.setFont("helvetica", "normal");
        doc.setTextColor(100, 116, 139);
        doc.text("Out of Stock:", 110, statsY + 8);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(239, 68, 68);
        doc.text(outOfStockCount.toString(), 155, statsY + 8);
        
        doc.setFont("helvetica", "normal");
        doc.setTextColor(100, 116, 139);
        doc.text("Expiring Soon:", 40, statsY + 16);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(245, 158, 11);
        doc.text(expiringCount.toString(), 80, statsY + 16);
        
        // Footer
        doc.setFont("helvetica", "italic");
        doc.setFontSize(8);
        doc.setTextColor(148, 163, 184);
        doc.text("", pageWidth / 2, pageHeight - 15, { align: 'center' });
        doc.text("", pageWidth / 2, pageHeight - 10, { align: 'center' });
        
// ============================================
// PAGE 2+: DETAILED TABLE 
// ============================================
doc.addPage();

// Header
doc.setFillColor(37, 99, 235);
doc.rect(0, 0, pageWidth, 25, 'F');

doc.setFont("times", "bold");
doc.setFontSize(18);
doc.setTextColor(255, 255, 255);
doc.text(businessNameClean, 15, 12);

doc.setFont("helvetica", "normal");
doc.setFontSize(10);
doc.text("Detailed Product Inventory", 15, 19);

doc.setFontSize(8);
doc.text(`Report ID: ${reportId}`, pageWidth - 15, 12, { align: 'right' });
doc.text(`Page 2`, pageWidth - 15, 17, { align: 'right' });

// Table Data - Cleaned to remove Expiry Status
const tableData = products.map((product, index) => {
    let status = "In Stock";
    
    if (product.quantity === 0) {
        status = "Out of Stock";
    } else if (product.quantity < 10) {
        status = "Low Stock";
    }
    
    const expiryDateFormatted = product.expiryDate 
        ? new Date(product.expiryDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
        : "Not Set";
    
    // Returning 5 columns instead of 6
    return [
        (index + 1).toString(),
        product.name,
        `${product.quantity} ${product.unit}`,
        expiryDateFormatted,
        status
    ];
});

doc.autoTable({
    startY: 32,
    // Removed 'Expiry Status' from headers
    head: [['#', 'Product Name', 'Quantity', 'Expiry Date', 'Stock Status']],
    body: tableData,
    theme: 'grid',
    styles: {
        fontSize: 9,
        cellPadding: 4,
        lineColor: [226, 232, 240],
        lineWidth: 0.5,
    },
    headStyles: {
        fillColor: [248, 250, 252],
        textColor: [51, 65, 85],
        fontStyle: 'bold',
        halign: 'center',
        fontSize: 9,
        cellPadding: 5,
    },
    // Adjusted widths to distribute the space previously held by Expiry Status
    columnStyles: {
        0: { cellWidth: 15, halign: 'center', fillColor: [249, 250, 251] },
        1: { cellWidth: 75, fontStyle: 'bold' }, // Wider space for product names
        2: { cellWidth: 30, halign: 'center' },
        3: { cellWidth: 35, halign: 'center' },
        4: { cellWidth: 35, halign: 'center' }, // Stock Status is now column index 4
    },
    alternateRowStyles: {
        fillColor: [249, 250, 251]
    },
    didParseCell: function(data) {
        // Updated logic for the new Stock Status position (Index 4)
        if (data.column.index === 4 && data.section === 'body') {
            const status = data.cell.raw;
            if (status === "Out of Stock") {
                data.cell.styles.textColor = [239, 68, 68];
                data.cell.styles.fontStyle = 'bold';
            } else if (status === "Low Stock") {
                data.cell.styles.textColor = [217, 119, 6];
                data.cell.styles.fontStyle = 'bold';
            } else {
                data.cell.styles.textColor = [16, 185, 129];
                data.cell.styles.fontStyle = 'bold';
            }
        }
    },
    didDrawPage: function(data) {
        const pageNumber = doc.internal.getCurrentPageInfo().pageNumber;
        const totalPages = doc.internal.getNumberOfPages();
        
        doc.setFontSize(8);
        doc.setTextColor(148, 163, 184);
        doc.setFont("helvetica", "italic");
        
        doc.text(
            `Generated on ${new Date().toLocaleString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            })}`,
            15,
            pageHeight - 10
        );
        
        doc.text(
            `Page ${pageNumber} of ${totalPages}`,
            pageWidth - 15,
            pageHeight - 10,
            { align: 'right' }
        );
    }
});
        
        // ============================================
        // LAST PAGE: SUMMARY & INSIGHTS 
        // ============================================
        doc.addPage();
        
        // Page Header
        doc.setFillColor(37, 99, 235);
        doc.rect(0, 0, pageWidth, 25, 'F');
        
        doc.setFont("times", "bold");
        doc.setFontSize(18);
        doc.setTextColor(255, 255, 255);
        doc.text(businessNameClean, 15, 12);
        
        doc.setFont("helvetica", "normal");
        doc.setFontSize(10);
        doc.text("Report Summary & Recommendations", 15, 19);
        
        let summaryY = 40;
        
        // --- KEY INSIGHTS SECTION ---
        doc.setFillColor(248, 250, 252);
        doc.roundedRect(15, summaryY, pageWidth - 30, 50, 3, 3, 'F');
        
        // Draw a small blue square instead of a Chart Emoji
        doc.setFillColor(37, 99, 235);
        doc.rect(20, summaryY + 6, 4, 4, 'F'); 
        
        doc.setFont("helvetica", "bold");
        doc.setFontSize(12);
        doc.setTextColor(30, 41, 59);
        doc.text("KEY INSIGHTS", 27, summaryY + 10);
        
        doc.setFont("helvetica", "normal");
        doc.setFontSize(9);
        doc.setTextColor(71, 85, 105);
        
        const insights = [
            `- Total inventory value across ${totalProducts} unique products`,
            `- ${totalStock} total units currently in stock`,
            `- ${((products.filter(p => p.quantity > 0).length / totalProducts) * 100).toFixed(1)}% of products are in stock`,
            `- ${outOfStockCount} products require immediate restocking`,
            `- ${expiringCount} products are expiring within ${notificationDays} days`
        ];
        
        insights.forEach((insight, idx) => {
            doc.text(insight, 20, summaryY + 20 + (idx * 6));
        });
        
        summaryY += 60;
        
        // --- CRITICAL ACTIONS SECTION ---
        doc.setFillColor(254, 242, 242);
        doc.roundedRect(15, summaryY, pageWidth - 30, 40, 3, 3, 'F');
        doc.setDrawColor(239, 68, 68);
        doc.setLineWidth(0.5);
        doc.roundedRect(15, summaryY, pageWidth - 30, 40, 3, 3, 'S');
        
        // Draw a small red triangle instead of a Warning Emoji
        doc.setFillColor(220, 38, 38);
        doc.triangle(20, summaryY + 10, 22, summaryY + 6, 24, summaryY + 10, 'F');
        
        doc.setFont("helvetica", "bold");
        doc.setFontSize(12);
        doc.setTextColor(220, 38, 38);
        doc.text("CRITICAL ACTIONS REQUIRED", 27, summaryY + 10);
        
        doc.setFont("helvetica", "normal");
        doc.setFontSize(9);
        doc.setTextColor(127, 29, 29);
        
        const criticalActions = [];
        if (outOfStockCount > 0) criticalActions.push(`- Restock ${outOfStockCount} out-of-stock products immediately`);
        if (expiringCount > 0) criticalActions.push(`- Review ${expiringCount} products expiring soon`);
        if (lowStockCount > 0) criticalActions.push(`- Plan reorder for ${lowStockCount} low-stock items`);
        
        if (criticalActions.length === 0) {
            doc.setTextColor(16, 185, 129);
            doc.text("Summary: Inventory is healthy! No critical actions required.", 20, summaryY + 20);
        } else {
            criticalActions.forEach((action, idx) => {
                doc.text(action, 20, summaryY + 20 + (idx * 6));
            });
        }
        
        summaryY += 50;
        
        // --- RECOMMENDATIONS SECTION ---
        doc.setFillColor(236, 253, 245);
        doc.roundedRect(15, summaryY, pageWidth - 30, 50, 3, 3, 'F');
        doc.setDrawColor(16, 185, 129);
        doc.setLineWidth(0.5);
        doc.roundedRect(15, summaryY, pageWidth - 30, 50, 3, 3, 'S');
        
        // Draw a small green circle instead of a Lightbulb Emoji
        doc.setFillColor(16, 185, 129);
        doc.circle(22, summaryY + 8, 2, 'F');
        
        doc.setFont("helvetica", "bold");
        doc.setFontSize(12);
        doc.setTextColor(6, 95, 70);
        doc.text("RECOMMENDATIONS", 27, summaryY + 10);
        
        doc.setFont("helvetica", "normal");
        doc.setFontSize(9);
        doc.setTextColor(6, 78, 59);
        
        const recommendations = [
            "- Set expiry dates for all products to enable better tracking",
            "- Maintain minimum stock levels of 10 units per product",
            "- Review inventory weekly to prevent stockouts",
            "- Consider automated reordering for fast-moving items",
            "- Implement FIFO (First In, First Out) for perishable goods"
        ];
        
        recommendations.forEach((rec, idx) => {
            doc.text(rec, 20, summaryY + 20 + (idx * 6));
        });

        // --- SIGNATURE & FOOTER ---
        summaryY += 60;
        doc.setDrawColor(226, 232, 240);
        doc.setLineWidth(0.5);
        doc.line(15, summaryY, pageWidth - 15, summaryY);
        
        summaryY += 10;
        doc.setFont("helvetica", "italic");
        doc.setFontSize(9);
        doc.setTextColor(100, 116, 139);
        doc.text("Report prepared by:", 20, summaryY);
        
        doc.setFont("helvetica", "bold");
        doc.setFontSize(11);
        doc.setTextColor(30, 41, 59);
        doc.text(fullName, 20, summaryY + 7);
        
        doc.setFont("helvetica", "normal");
        doc.setFontSize(8);
        doc.setTextColor(148, 163, 184);
        doc.text(`Authorized Signatory - ${businessNameClean}`, 20, summaryY + 13);
        
        doc.setDrawColor(37, 99, 235);
        doc.setLineWidth(1);
        doc.line(15, pageHeight - 30, pageWidth - 15, pageHeight - 30);
        
        doc.setFont("helvetica", "bold");
        doc.setFontSize(9);
        doc.setTextColor(37, 99, 235);
        doc.text("ScaleVest", pageWidth / 2, pageHeight - 22, { align: 'center' });
        
        doc.setFont("helvetica", "italic");
        doc.setFontSize(7);
        doc.setTextColor(148, 163, 184);
        doc.text("Powered by ScaleVest", pageWidth / 2, pageHeight - 17, { align: 'center' });
        doc.text("This document is generated by ScaleVest AI and is legally valid without signature", pageWidth / 2, pageHeight - 13, { align: 'center' });

        const fileName = `${businessNameClean}_ProductsInventory_Report.pdf`;
        doc.save(fileName);
        
        closeReportModal();
        if (typeof triggerSuccess === "function") triggerSuccess(`Premium Report Downloaded: ${fileName}`);
        
    } catch (error) {
        console.error("PDF Generation Error:", error);
        alert("Error generating PDF: " + error.message);
    } finally {
        btn.innerHTML = originalHTML;
        btn.disabled = false;
    }
}

// Add spin animation
const styleElement = document.createElement('style');
styleElement.textContent = `
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
`;
document.head.appendChild(styleElement);
</script>

</body>
</html>
