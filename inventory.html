<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Inventory</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

<style>
*{box-sizing:border-box;font-family:Inter}
body{margin:0;background:#f6f7fb;padding:30px}

/* HEADER */
.top{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px}
.top h2{margin:0;font-size:22px}
.top .actions{display:flex;gap:10px}
.top button{padding:12px 18px;border:none;border-radius:14px;background:#000;color:#fff;font-weight:600;cursor:pointer}

/* STATS */
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;margin-bottom:30px}
.stat{background:#fff;padding:22px;border-radius:20px;box-shadow:0 10px 25px rgba(0,0,0,.06)}
.stat span{color:#666;font-size:14px}
.stat h3{margin:8px 0 0;font-size:26px}

/* TABLE */
.table{background:#fff;border-radius:22px;box-shadow:0 15px 35px rgba(0,0,0,.08);overflow:hidden}
.head,.row{display:grid;grid-template-columns:2fr 1fr 1fr 2fr;padding:16px 22px;align-items:center}
.head{background:#f1f3f7;font-weight:600}
.row:not(:last-child){border-bottom:1px solid #eee}

/* STATUS */
.status.ok{color:#16a34a}
.status.low{color:#d97706}
.status.out{color:#dc2626}

/* BUTTONS */
.row button{padding:6px 12px;border-radius:10px;border:1px solid #ddd;background:#fff;cursor:pointer}
.remove{color:#dc2626;border-color:#dc2626}
.top .actions{
  display: flex;
  gap: 10px;
  flex-wrap: wrap; /* allow buttons to wrap if not enough space */
}
.top .actions button{
  padding:12px 18px;
  border:none;
  border-radius:14px;
  background:#000;
  color:#fff;
  font-weight:600;
  cursor:pointer;
  white-space: nowrap; /* prevent text wrapping inside button */
}

/* MODALS */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:1000}
.modal-box{width:380px;background:#fff;padding:26px;border-radius:22px}
.modal-box input{width:100%;padding:14px;border-radius:14px;border:1px solid #ddd;margin-bottom:12px}
.modal-box button{width:100%;padding:14px;border:none;border-radius:14px;background:#000;color:#fff;font-weight:600}

/* SCANNER */
#scanner{position:relative;width:100%;height:240px;background:#000;border-radius:14px;overflow:hidden}
.scan-zone{
  position:absolute;
  inset:25% 10%;
  border:2px dashed rgba(0,255,0,.7);
  border-radius:10px;
  z-index:10;
}
.laser{position:absolute;top:0;left:0;width:100%;height:2px;background:red;box-shadow:0 0 10px red;animation:scan 1.2s linear infinite}
@keyframes scan{0%{top:0}50%{top:100%}100%{top:0}}
.flash{
  position:fixed;
  inset:0;
  background:rgba(34,197,94,.25);
  pointer-events:none;
  z-index:3000;
  opacity:0;
  transition:.15s;
}
.flash.show{opacity:1}
/* POPUP */
.toast{
  position:fixed;
  top:20px;
  left:50%;
  transform:translateX(-50%);
  background:#16a34a;
  color:#fff;
  padding:12px 20px;
  border-radius:14px;
  font-weight:600;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
  display:none;
  z-index:2000;
  animation:fade 2s ease;
}
@keyframes fade{
  0%{opacity:0;top:10px}
  20%{opacity:1;top:20px}
  80%{opacity:1}
  100%{opacity:0}
}

/* COUNTER */
.counter{
  position:absolute;
  bottom:8px;
  right:10px;
  background:#000;
  color:#0f0;
  padding:4px 8px;
  border-radius:8px;
  font-size:12px;
  z-index:20;
}
</style>
</head>

<body>

<audio id="beep-ok" preload src="https://assets.mixkit.co/sfx/preview/mixkit-beep-tone-2864.mp3"></audio>
<audio id="beep-new" preload src="https://assets.mixkit.co/sfx/preview/mixkit-confirmation-tone-2867.mp3"></audio>

<div id="toast" class="toast"></div>

<div class="top">
  <h2>Inventory</h2>
 <div class="actions">
  <button onclick="openScanner()">Scan Barcode</button>
  <button onclick="openAdd()">Add Product</button>
  <button onclick="startVoice()">ðŸŽ™ Voice</button>
</div>

</div>

<div class="stats">
  <div class="stat"><span>Total Products</span><h3 id="total">0</h3></div>
  <div class="stat"><span>Low</span><h3 id="low">0</h3></div>
  <div class="stat"><span>Out</span><h3 id="out">0</h3></div>
</div>

<div class="table">
  <div class="head"><div>Product</div><div>Quantity</div><div>Status</div><div>Actions</div></div>
  <div id="products"></div>
</div>

<div id="addModal" class="modal">
  <div class="modal-box">
    <h3>Add Product</h3>
    <input id="pname" placeholder="Product name">
    <input id="pqty" type="number" placeholder="Quantity">
    <input id="punit" placeholder="Unit">
    <button onclick="addProduct()">Save</button>
  </div>
</div>
<input id="barcodeInput" style="position:absolute; left:-9999px;">

<div id="scannerModal" class="modal">
  <div class="modal-box">
    <h3>Scan Barcode</h3>
    <div id="scanner">
      <div class="scan-zone"></div>
      <div class="laser"></div>
      <div id="scanCount" class="counter">0</div>
    </div>
    <button onclick="closeScanner()">Close</button>
  </div>
</div>
<div id="flash" class="flash"></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const GOOGLE_TRANSLATE_API_KEY = "AIzaSyBWd8VNdVzvP9CESzih6bWetkwJHKygnLs"; 


firebase.initializeApp({
  apiKey:"AIzaSyD6PdrKp2XLfRqjC587lMpdKTaWD4MBens",
  authDomain:"scalevest-163a0.firebaseapp.com",
  databaseURL:"https://scalevest-163a0-default-rtdb.firebaseio.com",
  projectId:"scalevest-163a0"
});

const auth=firebase.auth(), db=firebase.database();
let inventory={}, invRef, scannerRunning=false;
let scanStamp = 0;
let scanTotal = 0;


function showToast(t){
  toast.textContent="âœ” "+t;
  toast.style.display="block";
  setTimeout(()=>toast.style.display="none",1800);
}

auth.onAuthStateChanged(u=>{
  if(!u){location.href="login.html";return;}
  invRef=db.ref(`Businesses/${u.uid}/inventory`);
  invRef.on("value",s=>{inventory=s.val()||{};render();});
});

function openAdd(){addModal.style.display="flex"}
function openScanner(){
  unlockAudio();          
  scannerModal.style.display="flex";
  startScanner();
}
const input = document.getElementById('barcodeInput');
input.focus();

input.addEventListener('keypress', e => {
  if (e.key === 'Enter') {
    handleBarcode(input.value); // your existing scan handler
    input.value = '';
  }
});

function closeScanner(){scannerModal.style.display="none";if(scannerRunning){Quagga.stop();scannerRunning=false}}

function addProduct(){
  if(!pname.value || !pqty.value){
    alert("Product name and quantity are required");
    return;
  }

  invRef.push({
    name: pname.value,
    quantity: +pqty.value,
    unit: punit.value || "pcs"   // âœ… default if empty
  });

  pname.value = "";
  pqty.value = "";
  punit.value = "";

  addModal.style.display = "none";
}
function greenFlash(){
  const f=document.getElementById("flash");
  f.classList.add("show");
  setTimeout(()=>f.classList.remove("show"),120);
}
function extractQtyAndName(text) {
  const words = text.toLowerCase().split(" ");

  let qty = 1;
  let nameParts = [];

  for (let w of words) {
    if (!isNaN(w)) {
      qty = parseInt(w);
    } else if (!["add","increase","decrease","remove","delete","by","quantity","of"].includes(w)) {
      nameParts.push(w);
    }
  }

  return {
    qty,
    name: nameParts.join(" ").trim()
  };
}

async function translateToEnglish(text){
  if(!text) return text;
  try{
    const response = await fetch(`https://translation.googleapis.com/language/translate/v2?key=${GOOGLE_TRANSLATE_API_KEY}`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({
        q: text,
        target: "en",   // always translate to English
        format: "text"
      })
    });
    const data = await response.json();
    if(data.data && data.data.translations && data.data.translations.length){
      return data.data.translations[0].translatedText;
    }
  }catch(e){
    console.error("Translation error:", e);
  }
  return text; // fallback if translation fails
}

/* ðŸ”¥ INSANE MODE INIT */
function startScanner(){
  if(scannerRunning) return;

  const isLaptop=!/Android|iPhone/i.test(navigator.userAgent);

  Quagga.init({
    inputStream:{
      type:"LiveStream",
      target:scanner,
      constraints:{
        facingMode:isLaptop?"user":"environment",
        width:{ideal:1280},
        height:{ideal:720}
      }
    },
    locator:{patchSize:"small",halfSample:true},
    numOfWorkers:navigator.hardwareConcurrency||4,
    frequency:10,
    decoder:{readers:["ean_reader","upc_reader","code_128_reader"]},
    locate:true
  },e=>{
    if(e){alert("Camera / HTTPS error");return;}
    Quagga.start();scannerRunning=true;
  });

  Quagga.onDetected(d=>{
    if(d.codeResult.confidence<0.75) return;
    handleBarcode(d.codeResult.code);
  });
}

async function handleBarcode(code){
  const now = Date.now();
  if(now - scanStamp < 120) return;   // 5â€“10 scans/sec
  scanStamp = now;

  scanTotal++;
  document.getElementById("scanCount").textContent = scanTotal;

  let name = "Unknown Product";
  const found = Object.entries(inventory).find(([_,p])=>p.barcode===code);

  if(found){
    name = found[1].name;
    invRef.child(found[0]).update({
      quantity: found[1].quantity + 1
    });
    document.getElementById("beep-ok").play().catch(()=>{});
  }else{
    document.getElementById("beep-new").play().catch(()=>{});
    try{
      const r = await fetch(`https://world.openfoodfacts.org/api/v0/product/${code}.json`);
      const j = await r.json();
      if(j.status === 1) name = j.product.product_name || name;
    }catch(e){}
    invRef.push({
      name,
      quantity: 1,
      unit: "pcs",
      barcode: code
    });
  }

  greenFlash();     // âœ… ADD THIS LINE HERE
  showToast(name);
}

function unlockAudio(){
  ["beep-ok","beep-new"].forEach(id=>{
    const a=document.getElementById(id);
    a.play().then(()=>{
      a.pause();
      a.currentTime=0;
    }).catch(()=>{});
  });
}
let gunBuffer="";
let gunTimer=null;

document.addEventListener("keydown",e=>{
  if(scannerModal.style.display!=="flex") return;

  if(e.key==="Enter"){
    if(gunBuffer.length>=6){
      handleBarcode(gunBuffer);
    }
    gunBuffer="";
    return;
  }

  if(/^[0-9]$/.test(e.key)){
    gunBuffer+=e.key;
    clearTimeout(gunTimer);
    gunTimer=setTimeout(()=>gunBuffer="",100);
  }
});

function render(){
  products.innerHTML="";
  let lowC=0,outC=0;
  Object.entries(inventory).forEach(([id,p])=>{
    let s="In Stock",c="ok";
    if(p.quantity===0){s="Out of Stock";c="out";outC++}
    else if(p.quantity<10){s="Low in Stock";c="low";lowC++}
    products.innerHTML+=`
    <div class="row">
      <div>${p.name}</div>
      <div>${p.quantity} ${p.unit}</div>
      <div class="status ${c}">${s}</div>
<div>
  <button onclick="changeQty('${id}', 1)">+</button>
  <button onclick="changeQty('${id}', -1)">âˆ’</button>
  <button class="remove" onclick="invRef.child('${id}').remove()">Remove</button>
</div>


    </div>`;
  });
  total.textContent=Object.keys(inventory).length;
  low.textContent=lowC;
  out.textContent=outC;
}
function incQty(id, qty){
  invRef.child(id).update({ quantity: qty + 1 });
}

function decQty(id, qty){
  if(qty <= 0) return;
  invRef.child(id).update({ quantity: qty - 1 });
}
function changeQty(id, direction){
  const p = inventory[id];
  if(!p) return;

  let val = prompt("Enter quantity:", "1");
  val = parseInt(val);

  if(isNaN(val) || val <= 0) return;

  let newQty = p.quantity + (direction * val);
  if(newQty < 0) newQty = 0;

  invRef.child(id).update({ quantity: newQty });
}
/* ===============================
   ðŸŽ™ï¸ VOICE ASSISTANT ENGINE
================================ */

let recognition;
let listening = false;

function startVoice(){
  if(!('webkitSpeechRecognition' in window)){
    alert("Voice not supported");
    return;
  }

  document.getElementById("voiceModal").style.display = "flex";

  recognition = new webkitSpeechRecognition();
  recognition.lang = "en-US";
  recognition.continuous = true;
  recognition.interimResults = false;

  recognition.onresult = async e => {
    const text = e.results[e.results.length-1][0].transcript;
    console.log("VOICE:", text);
    await processVoice(text);
  };

  listening = true;
  recognition.start();
}


function stopVoice(){
  if(recognition) recognition.stop();
  document.getElementById("voiceModal").style.display = "none";
}


/* ===============================
   ðŸ§  COMMAND PROCESSOR
================================ */
function cleanProductName(name) {
  return name
    .replace(/[.,!?]+$/g, "")   // remove ending dots
    .replace(/\s+/g, " ")       // remove extra spaces
    .trim();
}
function capitalizeWords(text) {
  return text
    .toLowerCase()
    .split(" ")
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join(" ");
}

async function processVoice(cmd){
  cmd = cmd.toLowerCase();

  const { qty, name } = extractQtyAndName(cmd);
  if(!name){
    showToast("Say product name");
    return;
  }

let product = await translateToEnglish(name);
product = cleanProductName(product);
product = capitalizeWords(product);



  // ADD
  if(cmd.includes("add") || cmd.includes("daal") || cmd.includes("jodo")){
    invRef.push({ name: product, quantity: qty, unit: "pcs" });
    showToast(`Added ${qty} ${product}`);
    return;
  }

  // INCREASE
  if(cmd.includes("increase") || cmd.includes("badhao") || cmd.includes("aur")){
    changeByName(product, qty);
    return;
  }

  // DECREASE
  if(cmd.includes("decrease") || cmd.includes("ghatao") || cmd.includes("kam")){
    changeByName(product, -qty);
    return;
  }

  // REMOVE
  if(cmd.includes("remove") || cmd.includes("delete") || cmd.includes("hatao")){
    removeByName(product);
    return;
  }

  showToast("Command not understood");
}



/* ===============================
   ðŸ”§ HELPERS
================================ */

function extractProduct(text){
  const words = text.split(" ");
  const ignore = ["add","increase","decrease","remove","delete","quantity","by"];
  const filtered = words.filter(w => !ignore.includes(w) && isNaN(w));
  return filtered.join(" ").trim();
}

function extractNumber(text){
  const match = text.match(/\d+/);
  return match ? parseInt(match[0]) : null;
}

function changeByName(name, diff){
  if(!name) return showToast("Say product name");

  const found = Object.entries(inventory)
    .find(([_,p])=>p.name.toLowerCase() === name.toLowerCase());

  if(!found) return showToast("Product not found");

  const [id,p] = found;
  const newQty = Math.max(0, p.quantity + diff);

  invRef.child(id).update({ quantity: newQty });
  showToast(`${name} updated`);
}

function removeByName(name){
  if(!name) return showToast("Say product name");

  const found = Object.entries(inventory)
    .find(([_,p])=>p.name.toLowerCase() === name.toLowerCase());

  if(!found) return showToast("Product not found");

  invRef.child(found[0]).remove();
  showToast(`${name} removed`);
}

</script>
<div id="voiceModal" class="modal">
  <div class="modal-box">
    <h3>ðŸŽ™ Listeningâ€¦</h3>
    <p>Speak commands continuously</p>
    <button onclick="stopVoice()">Stop</button>
  </div>
</div>

</body>
</html>
