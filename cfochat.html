<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CFO Assistant Chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .chat-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 800px;
            width: 100%;
            height: 600px;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .user-info {
            font-size: 14px;
            opacity: 0.9;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .message {
            margin-bottom: 16px;
            display: flex;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.assistant {
            justify-content: flex-start;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 18px;
            border-radius: 18px;
            font-size: 15px;
            line-height: 1.5;
        }

        .message.assistant .message-content {
            background: white;
            color: #333;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .chat-input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            padding: 12px 18px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 15px;
            transition: border-color 0.3s;
        }

        .chat-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .send-btn {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .send-btn:hover {
            transform: scale(1.1);
        }

        .send-btn svg {
            width: 24px;
            height: 24px;
        }

        .back-btn {
            position: fixed;
            bottom: 30px;
            left: 30px;
            padding: 12px 24px;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
            display: none;
        }

        .back-btn:hover {
            transform: translateY(-2px);
        }

        .loading {
            display: flex;
            gap: 4px;
            padding: 12px 18px;
        }

        .loading span {
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .loading span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1);
            }
        }

        .status-indicator {
            font-size: 12px;
            color: #4ade80;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <div>
                <h1>üíº CFO Assistant</h1>
                <div class="user-info" id="userInfo"></div>
                <div class="status-indicator">‚óè Data loaded successfully</div>
            </div>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input-area">
            <input type="text" class="chat-input" id="chatInput" placeholder="Ask about your business metrics..." onkeypress="handleKeyPress(event)">
            <button class="send-btn" onclick="sendMessage()">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                </svg>
            </button>
        </div>
    </div>

    <button class="back-btn" id="backBtn" onclick="goBack()">‚Üê Back to Dashboard</button>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyD6PdrKp2XLfRqjC587lMpdKTaWD4MBens",
  authDomain: "scalevest-163a0.firebaseapp.com",
  databaseURL: "https://scalevest-163a0-default-rtdb.firebaseio.com",
  projectId: "scalevest-163a0",
  storageBucket: "scalevest-163a0.firebasestorage.app",
  messagingSenderId: "938358950124",
  appId: "1:938358950124:web:043506aeaacea2a96bfdc9",
  measurementId: "G-QD3TWBZHR0"
};

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);
        
        window.database = database;
        window.dbRef = ref;
        window.dbGet = get;
        window.auth = auth;

        // Check authentication status
onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'login.html';
            } else {
                window.currentUserId = user.uid;
                // Wait for auth to be solid before loading data
                loadUserData(user.uid);
            }
        });

        async function loadUserData(userId) {
            try {
                // Ensure your Firebase structure is prices/UID and sales/UID
                const pricesRef = dbRef(database, `prices/${userId}`);
                const salesRef = dbRef(database, `sales/${userId}`);
                
                const [pricesSnapshot, salesSnapshot] = await Promise.all([
                    dbGet(pricesRef),
                    dbGet(salesRef)
                ]);

                window.userData = {
                    prices: pricesSnapshot.exists() ? pricesSnapshot.val() : "No inventory data.",
                    sales: salesSnapshot.exists() ? salesSnapshot.val() : "No sales data."
                };

                document.getElementById('chatContainer').style.display = 'flex';
                document.getElementById('userInfo').textContent = `ID: ${userId.substring(0, 8)}`;
                addMessageDirect('assistant', "Connection established. Data Vault decrypted. What is our objective?");
            } catch (error) {
                console.error('Permission Error:', error);
                alert("Vault Access Denied. Verify your data is stored under your User ID.");
            }
        }

                // Add greeting message
                const greetings = [
                    "Good morning! How can I assist you with your business today?",
                    "Good afternoon! Ready to dive into your metrics?",
                    "Good evening! Let's review your business performance.",
                    "Hello! I'm here to help you understand your data better.",
                    "Hi there! What would you like to know about your business?",
                    "Welcome back! How can I help optimize your operations today?"
                ];
                const greeting = greetings[Math.floor(Math.random() * greetings.length)];
                addMessageDirect('assistant', greeting);
             catch (error) {
                console.error('Error loading data:', error);
                alert('Error loading user data. Please try again.');
            }
        }

        function addMessageDirect(type, content) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = content;
            
            messageDiv.appendChild(contentDiv);
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        window.loadUserData = loadUserData;
        window.addMessageDirect = addMessageDirect;
    </script>

    <script>
        const API_URL = 'YOUR_VERCEL_URL_HERE'; // Replace with your Vercel URL

        function addMessage(type, content) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = content;
            
            messageDiv.appendChild(contentDiv);
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function addLoadingMessage() {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            messageDiv.id = 'loadingMessage';
            
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message-content loading';
            loadingDiv.innerHTML = '<span></span><span></span><span></span>';
            
            messageDiv.appendChild(loadingDiv);
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function removeLoadingMessage() {
            const loadingMessage = document.getElementById('loadingMessage');
            if (loadingMessage) {
                loadingMessage.remove();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;

            addMessage('user', message);
            input.value = '';
            
            addLoadingMessage();

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        userData: window.userData
                    })
                });

                const data = await response.json();
                removeLoadingMessage();
                addMessage('assistant', data.response || 'I apologize, but I encountered an error processing your request.');
            } catch (error) {
                console.error('Error:', error);
                removeLoadingMessage();
                addMessage('assistant', 'I apologize, but I\'m having trouble connecting right now. Please try again in a moment.');
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function goBack() {
            window.location.href = 'CFO.html';
        }

        window.sendMessage = sendMessage;
        window.handleKeyPress = handleKeyPress;
        window.goBack = goBack;
    </script>
</body>
</html>
