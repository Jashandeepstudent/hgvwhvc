<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Session | ScaleVest</title>
    <script src="https://unpkg.com/@daily-co/daily-js"></script>
    <style>
        /* Reusing your ScaleVest Theme */
        body { font-family: 'SF Pro Display', -apple-system, sans-serif; background: #f8f9fa; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* HEADER */
        .chat-header {
            background: white; padding: 15px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex; align-items: center; justify-content: space-between; z-index: 100;
        }
        
        .header-left { display: flex; align-items: center; gap: 15px; }
        .header-logo { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid #e5e7eb; }
        .header-title { font-weight: 800; font-size: 1.2rem; color: #1a1a1a; }
        .header-sub { font-size: 0.85rem; color: #10b981; font-weight: 600; }
        .header-actions { display: flex; align-items: center; gap: 10px; }

        .action-btn {
            background: #f3f4f6; border: 1px solid #e5e7eb; padding: 8px 14px; border-radius: 8px;
            cursor: pointer; font-size: 0.85rem; font-weight: 600; color: #374151;
            display: flex; align-items: center; gap: 6px; transition: 0.2s; text-decoration: none; height: 38px;
        }
        .meeting-btn { background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; display: none; }
        .action-btn:hover { transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* CHAT AREA */
        #chatContainer {
            flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px;
            position: relative; background-image: radial-gradient(#e5e7eb 1px, transparent 1px); background-size: 20px 20px;
        }

        /* MESSAGES */
        .message-bubble { max-width: 70%; padding: 12px 18px; border-radius: 18px; font-size: 15px; line-height: 1.5; position: relative; animation: popIn 0.3s ease; word-wrap: break-word; }
        .msg-mine { background: #10b981; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .msg-theirs { background: white; color: #374151; align-self: flex-start; border-bottom-left-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .timestamp { font-size: 10px; opacity: 0.7; margin-top: 5px; display: block; text-align: right; }
        
        /* MEETING CARD */
        .meeting-card {
            background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); border-radius: 10px; padding: 15px; margin-top: 5px; cursor: pointer; transition: 0.2s;
        }
        .meeting-card:hover { background: rgba(255,255,255,0.25); }
        .msg-theirs .meeting-card { background: #f0fdf4; border-color: #10b981; color: #064e3b; }
        .join-btn { background: #fff; color: #10b981; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 700; margin-top: 10px; cursor: pointer; width: 100%; }

        /* INPUT AREA */
        .input-area { background: white; padding: 15px 20px; display: flex; gap: 12px; border-top: 1px solid #e5e7eb; align-items: center; }
        #attachBtn { background: #f3f4f6; color: #6b7280; border: none; padding: 10px; border-radius: 50%; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; width: 45px; height: 45px; }
        #attachBtn:hover { background: #e5e7eb; color: #1a1a1a; }
        #msgInput { flex: 1; padding: 15px; border: 2px solid #e5e7eb; border-radius: 12px; outline: none; font-size: 16px; transition: 0.3s; }
        #msgInput:focus { border-color: #10b981; }
        #sendBtn { background: #10b981; color: white; border: none; padding: 0 25px; border-radius: 12px; font-weight: 700; cursor: pointer; transition: 0.2s; height: 50px; }
        #sendBtn:hover { transform: scale(1.05); }

        /* MODALS (Meeting Setup & Waiting Room) */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            z-index: 2000; display: none; align-items: center; justify-content: center;
        }
        .modal-box {
            background: white; padding: 30px; border-radius: 16px; width: 90%; max-width: 400px; box-shadow: 0 20px 50px rgba(0,0,0,0.2);
        }
        .modal-title { font-size: 1.2rem; font-weight: 800; margin-bottom: 20px; color: #111; }
        .modal-input { width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 8px; margin-bottom: 15px; font-size: 1rem; box-sizing: border-box;}
        .modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .modal-btn { padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: 700; transition: 0.2s; width: 100%; }
        .btn-primary { background: #10b981; color: white; }
        .btn-secondary { background: #f3f4f6; color: #333; }
        .btn-danger { background: #ef4444; color: white; }

        /* VIDEO CONFERENCE INTERFACE */
        #videoConferenceContainer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 3000; display: none; flex-direction: column;
        }
        #dailyFrame { flex: 1; width: 100%; border: none; position: relative; }
        
        /* MEETING LOADER */
        #meetingLoader {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #111;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 3001; color: white;
        }
        .loader-spinner {
            width: 60px; height: 60px; border: 4px solid #333; border-top: 4px solid #10b981;
            border-radius: 50%; animation: spin 1s linear infinite;
        }
        .loader-text { margin-top: 20px; font-size: 1rem; color: #999; }
        
        .video-controls {
            height: 80px; background: #111; display: flex; align-items: center; justify-content: center; gap: 20px;
        }
        .control-btn {
            width: 50px; height: 50px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;
            background: #333; color: white; transition: 0.2s;
        }
        .control-btn.active { background: #ef4444; color: white; }
        .control-btn:hover { transform: scale(1.1); }
        .btn-leave { background: #ef4444 !important; }
        .btn-end { background: #b91c1c !important; width: auto; padding: 0 20px; border-radius: 25px; }

        /* WAITING ROOM */
        .waiting-room { text-align: center; color: #333; }
        .waiting-time { font-size: 2rem; font-weight: 800; color: #10b981; margin: 20px 0; }

        /* UTILS */
        #uploadProgress { position: fixed; top: 0; left: 0; width: 0%; height: 4px; background: #10b981; z-index: 200; transition: width 0.3s; }
        .typing-indicator { align-self: flex-start; background: white; padding: 10px 15px; border-radius: 20px; border-bottom-left-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: none; align-items: center; gap: 5px; margin-bottom: 10px; }
        .dot { width: 6px; height: 6px; background: #bbb; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        @keyframes popIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="uploadProgress"></div>

    <div class="chat-header">
        <div class="header-left">
            <img src="ScaleVestLogo.png" alt="SV" class="header-logo" onerror="this.src='https://via.placeholder.com/45?text=SV'"> 
            <div>
                <div class="header-title" id="chatTitle">Connecting...</div>
                <div class="header-sub">ScaleVest Secure Line</div>
            </div>
        </div>
        
        <div class="header-actions">
            <button class="action-btn meeting-btn" id="meetingBtn" onclick="openMeetingModal()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                Arrange Meeting
            </button>
            <button class="action-btn" onclick="history.back()">Back</button>
        </div>
    </div>

    <div id="chatContainer">
        <div id="initialLoader" style="position: absolute; top:0; left:0; width:100%; height:100%; background:#f8f9fa; z-index:50; display:flex; flex-direction:column; align-items:center; justify-content:center;">
            <div style="width: 40px; height: 40px; border: 4px solid #ddd; border-top: 4px solid #10b981; border-radius: 50%; animation: spin 1s infinite linear;"></div>
            <div style="margin-top:10px; color:#888; font-size:0.9rem;">Syncing...</div>
        </div>

        <div id="safetyWarning" class="safety-warning" style="display:none;">
            <span class="safety-icon">üõ°Ô∏è</span>
            <div class="safety-text">
                <strong>ScaleVest has your back.</strong><br>
                Please do not open any suspicious links or share sensitive passwords.
                <br><br>
                <small style="color:#999">Messages are end-to-end encrypted.</small>
            </div>
        </div>

        <div class="typing-indicator" id="typingBubble">
            <div class="dot"></div><div class="dot"></div><div class="dot"></div>
        </div>
    </div>

    <div class="input-area">
        <button id="attachBtn" title="Attach File">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
            </svg>
        </button>
        <input type="file" id="fileInput" style="display: none;">

        <input type="text" id="msgInput" placeholder="Type a message..." autocomplete="off">
        <button id="sendBtn">SEND</button>
    </div>

    <div id="meetingSetupModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">Arrange Meeting</div>
            <input type="text" id="meetingTitle" class="modal-input" placeholder="Meeting Title (e.g. Funding Discussion)">
            
            <div style="margin-bottom:10px; font-weight:600; font-size:0.9rem;">Schedule (Optional)</div>
            <div class="modal-grid">
                <input type="date" id="meetingDate" class="modal-input" style="margin:0;">
                <input type="time" id="meetingTime" class="modal-input" style="margin:0;">
            </div>

            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="modal-btn btn-secondary" onclick="closeMeetingModal()">Cancel</button>
                <button class="modal-btn btn-primary" onclick="createMeeting()">Generate Link</button>
            </div>
        </div>
    </div>

    <div id="waitingRoomModal" class="modal-overlay">
        <div class="modal-box waiting-room">
            <div style="font-size:3rem;">‚è≥</div>
            <div class="modal-title">Meeting Scheduled</div>
            <p>This meeting is scheduled for:</p>
            <div class="waiting-time" id="waitDisplayTime">--:--</div>
            <p id="waitDisplayDate" style="color:#666; margin-bottom:20px;">--/--/----</p>
            <button class="modal-btn btn-secondary" onclick="document.getElementById('waitingRoomModal').style.display='none'">Okay, I'll wait</button>
        </div>
    </div>

    <div id="videoConferenceContainer">
        <div id="dailyFrame">
            <div id="meetingLoader">
                <div class="loader-spinner"></div>
                <div class="loader-text">Connecting to meeting...</div>
            </div>
        </div>
        <div class="video-controls">
            <button class="control-btn" onclick="toggleAudio()" id="btnMic">üé§</button>
            <button class="control-btn" onclick="toggleVideo()" id="btnCam">üì∑</button>
            <button class="control-btn btn-leave" onclick="leaveMeeting()">Leave</button>
            <button class="control-btn btn-end" id="btnEndAll" style="display:none;" onclick="endMeetingForAll()">End Meeting</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onChildAdded, get, set, update, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyD6PdrKp2XLfRqjC587lMpdKTaWD4MBens",
            authDomain: "scalevest-163a0.firebaseapp.com",
            databaseURL: "https://scalevest-163a0-default-rtdb.firebaseio.com",
            projectId: "scalevest-163a0",
            storageBucket: "scalevest-163a0.firebasestorage.app",
            messagingSenderId: "938358950124",
            appId: "1:938358950124:web:043506aeaacea2a96bfdc9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const storage = getStorage(app);
        const auth = getAuth(app);

        // Daily.co API Key
        const DAILY_API_KEY = "41c6bd698967b9c40aa06a2ae07a661891df5d6657ca4166d82fd5ca77e94134";

        // GLOBAL VARS
        const params = new URLSearchParams(window.location.search);
        const recipientUID = params.get('recipient');
        let currentUser = null;
        let chatRoomID = null;
        let dailyCall = null;
        let isInvestor = false;
        let userDisplayName = "User";
        let userAvatar = "";
        let typingTimeout = null;
        let audioMuted = false;
        let videoMuted = false;

        // AUTH
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                if(!recipientUID) { window.location.href = "dashboard.html"; return; }
                
                await identifyUserRole();
                initializeChat();
            } else {
                window.location.href = "login3.html";
            }
        });

        // 1. IDENTIFY ROLE & GET MY DETAILS
        async function identifyUserRole() {
            try {
                const invSnap = await get(ref(db, `investorProfiles/${currentUser.uid}`));
                if (invSnap.exists()) {
                    isInvestor = true;
                    document.getElementById('meetingBtn').style.display = 'flex';
                    document.getElementById('btnEndAll').style.display = 'flex';
                    const data = invSnap.val();
                    userDisplayName = data.fullName || "Investor";
                    userAvatar = data.photoURL || data.logo || "";
                    return;
                }
            } catch(e) {}

            try {
                const fndSnap = await get(ref(db, `founderProfile/${currentUser.uid}`));
                if (fndSnap.exists()) {
                    const data = fndSnap.val();
                    userDisplayName = data.founderUsername || "Founder";
                    userAvatar = data.photoURL || "";
                }
            } catch(e) {}
        }

        async function initializeChat() {
            const participantIDs = [currentUser.uid, recipientUID].sort();
            chatRoomID = `chat_${participantIDs[0]}_${participantIDs[1]}`;

            let chatTitle = "Chat";
            try {
                const fSnap = await get(ref(db, `founderProfile/${recipientUID}`));
                if (fSnap.exists()) chatTitle = fSnap.val().firstName || "Founder";
                else {
                    const iSnap = await get(ref(db, `investorProfiles/${recipientUID}`));
                    if (iSnap.exists()) chatTitle = iSnap.val().fullName || "Investor";
                }
            } catch (e) {}
            document.getElementById('chatTitle').textContent = chatTitle;
            document.getElementById('initialLoader').style.display = 'none';

            const messagesRef = ref(db, `Chats/${chatRoomID}`);
            onChildAdded(messagesRef, (snapshot) => {
                const msg = snapshot.val();
                if(msg.sender) renderMessage(msg);
            });
            
            const typingRef = ref(db, `Chats/${chatRoomID}/typing/${recipientUID}`);
            onValue(typingRef, (snapshot) => {
                const isTyping = snapshot.val();
                const bubble = document.getElementById('typingBubble');
                const container = document.getElementById('chatContainer');
                
                if (isTyping) {
                    bubble.style.display = 'flex';
                    container.appendChild(bubble); 
                    container.scrollTop = container.scrollHeight;
                } else {
                    bubble.style.display = 'none';
                }
            });
        }

        // --- RENDER MESSAGES ---
        function renderMessage(msg) {
            const container = document.getElementById('chatContainer');
            const isMine = msg.sender === currentUser.uid;
            const div = document.createElement('div');
            div.className = `message-bubble ${isMine ? 'msg-mine' : 'msg-theirs'}`;
            
            const time = new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            let contentHtml = "";
            if (msg.fileType === 'image') {
                contentHtml = `<img src="${msg.fileUrl}" style="max-width:100%; border-radius:8px; cursor:pointer;" onclick="window.open('${msg.fileUrl}')">`;
            } else if (msg.fileType === 'video') {
                contentHtml = `<video src="${msg.fileUrl}" style="max-width:100%; border-radius:8px;" controls></video>`;
            } else if (msg.fileType === 'document') {
                contentHtml = `<a href="${msg.fileUrl}" target="_blank" style="color:inherit; text-decoration:underline;">üìÑ ${msg.fileName || 'Document'}</a>`;
            }

            if (msg.text) {
                contentHtml += `<div>${msg.text}</div>`;
            }
            else if (msg.type === 'meeting') {
                const isScheduled = msg.scheduledTime && msg.scheduledTime !== 'now';
                const dateObj = isScheduled ? new Date(msg.scheduledTime) : new Date();
                const displayTime = isScheduled ? dateObj.toLocaleString() : "Happening Now";

                contentHtml = `
                    <div class="meeting-card" onclick="event.stopPropagation(); window.tryJoinMeeting('${msg.meetingId}', '${msg.roomUrl}', ${msg.scheduledTime === 'now' ? "'now'" : msg.scheduledTime})">
                        <span style="font-size:2rem">üìπ</span>
                        <div style="flex:1">
                            <div style="font-weight:700; font-size:1rem;">${msg.title}</div>
                            <div style="font-size:0.85rem; opacity:0.8;">${displayTime}</div>
                            <button class="join-btn" onclick="event.stopPropagation(); window.tryJoinMeeting('${msg.meetingId}', '${msg.roomUrl}', ${msg.scheduledTime === 'now' ? "'now'" : msg.scheduledTime})">JOIN MEETING</button>
                        </div>
                    </div>
                `;
            }
            
            div.innerHTML = `${contentHtml}<span class="timestamp">${time}</span>`;

            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // --- DAILY.CO ROOM CREATION ---
       async function createDailyRoom(roomName) {
    try {
        const response = await fetch('https://api.daily.co/v1/rooms', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${DAILY_API_KEY}`
            },
            body: JSON.stringify({
                name: roomName,
                privacy: 'public',
                properties: {
                    enable_chat: true,
                    enable_screenshare: true,
                    // enable_recording: 'cloud', <-- REMOVED this line to fix 400 error
                    start_video_off: false,
                    start_audio_off: false,
                    owner_only_broadcast: false,
                    enable_knocking: false,
                    enable_prejoin_ui: false,
                    max_participants: 10,
                    exp: Math.round(Date.now() / 1000) + 3600 // Room auto-deletes in 1 hour
                }
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            console.error('Daily API error details:', errorData);
            throw new Error(`Daily API error: ${response.status}`);
        }

        const room = await response.json();
        return room.url;
    } catch (error) {
        console.error('Error creating Daily room:', error);
        return null;
    }
}

        // --- MEETING LOGIC ---
        window.openMeetingModal = () => {
            document.getElementById('meetingSetupModal').style.display = 'flex';
        };
        window.closeMeetingModal = () => {
            document.getElementById('meetingSetupModal').style.display = 'none';
        };

        window.createMeeting = async () => {
            const title = document.getElementById('meetingTitle').value || "Quick Sync";
            const dateVal = document.getElementById('meetingDate').value;
            const timeVal = document.getElementById('meetingTime').value;
            
            let scheduledTime = 'now';
            let meetingId = `meet_${Date.now()}_${Math.floor(Math.random()*1000)}`;

            if (dateVal && timeVal) {
                scheduledTime = new Date(`${dateVal}T${timeVal}`).getTime();
            }

            // Create Daily.co room
            const roomUrl = await createDailyRoom(`scalevest-${meetingId}`);
            
            if (!roomUrl) {
                alert('Failed to create meeting room. Please try again.');
                return;
            }

            await push(ref(db, `Chats/${chatRoomID}`), {
                sender: currentUser.uid,
                type: 'meeting',
                title: title,
                meetingId: meetingId,
                roomUrl: roomUrl,
                scheduledTime: scheduledTime,
                timestamp: Date.now(),
                recipient: recipientUID
            });

            closeMeetingModal();
        };

        window.tryJoinMeeting = async (meetingId, roomUrl, scheduledTime) => {
            console.log("Trying to join meeting:", meetingId, roomUrl, scheduledTime);
            const now = Date.now();

            if (scheduledTime !== 'now' && now < (scheduledTime - 5 * 60 * 1000)) {
                const dateObj = new Date(scheduledTime);
                document.getElementById('waitDisplayTime').textContent = dateObj.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                document.getElementById('waitDisplayDate').textContent = dateObj.toLocaleDateString();
                document.getElementById('waitingRoomModal').style.display = 'flex';
                return;
            }

            document.getElementById('videoConferenceContainer').style.display = 'flex';
            document.getElementById('meetingLoader').style.display = 'flex';

            try {
                await loadDaily(roomUrl);
            } catch (err) {
                console.error("Daily.co error:", err);
                document.getElementById('videoConferenceContainer').style.display = 'none';
                alert("Failed to join meeting. Please try again.");
            }
        };

        async function loadDaily(roomUrl) {
            console.log("Loading Daily.co for room:", roomUrl);

            try {
                dailyCall = window.DailyIframe.createFrame(document.getElementById('dailyFrame'), {
                    showLeaveButton: false,
                    showFullscreenButton: true,
                    iframeStyle: {
                        position: 'absolute',
                        width: '100%',
                        height: '100%',
                        border: 0
                    }
                });

                await dailyCall.join({
                    url: roomUrl,
                    userName: userDisplayName
                });

                console.log("Daily call joined successfully");
                document.getElementById('meetingLoader').style.display = 'none';

                // Event listeners
                dailyCall.on('left-meeting', () => {
                    console.log("Left meeting");
                    closeVideoInterface();
                });

                dailyCall.on('error', (error) => {
                    console.error("Daily error:", error);
                    alert("Meeting error occurred");
                    closeVideoInterface();
                });

            } catch (err) {
                console.error("Daily initialization error:", err);
                throw err;
            }
        }

        // --- VIDEO CONTROLS ---
        window.toggleAudio = async () => {
            if(dailyCall) {
                audioMuted = !audioMuted;
                await dailyCall.setLocalAudio(!audioMuted);
                document.getElementById('btnMic').classList.toggle('active', audioMuted);
            }
        };

        window.toggleVideo = async () => {
            if(dailyCall) {
                videoMuted = !videoMuted;
                await dailyCall.setLocalVideo(!videoMuted);
                document.getElementById('btnCam').classList.toggle('active', videoMuted);
            }
        };

        window.leaveMeeting = async () => {
            if(dailyCall) {
                await dailyCall.leave();
                dailyCall.destroy();
            }
            closeVideoInterface();
        };

        window.endMeetingForAll = async () => {
            if(!confirm("End meeting for everyone?")) return;
            if(dailyCall) {
                await dailyCall.leave();
                dailyCall.destroy();
            }
            closeVideoInterface();
        };

        function closeVideoInterface() {
            document.getElementById('videoConferenceContainer').style.display = 'none';
            document.getElementById('dailyFrame').innerHTML = `
                <div id="meetingLoader">
                    <div class="loader-spinner"></div>
                    <div class="loader-text">Connecting to meeting...</div>
                </div>
            `;
            dailyCall = null;
            audioMuted = false;
            videoMuted = false;
            document.getElementById('btnMic').classList.remove('active');
            document.getElementById('btnCam').classList.remove('active');
        }

        // --- FILE UPLOAD ---
        const fileInput = document.getElementById('fileInput');
        const attachBtn = document.getElementById('attachBtn');

        attachBtn.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const progressBar = document.getElementById('uploadProgress');
            progressBar.style.width = '10%';

            try {
                const storagePath = `chat_uploads/${chatRoomID}/${Date.now()}_${file.name}`;
                const fileRef = storageRef(storage, storagePath);
                const uploadTask = uploadBytesResumable(fileRef, file);

                uploadTask.on('state_changed', 
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        progressBar.style.width = progress + '%';
                    }, 
                    (error) => {
                        console.error("Upload failed", error);
                        alert("File upload failed.");
                        progressBar.style.width = '0%';
                    }, 
                    async () => {
                        const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                        
                        let type = 'document';
                        if (file.type.startsWith('image/')) type = 'image';
                        else if (file.type.startsWith('video/')) type = 'video';

                        await push(ref(db, `Chats/${chatRoomID}`), {
                            sender: currentUser.uid,
                            text: "", 
                            fileUrl: downloadURL,
                            fileType: type,
                            fileName: file.name,
                            timestamp: Date.now(),
                            recipient: recipientUID
                        });

                        progressBar.style.width = '0%';
                        fileInput.value = '';
                    }
                );
            } catch (error) {
                console.error("Error", error);
                progressBar.style.width = '0%';
            }
        });

        // --- TEXT SEND ---
        const input = document.getElementById('msgInput');
        const sendBtn = document.getElementById('sendBtn');

        async function sendMessage() {
            const text = input.value.trim();
            if (!text || !chatRoomID) return;

            const badWords = ["abuse", "scam", "fraud", "kill", "idiot"];
            let cleanText = text;
            badWords.forEach(w => { cleanText = cleanText.replace(new RegExp(`\\b${w}\\b`,'gi'), '####'); });

            await push(ref(db, `Chats/${chatRoomID}`), {
                sender: currentUser.uid,
                text: cleanText,
                timestamp: Date.now(),
                recipient: recipientUID
            });
            input.value = "";
            set(ref(db, `Chats/${chatRoomID}/typing/${currentUser.uid}`), false);
        }
        
        input.addEventListener('input', () => {
            if (!chatRoomID) return;
            set(ref(db, `Chats/${chatRoomID}/typing/${currentUser.uid}`), true);
            if (typingTimeout) clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                set(ref(db, `Chats/${chatRoomID}/typing/${currentUser.uid}`), false);
            }, 2000);
        });

        sendBtn.addEventListener('click', sendMessage);
        input.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });

    </script>
</body>
</html>
