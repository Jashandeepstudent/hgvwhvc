<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Session | ScaleVest</title>
    <style>
        /* Reusing your ScaleVest Theme */
        body { font-family: 'SF Pro Display', -apple-system, sans-serif; background: #f8f9fa; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        
        /* HEADER */
        .chat-header {
            background: white; padding: 15px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex; align-items: center; justify-content: space-between; z-index: 100;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /* Circular Logo */
        .header-logo {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #e5e7eb;
        }

        .header-title { font-weight: 800; font-size: 1.2rem; color: #1a1a1a; }
        .header-sub { font-size: 0.85rem; color: #10b981; font-weight: 600; }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .action-btn {
            background: #f3f4f6;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: 0.2s;
            text-decoration: none;
        }
        
        .action-btn.meeting-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .action-btn:hover { transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* CHAT AREA */
        #chatContainer {
            flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px;
            position: relative;
            background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* SAFETY WARNING (EMPTY STATE) */
        .safety-warning {
            text-align: center;
            padding: 40px 20px;
            background: #fff;
            border-radius: 12px;
            margin: 20px auto;
            max-width: 80%;
            border: 1px dashed #ccc;
            color: #555;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03);
        }
        .safety-icon { font-size: 2rem; margin-bottom: 10px; display: block; }
        .safety-text { font-size: 0.95rem; line-height: 1.5; }
        .safety-text strong { color: #10b981; }

        /* MESSAGES */
        .message-bubble {
            max-width: 70%; padding: 12px 18px; border-radius: 18px; font-size: 15px; line-height: 1.5; position: relative; animation: popIn 0.3s ease;
            word-wrap: break-word;
        }
        .msg-mine {
            background: #10b981; color: white; align-self: flex-end; border-bottom-right-radius: 4px;
        }
        .msg-theirs {
            background: white; color: #374151; align-self: flex-start; border-bottom-left-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .timestamp { font-size: 10px; opacity: 0.7; margin-top: 5px; display: block; text-align: right; }
        
        /* MEETING CARD STYLE */
        .meeting-card {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            padding: 10px;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .msg-theirs .meeting-card { background: #f0fdf4; border-color: #10b981; color: #064e3b; }
        
        /* MEDIA STYLES */
        .chat-image {
            max-width: 100%; border-radius: 10px; margin-bottom: 5px; display: block; cursor: pointer;
        }
        .chat-video {
            max-width: 100%; border-radius: 10px; margin-bottom: 5px;
        }
        .file-attachment {
            display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.1); padding: 10px; border-radius: 8px; text-decoration: none; color: inherit; font-weight: 600; margin-bottom: 5px;
        }
        .msg-mine .file-attachment { color: white; background: rgba(255,255,255,0.2); }

        /* TYPING INDICATOR */
        .typing-indicator {
            align-self: flex-start; background: white; padding: 10px 15px; border-radius: 20px; border-bottom-left-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: none; align-items: center; gap: 5px; margin-bottom: 10px;
        }
        .dot { width: 6px; height: 6px; background: #bbb; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* INPUT AREA */
        .input-area { background: white; padding: 15px 20px; display: flex; gap: 12px; border-top: 1px solid #e5e7eb; align-items: center; }
        #attachBtn { background: #f3f4f6; color: #6b7280; border: none; padding: 10px; border-radius: 50%; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; width: 45px; height: 45px; }
        #attachBtn:hover { background: #e5e7eb; color: #1a1a1a; }
        #msgInput { flex: 1; padding: 15px; border: 2px solid #e5e7eb; border-radius: 12px; outline: none; font-size: 16px; transition: 0.3s; }
        #msgInput:focus { border-color: #10b981; }
        #sendBtn { background: #10b981; color: white; border: none; padding: 0 25px; border-radius: 12px; font-weight: 700; cursor: pointer; transition: 0.2s; height: 50px; }
        #sendBtn:hover { transform: scale(1.05); }

        /* LOADING OVERLAY */
        #initialLoader { position: absolute; top:0; left:0; width:100%; height:100%; background:#f8f9fa; z-index:50; display:flex; flex-direction:column; align-items:center; justify-content:center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #ddd; border-top: 4px solid #10b981; border-radius: 50%; animation: spin 1s infinite linear; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Upload Progress */
        #uploadProgress { position: fixed; top: 0; left: 0; width: 0%; height: 4px; background: #10b981; z-index: 200; transition: width 0.3s; }

        @keyframes popIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="uploadProgress"></div>

    <div class="chat-header">
        <div class="header-left">
            <img src="ScaleVestLogo.png" alt="SV" class="header-logo" onerror="this.src='https://via.placeholder.com/45?text=SV'"> 
            <div>
                <div class="header-title" id="chatTitle">Connecting...</div>
                <div class="header-sub">ScaleVest Secure Line</div>
            </div>
        </div>
        
        <div class="header-actions">
            <button class="action-btn meeting-btn" id="meetingBtn" onclick="sendMeetingRequest()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                Arrange Meeting
            </button>
            
            <a href="#" onclick="history.back()" class="back-btn">‚Üê Back</a>
        </div>
    </div>

    <div id="chatContainer">
        <div id="initialLoader">
            <div class="spinner"></div>
            <div style="margin-top:10px; color:#888; font-size:0.9rem;">Syncing History...</div>
        </div>

        <div id="safetyWarning" class="safety-warning" style="display:none;">
            <span class="safety-icon">üõ°Ô∏è</span>
            <div class="safety-text">
                <strong>ScaleVest has your back.</strong><br>
                Please do not open any suspicious links or share sensitive passwords.
                <br><br>
                <small style="color:#999">Messages are end-to-end encrypted.</small>
            </div>
        </div>

        <div class="typing-indicator" id="typingBubble">
            <div class="dot"></div><div class="dot"></div><div class="dot"></div>
        </div>
    </div>

    <div class="input-area">
        <button id="attachBtn" title="Attach File">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
            </svg>
        </button>
        <input type="file" id="fileInput" style="display: none;">

        <input type="text" id="msgInput" placeholder="Type a message..." autocomplete="off">
        <button id="sendBtn">SEND</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onChildAdded, get, set, onValue, query, orderByChild, startAfter } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyD6PdrKp2XLfRqjC587lMpdKTaWD4MBens",
            authDomain: "scalevest-163a0.firebaseapp.com",
            databaseURL: "https://scalevest-163a0-default-rtdb.firebaseio.com",
            projectId: "scalevest-163a0",
            storageBucket: "scalevest-163a0.firebasestorage.app",
            messagingSenderId: "938358950124",
            appId: "1:938358950124:web:043506aeaacea2a96bfdc9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const storage = getStorage(app);
        const auth = getAuth(app);

        // ABUSIVE WORDS LIST (Simple Bot Filter)
        const badWords = ["abuse", "scam", "fraud", "kill", "idiot", "stupid", "badword", "fake"];

        // GET PARAMS
        const params = new URLSearchParams(window.location.search);
        const recipientUID = params.get('recipient');
        let currentUser = null;
        let chatRoomID = null;
        let typingTimeout = null;
        let lastLoadedTimestamp = 0;

        // AUTH GUARD
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                if(!recipientUID) {
                    alert("No recipient specified.");
                    window.location.href = "dashboard.html";
                    return;
                }
                initializeChat();
            } else {
                window.location.href = "login3.html";
            }
        });

        async function initializeChat() {
            const participantIDs = [currentUser.uid, recipientUID].sort();
            chatRoomID = `chat_${participantIDs[0]}_${participantIDs[1]}`;

            // 1. FETCH HEADER NAME
            let chatTitle = "Chat";
            try {
                const founderSnap = await get(ref(db, `founderProfile/${recipientUID}`));
                if (founderSnap.exists()) {
                    chatTitle = founderSnap.val().founderUsername || "Founder";
                } else {
                    const investorSnap = await get(ref(db, `investorProfiles/${recipientUID}`));
                    if (investorSnap.exists()) {
                        chatTitle = investorSnap.val().fullName || "Investor"; 
                    }
                }
            } catch (e) { console.error(e); }
            document.getElementById('chatTitle').textContent = chatTitle;

            // 2. BULK LOAD HISTORY
            const messagesRef = ref(db, `Chats/${chatRoomID}`);
            
            try {
                const snapshot = await get(messagesRef);
                const loader = document.getElementById('initialLoader');
                const warning = document.getElementById('safetyWarning');

                if (snapshot.exists()) {
                    const data = snapshot.val();
                    const messages = [];

                    Object.values(data).forEach(msg => {
                        if (msg.sender && msg.timestamp) {
                            messages.push(msg);
                        }
                    });

                    messages.sort((a, b) => a.timestamp - b.timestamp);

                    messages.forEach(msg => {
                        renderMessage(msg, false); 
                        lastLoadedTimestamp = msg.timestamp;
                    });

                    const container = document.getElementById('chatContainer');
                    container.scrollTop = container.scrollHeight;
                    if(messages.length > 0) warning.style.display = 'none';
                } else {
                    warning.style.display = 'block';
                }
                loader.style.display = 'none';

            } catch (e) {
                console.error("Chat Load Error", e);
                document.getElementById('initialLoader').innerHTML = "Error loading chat.";
            }

            // 3. LISTEN FOR *NEW* MESSAGES
            const newMsgQuery = query(messagesRef, orderByChild('timestamp'), startAfter(lastLoadedTimestamp));
            onChildAdded(newMsgQuery, (snapshot) => {
                const msg = snapshot.val();
                if(msg && msg.timestamp > lastLoadedTimestamp) { 
                    renderMessage(msg, true); 
                    lastLoadedTimestamp = msg.timestamp; 
                }
            });

            // 4. LISTEN FOR TYPING
            const typingRef = ref(db, `Chats/${chatRoomID}/typing/${recipientUID}`);
            onValue(typingRef, (snapshot) => {
                const isTyping = snapshot.val();
                const bubble = document.getElementById('typingBubble');
                const container = document.getElementById('chatContainer');
                
                if (isTyping) {
                    bubble.style.display = 'flex';
                    container.appendChild(bubble); 
                    container.scrollTop = container.scrollHeight;
                } else {
                    bubble.style.display = 'none';
                }
            });
        }

        // --- FILTER FUNCTION (BOT) ---
        function sanitizeMessage(text) {
            let cleanText = text;
            badWords.forEach(word => {
                const regex = new RegExp(`\\b${word}\\b`, 'gi');
                cleanText = cleanText.replace(regex, '####');
            });
            return cleanText;
        }

        // --- NEW: SEND MEETING REQUEST ---
        window.sendMeetingRequest = async function() {
            if(!confirm("Send a meeting invitation to this user?")) return;

            const text = "üìÖ I'd like to arrange a meeting to discuss this opportunity further.";
            
            // Send special message
            await push(ref(db, `Chats/${chatRoomID}`), {
                sender: currentUser.uid,
                text: text,
                isMeetingRequest: true, // Special flag
                timestamp: Date.now(),
                recipient: recipientUID
            });

            const container = document.getElementById('chatContainer');
            container.scrollTop = container.scrollHeight;
        };

        // --- RENDER UI ---
        function renderMessage(msg, autoScroll) {
            const container = document.getElementById('chatContainer');
            const warning = document.getElementById('safetyWarning');
            const bubble = document.getElementById('typingBubble');
            
            if (warning) warning.style.display = 'none';

            const isMine = msg.sender === currentUser.uid;
            
            const div = document.createElement('div');
            div.className = `message-bubble ${isMine ? 'msg-mine' : 'msg-theirs'}`;
            
            const time = new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            // Handle Content Type
            let contentHtml = "";

            if (msg.fileType === 'image') {
                contentHtml = `<img src="${msg.fileUrl}" class="chat-image" onclick="window.open('${msg.fileUrl}')">`;
            } else if (msg.fileType === 'video') {
                contentHtml = `<video src="${msg.fileUrl}" class="chat-video" controls></video>`;
            } else if (msg.fileType === 'document') {
                contentHtml = `
                    <a href="${msg.fileUrl}" target="_blank" class="file-attachment">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>
                        ${msg.fileName || 'Document'}
                    </a>
                `;
            }

            if (msg.text) {
                contentHtml += `<div>${msg.text}</div>`;
            }

            // Special Meeting Style
            if (msg.isMeetingRequest) {
                contentHtml += `
                    <div class="meeting-card">
                        <span style="font-size:1.5rem">üìÖ</span>
                        <div>
                            <strong>Meeting Invitation</strong>
                            <div style="font-size:0.8rem; opacity:0.8">Let's connect soon.</div>
                        </div>
                    </div>
                `;
            }
            
            div.innerHTML = `
                ${contentHtml}
                <span class="timestamp">${time}</span>
            `;
            
            // Insert Logic
            if (bubble && container.contains(bubble)) {
                container.insertBefore(div, bubble);
            } else {
                container.appendChild(div);
            }
            
            if(autoScroll) container.scrollTop = container.scrollHeight;
        }

        // --- FILE UPLOAD LOGIC ---
        const fileInput = document.getElementById('fileInput');
        const attachBtn = document.getElementById('attachBtn');

        attachBtn.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const progressBar = document.getElementById('uploadProgress');
            progressBar.style.width = '10%';

            try {
                const storagePath = `chat_uploads/${chatRoomID}/${Date.now()}_${file.name}`;
                const fileRef = storageRef(storage, storagePath);
                const uploadTask = uploadBytesResumable(fileRef, file);

                uploadTask.on('state_changed', 
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        progressBar.style.width = progress + '%';
                    }, 
                    (error) => {
                        console.error("Upload failed", error);
                        alert("File upload failed.");
                        progressBar.style.width = '0%';
                    }, 
                    async () => {
                        const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                        
                        let type = 'document';
                        if (file.type.startsWith('image/')) type = 'image';
                        else if (file.type.startsWith('video/')) type = 'video';

                        await push(ref(db, `Chats/${chatRoomID}`), {
                            sender: currentUser.uid,
                            text: "", 
                            fileUrl: downloadURL,
                            fileType: type,
                            fileName: file.name,
                            timestamp: Date.now(),
                            recipient: recipientUID
                        });

                        progressBar.style.width = '0%'; 
                    }
                );
            } catch (error) {
                console.error("Error", error);
            }
        });

        // --- TEXT SEND LOGIC ---
        const input = document.getElementById('msgInput');
        const sendBtn = document.getElementById('sendBtn');

        async function sendMessage() {
            const rawText = input.value.trim();
            if (!rawText || !chatRoomID) return;

            const cleanText = sanitizeMessage(rawText);

            const messagesRef = ref(db, `Chats/${chatRoomID}`);
            await push(messagesRef, {
                sender: currentUser.uid,
                text: cleanText,
                timestamp: Date.now(),
                recipient: recipientUID 
            });

            input.value = ""; 
            input.focus();
            set(ref(db, `Chats/${chatRoomID}/typing/${currentUser.uid}`), false);
        }

        // TYPING LOGIC
        input.addEventListener('input', () => {
            if (!chatRoomID) return;
            set(ref(db, `Chats/${chatRoomID}/typing/${currentUser.uid}`), true);
            if (typingTimeout) clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                set(ref(db, `Chats/${chatRoomID}/typing/${currentUser.uid}`), false);
            }, 2000);
        });

        sendBtn.addEventListener('click', sendMessage);
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

    </script>
</body>
</html>
