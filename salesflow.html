<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ScalVest Enterprise â€“ Zero-Bug Engine</title>
    <style>
        :root { --bg: #000; --card: #111; --blue: #2563eb; --green: #10b981; --red: #ef4444; --text: #fff; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; padding: 20px; }
        .container { max-width: 1100px; margin: auto; }
        
        /* Dashboard Stats */
        .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-box { background: var(--card); padding: 25px; border-radius: 20px; border: 1px solid #222; text-align: center; }
        .stat-box h2 { font-size: 12px; color: #888; text-transform: uppercase; margin: 0; }
        .stat-box div { font-size: 28px; font-weight: 700; margin-top: 10px; }
        .val-spend { color: var(--red); }
        .val-earn { color: var(--green); }
        .val-stock { color: #f59e0b; }

        /* Management Table */
        .inventory-card { background: var(--card); padding: 30px; border-radius: 24px; border: 1px solid #222; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; color: #555; font-size: 12px; padding: 15px; border-bottom: 1px solid #222; }
        td { padding: 15px; border-bottom: 1px solid #222; }
        
        input { background: #1a1a1a; border: 1px solid #333; color: #fff; padding: 10px; border-radius: 10px; outline: none; width: 120px; }
        input:focus { border-color: var(--blue); }
        .qty-input { width: 70px; text-align: center; font-weight: bold; border-color: #444; }
    </style>
</head>
<body>

<div class="container">
    <div class="stats">
        <div class="stat-box"><h2>Total Spend (Purchases)</h2><div id="dispSpend" class="val-spend">0</div></div>
        <div class="stat-box"><h2>Total Earned (Sales)</h2><div id="dispEarned" class="val-earn">0</div></div>
        <div class="stat-box"><h2>Net Stock Value</h2><div id="dispStock" class="val-stock">0</div></div>
    </div>

    <div class="inventory-card">
        <h3 style="margin-top:0">Inventory Intelligence</h3>
        <table>
            <thead>
                <tr><th>Product</th><th>Qty</th><th>Buy Price</th><th>Sell Price</th><th>Action</th></tr>
            </thead>
            <tbody id="inventoryBody"></tbody>
        </table>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyD6PdrKp2XLfRqjC587lMpdKTaWD4MBens",
        authDomain: "scalevest-163a0.firebaseapp.com",
        databaseURL: "https://scalevest-163a0-default-rtdb.firebaseio.com",
        projectId: "scalevest-163a0",
        storageBucket: "scalevest-163a0.firebasestorage.app",
        messagingSenderId: "938358950124",
        appId: "1:938358950124:web:043506aeaacea2a96bfdc9"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    let uID, currency = "USD";
    let inventoryData = {};

    // 1. THE AUDITOR: Strips symbols and returns a pure number
    const toNum = (v) => {
        if (!v) return 0;
        const n = parseFloat(v.toString().replace(/[^0-9.]/g, ''));
        return isNaN(n) ? 0 : n;
    };

    auth.onAuthStateChanged(user => {
        if (!user) return;
        uID = user.uid;

        // Sync Currency
        db.ref(`BusinessOwners/${uID}/nationalCurrency`).on('value', s => { currency = s.val() || "USD"; });

        // MASTER LISTENER: Listens to EVERYTHING
        db.ref(`Businesses/${uID}/inventory`).on('value', snap => {
            inventoryData = snap.val() || {};
            calculateEverything(); // Every change triggers a fresh calculation
            renderTable();
        });
    });

    function calculateEverything() {
        let totalPurchasedValue = 0;  // Sum of (Qty * Cost) representing total money spent
        let totalSoldValue = 0;       // We will track sales based on manual decrement triggers
        let currentStockValue = 0;    // Value of items currently on shelf

        // We fetch the current "Earned" from the DB because sales are historical
        db.ref(`BusinessOwners/${uID}/totalEarned`).once('value', s => {
            let earned = s.val() || 0;
            document.getElementById('dispEarned').innerText = `${currency} ${earned.toLocaleString()}`;
        });

        // Calculate Spend & Stock
        Object.values(inventoryData).forEach(item => {
            const q = toNum(item.quantity);
            const c = toNum(item.costPrice);
            totalPurchasedValue += (q * c);
            currentStockValue += (q * c);
        });

        // AUTOMATICALLY FIX TOTAL SPEND IN DB
        db.ref(`BusinessOwners/${uID}`).update({ totalSpend: totalPurchasedValue });

        document.getElementById('dispSpend').innerText = `${currency} ${totalPurchasedValue.toLocaleString()}`;
        document.getElementById('dispStock').innerText = `${currency} ${currentStockValue.toLocaleString()}`;
    }

    function renderTable() {
        const tbody = document.getElementById('inventoryBody');
        tbody.innerHTML = "";
        Object.keys(inventoryData).forEach(id => {
            const item = inventoryData[id];
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><b>${item.name || id}</b></td>
                <td><input type="number" class="qty-input" value="${item.quantity}" onchange="updateQty('${id}', this.value, ${item.quantity})"></td>
                <td><input type="text" value="${item.costPrice || ''}" onchange="updateVal('${id}', 'costPrice', this.value)"></td>
                <td><input type="text" value="${item.sellingPrice || ''}" onchange="updateVal('${id}', 'sellingPrice', this.value)"></td>
                <td><button onclick="recordSale('${id}')" style="background:var(--green); border:none; color:#fff; padding:5px 10px; border-radius:5px; cursor:pointer;">Sold 1</button></td>
            `;
            tbody.appendChild(tr);
        });
    }

    function updateVal(id, field, val) {
        db.ref(`Businesses/${uID}/inventory/${id}`).update({ [field]: val });
    }

    function updateQty(id, newVal, oldVal) {
        const n = toNum(newVal);
        const o = toNum(oldVal);
        
        // If we decrease quantity, we assume it was a SALE
        if (n < o) {
            const diff = o - n;
            const item = inventoryData[id];
            const sellPrice = toNum(item.sellingPrice);
            const revenue = diff * sellPrice;

            db.ref(`BusinessOwners/${uID}/totalEarned`).transaction(current => (current || 0) + revenue);
        }
        
        db.ref(`Businesses/${uID}/inventory/${id}`).update({ quantity: n });
    }

    function recordSale(id) {
        const item = inventoryData[id];
        const currentQty = toNum(item.quantity);
        if (currentQty > 0) {
            updateQty(id, currentQty - 1, currentQty);
        }
    }
</script>
</body>
</html>
