<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScalVest Enterprise Hub</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #000000; --card: #111827; --primary: #2563eb;
            --success: #10b981; --danger: #ef4444; --text: #ffffff;
        }
        body {
            background: var(--bg); color: var(--text);
            font-family: 'Inter', sans-serif; margin: 0; padding: 20px;
        }
        .container { max-width: 1200px; margin: auto; }
        
        /* DASHBOARD GRID */
        .dashboard {
            display: grid; grid-template-columns: repeat(3, 1fr);
            gap: 25px; margin-bottom: 40px;
        }
        .stat-card {
            background: var(--card); border: 1px solid #1f2937;
            padding: 30px; border-radius: 24px; text-align: center;
            transition: all 0.3s ease;
        }
        .stat-card:hover { border-color: var(--primary); transform: translateY(-5px); }
        .stat-card h2 { font-size: 13px; text-transform: uppercase; color: #9ca3af; margin: 0; }
        .stat-card .amount { font-size: 32px; font-weight: 700; margin-top: 12px; }
        
        .spend-val { color: var(--danger); }
        .earn-val { color: var(--success); }
        .stock-val { color: #f59e0b; }

        /* TABLE STYLING */
        .inventory-wrapper {
            background: var(--card); border-radius: 28px;
            padding: 35px; border: 1px solid #1f2937;
        }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px; color: #6b7280; font-size: 12px; text-transform: uppercase; }
        td { padding: 18px 15px; border-bottom: 1px solid #1f2937; }

        input {
            background: #1f2937; border: 1px solid #374151; color: white;
            padding: 10px 14px; border-radius: 12px; outline: none; transition: 0.2s;
        }
        input:focus { border-color: var(--primary); background: #262f3f; }
        .qty-input { width: 80px; text-align: center; font-weight: 600; }
        .price-input { width: 140px; }

        /* NO DATA PLACEHOLDER */
        .empty-state { text-align: center; padding: 50px; color: #4b5563; }
    </style>
</head>
<body>

<div class="container">
    <div class="dashboard">
        <div class="stat-card">
            <h2>Total Spend</h2>
            <div id="dispSpend" class="amount spend-val">0.00</div>
        </div>
        <div class="stat-card">
            <h2>Total Earned</h2>
            <div id="dispEarned" class="amount earn-val">0.00</div>
        </div>
        <div class="stat-card">
            <h2>Current Stock Value</h2>
            <div id="dispStock" class="amount stock-val">0.00</div>
        </div>
    </div>

    <div class="inventory-wrapper">
        <h3 style="margin-top:0; margin-bottom:25px;">Live Inventory Management</h3>
        <table>
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Current Qty</th>
                    <th>Cost Price (Buy)</th>
                    <th>Selling Price (Sell)</th>
                </tr>
            </thead>
            <tbody id="inventoryBody">
                </tbody>
        </table>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

<script>
    // CORE FIREBASE INITIALIZATION
    const firebaseConfig = {
        apiKey: "AIzaSyD6PdrKp2XLfRqjC587lMpdKTaWD4MBens",
        authDomain: "scalevest-163a0.firebaseapp.com",
        databaseURL: "https://scalevest-163a0-default-rtdb.firebaseio.com",
        projectId: "scalevest-163a0",
        storageBucket: "scalevest-163a0.firebasestorage.app",
        messagingSenderId: "938358950124",
        appId: "1:938358950124:web:043506aeaacea2a96bfdc9"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    let uID, currency = "USD", globalSpend = 0, globalEarned = 0, inventory = {};

    // THE AUDITOR: Deep Analysis Utility
    const cleanNumber = (val) => {
        if (!val) return 0;
        // Removes anything that isn't a digit or a decimal point
        const sanitized = val.toString().replace(/[^0-9.]/g, '');
        const num = parseFloat(sanitized);
        return isNaN(num) ? 0 : num;
    };

    auth.onAuthStateChanged(user => {
        if (!user) return;
        uID = user.uid;

        // 1. WATCHER: Business Meta
        db.ref(`BusinessOwners/${uID}`).on('value', snap => {
            const data = snap.val() || {};
            currency = data.nationalCurrency || "USD";
            globalSpend = data.totalSpend || 0;
            globalEarned = data.totalEarned || 0;
            updateDashboardUI();
        });

        // 2. WATCHER: Inventory Data
        db.ref(`Businesses/${uID}/inventory`).on('value', snap => {
            inventory = snap.val() || {};
            renderInventoryTable();
            updateDashboardUI(); // Immediate recalculation of Stock Value
        });
    });

    function updateDashboardUI() {
        // Recalculate Stock Value locally for real-time precision
        let currentStockTotal = 0;
        Object.values(inventory).forEach(item => {
            const q = cleanNumber(item.quantity);
            const c = cleanNumber(item.costPrice);
            currentStockTotal += (q * c);
        });

        document.getElementById('dispSpend').innerText = `${currency} ${globalSpend.toLocaleString(undefined, {minimumFractionDigits:2})}`;
        document.getElementById('dispEarned').innerText = `${currency} ${globalEarned.toLocaleString(undefined, {minimumFractionDigits:2})}`;
        document.getElementById('dispStock').innerText = `${currency} ${currentStockTotal.toLocaleString(undefined, {minimumFractionDigits:2})}`;
    }

    function renderInventoryTable() {
        const tbody = document.getElementById('inventoryBody');
        let tableHTML = "";
        
        Object.keys(inventory).forEach(prodID => {
            const item = inventory[prodID];
            tableHTML += `
                <tr>
                    <td><strong style="color:var(--primary)">${item.name || prodID}</strong></td>
                    <td>
                        <input type="number" class="qty-input" value="${item.quantity || 0}" 
                        onchange="handleQuantityChange('${prodID}', this.value, ${item.quantity || 0})">
                    </td>
                    <td>
                        <input type="text" class="price-input" value="${item.costPrice || ''}" 
                        onchange="syncField('${prodID}', 'costPrice', this.value)">
                    </td>
                    <td>
                        <input type="text" class="price-input" value="${item.sellingPrice || ''}" 
                        onchange="syncField('${prodID}', 'sellingPrice', this.value)">
                    </td>
                </tr>
            `;
        });
        tbody.innerHTML = tableHTML || `<tr><td colspan="4" class="empty-state">No products found in database.</td></tr>`;
    }

    // UPDATE FIELD: Standard sync
    function syncField(id, field, val) {
        db.ref(`Businesses/${uID}/inventory/${id}`).update({ [field]: val });
    }

    // QUANTITY LOGIC: The Financial Engine
    function handleQuantityChange(id, newValue, oldValue) {
        const nVal = cleanNumber(newValue);
        const oVal = cleanNumber(oldValue);
        const diff = nVal - oVal;

        const item = inventory[id];
        const cost = cleanNumber(item.costPrice);
        const sell = cleanNumber(item.sellingPrice);

        const updates = {};
        
        if (diff > 0) {
            // STOCK PURCHASE: Increase Total Spend
            const purchaseCost = diff * cost;
            updates[`BusinessOwners/${uID}/totalSpend`] = globalSpend + purchaseCost;
        } else if (diff < 0) {
            // STOCK SALE: Increase Total Earned
            const revenue = Math.abs(diff) * sell;
            updates[`BusinessOwners/${uID}/totalEarned`] = globalEarned + revenue;
        }

        // Save new quantity
        updates[`Businesses/${uID}/inventory/${id}/quantity`] = nVal;

        // Perform atomic update to prevent desync
        db.ref().update(updates).then(() => {
            console.log("System Synced Successfully.");
        }).catch(e => alert("Database Error: Check Rules."));
    }
</script>

</body>
</html>
