<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ScalVest Enterprise â€“ Unified Hub</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #f6f7fb; --card: #ffffff; --primary: #7c3aed; --success: #10b981; --danger: #ef4444; --text: #1e293b; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; padding: 20px; }
        .container { max-width: 1200px; margin: auto; }

        /* Dashboard Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--card); padding: 25px; border-radius: 24px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); transition: 0.3s; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-label { font-size: 12px; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-val { font-size: 28px; font-weight: 800; margin-top: 10px; }
        .spend { color: var(--danger); }
        .earned { color: var(--success); }
        .stock { color: #f59e0b; }

        /* Inventory Table */
        .inventory-wrapper { background: var(--card); border-radius: 24px; padding: 25px; border: 1px solid #e2e8f0; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px; color: #64748b; font-size: 13px; border-bottom: 2px solid #f1f5f9; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }

        /* Inputs & Buttons */
        input { background: #f8fafc; border: 1px solid #e2e8f0; padding: 10px; border-radius: 12px; outline: none; transition: 0.2s; }
        input:focus { border-color: var(--primary); background: #fff; }
        .qty-btn { width: 35px; height: 35px; border-radius: 10px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-plus { background: #f5f3ff; color: var(--primary); }
        .btn-minus { background: #fef2f2; color: var(--danger); }
        .btn-plus:hover { background: var(--primary); color: #fff; }
        .btn-minus:hover { background: var(--danger); color: #fff; }
        
        .nav-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .action-btns { display: flex; gap: 10px; }
        .btn-main { background: #000; color: #fff; padding: 12px 20px; border-radius: 14px; border: none; font-weight: 600; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <div class="nav-header">
        <h2>Enterprise Management</h2>
        <div class="action-btns">
            <button class="btn-main" onclick="location.reload()">ðŸ”„ Refresh Sync</button>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <span class="stat-label">Total Investment (Spent)</span>
            <div id="dispSpend" class="stat-val spend">0.00</div>
        </div>
        <div class="stat-card">
            <span class="stat-label">Total Revenue (Earned)</span>
            <div id="dispEarned" class="stat-val earned">0.00</div>
        </div>
        <div class="stat-card">
            <span class="stat-label">Net Asset Value (Stock)</span>
            <div id="dispStock" class="stat-val stock">0.00</div>
        </div>
    </div>

    <div class="inventory-wrapper">
        <table>
            <thead>
                <tr>
                    <th>Product Identity</th>
                    <th>Current Qty</th>
                    <th>Buy Price</th>
                    <th>Sell Price</th>
                    <th style="text-align: right;">Quick Actions</th>
                </tr>
            </thead>
            <tbody id="inventoryBody">
                </tbody>
        </table>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyD6PdrKp2XLfRqjC587lMpdKTaWD4MBens",
        authDomain: "scalevest-163a0.firebaseapp.com",
        databaseURL: "https://scalevest-163a0-default-rtdb.firebaseio.com",
        projectId: "scalevest-163a0",
        storageBucket: "scalevest-163a0.firebasestorage.app",
        messagingSenderId: "938358950124",
        appId: "1:938358950124:web:043506aeaacea2a96bfdc9"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    let uID, currency = "USD", inventory = {};

    const toNum = (v) => {
        if (!v) return 0;
        const n = parseFloat(v.toString().replace(/[^0-9.]/g, ''));
        return isNaN(n) ? 0 : n;
    };

    auth.onAuthStateChanged(user => {
        if (!user) return;
        uID = user.uid;

        // 1. Listen for Currency & Financial Totals
        db.ref(`BusinessOwners/${uID}`).on('value', snap => {
            const data = snap.val() || {};
            currency = data.nationalCurrency || "USD";
            const spend = data.totalSpend || 0;
            const earned = data.totalEarned || 0;
            
            document.getElementById('dispSpend').innerText = `${currency} ${spend.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
            document.getElementById('dispEarned').innerText = `${currency} ${earned.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
        });

        // 2. Listen for Inventory & Calculate Stock Value
        db.ref(`Businesses/${uID}/inventory`).on('value', snap => {
            inventory = snap.val() || {};
            renderTable();
            calculateStockValue();
        });
    });

    function calculateStockValue() {
        let totalStock = 0;
        Object.values(inventory).forEach(item => {
            totalStock += (toNum(item.quantity) * toNum(item.costPrice));
        });
        document.getElementById('dispStock').innerText = `${currency} ${totalStock.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
    }

    function renderTable() {
        const tbody = document.getElementById('inventoryBody');
        tbody.innerHTML = "";
        Object.keys(inventory).forEach(id => {
            const item = inventory[id];
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><strong style="color:#1e293b">${item.name || id}</strong></td>
                <td>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <button class="qty-btn btn-minus" onclick="changeQty('${id}', -1)">-</button>
                        <span style="font-weight:800; width:30px; text-align:center;">${item.quantity}</span>
                        <button class="qty-btn btn-plus" onclick="changeQty('${id}', 1)">+</button>
                    </div>
                </td>
                <td><input type="text" value="${item.costPrice || ''}" onchange="updateField('${id}', 'costPrice', this.value)" style="width:80px"></td>
                <td><input type="text" value="${item.sellingPrice || ''}" onchange="updateField('${id}', 'sellingPrice', this.value)" style="width:80px"></td>
                <td style="text-align: right;">
                    <button onclick="deleteProduct('${id}')" style="background:none; border:none; color:var(--danger); cursor:pointer; font-weight:600;">Remove</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function updateField(id, field, val) {
        db.ref(`Businesses/${uID}/inventory/${id}`).update({ [field]: val });
    }

    function changeQty(id, delta) {
        const item = inventory[id];
        const oldQty = toNum(item.quantity);
        const newQty = Math.max(0, oldQty + delta);
        const cost = toNum(item.costPrice);
        const sell = toNum(item.sellingPrice);

        const updates = {};
        updates[`Businesses/${uID}/inventory/${id}/quantity`] = newQty;

        if (delta > 0) {
            // STOCK PURCHASE: Update Total Spend (Investment)
            db.ref(`BusinessOwners/${uID}/totalSpend`).transaction(current => (current || 0) + (Math.abs(delta) * cost));
        } else if (delta < 0 && oldQty > 0) {
            // STOCK SALE: Update Total Earned (Revenue)
            db.ref(`BusinessOwners/${uID}/totalEarned`).transaction(current => (current || 0) + (Math.abs(delta) * sell));
        }

        db.ref().update(updates);
    }

    function deleteProduct(id) {
        if(confirm("Permanently delete this item from records?")) {
            db.ref(`Businesses/${uID}/inventory/${id}`).remove();
        }
    }
</script>
</body>
</html>
