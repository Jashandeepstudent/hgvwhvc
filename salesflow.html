<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ScaleVest - SalesFlow</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
* { box-sizing: border-box; font-family: Inter, sans-serif; }
body { 
  margin: 0; 
  background: #f6f7fb; 
  padding: 20px; 
  overflow-x: hidden;
}

.top {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30px;
  flex-wrap: wrap;
  gap: 15px;
}

.back-nav-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 38px;
  height: 38px;
  background: white;
  border: 1px solid #e2e8f0;
  border-radius: 12px;
  color: #1e293b;
  text-decoration: none;
  transition: all 0.2s ease;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.back-nav-btn:hover {
  background: #f5f3ff;
  border-color: #7c3aed;
  color: #7c3aed;
  transform: translateX(-3px);
}

h2 {
  margin: 0;
  font-size: 26px;
  font-weight: 800;
  color: #1e293b;
}

/* Performance Chart Section */
.chart-section {
  background: white;
  padding: 30px;
  border-radius: 24px;
  border: 1px solid #f1f5f9;
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
  margin-bottom: 30px;
}

.chart-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  flex-wrap: wrap;
  gap: 10px;
}

.chart-title {
  font-size: 18px;
  font-weight: 700;
  color: #1e293b;
  margin: 0;
}

#performanceChart {
  max-height: 300px;
}

/* Metric Grid - 4 Column Clean Layout */
.metric-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 20px;
  margin-bottom: 30px;
}

.metric-card {
  background: white;
  padding: 24px;
  border-radius: 20px;
  border: 1px solid #f1f5f9;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  position: relative;
  overflow: hidden;
}

.metric-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 12px 24px rgba(0, 0, 0, 0.08);
}

.metric-label {
  font-size: 12px;
  font-weight: 600;
  color: #64748b;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  margin-bottom: 12px;
  display: block;
}

.metric-value {
  font-size: 32px;
  font-weight: 800;
  color: #1e293b;
  margin-bottom: 12px;
  line-height: 1.2;
}

.metric-sub {
  font-size: 12px;
  color: #94a3b8;
  font-weight: 500;
  margin-bottom: 12px;
}

/* Comparison Badge - Pill Style */
.comparison-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 6px 12px;
  border-radius: 50px;
  font-size: 11px;
  font-weight: 700;
  margin-top: 8px;
  letter-spacing: 0.3px;
}

.comparison-up {
  background: rgba(16, 185, 129, 0.1);
  color: #059669;
}

.comparison-down {
  background: rgba(239, 68, 68, 0.1);
  color: #dc2626;
}

.comparison-neutral {
  background: rgba(148, 163, 184, 0.1);
  color: #64748b;
}

/* Margin Gauge Bar */
.margin-gauge {
  margin-top: 16px;
  padding-top: 12px;
  border-top: 1px solid #f1f5f9;
}

.margin-label {
  font-size: 11px;
  font-weight: 600;
  color: #64748b;
  margin-bottom: 8px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.margin-bar {
  height: 8px;
  background: #f1f5f9;
  border-radius: 50px;
  overflow: hidden;
  position: relative;
}

.margin-fill {
  height: 100%;
  border-radius: 50px;
  transition: width 0.5s ease, background 0.3s ease;
}

.margin-profit {
  background: linear-gradient(90deg, #10b981, #059669);
}

.margin-loss {
  background: linear-gradient(90deg, #ef4444, #dc2626);
}

/* Products Table */
.products-wrapper {
  background: white;
  border-radius: 24px;
  border: 1px solid #f1f5f9;
  box-shadow: 0 4px 20px rgba(0,0,0,0.03);
  overflow: hidden;
}

.products-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 24px;
  border-bottom: 1px solid #f1f5f9;
}

.products-header h3 {
  margin: 0;
  font-size: 18px;
  font-weight: 700;
  color: #1e293b;
}

.btn-download {
  padding: 12px 20px;
  background: #7c3aed;
  color: white;
  border: none;
  border-radius: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-download:hover {
  background: #6d28d9;
  transform: translateY(-2px);
}

.grid-header {
  display: grid;
  grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
  background: #f8fafc;
  padding: 16px 24px;
  border-bottom: 1px solid #f1f5f9;
  color: #64748b;
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.grid-body {
  max-height: 50vh;
  overflow-y: auto;
}

.product-row {
  display: grid;
  grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
  align-items: center;
  padding: 18px 24px;
  border-bottom: 1px solid #f8fafc;
  transition: all 0.2s ease;
}

.product-row:hover {
  background-color: #f5f3ff;
}

.product-row:last-child { border-bottom: none; }

.product-name {
  font-weight: 600;
  color: #1e293b;
}

.product-qty {
  font-weight: 600;
  color: #64748b;
}

.set-btn {
  padding: 8px 16px;
  background: #7c3aed;
  color: white;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  font-size: 12px;
  transition: all 0.2s;
}

.set-btn:hover {
  background: #6d28d9;
  transform: scale(1.05);
}

/* Modal */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  backdrop-filter: blur(8px);
}

.modal-box {
  background: white;
  padding: 35px;
  border-radius: 28px;
  width: 90%;
  max-width: 400px;
  text-align: center;
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
}

.modal-box h3 {
  margin: 0 0 10px 0;
  font-size: 20px;
  font-weight: 700;
}

.modal-box p {
  color: #64748b;
  margin-bottom: 20px;
}

.price-inputs {
  display: grid;
  gap: 15px;
  margin: 20px 0;
}

.input-group {
  text-align: left;
}

.input-group label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  color: #64748b;
  margin-bottom: 8px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.input-group input {
  width: 100%;
  padding: 14px;
  border: 1px solid #e2e8f0;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 600;
  transition: all 0.2s;
}

.input-group input:focus {
  outline: none;
  border-color: #7c3aed;
  box-shadow: 0 0 0 4px rgba(124, 58, 237, 0.1);
}

.modal-actions {
  display: grid;
  grid-template-columns: 1fr 2fr;
  gap: 12px;
  margin-top: 20px;
}

.btn-cancel {
  padding: 12px;
  background: #f1f5f9;
  color: #64748b;
  border: none;
  border-radius: 12px;
  font-weight: 600;
  cursor: pointer;
}

.btn-save {
  padding: 12px;
  background: #7c3aed;
  color: white;
  border: none;
  border-radius: 12px;
  font-weight: 600;
  cursor: pointer;
}

.btn-save:hover { background: #6d28d9; }

.success-popup {
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%);
  background: #10b981;
  color: white;
  padding: 14px 28px;
  border-radius: 50px;
  font-weight: 600;
  display: none;
  z-index: 3000;
  box-shadow: 0 10px 20px rgba(0,0,0,0.2);
  animation: slideUp 0.3s ease;
}

@keyframes slideUp {
  from { bottom: -50px; opacity: 0; }
  to { bottom: 30px; opacity: 1; }
}

/* Responsive Design */
@media (max-width: 1200px) {
  .metric-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 768px) {
  .metric-grid {
    grid-template-columns: 1fr;
  }
  
  .chart-section {
    padding: 20px;
  }
  
  .metric-value {
    font-size: 28px;
  }
  
  .grid-header { display: none; }
  
  .product-row {
    grid-template-columns: 1fr;
    gap: 10px;
    padding: 15px;
  }
}
</style>
</head>

<body>

<div id="successPopup" class="success-popup">Prices Updated!</div>

<div class="top">
  <div style="display: flex; align-items: center; gap: 15px;">
    <a href="inventory.html" class="back-nav-btn">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
        <line x1="19" y1="12" x2="5" y2="12"/>
        <polyline points="12 19 5 12 12 5"/>
      </svg>
    </a>
    <h2>üí∞ Financial Dashboard</h2>
  </div>

  <div class="filter-container" style="position: relative;">
    <span style="font-size: 13px; font-weight: 600; color: #64748b; margin-right: 8px;">Period:</span>
    <select id="timeFilter" onchange="calculateFinancials()" style="padding: 10px 15px; border-radius: 12px; border: 1px solid #e2e8f0; background: white; font-weight: 600; color: #1e293b; cursor: pointer; outline: none;">
      <option value="all">All Time</option>
      <option value="today">Today</option>
      <option value="yesterday">Yesterday</option>
      <option value="week">This Week</option>
      <option value="lastWeek">Last Week</option>
      <option value="month">This Month</option>
      <option value="lastMonth">Last Month</option>
      <option value="year">This Year</option>
    </select>
  </div>
</div>

<!-- Performance Chart -->
<div class="chart-section">
  <div class="chart-header">
    <h3 class="chart-title">üìà Performance Overview</h3>
  </div>
  <canvas id="performanceChart"></canvas>
</div>

<!-- Metric Grid - 4 Columns -->
<div class="metric-grid">
  <!-- Revenue Card -->
  <div class="metric-card">
    <span class="metric-label">Total Revenue</span>
    <div class="metric-value" id="totalEarned">$0</div>
    <div class="metric-sub" id="earnedSub">Sales income</div>
    <div id="earnedComparison"></div>
  </div>

  <!-- Profit Card with Margin Gauge -->
  <div class="metric-card">
    <span class="metric-label">Gross Profit</span>
    <div class="metric-value" id="grossProfit">$0</div>
    <div class="metric-sub">After cost deduction</div>
    
    <div class="margin-gauge">
      <div class="margin-label">
        <span id="marginLabel">Profit Margin</span>
        <span id="marginValue">0%</span>
      </div>
      <div class="margin-bar">
        <div class="margin-fill margin-profit" id="marginFill" style="width: 0%"></div>
      </div>
    </div>
  </div>

  <!-- Spend Card -->
  <div class="metric-card">
    <span class="metric-label">Total Spend</span>
    <div class="metric-value" id="totalSpend">$0</div>
    <div class="metric-sub">Lifetime investment</div>
  </div>

  <!-- Comparison Card -->
  <div class="metric-card">
    <span class="metric-label">Performance</span>
    <div class="metric-value" id="performanceIndicator">‚Äî</div>
    <div class="metric-sub" id="performanceSub">Period comparison</div>
    <div id="performanceComparison"></div>
  </div>
</div>

<div class="products-wrapper">
  <div class="products-header">
    <h3>üì¶ Product Pricing</h3>
    <button class="btn-download" onclick="downloadProducts()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:inline; margin-right:6px;">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
        <polyline points="7 10 12 15 17 10"/>
        <line x1="12" y1="15" x2="12" y2="3"/>
      </svg>
      Download Report
    </button>
  </div>
 <button class="upload-shop-btn" onclick="openTableUpload()">
    üìä Table Bulk Upload
</button>
  <div class="grid-header">
    <div>Product Name</div>
    <div>Quantity</div>
    <div>Cost Price</div>
    <div>Sell Price</div>
    <div>Action</div>
  </div>

  <div class="grid-body" id="productsGrid"></div>
</div>

<div id="priceModal" class="modal">
  <div class="modal-box">
    <h3 id="modalTitle">Set Prices</h3>
    <p id="modalSubtitle">Define cost and selling price</p>
    
<div class="price-inputs">
  <div class="input-group">
    <label>Cost Price</label>
    <input type="number" id="costPriceInput" placeholder="Enter number (e.g., 200)" step="0.01">
    <div style="font-size: 11px; color: #ef4444; margin-top: 4px; font-weight: bold;">
        ‚ö†Ô∏è Numbers only. Do not add "per pack" or "kg".
    </div>
  </div>
  <div class="input-group">
    <label>Selling Price</label>
    <input type="number" id="sellPriceInput" placeholder="Enter number (e.g., 400)" step="0.01">
    <div style="font-size: 11px; color: #ef4444; margin-top: 4px; font-weight: bold;">
        ‚ö†Ô∏è Numbers only. System calculates per unit automatically.
    </div>
  </div>
</div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closePriceModal()">Cancel</button>
      <button class="btn-save" onclick="savePrices()">Save Prices</button>
    </div>
  </div>
</div>

<div id="currencyModal" class="modal">
  <div class="modal-box">
    <h3>üåç Regional Settings</h3>
    <p>Enter your 3-letter currency code (e.g., USD, INR, GBP, EUR)</p>
    
    <div class="price-inputs">
      <div class="input-group">
        <label>Currency Code</label>
        <input type="text" id="currencyInput" placeholder="USD" maxlength="3" style="text-transform: uppercase;">
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn-save" style="grid-column: span 2;" onclick="saveCurrency()">Save & Continue</button>
    </div>
  </div>
</div>
<div id="tableUploadModal" class="story-card" style="width: 90vw; max-width: 1000px;">
    <button class="close-btn" onclick="closeTableUpload()">√ó</button>
    <h2>Bulk Price Manager</h2>
    <p style="color: #94a3b8; margin-bottom: 20px;">Fill in the prices below. Only numbers are accepted.</p>
    
    <div style="overflow-x: auto; background: rgba(0,0,0,0.2); border-radius: 12px;">
        <table style="width: 100%; border-collapse: collapse; color: white; text-align: left;">
            <thead>
                <tr style="border-bottom: 2px solid var(--neon-primary);">
                    <th style="padding: 15px;">Product Name</th>
                    <th style="padding: 15px;">Stock</th>
                    <th style="padding: 15px;">Cost Price ($)</th>
                    <th style="padding: 15px;">Selling Price ($)</th>
                </tr>
            </thead>
            <tbody id="bulkTableBody">
                </tbody>
        </table>
    </div>

    <button class="exchange-btn" onclick="saveAllPrices()" style="margin-top: 20px;">
        üíæ Save All Changes
    </button>
</div>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyD6PdrKp2XLfRqjC587lMpdKTaWD4MBens",
  authDomain: "scalevest-163a0.firebaseapp.com",
  databaseURL: "https://scalevest-163a0-default-rtdb.firebaseio.com",
  projectId: "scalevest-163a0"
});

const auth = firebase.auth();
const db = firebase.database();

// Global State
let inventory = {};
let prices = {};
let sales = {};
let purchases = {};
let invRef, pricesRef, salesRef, purchasesRef, lastKnownRef;
let currentProductId = null;
let userCurrency = "USD";
let performanceChart = null;

// HYBRID PRICE PARSER
function extractNumericValue(input) {
  if (!input) return 0;
  const str = String(input).trim();
  const match = str.match(/[\d,.]+/);
  if (!match) return 0;
  const numStr = match[0].replace(/,/g, '');
  return parseFloat(numStr) || 0;
}

function createPriceObject(input) {
  const numeric = extractNumericValue(input);
  const display = String(input).trim();
  return { numericValue: numeric, displayString: display };
}

// COMPARISON ENGINE
function calculateComparison(currentValue, previousValue) {
  if (!previousValue || previousValue === 0) {
    return { change: 0, percentage: 0, direction: 'neutral' };
  }
  const change = currentValue - previousValue;
  const percentage = (change / previousValue) * 100;
  const direction = change > 0 ? 'up' : change < 0 ? 'down' : 'neutral';
  return { change, percentage, direction };
}

// RENDER COMPARISON BADGE - CLEAN LOGIC
function renderComparisonBadge(comparison, periodName) {
  if (!comparison || comparison.direction === 'neutral' || isNaN(comparison.percentage) || comparison.percentage === 0) {
    return '';
  }
  
  const arrow = comparison.direction === 'up' ? '‚ñ≤' : '‚ñº';
  const comparisonClass = `comparison-${comparison.direction}`;
  
  return `
    <div class="comparison-badge ${comparisonClass}">
      ${arrow} ${Math.abs(comparison.percentage).toFixed(1)}% ${periodName}
    </div>
  `;
}
function openTableUpload() {
    const modal = document.getElementById('tableUploadModal');
    const tbody = document.getElementById('bulkTableBody');
    const overlay = document.querySelector('.overlay');
    
    tbody.innerHTML = ''; // Clear existing
    
    // productsData comes from your existing Firebase fetch logic
    productsData.forEach(product => {
        const tr = document.createElement('tr');
        tr.style.borderBottom = "1px solid rgba(255,255,255,0.05)";
        
        // Use existing prices if they exist, otherwise empty
        const currentCost = product.costPrice || '';
        const currentSell = product.sellPrice || '';

        tr.innerHTML = `
            <td style="padding: 15px;">${product.name} ${product.icon || ''}</td>
            <td style="padding: 15px;">${product.stock}</td>
            <td style="padding: 15px;">
                <input type="number" class="bulk-cost" data-id="${product.id}" 
                       value="${currentCost}" placeholder="0.00" 
                       style="background:rgba(255,255,255,0.1); border:1px solid var(--neon-primary); color:white; padding:5px; border-radius:4px; width:100px;">
            </td>
            <td style="padding: 15px;">
                <input type="number" class="bulk-sell" data-id="${product.id}" 
                       value="${currentSell}" placeholder="0.00" 
                       style="background:rgba(255,255,255,0.1); border:1px solid var(--neon-accent); color:white; padding:5px; border-radius:4px; width:100px;">
            </td>
        `;
        tbody.appendChild(tr);
    });

    modal.classList.add('active');
    overlay.classList.add('active');
}

function saveAllPrices() {
    const updates = {};
    const costInputs = document.querySelectorAll('.bulk-cost');
    const sellInputs = document.querySelectorAll('.bulk-sell');
    let hasError = false;

    costInputs.forEach((input, index) => {
        const productId = input.getAttribute('data-id');
        const costVal = input.value.trim();
        const sellVal = sellInputs[index].value.trim();

        // VALIDATION: Skip empty ones, but ensure others are numbers
        if (costVal !== "" && sellVal !== "") {
            if (isNaN(costVal) || isNaN(sellVal)) {
                hasError = true;
            } else {
                updates[`Businesses/${currentUserId}/prices/${productId}/costPrice`] = parseFloat(costVal);
                updates[`Businesses/${currentUserId}/prices/${productId}/sellPrice`] = parseFloat(sellVal);
                updates[`Businesses/${currentUserId}/prices/${productId}/updatedAt`] = Date.now();
            }
        }
    });

    if (hasError) {
        alert("‚ùå Some entries are not valid numbers. Please fix them.");
        return;
    }

    // FIREBASE BULK UPDATE
    if (Object.keys(updates).length > 0) {
        update(ref(database), updates).then(() => {
            showToast("‚úÖ Success", "All prices updated in real-time.");
            closeTableUpload();
        }).catch(err => {
            alert("Error saving: " + err.message);
        });
    } else {
        alert("No changes to save.");
    }
}

function closeTableUpload() {
    document.getElementById('tableUploadModal').classList.remove('active');
    document.querySelector('.overlay').classList.remove('active');
}
function getTimeRanges() {
  const now = new Date();
  const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
  const startOfYesterday = startOfToday - 86400000;
  
  const day = now.getDay();
  const startOfWeek = startOfToday - (day * 86400000);
  const startOfLastWeek = startOfWeek - (7 * 86400000);
  
  const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
  const startOfLastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1).getTime();
  
  const startOfYear = new Date(now.getFullYear(), 0, 1).getTime();
  const startOfLastYear = new Date(now.getFullYear() - 1, 0, 1).getTime();
  const endOfLastYear = new Date(now.getFullYear(), 0, 1).getTime();
  
  return {
    today: { start: startOfToday, end: Infinity },
    yesterday: { start: startOfYesterday, end: startOfToday },
    thisWeek: { start: startOfWeek, end: Infinity },
    lastWeek: { start: startOfLastWeek, end: startOfWeek },
    thisMonth: { start: startOfMonth, end: Infinity },
    lastMonth: { start: startOfLastMonth, end: startOfMonth },
    thisYear: { start: startOfYear, end: Infinity },
    lastYear: { start: startOfLastYear, end: endOfLastYear }
  };
}

function calculateRevenueForPeriod(start, end) {
    let total = 0;
    if (!sales) return 0; // Guard if sales node hasn't loaded
    
    Object.values(sales).forEach(sale => {
        if (sale.timestamp >= start && sale.timestamp <= end) {
            total += (parseFloat(sale.revenue) || 0);
        }
    });
    return total;
}

function calculateCostForPeriod(startTime, endTime) {
  let cost = 0;
  Object.values(sales).forEach(sale => {
    const saleTime = sale.timestamp;
    if (saleTime >= startTime && saleTime < endTime) {
      const productId = sale.productId;
      const priceData = prices[productId];
      if (priceData && priceData.costPrice) {
        const costValue = typeof priceData.costPrice === 'object' 
          ? priceData.costPrice.numericValue 
          : extractNumericValue(priceData.costPrice);
        cost += costValue * (sale.quantity || 0);
      }
    }
  });
  return cost;
}

// CHART RENDERING
function renderPerformanceChart(filter) {
  const ctx = document.getElementById('performanceChart');
  if (!ctx) return;
  
  if (performanceChart) {
    performanceChart.destroy();
  }
  
  const ranges = getTimeRanges();
  
  if (filter === 'all') {
    // Line chart for last 30 days
    const days = 30;
    const labels = [];
    const revenueData = [];
    const profitData = [];
    
    for (let i = days - 1; i >= 0; i--) {
      const date = new Date();
      date.setDate(date.getDate() - i);
      const startOfDay = new Date(date.getFullYear(), date.getMonth(), date.getDate()).getTime();
      const endOfDay = startOfDay + 86400000;
      
      labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
      
      const dayRevenue = calculateRevenueForPeriod(startOfDay, endOfDay);
      const dayCost = calculateCostForPeriod(startOfDay, endOfDay);
      
      revenueData.push(dayRevenue);
      profitData.push(dayRevenue - dayCost);
    }
    
    performanceChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'Revenue',
            data: revenueData,
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            fill: true,
            tension: 0.4,
            borderWidth: 2
          },
          {
            label: 'Profit',
            data: profitData,
            borderColor: '#10b981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            fill: true,
            tension: 0.4,
            borderWidth: 2
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            position: 'top',
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: {
              color: '#f1f5f9'
            }
          },
          x: {
            grid: {
              display: false
            }
          }
        }
      }
    });
  } else {
    // Bar chart comparing current vs previous period
    let currentPeriod, previousPeriod, periodLabel;
    
    switch(filter) {
      case 'today':
        currentPeriod = ranges.today;
        previousPeriod = ranges.yesterday;
        periodLabel = ['Yesterday', 'Today'];
        break;
      case 'week':
        currentPeriod = ranges.thisWeek;
        previousPeriod = ranges.lastWeek;
        periodLabel = ['Last Week', 'This Week'];
        break;
      case 'month':
        currentPeriod = ranges.thisMonth;
        previousPeriod = ranges.lastMonth;
        periodLabel = ['Last Month', 'This Month'];
        break;
      case 'year':
        currentPeriod = ranges.thisYear;
        previousPeriod = ranges.lastYear;
        periodLabel = ['Last Year', 'This Year'];
        break;
      default:
        currentPeriod = ranges.today;
        previousPeriod = ranges.yesterday;
        periodLabel = ['Previous', 'Current'];
    }
    
    const prevRevenue = calculateRevenueForPeriod(previousPeriod.start, previousPeriod.end);
    const currRevenue = calculateRevenueForPeriod(currentPeriod.start, currentPeriod.end);
    
    const prevCost = calculateCostForPeriod(previousPeriod.start, previousPeriod.end);
    const currCost = calculateCostForPeriod(currentPeriod.start, currentPeriod.end);
    
    performanceChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: periodLabel,
        datasets: [
          {
            label: 'Revenue',
            data: [prevRevenue, currRevenue],
            backgroundColor: '#3b82f6',
            borderRadius: 8
          },
          {
            label: 'Profit',
            data: [prevRevenue - prevCost, currRevenue - currCost],
            backgroundColor: '#10b981',
            borderRadius: 8
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            position: 'top',
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: {
              color: '#f1f5f9'
            }
          },
x: {
            grid: {
              display: false
            }
          }
        } 
      } 
    }); 
  } 
} 
function calculateFinancials() {
    const filter = document.getElementById("timeFilter").value;
    const ranges = getTimeRanges();
    
    let startTime = 0;
    let endTime = Infinity;
    let comparisonPeriod = null;
    let periodName = "";

    switch(filter) {
        case "today":
            startTime = ranges.today.start;
            comparisonPeriod = ranges.yesterday;
            periodName = "vs Yesterday";
            break;
        case "yesterday":
            startTime = ranges.yesterday.start;
            endTime = ranges.yesterday.end;
            periodName = "vs Day Before";
            break;
        case "week":
            startTime = ranges.thisWeek.start;
            comparisonPeriod = ranges.lastWeek;
            periodName = "vs Last Week";
            break;
        case "month":
            startTime = ranges.thisMonth.start;
            comparisonPeriod = ranges.lastMonth;
            periodName = "vs Last Month";
            break;
        case "year":
            startTime = ranges.thisYear.start;
            comparisonPeriod = ranges.lastYear;
            periodName = "vs Last Year";
            break;
    }

    // --- 1. SPEND CALCULATION ---
    let totalSpend = 0;
    const productsWithHistory = new Set();
    if (typeof purchases !== 'undefined' && purchases) {
        Object.values(purchases).forEach(purchase => {
            totalSpend += (parseFloat(purchase.totalCost) || 0);
            productsWithHistory.add(purchase.productId);
        });
    }
    Object.entries(inventory).forEach(([id, product]) => {
        if (!productsWithHistory.has(id)) {
            const priceData = (typeof prices !== 'undefined') ? prices[id] : null;
            if (priceData && priceData.costPrice) {
                const costValue = (typeof priceData.costPrice === 'object') 
                    ? (priceData.costPrice.numericValue || 0) 
                    : parseFloat(priceData.costPrice) || 0;
                totalSpend += costValue * (parseFloat(product.quantity) || 0);
            }
        }
    });

    // --- 2. REVENUE & PROFIT ---
    const currentRevenue = calculateRevenueForPeriod(startTime, endTime);
    const currentCost = calculateCostForPeriod(startTime, endTime);
    const grossProfit = currentRevenue - currentCost;
    
    const formatter = new Intl.NumberFormat(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

    // Update UI Cards
    document.getElementById("totalSpend").textContent = `${userCurrency} ${formatter.format(totalSpend)}`;
    document.getElementById("totalEarned").textContent = `${userCurrency} ${formatter.format(currentRevenue)}`;
    
    const profitEl = document.getElementById("grossProfit");
    profitEl.textContent = `${userCurrency} ${formatter.format(Math.abs(grossProfit))}`;
    profitEl.style.color = grossProfit >= 0 ? "#1e293b" : "#ef4444";

    // --- 3. FIX: MARGIN GAUGE LOGIC ---
    // This section makes the Profit/Loss bar move and update text
    const marginLabel = document.getElementById("marginLabel");
    const marginValue = document.getElementById("marginValue");
    const marginFill = document.getElementById("marginFill");
    
    let marginPercent = 0;
    if (grossProfit >= 0) {
        // Profit Margin: (Profit / Revenue) * 100
        marginPercent = currentRevenue > 0 ? (grossProfit / currentRevenue) * 100 : 0;
        marginLabel.textContent = "Profit Margin";
        marginFill.className = "margin-fill margin-profit";
    } else {
        // Loss Margin: (Loss / Cost) * 100
        marginPercent = currentCost > 0 ? (Math.abs(grossProfit) / currentCost) * 100 : 0;
        marginLabel.textContent = "Loss Margin";
        marginFill.className = "margin-fill margin-loss";
    }
    
    marginValue.textContent = `${marginPercent.toFixed(1)}%`;
    marginFill.style.width = `${Math.min(marginPercent, 100)}%`;

    // --- 4. COMPARISON LOGIC ---
    const earnedCompEl = document.getElementById("earnedComparison");
    const perfIndicator = document.getElementById("performanceIndicator");

    if (comparisonPeriod && filter !== 'all') {
        const previousRevenue = calculateRevenueForPeriod(comparisonPeriod.start, comparisonPeriod.end);
        const comparison = calculateComparison(currentRevenue, previousRevenue);
        earnedCompEl.innerHTML = renderComparisonBadge(comparison, periodName);
        perfIndicator.textContent = comparison.direction === 'up' ? 'Growing' : comparison.direction === 'down' ? 'Declining' : 'Stable';
        perfIndicator.style.color = comparison.direction === 'up' ? '#10b981' : comparison.direction === 'down' ? '#ef4444' : '#1e293b';
    } else {
        earnedCompEl.innerHTML = '<span style="color:#94a3b8; font-size:12px;">No comparison</span>';
        perfIndicator.textContent = "Stable";
    }

    if (typeof renderPerformanceChart === 'function') renderPerformanceChart(filter);
}
auth.onAuthStateChanged(user => {
    if (!user) return;

    const currencyRef = db.ref(`BusinessOwners/${user.uid}/National Currency`);
    invRef = db.ref(`Businesses/${user.uid}/inventory`);
    pricesRef = db.ref(`Businesses/${user.uid}/prices`);
    salesRef = db.ref(`Businesses/${user.uid}/sales`);
    purchasesRef = db.ref(`Businesses/${user.uid}/purchases`);

    currencyRef.on("value", snapshot => {
        const data = snapshot.val();
        if (data && data.currency) {
            userCurrency = data.currency.toUpperCase();
            document.getElementById("currencyModal").style.display = "none";
            calculateFinancials();
        } else {
            document.getElementById("currencyModal").style.display = "flex";
        }
    });

    // These listeners ensure the dashboard updates instantly when inventory or sales change
    pricesRef.on("value", snapshot => { prices = snapshot.val() || {}; render(); calculateFinancials(); });
    invRef.on("value", snapshot => { inventory = snapshot.val() || {}; render(); calculateFinancials(); });
    salesRef.on("value", snapshot => { sales = snapshot.val() || {}; calculateFinancials(); });
    purchasesRef.on("value", snapshot => { purchases = snapshot.val() || {}; calculateFinancials(); });
});

// UI RENDERING
function render() {
    const grid = document.getElementById("productsGrid");
    if(!grid) return;
    grid.innerHTML = "";

    Object.entries(inventory).forEach(([id, product]) => {
        const priceData = prices[id] || {};
        const costDisp = priceData.costPrice ? (typeof priceData.costPrice === 'object' ? priceData.costPrice.displayString : priceData.costPrice) : "Not set";
        const sellDisp = priceData.sellPrice ? (typeof priceData.sellPrice === 'object' ? priceData.sellPrice.displayString : priceData.sellPrice) : "Not set";

        grid.innerHTML += `
            <div class="product-row">
                <div class="product-name">${product.name}</div>
                <div class="product-qty">${product.quantity} ${product.unit || 'pcs'}</div>
                <div class="product-cost">${userCurrency} ${costDisp}</div>
                <div class="product-sell">${userCurrency} ${sellDisp}</div>
                <div><button class="set-btn" onclick="openPriceModal('${id}', '${product.name}')">Edit</button></div>
            </div>
        `;
    });
}

// MODAL CONTROLS
function openPriceModal(productId, productName) {
    currentProductId = productId;
    document.getElementById("modalTitle").textContent = productName;
    const priceData = prices[productId] || {};
    document.getElementById("costPriceInput").value = priceData.costPrice ? (typeof priceData.costPrice === 'object' ? priceData.costPrice.displayString : priceData.costPrice) : "";
    document.getElementById("sellPriceInput").value = priceData.sellPrice ? (typeof priceData.sellPrice === 'object' ? priceData.sellPrice.displayString : priceData.sellPrice) : "";
    document.getElementById("priceModal").style.display = "flex";
}

function closePriceModal() { document.getElementById("priceModal").style.display = "none"; }

function savePrices() {
    const costInput = document.getElementById("costPriceInput").value.trim();
    const sellInput = document.getElementById("sellPriceInput").value.trim();

    // 1. REGEX CHECK: Only allow numbers and one decimal point. 
    // This rejects "100/kg", "200 per pack", or "cheap".
    const numberRegex = /^\d+(\.\d{1,2})?$/;

    if (!numberRegex.test(costInput) || !numberRegex.test(sellInput)) {
        alert("‚ùå INVALID INPUT\n\nPlease enter ONLY numbers (e.g., 200 or 450.50).\n\nDo not add text like 'per pack', 'kg', or '/bottle'.");
        return; // Stops the function here so Firebase never sees the bad data
    }

    // 2. Logic Protection: Ensure selling price isn't 0
    if (parseFloat(sellInput) <= 0) {
        alert("Selling price must be greater than 0");
        return;
    }

    // 3. Save to Firebase (Only runs if the check above passes)
    pricesRef.child(currentProductId).set({
        // We use parseFloat to ensure it's saved as a clean number in the DB
        costPrice: parseFloat(costInput),
        sellPrice: parseFloat(sellInput),
        updatedAt: firebase.database.ServerValue.TIMESTAMP
    }).then(() => {
        showSuccess("Prices Saved!");
        closePriceModal();
    });
}
function saveCurrency() {
    const code = document.getElementById("currencyInput").value.trim().toUpperCase();
    if (code.length < 2) return alert("Enter valid code");
    db.ref(`BusinessOwners/${auth.currentUser.uid}/National Currency`).set({
        currency: code,
        updatedAt: firebase.database.ServerValue.TIMESTAMP
    });
}

function showSuccess(msg) {
    const popup = document.getElementById("successPopup");
    popup.textContent = msg; popup.style.display = "block";
    setTimeout(() => popup.style.display = "none", 3000);
}
function downloadProducts() {
    let csv = "Product Name,Quantity,Cost Price,Selling Price\n";
    Object.entries(inventory).forEach(([id, product]) => {
        const pData = prices[id] || {};
        const cost = pData.costPrice ? (pData.costPrice.numericValue || pData.costPrice) : 0;
        const sell = pData.sellPrice ? (pData.sellPrice.numericValue || pData.sellPrice) : 0;
        csv += `"${product.name}","${product.quantity}","${cost}","${sell}"\n`;
    });
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'Product_Pricing_Report.csv';
    a.click();
}
</script>
</body>
</html>
