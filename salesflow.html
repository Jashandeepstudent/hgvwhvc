<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ScaleVest - SalesFlow Premium</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
* { box-sizing: border-box; font-family: Inter, sans-serif; }
body { margin: 0; background: #f6f7fb; padding: 20px; overflow-x: hidden; }

.top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 15px; }
.back-nav-btn { display: flex; align-items: center; justify-content: center; width: 38px; height: 38px; background: white; border: 1px solid #e2e8f0; border-radius: 12px; color: #1e293b; text-decoration: none; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer; }
.back-nav-btn:hover { background: #f5f3ff; border-color: #7c3aed; color: #7c3aed; transform: translateX(-3px); }
h2 { margin: 0; font-size: 26px; font-weight: 800; color: #1e293b; }

.chart-section { background: white; padding: 30px; border-radius: 24px; border: 1px solid #f1f5f9; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05); margin-bottom: 30px; }
.chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
.chart-title { font-size: 18px; font-weight: 700; color: #1e293b; margin: 0; }
#performanceChart { max-height: 350px; }

.metric-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
.metric-card { background: white; padding: 24px; border-radius: 20px; border: 1px solid #f1f5f9; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04); transition: transform 0.2s ease, box-shadow 0.2s ease; position: relative; overflow: hidden; }
.metric-card:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0, 0, 0, 0.08); }
.metric-label { font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 12px; display: block; }
.metric-value { font-size: 32px; font-weight: 800; color: #1e293b; margin-bottom: 12px; line-height: 1.2; }
.metric-sub { font-size: 12px; color: #94a3b8; font-weight: 500; margin-bottom: 12px; }

.comparison-badge { display: inline-flex; align-items: center; gap: 4px; padding: 6px 12px; border-radius: 50px; font-size: 11px; font-weight: 700; margin-top: 8px; letter-spacing: 0.3px; }
.comparison-up { background: rgba(16, 185, 129, 0.1); color: #059669; }
.comparison-down { background: rgba(239, 68, 68, 0.1); color: #dc2626; }
.comparison-neutral { background: rgba(148, 163, 184, 0.1); color: #64748b; }

.margin-gauge { margin-top: 16px; padding-top: 12px; border-top: 1px solid #f1f5f9; }
.margin-label { font-size: 11px; font-weight: 600; color: #64748b; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
.margin-bar { height: 8px; background: #f1f5f9; border-radius: 50px; overflow: hidden; position: relative; }
.margin-fill { height: 100%; border-radius: 50px; transition: width 0.5s ease, background 0.3s ease; }
.margin-profit { background: linear-gradient(90deg, #10b981, #059669); }
.margin-loss { background: linear-gradient(90deg, #ef4444, #dc2626); }

.products-wrapper { background: white; border-radius: 24px; border: 1px solid #f1f5f9; box-shadow: 0 4px 20px rgba(0,0,0,0.03); overflow: hidden; }
.products-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid #f1f5f9; }
.products-header h3 { margin: 0; font-size: 18px; font-weight: 700; color: #1e293b; }

.grid-header { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr; background: #f8fafc; padding: 16px 24px; border-bottom: 1px solid #f1f5f9; color: #64748b; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
.grid-body { max-height: 50vh; overflow-y: auto; }
.product-row { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr; align-items: center; padding: 18px 24px; border-bottom: 1px solid #f8fafc; transition: all 0.2s ease; }
.product-row:hover { background-color: #f5f3ff; }
.product-row:last-child { border-bottom: none; }
.product-name { font-weight: 600; color: #1e293b; }
.product-qty { font-weight: 600; color: #64748b; }

.set-btn { padding: 8px 16px; background: #7c3aed; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 12px; transition: all 0.2s; }
.set-btn:hover { background: #6d28d9; transform: scale(1.05); }

.button-group { display: flex; gap: 16px; align-items: center; }
.btn-modern { display: inline-flex; align-items: center; justify-content: center; padding: 12px 28px; border-radius: 14px; font-size: 15px; font-weight: 700; letter-spacing: -0.2px; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border: none; height: 52px; }
.btn-bulk { background: linear-gradient(135deg, #6366f1 0%, #4338ca 100%); color: white; box-shadow: 0 10px 20px -10px rgba(99, 102, 241, 0.5); }
.btn-bulk:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 20px 25px -5px rgba(99, 102, 241, 0.4); filter: brightness(1.1); }
.btn-download { background: #ffffff; color: #1e293b; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
.btn-download:hover { background: #f8fafc; border-color: #cbd5e1; transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
.btn-modern:active { transform: translateY(0) scale(0.98); }

.btn-reason { padding: 10px 20px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3); }
.btn-reason:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(245, 158, 11, 0.4); }

.filter-container { display: flex; align-items: center; gap: 12px; }

.modal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(8px); }
.modal-box { background: white; padding: 35px; border-radius: 28px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
#settingsModal .modal-box { max-width: 350px; border: 2px solid #7c3aed; }
.modal-box h3 { margin: 0 0 10px 0; font-size: 20px; font-weight: 700; }
.modal-box p { color: #64748b; margin-bottom: 20px; }

.price-inputs { display: grid; gap: 15px; margin: 20px 0; }
.input-group { text-align: left; }
.input-group label { display: block; font-size: 13px; font-weight: 600; color: #64748b; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
.input-group input { width: 100%; padding: 14px; border: 1px solid #e2e8f0; border-radius: 12px; font-size: 16px; font-weight: 600; transition: all 0.2s; }
.input-group input:focus { outline: none; border-color: #7c3aed; box-shadow: 0 0 0 4px rgba(124, 58, 237, 0.1); }

.modal-actions { display: grid; grid-template-columns: 1fr 2fr; gap: 12px; margin-top: 20px; }
.btn-cancel { padding: 12px; background: #f1f5f9; color: #64748b; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; }
.btn-save { padding: 12px; background: #7c3aed; color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; }
.btn-save:hover { background: #6d28d9; }

.success-popup { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #10b981; color: white; padding: 14px 28px; border-radius: 50px; font-weight: 600; display: none; z-index: 10000; box-shadow: 0 10px 20px rgba(0,0,0,0.2); animation: slideUp 0.3s ease; }
@keyframes slideUp { from { bottom: -50px; opacity: 0; } to { bottom: 30px; opacity: 1; } }
.reasoning-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index:999999; backdrop-filter: blur(10px); }
.reasoning-content { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 0; border-radius: 24px; width: 90%; max-width: 600px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); overflow: hidden; animation: modalSlideIn 0.4s ease; }
@keyframes modalSlideIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
.reasoning-header { background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 24px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.2); }
.reasoning-header h3 { margin: 0; font-size: 24px; font-weight: 800; color: white; display: flex; align-items: center; gap: 12px; }
.close-reasoning { background: rgba(255,255,255,0.2); border: none; width: 36px; height: 36px; border-radius: 50%; color: white; font-size: 24px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; }
.close-reasoning:hover { background: rgba(255,255,255,0.3); transform: rotate(90deg); }
.reasoning-body { background: white; padding: 30px; max-height: 60vh; overflow-y: auto; }
.reasoning-section { margin-bottom: 24px; padding: 20px; background: #f8fafc; border-radius: 16px; border-left: 4px solid #667eea; }
.reasoning-section h4 { margin: 0 0 12px 0; font-size: 16px; font-weight: 700; color: #1e293b; display: flex; align-items: center; gap: 8px; }
.reasoning-section p { margin: 0; font-size: 14px; line-height: 1.6; color: #64748b; }
.reasoning-metrics { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 20px; }
.reason-metric-card { background: white; padding: 16px; border-radius: 12px; border: 2px solid #e2e8f0; text-align: center; }
.reason-metric-card .label { font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
.reason-metric-card .value { font-size: 20px; font-weight: 800; color: #1e293b; }
/* MOBILE RESPONSIVE */
@media (max-width: 1200px) { .metric-grid { grid-template-columns: repeat(2, 1fr); } }
@media (max-width: 768px) {
  .metric-grid { grid-template-columns: 1fr; }
  .chart-section { padding: 20px; }
  .metric-value { font-size: 28px; }
  .grid-header { display: none; }
  .grid-body { padding: 0; }
  .product-row { display: block; background: white; border: 1px solid #e2e8f0; border-radius: 16px; padding: 20px; margin: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.06); }
  .product-row:hover { background: white; box-shadow: 0 8px 16px rgba(0,0,0,0.12); }
  .product-name { font-size: 18px; font-weight: 700; color: #0f172a; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
  .product-qty { display: inline-block; background: #f0fdf4; color: #16a34a; padding: 6px 12px; border-radius: 12px; font-size: 13px; font-weight: 700; }
  .product-cost, .product-sell { display: inline-block; width: 48%; margin-bottom: 16px; font-size: 16px; font-weight: 700; color: #1e293b; }
  .product-cost { margin-right: 4%; }
  .product-cost::before { content: "Cost: "; font-size: 11px; color: #64748b; font-weight: 600; text-transform: uppercase; display: block; margin-bottom: 4px; }
  .product-sell::before { content: "Sell: "; font-size: 11px; color: #64748b; font-weight: 600; text-transform: uppercase; display: block; margin-bottom: 4px; }
  .set-btn { width: 100%; padding: 14px; font-size: 15px; border-radius: 12px; margin-top: 8px; }
  .products-header { flex-direction: column; align-items: flex-start; gap: 15px; }
  .button-group { width: 100%; display: flex; gap: 8px; }
  .btn-modern { padding: 8px 12px; font-size: 13px; height: 44px; flex: 1; justify-content: center; }
  .btn-modern svg { width: 16px; height: 16px; margin-right: 6px; }
  .products-header h3 { font-size: 18px; }
  .filter-container { flex-direction: column; align-items: flex-start; }
}

.input-with-currency { position: relative; display: inline-block; }
.currency-label { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-weight: 700; color: #64748b; font-size: 14px; }
.input-with-currency input { padding-left: 45px; width: 120px; }
</style>
</head>

<body>
<div id="successPopup" class="success-popup">Updated!</div>

<div class="top">
  <div style="display: flex; align-items: center; gap: 15px;">
    <a href="mainbusinesshub.html" class="back-nav-btn">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
    </a>
    <button onclick="openSettings()" class="back-nav-btn">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
    </button>
    <h2>üí∞ SalesFlow Premium</h2>
  </div>
  <div class="filter-container">
    <span style="font-size: 13px; font-weight: 600; color: #64748b;">Period:</span>
    <select id="timeFilter" onchange="calculateFinancials()" style="padding: 10px 15px; border-radius: 12px; border: 1px solid #e2e8f0; background: white; font-weight: 600; color: #1e293b; cursor: pointer;">
      <option value="all">All Time</option>
      <option value="today">Today</option>
      <option value="yesterday">Yesterday</option>
      <option value="week">This Week</option>
      <option value="month">This Month</option>
      <option value="year">This Year</option>
    </select>
    <button class="btn-reason" onclick="showReasoning()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="margin-right: 6px; vertical-align: middle;"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
      Reason
    </button>
  </div>
</div>

<div class="chart-section">
  <div class="chart-header">
    <h3 class="chart-title">üìà Performance Analytics</h3>
  </div>
  <canvas id="performanceChart"></canvas>
</div>

<div class="metric-grid">
  <div class="metric-card">
    <span class="metric-label">Total Revenue</span>
    <div class="metric-value" id="totalEarned">$0</div>
    <div class="metric-sub">Sales income</div>
    <div id="earnedComparison"></div>
  </div>
  <div class="metric-card">
    <span class="metric-label">Gross Profit</span>
    <div class="metric-value" id="grossProfit">$0</div>
    <div class="metric-sub">After cost deduction</div>
    <div class="margin-gauge">
      <div class="margin-label"><span id="marginLabel">Profit Margin</span><span id="marginValue">0%</span></div>
      <div class="margin-bar"><div class="margin-fill margin-profit" id="marginFill" style="width: 0%"></div></div>
    </div>
  </div>
  <div class="metric-card">
    <span class="metric-label">Total Spend</span>
    <div class="metric-value" id="totalSpend">$0</div>
    <div class="metric-sub">Lifetime investment</div>
  </div>
  <div class="metric-card">
    <span class="metric-label">Performance</span>
    <div class="metric-value" id="performanceIndicator">‚Äî</div>
    <div class="metric-sub">Period comparison</div>
    <div id="performanceComparison"></div>
  </div>
</div>

<div class="products-wrapper">
  <div class="products-header">
    <h3 style="font-size: 24px; font-weight: 800; color: #0f172a;">üì¶ Inventory</h3>
    <div class="button-group">
      <button class="btn-modern btn-bulk" onclick="openTableUpload()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="margin-right:10px;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg>
        Bulk Editor
      </button>
      <button class="btn-modern btn-download" onclick="downloadProducts()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="margin-right:10px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        Download
      </button>
    </div>
  </div>
  <div class="grid-header">
    <div>Product Name</div><div>Quantity</div><div>Cost Price</div><div>Sell Price</div><div>Action</div>
  </div>
  <div class="grid-body" id="productsGrid"></div>
</div>

<div id="priceModal" class="modal">
  <div class="modal-box">
    <h3 id="modalTitle">Set Prices</h3>
    <p id="modalSubtitle">Define cost and selling price</p>
    <div class="price-inputs">
<div class="input-group">
  <label>Cost Price</label>
  <input type="number" id="costPriceInput" placeholder="200" step="0.01">
<div style="font-size: 11px; color: #ef4444; margin-top: 4px; font-weight: bold;">
 ‚ö†Ô∏è Numbers only
</div>

</div>
      <div class="input-group">
        <label>Selling Price</label>
        <input type="number" id="sellPriceInput" placeholder="400" step="0.01">
        <div style="font-size: 11px; color: #ef4444; margin-top: 4px; font-weight: bold;">‚ö†Ô∏è Numbers only</div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closePriceModal()">Cancel</button>
      <button class="btn-save" onclick="savePrices()">Save</button>
    </div>
  </div>
</div>

<div id="settingsModal" class="modal" onclick="if(event.target === this) closeSettings()">
  <div class="modal-box">
    <h3>‚öôÔ∏è Settings</h3>
    <p>Change your currency</p>
    <div class="price-inputs">
      <div class="input-group">
        <label>Currency</label>
        <input type="text" id="settingsCurrencyInput" maxlength="3" style="text-transform: uppercase;">
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeSettings()">Close</button>
      <button class="btn-save" onclick="updateCurrencyFromSettings()">Update</button>
    </div>
  </div>
</div>
<div id="reasoningModal" class="reasoning-modal">
  <div class="reasoning-content" onclick="event.stopPropagation()">
    <div class="reasoning-header">
      <h3><span id="reasoningEmoji">üìä</span> <span id="reasoningTitle">View Analysis</span></h3>
      <button class="close-reasoning" onclick="closeReasoning()">√ó</button>
    </div>
    <div class="reasoning-body" id="reasoningBody">
      <!-- Content will be inserted here -->
    </div>
  </div>
</div>
<div id="currencyModal" class="modal">
  <div class="modal-box">
    <h3>üåç Currency</h3>
    <p>Enter your 3-letter currency code (USD, INR, GBP, EUR)</p>
    <div class="price-inputs">
      <div class="input-group">
        <label>Currency Code</label>
        <input type="text" id="currencyInput" placeholder="USD" maxlength="3" style="text-transform: uppercase;">
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-save" style="grid-column: span 2;" onclick="saveCurrency()">Save</button>
    </div>
  </div>
</div>

<div id="tableUploadModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; justify-content:center; align-items:center;">
  <div style="background:white; width:95%; max-width:900px; padding:20px; border-radius:15px; max-height:90vh; overflow-y:auto;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
      <h2 style="font-size: 1.2rem; margin:0;">Bulk Price Manager</h2>
      <button onclick="closeTableUpload()" style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
    </div>
    <div style="overflow-x: auto; margin-bottom:20px;">
      <table style="width:100%; border-collapse:collapse; min-width: 400px;">
        <thead style="background:#f8fafc;">
          <tr>
            <th style="padding:10px; border:1px solid #e2e8f0; text-align:left; font-size:12px;">Product</th>
            <th style="padding:10px; border:1px solid #e2e8f0; font-size:12px;">Stock</th>
            <th style="padding:10px; border:1px solid #e2e8f0; font-size:12px;">Cost</th>
            <th style="padding:10px; border:1px solid #e2e8f0; font-size:12px;">Sell</th>
          </tr>
        </thead>
        <tbody id="bulkTableBody"></tbody>
      </table>
    </div>
    <div style="display:flex; gap:8px; justify-content:flex-end;">
      <button class="btn-modern btn-cancel" onclick="closeTableUpload()">Cancel</button>
      <button class="btn-modern btn-save-all" onclick="saveAllPrices()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="margin-right:5px;"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
        Save All
      </button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyD6PdrKp2XLfRqjC587lMpdKTaWD4MBens",
  authDomain: "scalevest-163a0.firebaseapp.com",
  databaseURL: "https://scalevest-163a0-default-rtdb.firebaseio.com",
  projectId: "scalevest-163a0"
});

const auth = firebase.auth();
const db = firebase.database();

let inventory = {}, prices = {}, sales = {}, purchases = {};
let invRef, pricesRef, salesRef, purchasesRef;
let currentProductId = null;
let userCurrency = "USD";
let performanceChart = null;
let reportCounter = 1;

// UTILITY FUNCTIONS
function extractNumericValue(input) {
  if (!input) return 0;
  const str = String(input).trim();
  const match = str.match(/[\d,.]+/);
  if (!match) return 0;
  const numStr = match[0].replace(/,/g, '');
  return parseFloat(numStr) || 0;
}

function calculateComparison(currentValue, previousValue) {
  if (!previousValue || previousValue === 0) {
    return { change: 0, percentage: 0, direction: 'neutral' };
  }
  const change = currentValue - previousValue;
  const percentage = (change / previousValue) * 100;
  const direction = change > 0 ? 'up' : change < 0 ? 'down' : 'neutral';
  return { change, percentage, direction };
}

function renderComparisonBadge(comparison, periodName) {
  if (!comparison || comparison.direction === 'neutral' || isNaN(comparison.percentage) || comparison.percentage === 0) {
    return '';
  }
  const arrow = comparison.direction === 'up' ? '‚ñ≤' : '‚ñº';
  const comparisonClass = `comparison-${comparison.direction}`;
  return `<div class="comparison-badge ${comparisonClass}">${arrow} ${Math.abs(comparison.percentage).toFixed(1)}% ${periodName}</div>`;
}

function getTimeRanges() {
  const now = new Date();
  const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
  const startOfYesterday = startOfToday - 86400000;
  const day = now.getDay();
  const startOfWeek = startOfToday - (day * 86400000);
  const startOfLastWeek = startOfWeek - (7 * 86400000);
  const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
  const startOfLastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1).getTime();
  const startOfYear = new Date(now.getFullYear(), 0, 1).getTime();
  const startOfLastYear = new Date(now.getFullYear() - 1, 0, 1).getTime();
  const endOfLastYear = new Date(now.getFullYear(), 0, 1).getTime();
  
  return {
    today: { start: startOfToday, end: Infinity },
    yesterday: { start: startOfYesterday, end: startOfToday },
    thisWeek: { start: startOfWeek, end: Infinity },
    lastWeek: { start: startOfLastWeek, end: startOfWeek },
    thisMonth: { start: startOfMonth, end: Infinity },
    lastMonth: { start: startOfLastMonth, end: startOfMonth },
    thisYear: { start: startOfYear, end: Infinity },
    lastYear: { start: startOfLastYear, end: endOfLastYear }
  };
}

function calculateRevenueForPeriod(start, end) {
  let total = 0;
  if (!sales) return 0;
  Object.values(sales).forEach(sale => {
    if (sale.timestamp >= start && sale.timestamp <= end) {
      total += (parseFloat(sale.revenue) || 0);
    }
  });
  return total;
}

function calculateCostForPeriod(startTime, endTime) {
  let cost = 0;
  Object.values(sales).forEach(sale => {
    const saleTime = sale.timestamp;
    if (saleTime >= startTime && saleTime < endTime) {
      const productId = sale.productId;
      const priceData = prices[productId];
      if (priceData && priceData.costPrice) {
        const costValue = typeof priceData.costPrice === 'object' 
          ? priceData.costPrice.numericValue 
          : extractNumericValue(priceData.costPrice);
        cost += costValue * (sale.quantity || 0);
      }
    }
  });
  return cost;
}

// YOUTUBE-STYLE CHART RENDERING
function renderPerformanceChart(filter) {
  const ctx = document.getElementById('performanceChart');
  if (!ctx) return;
  if (performanceChart) performanceChart.destroy();
  
  const ranges = getTimeRanges();
  let labels = [], revenueData = [], costData = [];
  
  if (filter === 'all') {
    // Monthly comparison for All Time
    for (let i = 11; i >= 0; i--) {
      const date = new Date();
      date.setMonth(date.getMonth() - i);
      const startOfMonth = new Date(date.getFullYear(), date.getMonth(), 1).getTime();
      const endOfMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0, 23, 59, 59).getTime();
      labels.push(date.toLocaleDateString('en-US', { month: 'short' }));
      const monthRevenue = calculateRevenueForPeriod(startOfMonth, endOfMonth);
      const monthCost = calculateCostForPeriod(startOfMonth, endOfMonth);
      revenueData.push(monthRevenue);
      costData.push(monthCost);
    }
  } else if (filter === 'today') {
    // Hourly comparison: Today vs Yesterday
    const todayStart = ranges.today.start;
    const yesterdayStart = ranges.yesterday.start;
    for (let hour = 0; hour < 24; hour++) {
      labels.push(`${hour}:00`);
      const hourStart = todayStart + (hour * 3600000);
      const hourEnd = hourStart + 3600000;
      const todayHourRev = calculateRevenueForPeriod(hourStart, hourEnd);
      const todayHourCost = calculateCostForPeriod(hourStart, hourEnd);
      const yestHourStart = yesterdayStart + (hour * 3600000);
      const yestHourEnd = yestHourStart + 3600000;
      const yestHourRev = calculateRevenueForPeriod(yestHourStart, yestHourEnd);
      const yestHourCost = calculateCostForPeriod(yestHourStart, yestHourEnd);
      revenueData.push(todayHourRev);
      costData.push(todayHourCost);
    }
  } else if (filter === 'week') {
    // Daily comparison: This Week vs Last Week
    const weekStart = ranges.thisWeek.start;
    const lastWeekStart = ranges.lastWeek.start;
    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    for (let day = 0; day < 7; day++) {
      labels.push(days[day]);
      const dayStart = weekStart + (day * 86400000);
      const dayEnd = dayStart + 86400000;
      const thisDayRev = calculateRevenueForPeriod(dayStart, dayEnd);
      const thisDayCost = calculateCostForPeriod(dayStart, dayEnd);
      revenueData.push(thisDayRev);
      costData.push(thisDayCost);
    }
  } else if (filter === 'month') {
    // Daily comparison for This Month
    const monthStart = ranges.thisMonth.start;
    const now = Date.now();
    const daysInMonth = Math.ceil((now - monthStart) / 86400000);
    for (let day = 0; day <= Math.min(daysInMonth, 30); day++) {
      labels.push(`Day ${day + 1}`);
      const dayStart = monthStart + (day * 86400000);
      const dayEnd = dayStart + 86400000;
      const dayRev = calculateRevenueForPeriod(dayStart, dayEnd);
      const dayCost = calculateCostForPeriod(dayStart, dayEnd);
      revenueData.push(dayRev);
      costData.push(dayCost);
    }
  } else {
    // Default: Last 30 days
    for (let i = 29; i >= 0; i--) {
      const date = new Date();
      date.setDate(date.getDate() - i);
      const startOfDay = new Date(date.getFullYear(), date.getMonth(), date.getDate()).getTime();
      const endOfDay = startOfDay + 86400000;
      labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
      const dayRevenue = calculateRevenueForPeriod(startOfDay, endOfDay);
      const dayCost = calculateCostForPeriod(startOfDay, endOfDay);
      revenueData.push(dayRevenue);
      costData.push(dayCost);
    }
  }
  
  // YouTube Analytics Style Chart
  performanceChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Revenue',
          data: revenueData,
          borderColor: '#10b981',
          backgroundColor: 'rgba(16, 185, 129, 0.1)',
          fill: true,
          tension: 0.4,
          borderWidth: 3,
          pointRadius: 0,
          pointHoverRadius: 6,
          pointHoverBackgroundColor: '#10b981',
          pointHoverBorderColor: '#fff',
          pointHoverBorderWidth: 2
        },
        {
          label: 'Cost',
          data: costData,
          borderColor: '#64748b',
          backgroundColor: 'rgba(100, 116, 139, 0.05)',
          fill: true,
          tension: 0.4,
          borderWidth: 3,
          pointRadius: 0,
          pointHoverRadius: 6,
          pointHoverBackgroundColor: '#64748b',
          pointHoverBorderColor: '#fff',
          pointHoverBorderWidth: 2
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      interaction: {
        mode: 'index',
        intersect: false
      },
      plugins: {
        legend: {
          position: 'top',
          labels: {
            usePointStyle: true,
            padding: 15,
            font: { size: 13, weight: '600' }
          }
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          padding: 12,
          cornerRadius: 8,
          titleFont: { size: 13, weight: '600' },
          bodyFont: { size: 12 }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: { color: '#f1f5f9', drawBorder: false },
          border: { display: false },
          ticks: { font: { size: 11 }, color: '#64748b' }
        },
        x: {
          grid: { display: false },
          border: { display: false },
          ticks: { font: { size: 11 }, color: '#64748b', maxRotation: 0 }
        }
      }
    }
  });
}
// REASONING MODAL
function showReasoning() {
  const filter = document.getElementById("timeFilter").value;
  const modal = document.getElementById("reasoningModal");
  const body = document.getElementById("reasoningBody");
  const title = document.getElementById("reasoningTitle");
  const emoji = document.getElementById("reasoningEmoji");

  if (!modal) {
    console.error("Modal not found!");
    return;
  }

  // 1. PULL REAL DATA FROM YOUR DASHBOARD
  const revenueStr = document.getElementById("totalEarned").textContent;
  const costStr = document.getElementById("totalSpend").textContent;
  const marginStr = document.getElementById("marginValue").textContent;
  
  // Convert strings (like "$ 1,200.00") to clean numbers for math
  const revenue = parseFloat(revenueStr.replace(/[^0-9.-]+/g, "")) || 0;
  const cost = parseFloat(costStr.replace(/[^0-9.-]+/g, "")) || 0;
  const profit = revenue - cost;
  const isProfitable = profit >= 0;

  let content = "";
  
  // 2. GENERATE DYNAMIC CONTENT BASED ON FILTER
  switch(filter) {
    case "today":
      emoji.textContent = "‚òÄÔ∏è";
      title.textContent = "Today's Performance Logic";
      content = `
        <div class="reasoning-section">
          <h4>üéØ Real-Time Calculation</h4>
          <p>Today, you generated <strong>${revenueStr}</strong> in revenue against <strong>${costStr}</strong> in costs. 
          This results in a net ${isProfitable ? 'profit' : 'loss'} of <strong>${userCurrency} ${Math.abs(profit).toFixed(2)}</strong>.</p>
        </div>
        <div class="reasoning-section">
          <h4>üìà Hourly Analysis</h4>
          <p>The chart displays your 24-hour performance. We compare each hour's sales against yesterday's same hour to determine if you are trending up or down.</p>
        </div>
      `;
      break;
      
    case "week":
      emoji.textContent = "üìÖ";
      title.textContent = "This Week's Analysis";
      content = `
        <div class="reasoning-section">
          <h4>üìä Weekly Breakdown</h4>
          <p>Your weekly margin is <strong>${marginStr}</strong>. This is calculated by taking your total weekly revenue (${revenueStr}) and subtracting the inventory costs (${costStr}).</p>
        </div>
        <div class="reasoning-section">
          <h4>üí° Growth Insight</h4>
          <p>The 7-day visualization helps identify which days of the week are your "Power Days" versus slow days where inventory costs might be exceeding sales.</p>
        </div>
      `;
      break;
      
    case "month":
      emoji.textContent = "üóìÔ∏è";
      title.textContent = "Monthly Financial Reasoning";
      content = `
        <div class="reasoning-section">
          <h4>üìâ Monthly Profitability</h4>
          <p>With a revenue of ${revenueStr} and costs of ${costStr}, your business is operating at a <strong>${marginStr}</strong> efficiency rate this month.</p>
        </div>
        <div class="reasoning-section">
          <h4>üîç Trend Recognition</h4>
          <p>The curved lines in the chart show "Smoothing Data." Instead of seeing jagged spikes, we show you the overall momentum of your business growth over 30 days.</p>
        </div>
      `;
      break;
      
    case "all":
      emoji.textContent = "üåç";
      title.textContent = "Lifetime Business Logic";
      content = `
        <div class="reasoning-section">
          <h4>üèÜ The Big Picture</h4>
          <p>This shows your total historic performance. You have processed <strong>${Object.keys(sales).length}</strong> total transactions since you started using SalesFlow.</p>
        </div>
        <div class="reasoning-section">
          <h4>üí∞ Total Wealth Generated</h4>
          <p>Your lifetime net ${isProfitable ? 'profit' : 'loss'} stands at <strong>${userCurrency} ${profit.toFixed(2)}</strong>.</p>
        </div>
      `;
      break;
      
    default:
      emoji.textContent = "üìä";
      title.textContent = "Custom View Logic";
      content = `<p>Showing calculations for the custom selected date range based on filtered sales data.</p>`;
  }

  // 3. ADD THE COMMON METRICS FOOTER
  content += `
    <div class="reasoning-metrics">
      <div class="reason-metric-card">
        <div class="label">Efficiency</div>
        <div class="value" style="color: ${isProfitable ? '#10b981' : '#ef4444'}">${isProfitable ? 'Healthy' : 'Low Margin'}</div>
      </div>
      <div class="reason-metric-card">
        <div class="label">Status</div>
        <div class="value">${profit > 0 ? '‚úÖ Profitable' : '‚ö†Ô∏è Review Costs'}</div>
      </div>
    </div>
  `;

  // 4. DISPLAY THE MODAL
  body.innerHTML = content;
  modal.style.display = "flex";
  modal.style.visibility = "visible";
  modal.style.opacity = "1";

  // Backdrop click to close
  modal.onclick = function(e) {
    if (e.target === modal) {
      closeReasoning();
    }
  };
}

function closeReasoning() {
  const modal = document.getElementById("reasoningModal");
  if (modal) {
    modal.style.display = "none";
    modal.onclick = null;
  }
}
// FINANCIAL CALCULATIONS
function calculateFinancials() {
const filter = document.getElementById("timeFilter")?.value || "all";

  const ranges = getTimeRanges();
  
  let startTime = 0, endTime = Infinity;
  let comparisonPeriod = null, periodName = "";

  switch(filter) {
    case "today":
      startTime = ranges.today.start;
      comparisonPeriod = ranges.yesterday;
      periodName = "vs Yesterday";
      break;
case "yesterday":
  emoji.textContent = "‚è™";
  title.textContent = "Yesterday's Performance";
  content = `<p>Yesterday vs day before analysis.</p>`;
  break;
    case "week":
      startTime = ranges.thisWeek.start;
      comparisonPeriod = ranges.lastWeek;
      periodName = "vs Last Week";
      break;
    case "month":
      startTime = ranges.thisMonth.start;
      comparisonPeriod = ranges.lastMonth;
      periodName = "vs Last Month";
      break;
case "year":
  emoji.textContent = "üìÜ";
  title.textContent = "Yearly Performance";
  content = `<p>Year-to-date business performance.</p>`;
  break;
  }

  // Calculate total spend
  let totalSpend = 0;
  const productsWithHistory = new Set();
  if (purchases) {
    Object.values(purchases).forEach(purchase => {
      totalSpend += (parseFloat(purchase.totalCost) || 0);
      productsWithHistory.add(purchase.productId);
    });
  }
  Object.entries(inventory).forEach(([id, product]) => {
    if (!productsWithHistory.has(id)) {
      const priceData = prices[id];
      if (priceData && priceData.costPrice) {
        const costValue = typeof priceData.costPrice === 'object' 
          ? (priceData.costPrice.numericValue || 0) 
          : parseFloat(priceData.costPrice) || 0;
        totalSpend += costValue * (parseFloat(product.quantity) || 0);
      }
    }
  });

  const currentRevenue = calculateRevenueForPeriod(startTime, endTime);
  const currentCost = calculateCostForPeriod(startTime, endTime);
  const grossProfit = currentRevenue - currentCost;
  
  const formatter = new Intl.NumberFormat(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

  document.getElementById("totalSpend").textContent = `${userCurrency} ${formatter.format(totalSpend)}`;
  document.getElementById("totalEarned").textContent = `${userCurrency} ${formatter.format(currentRevenue)}`;
  
  const profitEl = document.getElementById("grossProfit");
  profitEl.textContent = `${userCurrency} ${formatter.format(Math.abs(grossProfit))}`;
  profitEl.style.color = grossProfit >= 0 ? "#1e293b" : "#ef4444";

  // Margin gauge
  const marginLabel = document.getElementById("marginLabel");
  const marginValue = document.getElementById("marginValue");
  const marginFill = document.getElementById("marginFill");
  
  let marginPercent = 0;
  if (grossProfit >= 0) {
    marginPercent = currentRevenue > 0 ? (grossProfit / currentRevenue) * 100 : 0;
    marginLabel.textContent = "Profit Margin";
    marginFill.className = "margin-fill margin-profit";
  } else {
    marginPercent = currentCost > 0 ? (Math.abs(grossProfit) / currentCost) * 100 : 0;
    marginLabel.textContent = "Loss Margin";
    marginFill.className = "margin-fill margin-loss";
  }
  
  marginValue.textContent = `${marginPercent.toFixed(1)}%`;
  marginFill.style.width = `${Math.min(marginPercent, 100)}%`;

  // Comparison
  const earnedCompEl = document.getElementById("earnedComparison");
  const perfIndicator = document.getElementById("performanceIndicator");

  if (comparisonPeriod && filter !== 'all') {
    const previousRevenue = calculateRevenueForPeriod(comparisonPeriod.start, comparisonPeriod.end);
    const comparison = calculateComparison(currentRevenue, previousRevenue);
    earnedCompEl.innerHTML = renderComparisonBadge(comparison, periodName);
    perfIndicator.textContent = comparison.direction === 'up' ? 'Growing' : comparison.direction === 'down' ? 'Declining' : 'Stable';
    perfIndicator.style.color = comparison.direction === 'up' ? '#10b981' : comparison.direction === 'down' ? '#ef4444' : '#1e293b';
  } else {
    earnedCompEl.innerHTML = '<span style="color:#94a3b8; font-size:12px;">No comparison</span>';
    perfIndicator.textContent = "Stable";
  }

  renderPerformanceChart(filter);
}

// SETTINGS & CURRENCY
function openSettings() {
  document.getElementById("settingsCurrencyInput").value = userCurrency;
  document.getElementById("settingsModal").style.display = "flex";
}

function closeSettings() {
  document.getElementById("settingsModal").style.display = "none";
}

async function updateCurrencyFromSettings() {
  const newCurrency = document.getElementById("settingsCurrencyInput").value.trim().toUpperCase();
  if (newCurrency.length < 2) {
    alert("Please enter a valid 3-letter currency code");
    return;
  }
  try {
    const uid = auth.currentUser.uid;
    await db.ref(`BusinessOwners/${uid}/National Currency`).set({
      currency: newCurrency,
      updatedAt: firebase.database.ServerValue.TIMESTAMP
    });
    userCurrency = newCurrency;
    showSuccess(`Currency updated to ${newCurrency}`);
    calculateFinancials();
    render();
    closeSettings();
  } catch (error) {
    alert("Failed to save: " + error.message);
  }
}

async function saveCurrency() {
  const code = document.getElementById("currencyInput").value.trim().toUpperCase();
  if (code.length < 2) return alert("Please enter a valid 3-letter currency code.");
  try {
    const uid = auth.currentUser.uid;
    await db.ref(`BusinessOwners/${uid}/National Currency`).set({
      currency: code,
      updatedAt: firebase.database.ServerValue.TIMESTAMP
    });
    document.getElementById("currencyModal").style.display = "none";
    showSuccess(`Currency set to ${code}`);
  } catch (error) {
    alert("Error: " + error.message);
  }
}

// AUTH & LISTENERS
auth.onAuthStateChanged(user => {
  if (!user) return;

  const currencyRef = db.ref(`BusinessOwners/${user.uid}/National Currency`);
  invRef = db.ref(`Businesses/${user.uid}/inventory`);
  pricesRef = db.ref(`Businesses/${user.uid}/prices`);
  salesRef = db.ref(`Businesses/${user.uid}/sales`);
  purchasesRef = db.ref(`Businesses/${user.uid}/purchases`);

  currencyRef.on("value", snapshot => {
    const data = snapshot.val();
    if (data && data.currency) {
      userCurrency = data.currency.toUpperCase();
      document.getElementById("currencyModal").style.display = "none";
      calculateFinancials();
    } else {
      document.getElementById("currencyModal").style.display = "flex";
    }
  });

  pricesRef.on("value", snapshot => { prices = snapshot.val() || {}; render(); calculateFinancials(); });
  invRef.on("value", snapshot => { inventory = snapshot.val() || {}; render(); calculateFinancials(); });
  salesRef.on("value", snapshot => { sales = snapshot.val() || {}; calculateFinancials(); });
  purchasesRef.on("value", snapshot => { purchases = snapshot.val() || {}; calculateFinancials(); });
});

// UI RENDERING
function render() {
  const grid = document.getElementById("productsGrid");
  if(!grid) return;
  grid.innerHTML = "";

  Object.entries(inventory).forEach(([id, product]) => {
    const priceData = prices[id] || {};
    const costDisp = priceData.costPrice ? (typeof priceData.costPrice === 'object' ? priceData.costPrice.displayString : priceData.costPrice) : "Not set";
    const sellDisp = priceData.sellPrice ? (typeof priceData.sellPrice === 'object' ? priceData.sellPrice.displayString : priceData.sellPrice) : "Not set";

    grid.innerHTML += `
      <div class="product-row">
        <div class="product-name">${product.name}</div>
        <div class="product-qty">${product.quantity} ${product.unit || 'pcs'}</div>
        <div class="product-cost">${userCurrency} ${costDisp}</div>
        <div class="product-sell">${userCurrency} ${sellDisp}</div>
        <div><button class="set-btn" onclick="openPriceModal('${id}', '${product.name}')">Edit</button></div>
      </div>
    `;
  });
}

// BULK UPLOAD
async function openTableUpload() {
  const tbody = document.getElementById('bulkTableBody');
  tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:40px; color:#64748b;">üîÑ Loading...</td></tr>';
  
  let currency = "USD";
  try {
    const ownerSnapshot = await db.ref(`BusinessOwners/${auth.currentUser.uid}`).once('value');
    if (ownerSnapshot.exists() && ownerSnapshot.val()["National Currency"]) {
      currency = ownerSnapshot.val()["National Currency"].currency;
    }
  } catch (e) { console.log("Currency fetch failed"); }

  tbody.innerHTML = '';

  Object.entries(inventory).forEach(([id, product]) => {
    const pData = prices[id] || {};
    const currentCost = (pData.costPrice && pData.costPrice.numericValue !== undefined) 
                        ? pData.costPrice.numericValue 
                        : (typeof pData.costPrice === 'number' ? pData.costPrice : '');
    const currentSell = (pData.sellPrice && pData.sellPrice.numericValue !== undefined) 
                        ? pData.sellPrice.numericValue 
                        : (typeof pData.sellPrice === 'number' ? pData.sellPrice : '');

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>
        <div style="display:flex; align-items:center; gap:12px;">
          <div style="width:40px; height:40px; background:#f1f5f9; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:20px;">${product.icon || 'üì¶'}</div>
          <span style="font-weight:700; color:#0f172a; font-size:15px;">${product.name}</span>
        </div>
      </td>
      <td style="text-align:center;">
        <span style="background:#f0fdf4; color:#16a34a; padding:6px 12px; border-radius:10px; font-weight:700; font-size:13px;">${product.quantity}</span>
      </td>
      <td>
        <div class="input-with-currency">
          <span class="currency-label">${currency}</span>
          <input type="number" class="bulk-cost" data-id="${id}" value="${currentCost}" placeholder="0.00">
        </div>
      </td>
      <td>
        <div class="input-with-currency">
          <span class="currency-label">${currency}</span>
          <input type="number" class="bulk-sell" data-id="${id}" value="${currentSell}" placeholder="0.00">
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById('tableUploadModal').style.display = 'flex';
}

function closeTableUpload() {
  document.getElementById('tableUploadModal').style.display = 'none';
}

async function saveAllPrices() {
  const costInputs = document.querySelectorAll('.bulk-cost');
  const sellInputs = document.querySelectorAll('.bulk-sell');
  const updates = {};
  const uid = auth.currentUser.uid;
  const timestamp = Date.now();

  costInputs.forEach((input, index) => {
    const productId = input.getAttribute('data-id');
    const costVal = input.value.trim();
    const sellVal = sellInputs[index].value.trim();

    if (costVal !== "" && sellVal !== "") {
      const nCost = parseFloat(costVal);
      const nSell = parseFloat(sellVal);

      updates[`Businesses/${uid}/prices/${productId}`] = {
        costPrice: { displayString: costVal, numericValue: nCost },
        sellPrice: { displayString: sellVal, numericValue: nSell },
        updatedAt: timestamp
      };
    }
  });

  if (Object.keys(updates).length === 0) return alert("No changes to save!");

  try {
    await db.ref().update(updates);
    showSuccess("üöÄ All prices updated!");
    closeTableUpload();
  } catch (error) {
    alert("Update failed: " + error.message);
  }
}

// PRICE MODAL
function openPriceModal(productId, productName) {
  currentProductId = productId;
  document.getElementById("modalTitle").textContent = productName;
  const priceData = prices[productId] || {};
  document.getElementById("costPriceInput").value = priceData.costPrice ? (typeof priceData.costPrice === 'object' ? priceData.costPrice.displayString : priceData.costPrice) : "";
  document.getElementById("sellPriceInput").value = priceData.sellPrice ? (typeof priceData.sellPrice === 'object' ? priceData.sellPrice.displayString : priceData.sellPrice) : "";
  document.getElementById("priceModal").style.display = "flex";
}

function closePriceModal() {
  document.getElementById("priceModal").style.display = "none";
}

function savePrices() {
  const costInput = document.getElementById("costPriceInput").value.trim();
  const sellInput = document.getElementById("sellPriceInput").value.trim();

  const numberRegex = /^\d+(\.\d{1,2})?$/;
  if (!numberRegex.test(costInput) || !numberRegex.test(sellInput)) {
    alert("‚ùå INVALID INPUT\n\nPlease enter ONLY numbers (e.g., 200 or 450.50).\n\nDo not add text like 'per pack', 'kg', or '/bottle'.");
    return;
  }

  if (parseFloat(sellInput) <= 0) {
    alert("Selling price must be greater than 0");
    return;
  }

  pricesRef.child(currentProductId).set({
    costPrice: parseFloat(costInput),
    sellPrice: parseFloat(sellInput),
    updatedAt: firebase.database.ServerValue.TIMESTAMP
  }).then(() => {
    showSuccess("Prices Saved!");
    closePriceModal();
  });
}

// DOWNLOAD PDF
async function downloadProducts() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  let businessName = "My Business";
  let currency = "USD";

  try {
    const ownerSnapshot = await db.ref(`BusinessOwners/${auth.currentUser.uid}`).once('value');
    if (ownerSnapshot.exists()) {
      const data = ownerSnapshot.val();
      businessName = data.businessName ? data.businessName.toUpperCase() : "MY BUSINESS";
      if (data["National Currency"] && data["National Currency"].currency) {
        currency = data["National Currency"].currency;
      }
    }
  } catch (e) {
    console.error("Error fetching business data:", e);
  }

  doc.setFontSize(22);
  doc.setTextColor(30, 41, 59);
  doc.text(businessName, 14, 20);

  doc.setFontSize(12);
  doc.setTextColor(100, 116, 139);
  const dateStr = new Date().toLocaleDateString();
  doc.text(`Product Report #${reportCounter} | Date: ${dateStr}`, 14, 28);
  
  doc.setLineWidth(0.5);
  doc.line(14, 32, 196, 32);

  const tableRows = [];
  Object.entries(inventory).forEach(([id, product]) => {
    const pData = prices[id] || {};
    const cost = pData.costPrice ? (pData.costPrice.numericValue || pData.costPrice) : 0;
    const sell = pData.sellPrice ? (pData.sellPrice.numericValue || pData.sellPrice) : 0;

    tableRows.push([
      product.name,
      product.quantity,
      `${currency} ${parseFloat(cost).toFixed(2)}`,
      `${currency} ${parseFloat(sell).toFixed(2)}`
    ]);
  });

  doc.autoTable({
    startY: 40,
    head: [['Product Name', 'Quantity', `Cost (${currency})`, `Sales (${currency})`]],
    body: tableRows,
    theme: 'striped',
    headStyles: { fillColor: [0, 243, 255], textColor: [0, 0, 0] },
    styles: { fontSize: 10, cellPadding: 5 },
    columnStyles: {
      0: { cellWidth: 80 },
      1: { halign: 'center' },
      2: { halign: 'right' },
      3: { halign: 'right' }
    }
  });

  const sanitizedName = businessName.replace(/\s+/g, '_');
  const fileName = `${sanitizedName}_ProductReport_${reportCounter}.pdf`;
  
  doc.save(fileName);
  reportCounter++;
}

function showSuccess(msg) {
  const popup = document.getElementById("successPopup");
  popup.textContent = msg;
  popup.style.display = "block";
  setTimeout(() => popup.style.display = "none", 3000);
}
</script>
</body>
</html>
