
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Manager</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f0f2f5; padding: 20px; }
        .container { max-width: 900px; margin: auto; }
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .box { padding: 25px; border-radius: 12px; color: white; text-align: center; }
        .spend { background: #e74c3c; box-shadow: 0 4px 10px rgba(231, 76, 60, 0.3); }
        .earned { background: #2ecc71; box-shadow: 0 4px 10px rgba(46, 204, 113, 0.3); }
        .box h2 { margin: 0; font-size: 0.9rem; text-transform: uppercase; }
        .box .amount { font-size: 2.2rem; font-weight: bold; margin-top: 5px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px; border-bottom: 2px solid #eee; color: #666; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .qty { width: 60px; font-weight: bold; }
        .price { width: 110px; }
        #setupOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 100; }
        .modal { background: white; padding: 30px; border-radius: 8px; text-align: center; }
    </style>
</head>
<body>

<div id="setupOverlay">
    <div class="modal">
        <h3>Enter Currency</h3>
        <input type="text" id="currencyInput" placeholder="USD, PKR, RS, etc.">
        <button onclick="saveInitialSetup()" style="display:block; width:100%; margin-top:10px; padding:10px; background:#2ecc71; color:white; border:none; border-radius:4px;">Save</button>
    </div>
</div>

<div class="container">
    <div class="dashboard">
        <div class="box spend">
            <h2>Total Spend</h2>
            <div id="totalSpendDisplay" class="amount">0</div>
        </div>
        <div class="box earned">
            <h2>Total Earned</h2>
            <div id="totalEarnedDisplay" class="amount">0</div>
        </div>
    </div>

    <div class="card">
        <h3>Inventory</h3>
        <table>
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Quantity</th>
                    <th>Cost Price (Buy)</th>
                    <th>Sell Price (Earn)</th>
                </tr>
            </thead>
            <tbody id="inventoryBody"></tbody>
        </table>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
    // --- CONFIGURATION ---
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyD6PdrKp2XLfRqjC587lMpdKTaWD4MBens",
  authDomain: "scalevest-163a0.firebaseapp.com",
  databaseURL: "https://scalevest-163a0-default-rtdb.firebaseio.com",
  projectId: "scalevest-163a0",
  storageBucket: "scalevest-163a0.firebasestorage.app",
  messagingSenderId: "938358950124",
  appId: "1:938358950124:web:043506aeaacea2a96bfdc9",
  measurementId: "G-QD3TWBZHR0"
};

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    let uID, currency = "", currentSpend = 0, currentEarned = 0;

    auth.onAuthStateChanged(u => {
        if (!u) return;
        uID = u.uid;

        // Load Business Meta
        db.ref(`BusinessOwners/${uID}`).on('value', s => {
            const data = s.val() || {};
            if (!data.nationalCurrency) {
                document.getElementById('setupOverlay').style.display = 'flex';
            } else {
                document.getElementById('setupOverlay').style.display = 'none';
                currency = data.nationalCurrency;
                currentSpend = data.totalSpend || 0;
                currentEarned = data.totalEarned || 0;
                refreshDashboard();
            }
        });

        // Load Inventory
        db.ref(`Businesses/${uID}/inventory`).on('value', s => {
            renderTable(s.val() || {});
        });
    });

    function saveInitialSetup() {
        const c = document.getElementById('currencyInput').value.toUpperCase();
        if(!c) return;
        db.ref(`BusinessOwners/${uID}`).update({
            nationalCurrency: c,
            totalSpend: 0,
            totalEarned: 0
        });
    }

    function refreshDashboard() {
        document.getElementById('totalSpendDisplay').innerText = `${currency} ${currentSpend.toFixed(2)}`;
        document.getElementById('totalEarnedDisplay').innerText = `${currency} ${currentEarned.toFixed(2)}`;
    }

    function renderTable(data) {
        const tbody = document.getElementById('inventoryBody');
        tbody.innerHTML = "";
        Object.keys(data).forEach(key => {
            const item = data[key];
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${item.name || key}</td>
                <td><input type="number" class="qty" value="${item.quantity || 0}" 
                    onfocus="this.oldValue = this.value;" 
                    onchange="updateQty('${key}', this.value, this.oldValue, '${item.costPrice||0}', '${item.sellingPrice||0}')"></td>
                <td><input type="text" class="price" value="${item.costPrice || ''}" onblur="updateField('${key}', 'costPrice', this.value)"></td>
                <td><input type="text" class="price" value="${item.sellingPrice || ''}" onblur="updateField('${key}', 'sellingPrice', this.value)"></td>
            `;
            tbody.appendChild(tr);
        });
    }

    function updateField(key, field, val) {
        db.ref(`Businesses/${uID}/inventory/${key}`).update({ [field]: val });
    }

  // ... (Keep Firebase Init Code) ...

  function updateQty(key, newVal, oldVal, costTxt, sellTxt) {
    newVal = parseFloat(newVal) || 0;
    // If oldVal is undefined (first time), treat it as 0
    oldVal = parseFloat(oldVal) || 0; 
    
    const diff = newVal - oldVal;

    // Helper to get numbers out of text like "10/kg"
    const parsePrice = (t) => {
        if (!t) return 0;
        const matched = t.toString().match(/(\d+(\.\d+)?)/);
        return matched ? parseFloat(matched[0]) : 0;
    };

    const cost = parsePrice(costTxt);
    const sell = parsePrice(sellTxt);

    let updates = {};
    
    if (diff > 0) {
        // You bought more stock
        currentSpend += (diff * cost);
        updates[`BusinessOwners/${uID}/totalSpend`] = currentSpend;
    } else if (diff < 0) {
        // You sold stock
        currentEarned += (Math.abs(diff) * sell);
        updates[`BusinessOwners/${uID}/totalEarned`] = currentEarned;
    }

    updates[`Businesses/${uID}/inventory/${key}/quantity`] = newVal;
    
    // This sends both the new quantity AND the new totals to Firebase at once
    db.ref().update(updates).then(() => {
        console.log("Finance Updated!");
    }).catch(err => {
        console.error("Firebase Error:", err);
        alert("Check your Firebase Database Rules!");
    });
  }
</script>
</body>
</html>
