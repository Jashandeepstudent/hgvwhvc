<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Founder Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #ff006e, #8338ec, #3a86ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .header h1 svg {
            width: 50px;
            height: 50px;
        }
/* Black & White Premium Theme */
#autoReplyModal .edit-modal-content {
    background: #000000;
    border: 1px solid #333;
    border-radius: 0; /* Sharp edges for a more professional look */
    box-shadow: 0 0 30px rgba(255, 255, 255, 0.05);
    max-width: 550px;
    padding: 0;
}

.edit-modal-header {
    padding: 24px 30px;
    background: #000;
    border-bottom: 1px solid #222;
}

.edit-modal-header h3 {
    font-size: 1.2rem;
    font-weight: 600;
    color: #fff;
    text-transform: uppercase;
    letter-spacing: 2px;
}

#autoReplyTextarea {
    width: 100%;
    min-height: 180px;
    padding: 18px;
    background: #050505;
    border: 1px solid #222;
    border-radius: 0;
    color: #fff;
    font-size: 0.95rem;
    line-height: 1.6;
    outline: none;
    transition: border-color 0.3s ease;
}
/* Status Pill Styling */
.status-pill-nav {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 6px 14px;
    background: #000;
    border: 1px solid #333;
    border-radius: 999px;
    font-size: 0.75rem;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-left: 10px;
    transition: all 0.3s ease;
}

.status-pill-nav.active { color: #fff; border-color: #fff; }
.status-pill-nav.busy { color: #666; border-color: #222; }

/* The indicator dot */
.dot-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
}

.active .dot-indicator { 
    background: #fff; 
    box-shadow: 0 0 8px #fff; 
}

.busy .dot-indicator { 
    background: #ef4444; /* Keep red for busy to ensure it stands out */
}
#autoReplyTextarea:focus {
    border-color: #fff; /* High contrast focus */
}

/* Monochrome Toggle */
.status-card-lite {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-top: 20px;
    padding: 16px;
    background: #0a0a0a;
    border: 1px solid #222;
}

/* Sharp Action Buttons */
.modal-btn-save {
    background: #fff;
    color: #000;
    padding: 12px 28px;
    border-radius: 0;
    border: 1px solid #fff;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.modal-btn-save:hover {
    background: #000;
    color: #fff;
}

.modal-btn-cancel {
    background: transparent;
    color: #666;
    border: 1px solid #222;
    padding: 12px 24px;
    border-radius: 0;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-size: 0.8rem;
}
/* ========================================
   GLOBAL MOBILE RESPONSIVE STYLES
======================================== */

/* Mobile Breakpoint: 768px and below */
@media (max-width: 768px) {
    /* Navigation Bar */
    .top-nav {
        padding: 0.75rem 1rem !important;
        flex-wrap: wrap;
    }
    
    .logo {
        font-size: 1.3rem !important;
    }
    
    .circular-logo-container {
        width: 28px !important;
        height: 28px !important;
    }
    
    .nav-links {
        display: none !important; /* Hide main navigation on mobile */
    }
    
    .top-nav-right {
        gap: 0.75rem !important;
    }
    
    .icon-btn {
        width: 36px !important;
        height: 36px !important;
    }
    
    .status-pill-nav {
        padding: 4px 10px !important;
        font-size: 0.65rem !important;
    }
    
    .btn-browse-angels {
        padding: 5px 12px !important;
        font-size: 0.65rem !important;
        width: auto !important;
        min-width: 100px !important;
    }
    
    /* Container & Layout */
    .container {
        padding: 1.5rem 1rem !important;
        flex-direction: column !important;
        gap: 1.5rem !important;
    }
    
    .left-section {
        width: 100% !important;
        order: 2; /* Move below main content on mobile */
    }
    
    .right-section {
        width: 100% !important;
        max-width: 100% !important;
        order: 1;
    }
    
    /* Welcome Section */
    .welcome-text {
        font-size: 1.6rem !important;
        line-height: 1.3 !important;
    }
    
    .welcome-text svg {
        width: 28px !important;
        height: 28px !important;
    }
    
    .welcome-subtext {
        font-size: 0.95rem !important;
    }
    
    /* Banners */
    .banner {
        padding: 1.5rem !important;
        flex-direction: column !important;
        text-align: center !important;
    }
    
    .banner-content h3 {
        font-size: 1.3rem !important;
    }
    
    .banner-content h3 svg {
        width: 20px !important;
        height: 20px !important;
    }
    
    .banner-content p {
        font-size: 0.9rem !important;
    }
    
    .banner-icon {
        margin-left: 0 !important;
        margin-top: 1rem !important;
        width: 80px !important;
        height: 80px !important;
    }
    
    .banner-icon svg {
        width: 45px !important;
        height: 45px !important;
    }
    
    /* Cards */
    .card {
        padding: 1.5rem !important;
    }
    
    .profile-avatar, .startup-logo, .availability-indicator {
        width: 70px !important;
        height: 70px !important;
        font-size: 2rem !important;
    }
    
    .card-title {
        font-size: 1rem !important;
    }
    
    .card-subtitle {
        font-size: 0.85rem !important;
    }
    
    .card-btn {
        padding: 0.75rem 1.25rem !important;
        font-size: 0.9rem !important;
    }
    
    /* Roadmap */
    .roadmap {
        overflow-x: auto;
        padding: 1rem 0;
    }
    
    .roadmap::before {
        left: 5% !important;
        right: 5% !important;
    }
    
    .step-indicator {
        min-width: 80px;
    }
    
    .step-circle {
        width: 40px !important;
        height: 40px !important;
        font-size: 1rem !important;
    }
    
    .step-label {
        font-size: 0.75rem !important;
    }
    
    /* Form Card */
    .form-card {
        padding: 1.5rem !important;
    }
    
    /* Buttons */
    .buttons {
        flex-direction: column !important;
        gap: 0.75rem !important;
    }
    
    button {
        padding: 0.75rem 1.25rem !important;
        font-size: 0.9rem !important;
    }
    
    /* Vest Tabs */
    .vest-tab {
        padding: 0.5rem 0.75rem !important;
        font-size: 0.8rem !important;
    }
    
    /* Footer */
    .footer {
        padding: 2rem 1rem !important;
    }
    
    .footer-content {
        flex-direction: column !important;
        gap: 1.5rem !important;
        text-align: center !important;
    }
    
    .footer-logo-text {
        font-size: 1.5rem !important;
    }
    
    .footer-links {
        flex-direction: column !important;
        gap: 1rem !important;
    }
    
    /* Profile Pages */
    .edit-profile-container {
        padding: 1.5rem 1rem !important;
    }
    
    .profile-grid {
        grid-template-columns: 1fr !important;
        gap: 1.5rem !important;
    }
    
    .profile-sidebar {
        position: static !important;
        order: 2;
    }
    
    .profile-header-card {
        flex-direction: column !important;
        text-align: center !important;
    }
    
    .profile-avatar-large, .startup-logo-large {
        width: 90px !important;
        height: 90px !important;
        font-size: 2.5rem !important;
    }
    
    .profile-name, .startup-name-large {
        font-size: 1.5rem !important;
    }
    
    .dual-section {
        grid-template-columns: 1fr !important;
    }
    
    /* Modals */
    .edit-modal-content, .special-app-popup {
        width: 95% !important;
        padding: 1.5rem !important;
        max-height: 90vh !important;
        overflow-y: auto !important;
    }
    
    .edit-modal-header {
        padding: 1rem !important;
    }
    
    .edit-modal-body {
        padding: 1rem !important;
    }
    
    .edit-modal-footer {
        padding: 1rem !important;
        flex-direction: column !important;
    }
    
    .modal-btn-save, .modal-btn-cancel {
        width: 100% !important;
    }
    
    /* Back Button */
    .back-to-dash, .back-btn {
        padding: 0.6rem 1rem !important;
        font-size: 0.85rem !important;
    }
    
    /* Action Buttons */
    .action-buttons {
        flex-direction: column !important;
        width: 100% !important;
    }
    
    .preview-btn, .share-btn {
        width: 100% !important;
    }
    
    /* Verification Pages */
    .verify-page {
        padding: 2rem 1rem !important;
    }
    
    .verify-title {
        font-size: 1.8rem !important;
    }
    
    .verify-card {
        padding: 1.5rem !important;
    }
    
    .verify-option-btn {
        padding: 1.5rem !important;
        flex-direction: column !important;
        text-align: center !important;
    }
    
    .verify-icon {
        width: 50px !important;
        height: 50px !important;
    }
    
    /* Chat/Inbox */
    .chat-list-container {
        padding: 1.5rem 1rem !important;
    }
    
    .chat-item {
        padding: 1rem !important;
        gap: 1rem !important;
    }
    
    .chat-avatar {
        width: 48px !important;
        height: 48px !important;
        font-size: 1rem !important;
    }
    
    .chat-name {
        font-size: 1rem !important;
    }
    
    .chat-preview {
        font-size: 0.85rem !important;
        max-width: 100% !important;
    }
    
    /* Applications */
    .manage-vests-page {
        padding: 1.5rem 1rem !important;
    }
    
    .vest-cards-grid {
        grid-template-columns: 1fr !important;
        gap: 1rem !important;
    }
    
    .header-row {
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 1rem !important;
    }
    
    .btn-create-white {
        width: 100% !important;
        justify-content: center !important;
    }
    
    /* Analytics */
    .analytics-page {
        padding: 1.5rem 1rem !important;
    }
    
    .vest-selection-grid, .emergence-grid {
        grid-template-columns: 1fr !important;
        gap: 1.5rem !important;
    }
    
    /* Inbox Card */
    .inbox-card {
        margin-bottom: 1rem;
    }
    
    /* Team Members */
    .team-member-row {
        padding: 0.75rem !important;
    }
    
    .member-avatar-circle {
        width: 35px !important;
        height: 35px !important;
    }
    
    .member-name {
        font-size: 0.9rem !important;
    }
    
    .member-role {
        font-size: 0.8rem !important;
    }
    
    /* Scrollbar for mobile */
    ::-webkit-scrollbar {
        width: 4px !important;
    }
}

/* Extra Small Devices: 480px and below */
@media (max-width: 480px) {
    .welcome-text {
        font-size: 1.4rem !important;
    }
    
    .banner-content h3 {
        font-size: 1.1rem !important;
    }
    
    .card-title {
        font-size: 0.95rem !important;
    }
    
    .profile-name {
        font-size: 1.3rem !important;
    }
    
    .verify-title {
        font-size: 1.5rem !important;
    }
}

/* Landscape Mobile */
@media (max-height: 500px) and (orientation: landscape) {
    .top-nav {
        padding: 0.5rem 1rem !important;
    }
    
    .welcome-section {
        margin-bottom: 1.5rem !important;
    }
    
    .banner {
        padding: 1rem !important;
    }
}
.modal-btn-cancel:hover {
    border-color: #444;
    color: #fff;
}
        .roadmap {
            display: flex;
            justify-content: space-between;
            margin-bottom: 50px;
            position: relative;
            padding: 20px 0;
        }

        .roadmap::before {
            content: '';
            position: absolute;
            top: 35px;
            left: 10%;
            right: 10%;
            height: 3px;
            background: #333;
            z-index: 0;
        }

/* --- REFERRAL PAGE STYLES --- */
.ref-page-container {
    position: relative;
    min-height: 100vh;
    background: #000;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

/* Dynamic Background Animation */
.ref-bg-shapes {
    position: absolute;
    inset: 0;
    z-index: 0;
    pointer-events: none;
}

.ref-shape {
    position: absolute;
    border-radius: 50%;
    filter: blur(80px);
    opacity: 0.4;
    animation: floatShape 10s infinite alternate;
}

.ref-shape-1 { width: 400px; height: 400px; background: #ff006e; top: -100px; left: -100px; }
.ref-shape-2 { width: 500px; height: 500px; background: #8338ec; bottom: -100px; right: -100px; animation-delay: 2s; }
.ref-shape-3 { width: 300px; height: 300px; background: #3a86ff; top: 40%; left: 40%; animation-delay: 4s; opacity: 0.2; }

@keyframes floatShape {
    0% { transform: translate(0, 0) scale(1); }
    100% { transform: translate(30px, 50px) scale(1.1); }
}

/* Glass Card */
.ref-card {
    position: relative;
    z-index: 10;
    background: rgba(20, 20, 20, 0.6);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 24px;
    padding: 60px 40px;
    width: 100%;
    max-width: 550px;
    text-align: center;
    box-shadow: 0 40px 80px rgba(0,0,0,0.5);
    animation: slideUpCard 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
}

@keyframes slideUpCard {
    from { transform: translateY(50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.ref-title {
    font-size: 2.5rem;
    font-weight: 800;
    margin-bottom: 10px;
    background: linear-gradient(135deg, #fff 0%, #aaa 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.ref-subtitle {
    color: #888;
    font-size: 1.1rem;
    margin-bottom: 40px;
    line-height: 1.6;
}

/* Generate Button */
.btn-generate-ref {
    background: linear-gradient(135deg, #ff006e, #8338ec, #3a86ff);
    background-size: 200% 200%;
    color: #fff;
    border: none;
    padding: 18px 40px;
    border-radius: 50px;
    font-size: 1.1rem;
    font-weight: 800;
    letter-spacing: 1px;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.4s ease;
    animation: gradientMove 3s ease infinite;
    box-shadow: 0 10px 30px rgba(255, 0, 110, 0.4);
}

@keyframes gradientMove {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

.btn-generate-ref:hover {
    transform: translateY(-5px) scale(1.05);
    box-shadow: 0 20px 50px rgba(255, 0, 110, 0.6);
}

/* Result Section */
.ref-result-box {
    margin-top: 20px;
    animation: fadeIn 0.5s ease;
}

.ref-input-group {
    display: flex;
    background: #000;
    border: 1px solid #333;
    border-radius: 12px;
    padding: 5px;
    margin-bottom: 30px;
}

.ref-input {
    flex: 1;
    background: transparent;
    border: none;
    color: #fff;
    padding: 15px;
    font-family: monospace;
    font-size: 1rem;
    outline: none;
}

.ref-btn-copy {
    background: #222;
    color: #fff;
    border: none;
    padding: 0 25px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 700;
    transition: 0.2s;
}

.ref-btn-copy:hover {
    background: #fff;
    color: #000;
}

/* Social Share Row */
.share-label {
    color: #666;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 2px;
    margin-bottom: 15px;
    display: block;
    font-weight: 700;
}

.share-row {
    display: flex;
    justify-content: center;
    gap: 20px;
}

.share-icon-btn {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    cursor: pointer;
}

.share-icon-btn:hover {
    transform: translateY(-5px) scale(1.1);
}

.share-whatsapp { background: #25D366; box-shadow: 0 5px 20px rgba(37, 211, 102, 0.3); }
.share-x { background: #000; border: 1px solid #333; box-shadow: 0 5px 20px rgba(255, 255, 255, 0.1); }
.share-facebook { background: #1877F2; box-shadow: 0 5px 20px rgba(24, 119, 242, 0.3); }

.back-link-abs {
    position: absolute;
    top: 30px;
    left: 30px;
    color: #fff;
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
    z-index: 20;
    background: rgba(0,0,0,0.5);
    padding: 10px 20px;
    border-radius: 30px;
    border: 1px solid rgba(255,255,255,0.1);
    backdrop-filter: blur(10px);
    transition: 0.3s;
}

.back-link-abs:hover {
    background: #fff;
    color: #000;
}
/* ===============================
   HEADER ROW
================================ */
.header-row {
    display: flex;
    align-items: center;
    gap: 2rem;
    margin-bottom: 40px;
    width: 100%;
}

/* Left content (title / text) */
.header-row h2,
.header-row .left-content {
    flex: 0 1 auto;
}

/* ===============================
   CREATE VEST BUTTON
================================ */
.btn-create-white {
    background: #ffffff;
    color: #000000;
    border: none;

    padding: 16px 32px;
    font-size: 1rem;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 1px;

    border-radius: 12px;
    cursor: pointer;

    display: inline-flex;
    align-items: center;
    gap: 12px;

    margin-left: auto;
.chat-list-container {
  max-width: 900px;
  margin: 0 auto;
  padding: 24px;
}

.chat-header-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 28px;
}

.inbox-count {
  background: #111827;
  color: #9ca3af;
  padding: 6px 14px;
  border-radius: 999px;
  font-size: 0.8rem;
  font-weight: 600;
}

.chat-item {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 16px;
  border-radius: 16px;
  cursor: pointer;
  transition: 0.2s ease;
  border: 1px solid transparent;
}

.chat-item:hover {
  background: #f9fafb;
  border-color: #e5e7eb;
  transform: translateY(-1px);
}

.chat-avatar {
  position: relative;
  width: 54px;
  height: 54px;
  border-radius: 50%;
  background: #e5e7eb;
  font-weight: 800;
  font-size: 1.2rem;
  color: #111827;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}

.chat-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.chat-info {
  flex: 1;
  min-width: 0;
}

.chat-name {
  font-weight: 700;
  color: #111827;
  margin-bottom: 4px;
}

.chat-preview {
  font-size: 0.9rem;
  color: #6b7280;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* --- Tiny Red Delete Button --- */
.delete-chat-btn {
    background-color: #ef4444; /* Red Background */
    color: white;              /* White Icon */
    border: none;
    cursor: pointer;
    width: 22px;               /* Very small fixed width */
    height: 22px;              /* Very small fixed height */
    border-radius: 50%;        /* Perfect Circle */
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    margin-top: auto; 
    transition: transform 0.2s ease, background-color 0.2s;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.delete-chat-btn:hover {
    background-color: #dc2626; /* Darker Red */
    transform: scale(1.1);     /* Slight pop effect */
}
.unread-text {
  color: #111827;
  font-weight: 600;
}

.chat-meta {
  text-align: right;
  min-width: 70px;
}

.time-text {
  font-size: 0.75rem;
  color: #9ca3af;
}

.unread-pill {
  background: #10b981;
  color: white;
  font-size: 0.7rem;
  font-weight: 700;
  padding: 3px 8px;
  border-radius: 999px;
  margin-top: 6px;
  display: inline-block;
}

    /* ðŸ”’ CRITICAL FIXES */
    width: auto;
    min-width: fit-content;
    flex: 0 0 auto;
    white-space: nowrap;

    box-shadow: 0 8px 20px rgba(255, 255, 255, 0.15);
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
/* ===============================
   APP CARD DELETE (LUXURY FIX)
================================ */
.delete-app-wrapper {
    opacity: 1 !important; /* Force visible */
    display: flex !important;
    background: #ffffff !important;
    border: 1px solid rgba(0,0,0,0.1) !important;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1) !important;
}

.delete-app-wrapper:hover {
    transform: translateY(-2px) scale(1.05);
    box-shadow: 0 10px 25px rgba(0,0,0,0.25);
}
.app-editor-nav {
    max-width: 800px;
    margin: 0 auto 20px auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.btn-back-external {
    background: #fff;
    color: #000;
    border: 1px solid #ccc;
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}


/* Fix chat preview text color */
.chat-preview {
    color: #888;
    max-width: 85%; /* Prevent overlapping with time */
}
.btn-back-external:hover {
    transform: translateX(-5px);
    border-color: #000;
}

.draft-badge {
    background: #ffb703;
    color: #000;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 1px;
}
/* ===============================
   FORM HEADER BUTTON ROW
================================ */
.form-header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 32px;
}

/* Back / Save (Luxury Neutral) */
.btn-back-save {
    background: #ffffff;
    color: #000000;

    border: 1px solid rgba(0,0,0,0.2);
    border-radius: 10px;

    padding: 10px 18px;
    font-weight: 700;
    font-size: 0.85rem;

    display: inline-flex;
    align-items: center;
    gap: 8px;

    cursor: pointer;
    transition: all 0.25s ease;

    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.btn-back-save:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.22);
}

/* ===============================
   FORM FOOTER ACTIONS
================================ */
.form-actions-footer {
    display: flex;
    gap: 16px;
    margin-top: 32px;

    padding-top: 22px;
    border-top: 1px solid rgba(0,0,0,0.08);
}

/* Save Draft (White / Subtle) */
.btn-save-draft {
    flex: 1;

    background: #ffffff;
    color: #000000;

    border: 1px solid rgba(0,0,0,0.15);
    border-radius: 12px;

    padding: 14px;

    font-weight: 800;
    font-size: 0.8rem;
    letter-spacing: 0.6px;
    text-transform: uppercase;

    cursor: pointer;
    transition: all 0.25s ease;

    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
/* --- ONLINE STATUS DOT (FINAL SINGLE SOURCE) --- */
.status-indicator {
    position: absolute;
    bottom: 2px;
    right: 2px;

    width: 16px;             
    height: 16px;

    border-radius: 50%;
    border: 3px solid #111;   
    z-index: 10;
}


.status-online {
    background-color: #10b981;
    box-shadow:
        0 0 8px rgba(16, 185, 129, 0.8),
        0 0 14px rgba(16, 185, 129, 0.5);
}


.status-offline {
    background-color: #ef4444;  
    box-shadow:
        0 0 6px rgba(239, 68, 68, 0.6);
}



.chat-preview {
    color: #bbb; /* Lighter gray for better visibility */
    font-size: 0.95rem;
    max-width: 85%;
}

/* Fix for the weird attachment text */
.attachment-text {
    font-style: italic;
    color: #888;
}
.btn-save-draft:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.22);
}

/* Submit Application (Primary Luxury) */
.btn-submit-app {
    flex: 2;

    background: #000000;
    color: #ffffff;

    border: none;
    border-radius: 12px;

    padding: 14px;

    font-weight: 900;
    font-size: 0.8rem;
    letter-spacing: 1.2px;
    text-transform: uppercase;

    cursor: pointer;
    transition: all 0.25s ease;

    box-shadow: 0 8px 25px rgba(0,0,0,0.35);
}

.btn-submit-app:hover {
    transform: translateY(-2px);
    box-shadow: 0 14px 40px rgba(0,0,0,0.5);
}

/* ===============================
   STATUS PILLS (LUXURY MONO)
================================ */
.status-pill-overlay {
    padding: 6px 14px;
    border-radius: 999px;

    font-size: 0.7rem;
    font-weight: 900;
    letter-spacing: 0.7px;
    text-transform: uppercase;

    background: #ffffff;
    color: #000000;

    border: 1px solid rgba(0,0,0,0.2);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

/* Draft = subtle outline */
.status-pill-overlay.pill-draft {
    opacity: 0.8;
    border-style: dashed;
}

/* Completed = confident solid */
.status-pill-overlay.pill-completed {
    border-color: rgba(0,0,0,0.35);
}

/* Hover effect */
.btn-create-white:hover {
    transform: translateY(-4px) scale(1.02);
    box-shadow: 0 15px 40px rgba(255, 255, 255, 0.3);
    background: #ffffff;
}

/* Icon styling */
.btn-create-white svg {
    width: 20px;
    height: 20px;
    stroke-width: 3px;
    flex-shrink: 0;
}
        .step-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 1;
            flex: 1;
        }

        .step-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #222;
            border: 3px solid #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .step-indicator.active .step-circle {
            background: linear-gradient(135deg, #ff006e, #8338ec);
            border-color: #ff006e;
            transform: scale(1.1);
        }

        .step-indicator.completed .step-circle {
            background: #10b981;
            border-color: #10b981;
        }

        .step-label {
            font-size: 0.85rem;
            text-align: center;
            color: #888;
        }
/* Premium Monochrome Shop UI */
.emergence-page {
    background: #000 !important; /* Pure Black */
}
/* --- SPECIAL WHITE POPUP UI --- */
.edit-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.85);
    display: flex; /* Use flexbox */
    align-items: center; /* Vertical center */
    justify-content: center; /* Horizontal center */
    z-index: 1000000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}

.edit-modal.show {
    opacity: 1;
    visibility: visible;
}

/* --- SPECIAL WHITE POPUP UI --- */
.special-app-popup {
    background: #ffffff;
    width: 90%;
    max-width: 500px;
    border-radius: 4px; /* Slightly smoother professional edges */
    padding: 0;
    position: relative; /* Required for absolute positioning of close button */
    overflow: hidden;
    box-shadow: 0 30px 100px rgba(0,0,0,0.6);
    animation: popupSlideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
}

/* --- CLOSE BUTTON: Absolute Top Right --- */
.close-x {
    position: absolute; /* Take out of flow */
    top: 15px;
    right: 20px;
    background: none;
    border: none;
    font-size: 32px;
    line-height: 1;
    cursor: pointer;
    color: #bbb; /* Subtle gray */
    transition: all 0.2s ease;
    z-index: 10;
}

.close-x:hover { 
    color: #000; 
    transform: scale(1.1);
}

.app-popup-header {
    padding: 30px 40px 10px 40px; /* Aligned with content */
    display: flex;
    justify-content: flex-start; /* Move logo to the left */
}
.logo-mini {
    font-weight: 900;
    font-size: 1.2rem;
    color: #000;
    border: 2px solid #000;
    padding: 2px 8px;
}

.close-x {
    background: none;
    border: none;
    font-size: 28px;
    cursor: pointer;
    color: #888;
    transition: color 0.2s;
}

.close-x:hover { color: #000; }

.app-popup-content {
    padding: 0 40px 40px 40px;
    text-align: left;
}

.app-popup-content h2 {
    color: #000;
    font-size: 1.8rem;
    font-weight: 800;
    margin-bottom: 10px;
}

.app-popup-content p {
    color: #666;
    font-size: 0.95rem;
    line-height: 1.5;
    margin-bottom: 30px;
}
/* --- DOCUMENT STYLE APPLICATION CARDS --- */
.doc-card-header {
    height: 120px;
    background: #fff; /* White header for contrast on black cards */
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}

.doc-sv-logo {
    font-weight: 900;
    font-size: 1.8rem;
    color: #000;
    border: 3px solid #000;
    padding: 0 10px;
    letter-spacing: -1px;
}

.doc-badge {
    position: absolute;
    top: 10px;
    left: 10px;
    background: #000;
    color: #fff;
    font-size: 10px;
    font-weight: 900;
    padding: 2px 6px;
    letter-spacing: 1px;
}

.doc-id-tag {
    position: absolute;
    bottom: 10px;
    right: 15px;
    color: #000;
    font-size: 11px;
    font-weight: 700;
    font-family: monospace;
    opacity: 0.5;
}

/* Hover effect for document card */
.vest-gig-card:hover .doc-card-header {
    background: #f0f0f0;
}

.vest-gig-card:hover .doc-sv-logo {
    transform: scale(1.1);
    transition: 0.3s;
}
.input-wrapper-op label {
    font-size: 0.7rem;
    font-weight: 900;
    color: #000;
    letter-spacing: 1.5px;
    display: block;
    margin-bottom: 10px;
}

#newAppNameInput {
    width: 100%;
    border: none;
    border-bottom: 2px solid #eee;
    background: transparent;
    padding: 12px 0;
    font-size: 1.1rem;
    color: #000;
    border-radius: 0;
    transition: border-color 0.3s;
}
.success-toast {
    position: fixed;
    bottom: 30px;
    right: 30px;
    background: #10b981; /* ScaleVest Green */
    color: white;
    padding: 16px 28px;
    border-radius: 12px;
    font-weight: 700;
    font-size: 0.95rem;
    box-shadow: 0 15px 35px rgba(0,0,0,0.3);
    z-index: 10000001;
    display: flex;
    align-items: center;
    gap: 12px;
    animation: toastSlideIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}

@keyframes toastSlideIn {
    from { transform: translateY(100px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.toast-exit {
    animation: toastFadeOut 0.4s ease forwards;
}

@keyframes toastFadeOut {
    to { opacity: 0; transform: translateY(20px) scale(0.95); }
}
#newAppNameInput:focus {
    outline: none;
    border-color: #000;
}

.app-popup-footer {
    padding: 20px 40px 40px 40px;
    display: flex;
    gap: 15px;
}

/* Button UI Overhaul */
.btn-cancel-op {
    background: #f5f5f5;
    color: #666;
    border: none;
    padding: 15px 25px;
    font-weight: 700;
    cursor: pointer;
    border-radius: 4px;
    font-size: 0.9rem;
}

.btn-confirm-op {
    flex: 1;
    background: #000;
    color: #fff;
    border: none;
    padding: 15px 25px;
    font-weight: 700;
    cursor: pointer;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    font-size: 0.9rem;
    transition: all 0.3s;
}

.btn-confirm-op:hover {
    background: #333;
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.15);
}
/* Glass Buttons for Dashboard/Shop Nav */
.shop-nav-btn {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid #222;
    color: #fff;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 0.85rem;
    letter-spacing: 1px;
    text-transform: uppercase;
    transition: all 0.3s ease;
}

.shop-nav-btn:hover {
    background: #fff;
    color: #000;
    border-color: #fff;
}

.shop-nav-btn.active {
    background: #fff;
    color: #000;
    font-weight: 800;
}

/* Improved Card UI (Black & White) */
.emergence-card {
    background: #0a0a0a !important;
    border: 1px solid #222 !important;
    color: #fff !important;
}
/* Premium Black & White Shop UI */
.shop-bw {
    background: #000 !important;
}

/* Button UI Improvements */
.buy-btn-premium {
    width: 100%;
    padding: 16px;
    background: #fff;
    color: #000;
    border: 1px solid #fff;
    border-radius: 8px;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.buy-btn-premium:hover {
    background: #000;
    color: #fff;
    box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
}

/* Dashboard & Shop Nav Buttons */
.shop-nav-btn {
    background: transparent;
    border: 1px solid #333;
    color: #fff;
    padding: 10px 20px;
    border-radius: 10px;
    font-size: 0.8rem;
    font-weight: 600;
    transition: 0.3s;
}

.shop-nav-btn:hover {
    border-color: #fff;
    background: rgba(255,255,255,0.1);
}

.shop-nav-btn.active {
    background: #fff;
    color: #000;
}
/* Dashboard & Shop Global Premium Buttons */
.buy-btn-premium, .card-btn, .dashboard-btn {
    width: 100%;
    padding: 14px;
    background: #fff !important;
    color: #000 !important;
    border: 1px solid #fff !important;
    border-radius: 8px !important;
    font-weight: 800 !important;
    text-transform: uppercase !important;
    letter-spacing: 1.2px !important;
    cursor: pointer;
    transition: all 0.3s ease !important;
}

.buy-btn-premium:hover, .card-btn:hover, .dashboard-btn:hover {
    background: #000 !important;
    color: #fff !important;
    box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
}
/* Real Document Snapshot Simulation */
.app-screenshot-preview {
    height: 160px;
    background: #111; /* Dark background behind the paper */
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding-top: 20px;
    overflow: hidden;
    position: relative;
    border-bottom: 1px solid #222;
}

.mini-white-sheet {
    width: 120px;
    height: 160px;
    background: #fff;
    border-radius: 2px 2px 0 0;
    padding: 12px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    transform: translateY(0);
    transition: transform 0.3s ease;
}

.application-doc-card:hover .mini-white-sheet {
    transform: translateY(-5px);
}

/* Miniature Content Inside the Snapshot */
.mini-line {
    height: 3px;
    background: #eee;
    margin-bottom: 6px;
    border-radius: 2px;
}
.mini-line.header { width: 30%; background: #ddd; height: 5px; margin-bottom: 10px; }

.mini-title-box {
    font-size: 6px;
    font-weight: 900;
    color: #000;
    line-height: 1;
    margin-bottom: 10px;
    text-transform: uppercase;
    font-family: sans-serif;
}

.mini-body-content { margin-top: 15px; }

.mini-black-card {
    margin-top: 15px;
    height: 30px;
    background: #000;
    border-radius: 1px;
}

/* Status Overlay */
.status-pill-overlay {
    position: absolute;
    bottom: 10px;
    left: 10px;
    font-size: 9px;
    font-weight: 900;
    padding: 3px 8px;
    border-radius: 4px;
    letter-spacing: 1px;
}
.pill-draft { background: #ffb703; color: #000; }
.pill-completed { background: #10b981; color: #fff; }

.doc-date {
    font-size: 10px;
    color: #555;
    font-family: monospace;
}
/* Specific Style for the Token/Alpha/Critical Image Wrappers */
.bundle-image-wrapper {
    height: 100px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 25px;
}

.chest-img {
    height: 100%;
    width: auto;
    /* This filter ensures your black SVGs appear white on the dark background */
    filter: invert(100%) brightness(200%);
    transition: transform 0.3s ease;
}

/* Ensure the Surfing S bar and shop header match B&W theme */
.currency-display {
    border: 1.5px solid #fff !important;
    background: rgba(255,255,255,0.05) !important;
}

.surfing-bar {
    background: #fff !important;
    box-shadow: 0 0 10px #fff !important;
}
/* Overlay Background */
.verify-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(8px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    animation: modalFadeIn 0.3s ease;
}

/* Modal Container */
.verify-modal-container {
    background: #111;
    border: 1px solid #333;
    width: 90%;
    max-width: 400px;
    border-radius: 20px;
    position: relative;
    padding: 40px 30px 30px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.4);
}

/* Close Button Top Right */
.verify-modal-close {
    position: absolute;
    top: 15px;
    right: 15px;
    background: transparent;
    border: none;
    color: #666;
    cursor: pointer;
    transition: 0.2s;
}
.verify-modal-close:hover { color: #fff; }

/* Content Alignment */
.verify-modal-content {
    text-align: center;
}

.verify-icon-wrapper {
    margin-bottom: 20px;
    display: inline-flex;
    padding: 15px;
    background: rgba(255, 0, 110, 0.1);
    border-radius: 50%;
}

.verify-modal-content h3 {
    font-size: 1.4rem;
    font-weight: 700;
    margin-bottom: 12px;
    color: #fff;
}

.verify-modal-content p {
    color: #aaa;
    font-size: 0.95rem;
    line-height: 1.5;
    margin-bottom: 30px;
}

/* Buttons Styling */
.verify-modal-actions {
    display: flex;
    gap: 12px;
}

.verify-modal-actions button {
    flex: 1;
    padding: 12px;
    border-radius: 10px;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    transition: 0.3s;
}

.btn-secondary {
    background: #222;
    border: 1px solid #333;
    color: #eee;
}
.btn-secondary:hover { background: #333; }

.btn-primary {
    background: linear-gradient(135deg, #ff006e, #8338ec);
    border: none;
    color: #fff;
}
.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(255, 0, 110, 0.3);
}

@keyframes modalFadeIn {
    from { opacity: 0; transform: scale(0.95); }
    to { opacity: 1; transform: scale(1); }
}
.shop-nav-btn {
    border-color: #333 !important;
    color: #888 !important;
}

.shop-nav-btn.active {
    background: #fff !important;
    color: #000 !important;
    border-color: #fff !important;
}
/* Chest Image Styling */
.bundle-image-wrapper {
    height: 140px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 20px;
}
.success-toast {
    position: fixed;
    bottom: 30px;
    right: 30px;
    background: #10b981; /* ScaleVest Green */
    color: white;
    padding: 15px 25px;
    border-radius: 8px;
    font-weight: 700;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    z-index: 10000000;
    display: flex;
    align-items: center;
    gap: 12px;
    animation: slideInUp 0.4s ease forwards;
}

@keyframes slideInUp {
    from { transform: translateY(100px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.toast-fade-out {
    animation: fadeOut 0.5s ease forwards;
}

@keyframes fadeOut {
    to { opacity: 0; transform: translateY(20px); }
}
/* Chest Image Styling - FIXED FOR WHITE COLOR */
.chest-img {
    height: 100%;
    width: auto;
    
    /* This converts black SVG to white */
    filter: invert(100%) sepia(0%) saturate(0%) hue-rotate(0deg) brightness(200%) contrast(100%);
    -webkit-filter: invert(100%); 
    
    /* Keep your existing shadow and transitions */
    drop-shadow: 0 10px 15px rgba(255,255,255,0.1); 
    transition: transform 0.3s ease;
}

.bundle-card:hover .chest-img {
    transform: scale(1.1) rotate(-2deg);
    /* Increase brightness on hover for a glow effect */
    filter: invert(100%) brightness(300%);
}

/* Featured Card (Middle One) */
.emergence-card.featured {
    border: 2px solid #fff !important;
    background: linear-gradient(180deg, #0a0a0a 0%, #151515 100%) !important;
}
.emergence-card:hover {
    border-color: #fff !important;
    box-shadow: 0 0 20px rgba(255,255,255,0.1) !important;
}

.plan-icon svg {
    stroke: #fff !important; /* Force all icons to white */
}

.buy-btn {
    background: #fff !important;
    color: #000 !important;
    border-radius: 6px !important;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.buy-btn:hover {
    background: #888 !important;
    color: #fff !important;
}
.bundle-image-wrapper {
    height: 120px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 20px;
}

.chest-img {
    height: 100%;
    width: auto;
    /* This filter turns black SVGs to white */
    filter: invert(100%) brightness(200%);
    transition: transform 0.3s ease;
}

.bundle-card:hover .chest-img {
    transform: scale(1.1);
}

.buy-btn-premium {
    background: #fff;
    color: #000;
    border: 1px solid #fff;
    /* 8px top/bottom, 16px left/right for a tighter look */
    padding: 8px 16px; 
    border-radius: 4px; /* Sharper corners for a more technical look */
    font-weight: 800;
    font-size: 0.75rem; /* Smaller text for a micro-button feel */
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: all 0.2s ease;
    
    /* Strict size control */
    display: inline-block;
    width: fit-content; /* Only as wide as the text */
    min-width: 100px;    /* Much smaller minimum length */
    margin: 0 auto;
}

.buy-btn-premium:hover {
    background: #000;
    color: #fff;
    box-shadow: 0 4px 12px rgba(255, 255, 255, 0.15);
    transform: translateY(-1px);
}
/* Token Shop Specific */
.token-amount { color: #fff !important; font-size: 2.5rem !important; }
.token-cost { color: #888 !important; border-top: 1px solid #222; padding-top: 15px; }

/* Currency Indicator */
.currency-display {
    background: #000;
    border: 1px solid #fff; /* White border for high contrast */
    padding: 10px 20px;
}
        .step-indicator.active .step-label {
            color: #fff;
            font-weight: 600;
        }

        .form-card {
            background: #1a1a1a;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
        }

        .step-content {
            display: none;
        }

        .step-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #fff;
        }
.back-to-dash {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    color: #888;
    text-decoration: none;
    font-size: 0.9rem;
    font-weight: 600;
    padding: 10px 18px;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid #222;
    transition: all 0.3s ease;
}

.back-to-dash svg {
    transition: transform 0.3s ease;
}

.back-to-dash:hover {
    color: #fff;
    background: rgba(255, 255, 255, 0.08);
    border-color: #444;
}

.back-to-dash:hover svg {
    transform: translateX(-5px); /* Smooth slide effect */
    stroke: #ff006e; /* ScaleVest Pink accent on hover */
}
        input, textarea, select {
            width: 100%;
            padding: 12px 16px;
            background: #0a0a0a;
            border: 2px solid #333;
            border-radius: 10px;
            color: #fff;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #ff006e;
            box-shadow: 0 0 0 3px rgba(255, 0, 110, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .keywords-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
/* The background overlay (Hidden by default) */
.modal {
  display: none;             /* <--- THIS IS THE KEY LINE */
  position: fixed;
  z-index: 9999;            /* Ensures it sits on top of everything */
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.6); /* Semi-transparent black */
  backdrop-filter: blur(4px);           /* Optional: Blurs the background for a modern look */
}

/* The actual popup box */
.modal-content {
  background-color: #ffffff;
  margin: 10% auto;         /* Centers it 10% from the top */
  padding: 30px;
  width: 90%;
  max-width: 400px;         /* Keeps it responsive */
  border-radius: 12px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  position: relative;
}
        .keyword-input {
            flex: 1;
            min-width: 150px;
        }

        .tags-input-wrapper {
            background: #0a0a0a;
            border: 2px solid #333;
            border-radius: 10px;
            padding: 12px;
            min-height: 56px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            cursor: text;
            transition: all 0.3s ease;
        }

        .tags-input-wrapper:focus-within {
            border-color: #ff006e;
            box-shadow: 0 0 0 3px rgba(255, 0, 110, 0.1);
        }

        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            flex: 1;
        }

        .tag-pill {
            background: linear-gradient(135deg, #ff006e, #8338ec);
            color: #fff;
            padding: 6px 12px;
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            animation: popIn 0.3s ease;
        }

        @keyframes popIn {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .tag-remove {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: #fff;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .tag-remove:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(1.1);
        }

        .tags-main-input {
            border: none;
            background: transparent;
            flex: 1;
            min-width: 150px;
            padding: 4px 0;
        }

        .tags-main-input:focus {
            outline: none;
            border: none;
            box-shadow: none;
        }

        .file-upload {
            border: 2px dashed #333;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload:hover {
            border-color: #ff006e;
            background: rgba(255, 0, 110, 0.05);
        }

        .file-upload input {
            display: none;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
/* Emergence Page Styles */
.emergence-page {
    padding: 80px 20px;
    max-width: 1300px;
    margin: 0 auto;
    background: radial-gradient(circle at top center, #1a0b2e 0%, #000 60%);
}

.emergence-header {
    text-align: center;
    margin-bottom: 60px;
}

.release-tag {
    display: inline-block;
    padding: 6px 15px;
    background: rgba(255, 0, 110, 0.1);
    border: 1px solid #ff006e;
    color: #ff006e;
    border-radius: 50px;
    font-size: 0.7rem;
    font-weight: 800;
    letter-spacing: 2px;
    margin-bottom: 20px;
}

.emergence-header h1 {
    font-size: 3.5rem;
    font-weight: 800;
    letter-spacing: -1px;
    background: linear-gradient(to bottom, #fff 30%, #666 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 20px;
}

.emergence-header p {
    color: #888;
    max-width: 600px;
    margin: 0 auto;
    line-height: 1.6;
}

/* Card Grid */
.emergence-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 30px;
}

/* Base Card Styling */
.emergence-card {
    background: rgba(10, 10, 10, 0.6);
    backdrop-filter: blur(10px);
    border: 1px solid #222;
    border-radius: 24px;
    padding: 50px 40px;
    position: relative;
    display: flex;
    flex-direction: column;
    transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    overflow: hidden;
}

.emergence-card:hover {
    transform: translateY(-15px);
    border-color: #444;
    box-shadow: 0 30px 60px rgba(0,0,0,0.8);
}

/* Featured / Steady Card */
.emergence-card.featured {
    border: 1px solid #8338ec;
    box-shadow: 0 0 30px rgba(131, 56, 236, 0.2);
    background: rgba(15, 5, 25, 0.8);
    transform: scale(1.05);
}

.most-popular {
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    background: #8338ec;
    color: #fff;
    padding: 5px 20px;
    font-size: 0.7rem;
    font-weight: 900;
    border-radius: 0 0 12px 12px;
}

/* Icons */
.plan-icon {
    width: 70px;
    height: 70px;
    background: #111;
    border: 1px solid #333;
    border-radius: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 25px;
    color: #fff;
}

.alpha .plan-icon { color: #ff006e; border-color: rgba(255, 0, 110, 0.3); }
.steady .plan-icon { color: #8338ec; border-color: rgba(131, 56, 236, 0.3); }
.critical .plan-icon { color: #3a86ff; border-color: rgba(58, 134, 255, 0.3); }

/* Text Content */
.plan-title {
    font-size: 1.8rem;
    margin-bottom: 15px;
}

.plan-desc {
    color: #999;
    font-size: 0.95rem;
    line-height: 1.7;
    margin-bottom: 40px;
    min-height: 100px;
}
/* ===============================
   VEST CARD ACTIONS
================================ */
.card-actions {
    display: flex;
    gap: 12px;
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid rgba(255,255,255,0.08);
}

/* ===============================
   BASE ACTION BUTTON
================================ */
.action-btn {
    flex: 1;
    padding: 12px 14px;

    background: #ffffff;
    color: #000000;

    border-radius: 10px;
    border: 1px solid rgba(0,0,0,0.08);

    font-size: 0.8rem;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.6px;

    cursor: pointer;
    transition: all 0.25s ease;

    box-shadow:
        0 4px 10px rgba(0,0,0,0.08),
        inset 0 0 0 rgba(255,255,255,0);

    display: flex;
    align-items: center;
    justify-content: center;

    white-space: nowrap;
}

/* Premium hover */
.action-btn:hover {
    transform: translateY(-2px);
    box-shadow:
        0 8px 20px rgba(0,0,0,0.15),
        inset 0 1px 0 rgba(255,255,255,0.6);
}

/* Pressed */
.action-btn:active {
    transform: translateY(0);
    box-shadow:
        0 3px 8px rgba(0,0,0,0.12);
}

/* ===============================
   SHUTDOWN / REACTIVATE
================================ */
.btn-shutdown,
.btn-reactivate {
    background: #ffffff;
    color: #000000;
    border-color: rgba(0,0,0,0.12);
}

/* ===============================
   DELETE (ELEGANT DANGER)
================================ */
.btn-delete {
    flex: 0 0 auto;
    min-width: 90px;

    background: #ffffff;
    color: #000000;

    border: 1px solid rgba(0,0,0,0.2);

    box-shadow:
        0 4px 10px rgba(0,0,0,0.1);
}

/* Delete hover = subtle warning */
.btn-delete:hover {
    border-color: #000;
    box-shadow:
        0 10px 25px rgba(0,0,0,0.25);
}
/* --- CHAT INBOX STYLES --- */
/* --- IMPROVED INBOX STYLES --- */
.chat-list-container {
    max-width: 850px;
    margin: 0 auto;
    padding: 2rem 1rem;
    color: #fff;
    min-height: 80vh;
}

.chat-header-row {
    display: flex; 
    justify-content: space-between; 
    align-items: flex-end; 
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.chat-item {
    display: flex;
    align-items: center;
    gap: 1.2rem;
    background: #111;
    border: 1px solid #222;
    padding: 1.2rem;
    border-radius: 14px;
    margin-bottom: 0.8rem;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    overflow: hidden;
}

.chat-item:hover {
    background: #1a1a1a;
    border-color: #333;
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.3);
}

/* Avatar Styling */
.chat-avatar {
    width: 52px;
    height: 52px;
    border-radius: 50%;
    background: linear-gradient(135deg, #333, #444);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1.1rem;
    color: #fff;
    border: 2px solid #222;
    flex-shrink: 0;
    overflow: hidden;
    position: relative;
}

.chat-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* Text Info */
.chat-info {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.chat-name {
    font-size: 1.05rem;
    font-weight: 700;
    color: #fff;
    letter-spacing: 0.3px;
}

.chat-preview {
    color: #888;
    font-size: 0.9rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 95%;
    line-height: 1.4;
}

.unread-text {
    color: #fff;
    font-weight: 600;
}

/* Metadata (Time & Badge) */
.chat-meta {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 6px;
    min-width: 70px;
}

.time-text {
    color: #555;
    font-size: 0.75rem;
    font-weight: 600;
}

.unread-pill {
    background: #10b981; /* ScaleVest Green */
    color: #000;
    font-size: 0.65rem;
    padding: 3px 8px;
    border-radius: 12px;
    font-weight: 800;
    letter-spacing: 0.5px;
    text-transform: uppercase;
}

/* Empty State */
.empty-state-box {
    text-align: center;
    padding: 5rem 2rem;
    border: 1px dashed #333;
    border-radius: 16px;
    color: #666;
    background: #0a0a0a;
}
/* ===============================
   STATUS BADGES (LUXURY)
================================ */
.status-badge {
    position: absolute;
    top: 12px;
    left: 12px;

    padding: 5px 12px;
    border-radius: 8px;

    font-size: 0.7rem;
    font-weight: 900;
    letter-spacing: 0.6px;
    text-transform: uppercase;

    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 10;
}

/* Active = Green */
.status-active {
    background: #10b981;
    color: #fff;
    border: 1px solid #10b981;
}

/* Inactive = Gray */
.status-inactive {
    background: #666;
    color: #fff;
    border: 1px solid #666;
}

/* Draft = Red */
.status-draft {
    background: #ef4444;
    color: #fff;
    border: 1px solid #ef4444;
}
/* Pricing */
.price-section {
    margin-bottom: 40px;
    text-align: left;
}

.price-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 5px;
}

.old-price {
    color: #555;
    text-decoration: line-through;
    font-size: 1.2rem;
}

.discount-pill {
    font-size: 0.65rem;
    color: #10b981;
    background: rgba(16, 185, 129, 0.1);
    padding: 2px 8px;
    border-radius: 4px;
    font-weight: 700;
}

.new-price {
    font-size: 3rem;
    font-weight: 800;
    color: #fff;
}

/* Badges */
.plan-badge {
    position: absolute;
    top: 20px;
    right: -30px;
    background: #ff006e;
    color: #fff;
    padding: 5px 40px;
    transform: rotate(45deg);
    font-size: 0.75rem;
    font-weight: 800;
    box-shadow: 0 5px 15px rgba(255, 0, 110, 0.3);
}

/* Button */
.buy-btn {
    width: 100%;
    padding: 18px;
    border-radius: 14px;
    border: none;
    font-weight: 700;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s;
    background: #fff;
    color: #000;
}

.buy-btn:hover {
    background: #ff006e;
    color: #fff;
    transform: scale(1.02);
}

.featured .buy-btn {
    background: #8338ec;
    color: #fff;
}

.featured .buy-btn:hover {
    background: #fff;
    color: #8338ec;
}
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: #0a0a0a;
            border-radius: 10px;
            cursor: pointer;
            border: 2px solid #333;
            transition: all 0.3s ease;
        }
/* ===============================
   MINI BLACK BACK BUTTON (NEW)
================================ */
.editor-back-mini {
    display: inline-flex;
    align-items: center;
    gap: 6px;

    background: #000000;
    color: #ffffff;

    border: none;
    border-radius: 7px;

    padding: 6px 10px;
    font-size: 0.65rem;
    font-weight: 800;
    letter-spacing: 0.6px;
    text-transform: uppercase;

    cursor: pointer;

    width: auto;
    flex: 0 0 auto;
    white-space: nowrap;

    box-shadow: 0 4px 10px rgba(0,0,0,0.25);
    transition: all 0.2s ease;
}

.editor-back-mini:hover {
    transform: translateY(-1px);
    box-shadow: 0 8px 18px rgba(0,0,0,0.4);
}

.editor-back-mini svg {
    flex-shrink: 0;
}

        .checkbox-item:hover {
            border-color: #8338ec;
        }

        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        button {
            flex: 1;
            padding: 14px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-next {
            background: linear-gradient(135deg, #ff006e, #8338ec);
            color: #fff;
        }

        .btn-next:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(255, 0, 110, 0.3);
        }

        .btn-draft {
            background: #333;
            color: #fff;
        }
.loading-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #0a0a0a;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
}

.loading-screen.hidden {
    display: none;
}
.manage-vests-page {
    padding: 40px 3rem;
    max-width: 1400px;
    margin: 0 auto;
}

.header-row {
    display: flex;
    align-items: center;
    gap: 2rem;
    margin-bottom: 40px;
}

/* Stats Cards */
.vest-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 50px;
}

.stat-card {
    background: #0a0a0a;
    border: 1px solid #222;
    padding: 20px;
    border-radius: 12px;
    display: flex;
    flex-direction: column;
}

.stat-label { color: #888; font-size: 0.85rem; font-weight: 600; text-transform: uppercase; }
.stat-count { font-size: 2rem; font-weight: 800; margin-top: 5px; }
.active-text { color: #10b981; } /* Green */
.draft-text { color: #ff4d4d; }  /* Red */

/* Gig Cards Grid */
.vest-cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 25px;
}

.vest-gig-card {
    background: #0f0f0f;
    border: 1px solid #222;
    border-radius: 16px;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.3s ease;
}

.vest-gig-card:hover {
    transform: translateY(-8px);
    border-color: #444;
    box-shadow: 0 15px 30px rgba(0,0,0,0.5);
}

.vest-thumb-wrapper {
    position: relative;
    width: 100%;
    aspect-ratio: 16/9;
    background: #1a1a1a;
}

.vest-thumb-wrapper img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* ===============================
   STATUS BADGES (LUXURY)
================================ */
.status-badge {
    position: absolute;
    top: 12px;
    left: 12px;

    padding: 5px 12px;
    border-radius: 8px;

    font-size: 0.7rem;
    font-weight: 900;
    letter-spacing: 0.6px;
    text-transform: uppercase;

    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 10;
}

/* Active = Green */
.status-active {
    background: #10b981;
    color: #fff;
    border: 1px solid #10b981;
}

/* Inactive = Gray */
.status-inactive {
    background: #666;
    color: #fff;
    border: 1px solid #666;
}

/* Draft = Red */
.status-draft {
    background: #ef4444;
    color: #fff;
    border: 1px solid #ef4444;
}

.vest-card-content { padding: 20px; }

.vest-hook-text {
    font-size: 1.1rem;
    font-weight: 700;
    line-height: 1.4;
    margin-bottom: 10px;
    color: #fff;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.vest-desc-text {
    color: #888;
    font-size: 0.9rem;
    line-height: 1.5;
    margin-bottom: 20px;
}

.vest-card-footer {
    border-top: 1px solid #222;
    padding-top: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.startup-label { font-weight: 700; color: #fff; font-size: 0.85rem; }
.equity-tag { color: #ff006e; font-weight: 700; font-size: 0.85rem; }
/* Center the loading state globally */
.loading-box {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    position: fixed; /* Absolute to the screen */
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
}

/* Spinner animation */
.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(255, 255, 255, 0.1);
    border-top: 4px solid #fff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 15px;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}
        .btn-draft:hover {
            background: #444;
        }

        .btn-back {
            background: #222;
            color: #fff;
        }

        .btn-back:hover {
            background: #333;
        }

        .btn-launch {
            background: linear-gradient(135deg, #10b981, #3a86ff);
            color: #fff;
        }

        .btn-launch:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
        }

        .celebration {
            display: none;
            text-align: center;
            padding: 60px;
        }

        .celebration.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        .celebration svg {
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .celebration h2 {
            font-size: 2rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #10b981, #3a86ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .dashboard-btn {
            display: inline-block;
            margin-top: 30px;
            padding: 14px 40px;
            background: linear-gradient(135deg, #ff006e, #8338ec);
            color: #fff;
            text-decoration: none;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .dashboard-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(255, 0, 110, 0.3);
        }

        .required {
            color: #ff006e;
        }

        .equity-suffix {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
/* --- SPECIAL UPLOAD ANIMATION --- */
.special-upload-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.92);
    backdrop-filter: blur(15px);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 99999;
    opacity: 0;
    visibility: hidden;
    transition: all 0.4s ease;
}

.special-upload-overlay.active {
    opacity: 1;
    visibility: visible;
}

.pulse-ring {
    width: 80px; height: 80px;
    border-radius: 50%;
    background: linear-gradient(135deg, #ff006e, #8338ec);
    position: relative;
    animation: pulse-glow 2s infinite;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 0 30px rgba(255, 0, 110, 0.5);
    margin-bottom: 2rem;
}

.pulse-ring svg { width: 40px; height: 40px; stroke: #fff; }

@keyframes pulse-glow {
    0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 0, 110, 0.7); }
    70% { transform: scale(1); box-shadow: 0 0 0 20px rgba(255, 0, 110, 0); }
    100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 0, 110, 0); }
}

.upload-status-text {
    font-size: 1.5rem; font-weight: 700;
    background: linear-gradient(90deg, #fff, #aaa);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 0.5rem;
}
.circular-logo-container {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    overflow: hidden;
    background: #fff; /* White background for visibility on dark nav */
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
}

.circular-logo-img {
    width: 100%;
    height: 100%;
    object-fit: cover; /* Ensures image fills the circle without stretching */
}

/* Ensure the logo text and image stay aligned */
.logo {
    font-weight: 800;
    font-size: 1.4rem;
    letter-spacing: -0.5px;
    color: #fff;
    text-transform: none;
}
/* --- NEW PITCH DECK CARD STYLES --- */
.pitch-deck-row {
    display: flex;
    align-items: center;
    background: #111;
    border: 1px solid #333;
    border-radius: 12px;
    padding: 1.5rem;
    gap: 1.5rem;
    transition: all 0.3s;
}

.pitch-deck-row:hover {
    border-color: #555;
    background: #161616;
}

.pdf-thumbnail-container {
    width: 80px; height: 110px;
    background: #222;
    border-radius: 6px;
    overflow: hidden;
    flex-shrink: 0;
    border: 1px solid #444;
    position: relative;
}

.pdf-thumbnail-container canvas {
    width: 100%; height: 100%;
    object-fit: cover;
}

.pdf-details {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
}
/* Shop Navigation */
.shop-nav-btn {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid #333;
    color: #888;
    padding: 10px 20px;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
}
.shop-nav-btn.active {
    background: #fff;
    color: #000;
    border-color: #fff;
}

/* Currency Display */
.currency-display {
    display: flex;
    align-items: center;
    background: rgba(255, 255, 255, 0.05);
    padding: 8px 15px;
    border-radius: 50px;
    border: 1px solid #333;
    gap: 12px;
}

.s-logo-wrapper {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.surfing-bar {
    width: 24px;
    height: 3px;
    background: #fff;
    border-radius: 10px;
    margin-top: -2px;
    box-shadow: 0 0 10px #fff;
    animation: surf 2s infinite ease-in-out;
}

@keyframes surf {
    0%, 100% { transform: translateX(-3px) rotate(-5deg); }
    50% { transform: translateX(3px) rotate(5deg); }
}

#tokenCountDisplay {
    font-weight: 800;
    font-size: 1.1rem;
    color: #fff;
}

.plus-token-btn {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: #fff;
    color: #000;
    border: none;
    font-weight: 900;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: 0.2s;
    padding: 0;
    flex: none;
}

.plus-token-btn:hover { transform: scale(1.1); background: #ff006e; color: #fff; }

.token-cost {
    font-size: 1.5rem;
    font-weight: 800;
    color: #10b981;
    margin-bottom: 20px;
}

.token-amount {
    font-size: 2rem;
    font-weight: 800;
    color: #ffb703;
    margin: 20px 0;
}
.pdf-filename {
    font-size: 1.1rem; font-weight: 600; color: #fff;
    margin-bottom: 0.25rem;
    display: flex; align-items: center; gap: 8px;
}

.pdf-filesize {
    font-size: 0.85rem; color: #888;
}
.white-paper-form {
    background: #fff;
    max-width: 700px;
    margin: 0 auto;
    padding: 40px;
    border-radius: 4px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}
.form-group-white { margin-bottom: 25px; }
.form-group-white label { color: #333; font-weight: 700; margin-bottom: 8px; display: block; }
.form-group-white input, .form-group-white textarea {
    background: #fff !important;
    border: 1px solid #ddd !important;
    color: #000 !important;
    border-radius: 0 !important; /* Professional look */
}
.attach-btn {
    padding: 10px 20px;
    background: #f0f0f0;
    border: 1px solid #ccc;
    cursor: pointer;
    font-weight: 600;
}
.app-footer {
    margin-top: 50px;
    text-align: center;
    border-top: 1px solid #eee;
    padding-top: 20px;
    color: #999;
    font-size: 0.8rem;
}
.picker-modal {
    position: fixed; top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.8); z-index: 100000;
    display:flex; align-items:center; justify-content:center;
}
.picker-content {
    background: #111; padding:30px; border-radius:15px; width:90%; max-width:400px;
}
.picker-item {
    padding:15px; border-bottom: 1px solid #222; cursor:pointer;
}
.picker-item:hover { background: #222; }
.open-pitch-btn {
    background: #fff;
    color: #000;
    border: none;
    padding: 0.6rem 1.2rem;
    border-radius: 8px;
    font-weight: 700;
    cursor: pointer;
    transition: transform 0.2s;
    white-space: nowrap;
}

.open-pitch-btn:hover {
    transform: scale(1.05);
    background: #f0f0f0;
}

/* --- FULL SCREEN VIEWER --- */
.full-screen-viewer {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background: #0a0a0a;
    z-index: 999999;
    display: flex;
    flex-direction: column;
    opacity: 0; pointer-events: none;
    transition: opacity 0.3s ease;
}

.full-screen-viewer.active {
    opacity: 1; pointer-events: all;
}

.viewer-header {
    height: 60px;
    background: #111;
    border-bottom: 1px solid #333;
    display: flex;
    align-items: center;
    padding: 0 2rem;
    justify-content: space-between;
}

.viewer-back-btn {
    display: flex; align-items: center; gap: 0.5rem;
    background: none; border: none; color: #fff;
    font-size: 1rem; font-weight: 600; cursor: pointer;
}

.viewer-back-btn:hover { color: #ccc; }

.viewer-content {
    flex: 1;
    width: 100%;
    background: #000;
}
        .equity-suffix label {
            margin: 0;
        }
    </style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
<div id="availabilityModal" class="modal">
  <div class="modal-content">
    <span class="close-btn">&times;</span>
    <h3 style="margin-bottom: 20px;">Manage Availability</h3>
    
    <div id="modalMenu">
        <button class="modal-option-btn" onclick="showAvailabilityDetail('dateSection')">
            ðŸ“… Set Date of Unavailability
        </button>
        <button class="modal-option-btn" onclick="showAvailabilityDetail('statusSection')">
            ðŸ”˜ Set Status Now (Active/Busy)
        </button>
    </div>

    <div id="dateSection" class="availability-sub-section">
      <label>On which date are you unavailable?</label>
      <input type="date" id="unavailableDate">
      <div style="display:flex; gap:10px; margin-top:20px;">
          <button class="btn-back" onclick="resetModal()">Back</button>
          <button class="btn-launch" onclick="saveStatus()">Save Date</button>
      </div>
    </div>

    <div id="statusSection" class="availability-sub-section">
      <label>Set your current status:</label>
      <select id="status">
        <option value="active">ðŸŸ¢ Active</option>
        <option value="busy">ðŸ”´ Busy / Passive</option>
      </select>
      <div style="display:flex; gap:10px; margin-top:20px;">
          <button class="btn-back" onclick="resetModal()">Back</button>
          <button class="btn-launch" onclick="saveStatus()">Update Status</button>
      </div>
    </div>

  </div>
</div>

<div class="loading-screen" id="loadingScreen">
    <div class="spinner"></div>
</div>
    <div class="container vest-container">
        <div class="header">
            <h1>
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2L2 7L12 12L22 7L12 2Z" fill="url(#grad1)" stroke="url(#grad1)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M2 17L12 22L22 17" stroke="url(#grad1)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M2 12L12 17L22 12" stroke="url(#grad1)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <defs>
                        <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#ff006e;stop-opacity:1" />
                            <stop offset="50%" style="stop-color:#8338ec;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#3a86ff;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                </svg>
                Create Your Vest
            </h1>
            <p>Launch your startup vision in 5 simple steps</p>
        </div>

       <div class="roadmap">
    <div class="step-indicator active" onclick="goToStep(1)" style="cursor: pointer;">
        <div class="step-circle">1</div>
        <div class="step-label">Main Vest</div>
    </div>
    <div class="step-indicator" onclick="goToStep(2)" style="cursor: pointer;">
        <div class="step-circle">2</div>
        <div class="step-label">Startup</div>
    </div>
    <div class="step-indicator" onclick="goToStep(3)" style="cursor: pointer;">
        <div class="step-circle">3</div>
        <div class="step-label">Audit</div>
    </div>
    <div class="step-indicator" onclick="goToStep(4)" style="cursor: pointer;">
        <div class="step-circle">4</div>
        <div class="step-label">Roadmap</div>
    </div>
    <div class="step-indicator" onclick="goToStep(5)" style="cursor: pointer;">
        <div class="step-circle">5</div>
        <div class="step-label">Presence</div>
    </div>
    <div class="step-indicator" onclick="goToStep(6)" style="cursor: pointer;">
        <div class="step-circle">6</div>
        <div class="step-label">Launch</div>
    </div>
</div>

       <div class="form-card">
    
    <div class="step-content active" data-step="1" id="vest_step1">
        <h2>Vest Hook & Problem-Solution</h2>
        <p style="color: #888; margin-bottom: 25px;">Start with a compelling hook and define the problem you're solving.</p>

        <div class="form-group">
            <label>Vest Hook <span class="required">*</span> <span id="hookCount" style="color:#888; font-size:0.8rem; float:right;">0/15 words</span></label>
            <input type="text" id="vestHook" placeholder="e.g., AI-powered recruiting platform reducing hiring time by 70%" oninput="checkWordCount(this, 15, 'hookCount')" required>
        </div>

        <div class="form-group">
            <label>Vest Description <span class="required">*</span></label>
            <textarea id="vestDesc" placeholder="Brief overview of the vest..." style="height: 100px;"></textarea>
        </div>

        <div class="form-group">
            <label>The Problem (Current State) <span class="required">*</span></label>
            <textarea id="vestProblem" placeholder="What problem exists in the market?" style="height: 120px; border-radius: 0; border: 2px solid #333;"></textarea>
        </div>

        <div class="form-group">
            <label>The Solution <span class="required">*</span></label>
            <textarea id="vestSolution" placeholder="How does your startup solve this?" style="height: 120px; border-radius: 0; border: 2px solid #333;"></textarea>
        </div>

<div class="form-group">
    <label>Why You're Best For This <span class="required">*</span></label>
    <textarea id="vestAdvantage" placeholder="What makes you uniquely qualified to solve this problem?" style="height: 120px; border-radius: 0; border: 2px solid #333;"></textarea>
</div>
<div class="form-group">
    <label>Vest Thumbnail (Image) <span class="required">*</span></label>
    <div class="file-upload" onclick="document.getElementById('vestThumbnailInput').click()" style="height: 180px; display: flex; flex-direction: column; justify-content: center; align-items: center; border-style: dashed; overflow: hidden; position: relative;">
        <div id="thumbPreview" style="position: absolute; inset: 0; display: none;">
            <img id="imgPreview" src="" style="width: 100%; height: 100%; object-fit: cover; opacity: 0.5;">
        </div>
        <div id="uploadPlaceholder">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#ff006e" stroke-width="2" style="margin-bottom: 10px;">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                <polyline points="21 15 16 10 5 21"></polyline>
            </svg>
            <p style="color: #888;">Click to Upload Cover Image</p>
            <small style="color: #555;">Recommended: 16:9 Aspect Ratio</small>
        </div>
        <input type="file" id="vestThumbnailInput" accept="image/*" hidden>
    </div>
    <div id="thumbFileName" style="color: #10b981; margin-top: 5px; font-size: 0.85rem;"></div>
</div>
        <div style="display: flex; gap: 20px;">
            <div class="form-group" style="flex:1;">
                <label>Equity Willing to Give (%)</label>
                <input type="number" id="vestEquity" placeholder="e.g. 5">
            </div>
            <div class="form-group" style="flex:1;">
                <label>Fund Ask ($)</label>
                <input type="number" id="vestAsk" placeholder="e.g. 50000">
            </div>
        </div>

        <div class="buttons">
            <button class="btn-draft" onclick="saveNewVestAsDraft()">Save Draft</button>
            <button class="btn-next" onclick="nextStep()">Next: Startup</button>
        </div>
    </div>

    <div class="step-content" data-step="2" id="vest_step2">
        <h2>Startup Details</h2>
        <p style="color: #888; margin-bottom: 25px;">Facts and figures.</p>

        <div class="form-group">
            <label>Startup Name</label>
            <input type="text" id="stName" placeholder="Enter your startup name">
        </div>

        <div class="form-group">
            <label>Detailed Description</label>
            <textarea id="stDesc" placeholder="Describe what your startup does..." style="height: 100px;"></textarea>
        </div>

        <div class="form-group">
            <label>Category</label>
            <select id="stCategory">
                 <option value="AgTech">AgTech (Agriculture Technology)</option>
                            <option value="AdTech">AdTech (Advertising Technology)</option>
                            <option value="AI/ML">AI/ML (Artificial Intelligence & Machine Learning)</option>
                            <option value="Aerospace">Aerospace (Space exploration and satellites)</option>
                            <option value="AutoTech">AutoTech (Automotive and autonomous driving)</option>
                            <option value="BioTech">BioTech (Biology-based innovation)</option>
                            <option value="Blockchain">Blockchain (Decentralized ledgers and crypto)</option>
                            <option value="B2B SaaS">B2B SaaS (Business-to-Business Software)</option>
                            <option value="CleanTech">CleanTech (Environmentally friendly tech)</option>
                            <option value="Cybersecurity">Cybersecurity (Data protection and safety)</option>
                            <option value="ClimateTech">ClimateTech (Addressing global warming)</option>
                            <option value="EdTech">EdTech (Education and online learning)</option>
                            <option value="E-commerce">E-commerce (Online retail)</option>
                            <option value="FinTech">FinTech (Financial services)</option>
                            <option value="FoodTech">FoodTech (Food production and delivery)</option>
                            <option value="GameTech">GameTech (Video games and engines)</option>
                            <option value="HealthTech">HealthTech (Hospital and medical systems)</option>
                            <option value="InsurTech">InsurTech (Insurance innovation)</option>
                            <option value="IoT">IoT (Internet of Things/connected devices)</option>
                            <option value="LegalTech">LegalTech (Automating law services)</option>
                            <option value="Logistics">Logistics (Supply chain and shipping)</option>
                            <option value="MarTech">MarTech (Marketing automation)</option>
                            <option value="MedTech">MedTech (Medical devices and hardware)</option>
                            <option value="PropTech">PropTech (Property and Real Estate)</option>
                            <option value="SaaS">SaaS (Software as a Service)</option>
                            <option value="SpaceTech">SpaceTech (Rocketry and satellite data)</option>
                            <option value="TravelTech">TravelTech (Booking and tourism)</option>
                            <option value="VR/AR">VR/AR (Virtual and Augmented Reality)</option>
                            <option value="Web3">Web3 (Decentralized internet)</option>
                            <option value="Other">Other</option>
                        </select>

        </div>

        <div class="form-group">
            <label>Stage</label>
            <select id="stStage">
                <option value="">Select Stage</option>
                            <option value="Idea">Idea</option>
                            <option value="Building">Building</option>
                            <option value="MVP">MVP</option>
                            <option value="pre-seed">Pre-Seed</option>
                            <option value="seed">Seed</option>
                            <option value="Growing">Growing</option>
                            <option value="Scale">Scale</option>
            </select>
        </div>

        <div style="display: flex; gap: 20px;">
            <div class="form-group" style="flex:1;">
                <label>Current Revenue ($)</label>
                <input type="number" id="stRevenue" placeholder="0">
            </div>
            <div class="form-group" style="flex:1;">
                <label>Valuation ($)</label>
                <input type="number" id="stValuation" placeholder="0">
            </div>
        </div>

        <div class="form-group">
            <label>Pitch Deck (PDF)</label>
            <div class="file-upload" onclick="document.getElementById('newPitchDeck').click()">
                <p>Click to Upload PDF</p>
                <input type="file" id="newPitchDeck" accept=".pdf">
            </div>
            <div id="newPitchDeckName" style="color: #10b981; margin-top: 5px;"></div>
        </div>

        <div class="buttons">
            <button class="btn-back" onclick="previousStep()">Back</button>
            <button class="btn-draft" onclick="saveNewVestAsDraft()">Save Draft</button>
            <button class="btn-next" onclick="nextStep()">Next: Audit</button>
        </div>
    </div>

    <div class="step-content" data-step="3" id="vest_step3">
        <h2>Audit & Viability</h2>
        <p style="color: #888; margin-bottom: 25px;">Prove your concept.</p>

        <div class="form-group">
            <label>Can you scale? (Scalability)</label>
            <textarea id="auditScale" placeholder="Is your idea scalable? How?" style="height: 100px;"></textarea>
        </div>

        <div class="form-group">
            <label>Market Share / Size</label>
            <input type="text" id="auditMarket" placeholder="e.g. $5B TAM, targeting 1%...">
        </div>

        <div class="form-group">
            <label>Competitors</label>
            <textarea id="auditCompetitors" placeholder="Who are similar entities or have similar products?" style="height: 100px;"></textarea>
        </div>

        <div class="form-group">
            <label>Differentiation</label>
            <textarea id="auditDifferent" placeholder="Why is your idea better?" style="height: 100px;"></textarea>
        </div>

        <div class="form-group">
            <label>Monetization Idea</label>
            <textarea id="auditMoney" placeholder="How will you earn money?" style="height: 100px;"></textarea>
        </div>

        <div class="buttons">
            <button class="btn-back" onclick="previousStep()">Back</button>
            <button class="btn-draft" onclick="saveNewVestAsDraft()">Save Draft</button>
            <button class="btn-next" onclick="nextStep()">Next: Roadmap</button>
        </div>
    </div>

    <div class="step-content" data-step="4" id="vest_step4">
        <h2>Strategic Roadmap</h2>
        <p style="color: #888; margin-bottom: 25px;">Future plans.</p>

        <div class="form-group">
            <label>If funded, what will you do?</label>
            <textarea id="roadFundUsage" placeholder="Allocation of funds..." style="height: 100px;"></textarea>
        </div>

        <div class="form-group">
            <label>Main Goal for This Year</label>
            <input type="text" id="roadYearGoal" placeholder="e.g. Reach 10k users">
        </div>

        <div class="form-group">
            <label>Your next 3 Year Vision</label>
            <textarea id="roadVision" placeholder="Where do you see your startup in 3 years?" style="height: 100px;"></textarea>
        </div>

        <div class="form-group">
            <label>Strategy to use funds</label>
            <textarea id="roadStrategy" placeholder="Execution strategy..." style="height: 100px;"></textarea>
        </div>

        <div class="buttons">
            <button class="btn-back" onclick="previousStep()">Back</button>
            <button class="btn-draft" onclick="saveNewVestAsDraft()">Save Draft</button>
            <button class="btn-next" onclick="nextStep()">Next: Presence</button>
        </div>
    </div>

   <div class="step-content" data-step="5" id="vest_step5">
    <h2>Founder Presence</h2>
    <p style="color: #888; margin-bottom: 25px;">The team behind the dream.</p>

    <div class="form-group">
        <label>Founder Name (You)</label>
        <input type="text" id="fpName" placeholder="Your Full Name">
    </div>

    <div class="form-group">
        <label>Do you have Co-Founders?</label>
        <div style="display: flex; gap: 15px; margin-bottom: 15px;">
            <button class="btn-back" id="btnNoCF" onclick="toggleCoFounders(false)" style="flex:1; border:1px solid #333;">No, Solo Founder</button>
            <button class="btn-back" id="btnYesCF" onclick="toggleCoFounders(true)" style="flex:1; border:1px solid #333;">Yes, I have a team</button>
        </div>
        
        <div id="coFounderSection" style="display: none; border-left: 2px solid #8338ec; padding-left: 15px; margin-left: 5px;">
            <div class="form-group">
                <label>How many Co-Founders?</label>
                <input type="number" id="fpCoFounderCount" placeholder="e.g. 2">
            </div>
            <div class="form-group">
                <label>Co-Founder Names & Roles</label>
                <textarea id="fpCoFoundersDetails" placeholder="e.g. John Doe (CTO), Jane Smith (CMO)"></textarea>
            </div>
        </div>
    </div>

    <div class="form-group">
        <label>Demo Video (Upload)</label>
        <div class="file-upload" onclick="document.getElementById('newDemoVideo').click()">
            <p>Click to Upload Video</p>
            <input type="file" id="newDemoVideo" accept="video/*">
        </div>
        <div id="newDemoVideoName" style="color: #10b981; margin-top: 5px;"></div>
    </div>

    <div class="form-group">
        <label>Responsibilities / Work</label>
        <textarea id="fpWork" placeholder="What work do you and your co-founders do?" style="height: 100px;"></textarea>
    </div>

    <div class="buttons">
        <button class="btn-back" onclick="previousStep()">Back</button>
        <button class="btn-draft" onclick="saveNewVestAsDraft()">Save Draft</button>
        <button class="btn-next" onclick="nextStep()">Next: Launch</button>
    </div>
</div>

    <div class="step-content" data-step="6" id="vest_step6">
        <div style="text-align: center; padding: 40px 0;">
            <svg style="width: 80px; height: 80px; margin-bottom: 20px;" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
            <h2>Vest Successfully Completed!</h2>
            <p style="color: #888; margin: 20px 0;">Your vest is ready to go live on ScaleVest.</p>
            
            <div class="buttons" style="justify-content: center;">
                <button class="btn-back" onclick="previousStep()">Review</button>
                <button class="btn-draft" onclick="saveNewVestAsDraft()">Save Draft & Exit</button>
                <button class="btn-launch" onclick="launchNewVest()">Launch Vest</button>
            </div>
        </div>
    </div>

</div>

            <!-- Celebration -->
            <div class="celebration" id="celebration">
                <svg style="width: 120px; height: 120px; margin-bottom: 20px;" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="10" fill="url(#gradCelebrate)" stroke="url(#gradCelebrate)" stroke-width="2"/>
                    <path d="M8 14C8 14 9.5 16 12 16C14.5 16 16 14 16 14" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
                    <circle cx="9" cy="9" r="1" fill="#fff"/>
                    <circle cx="15" cy="9" r="1" fill="#fff"/>
                    <defs>
                        <linearGradient id="gradCelebrate" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#10b981;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#3a86ff;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                </svg>
                <h2>Successfully Launched!</h2>
                <p style="color: #888; margin-top: 10px;">Your vest is now live and ready for investors</p>
               <a href="#founder_dashboard" class="dashboard-btn">
                    Go to Founder Dashboard
                    <svg style="width: 18px; height: 18px; display: inline-block; vertical-align: middle; margin-left: 6px;" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 5L19 12L12 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </a>
            </div>
        </div>
    </div>

   <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getDatabase, ref, set, push, get, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
// Locate your existing import and add 'update' to the list
import { 
    update, 
    onValue 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    const firebaseConfig = {
        apiKey: "AIzaSyD6PdrKp2XLfRqjC587lMpdKTaWD4MBens",
        authDomain: "scalevest-163a0.firebaseapp.com",
        databaseURL: "https://scalevest-163a0-default-rtdb.firebaseio.com",
        projectId: "scalevest-163a0",
        storageBucket: "scalevest-163a0.firebasestorage.app",
        messagingSenderId: "938358950124",
        appId: "1:938358950124:web:043506aeaacea2a96bfdc9",
        measurementId: "G-QD3TWBZHR0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const storage = getStorage(app);
    const auth = getAuth(app);

    let currentUser = null;
let globalUnreadCount = 0;
const STORAGE_KEY = 'vestFormData';
// Helper function to create reusable navbar
function createNavBar() {
    const founderData = cachedFounderData || {};
    return `
<nav class="top-nav">
            <div class="logo" onclick="window.location.hash='founder_dashboard'" 
                 style="cursor: pointer; display: flex; align-items: center; gap: 12px;">
                <div class="circular-logo-container">
                    <img src="ScaleVestLogo.png" alt="ScaleVest Logo" class="circular-logo-img">
                </div>
                ScaleVest
            </div>  


            <div class="nav-links">
                <a href="#founder_dashboard" class="nav-link">Dashboard</a>
             <a href="vests.html#edit_startup" class="nav-link">My Startup</a>
                <div class="dropdown">
                    <span class="nav-link" onclick="toggleDropdown('scaleDropdown')">Scale and Elevate â–¾</span>
                    <div class="dropdown-content" id="scaleDropdown">
                       <a href="#founder_emergence" class="dropdown-item">Founder Emergence</a>
                        <a href="#ScaleVEST_Refers" class="dropdown-item">Referrals</a>
                       
                        <a href="#applications" class="dropdown-item">My Applications</a>
                    </div>
                </div>
            </div>
            <div class="top-nav-right">
                <div class="icon-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                    </svg>
                </div>
                <div class="icon-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                </div>
                <div class="profile-dropdown">
<div class="icon-btn" onclick="toggleDashProfileDropdown()">
    ${founderData?.photoURL 
        ? `<img src="${founderData.photoURL}" alt="Profile" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">` 
        : `<div style="font-size:1.2rem;font-weight:600;">${founderData.founderImage || 'U'}</div>`}
</div>
                    </div>
                    <div class="profile-dropdown-content" id="dashProfileDropdown">
                        <div class="profile-info">
                            <div class="profile-username">${founderData.founderUsername || 'Username'}</div>
                            <div class="profile-userid">${founderData.userId || 'USER_ID'}</div>
                        </div>
                        <button class="switch-btn">Switch to Browse</button>
                        <div class="profile-section">
                            <a href="#" class="profile-link">Refer a Friend</a>
                            <a href="#edit_founderprofile" class="profile-link">Profile</a>
                            <a href="#" class="profile-link" onclick="auth.signOut();return false;">Log Out</a>
                        </div>
                    </div>
                </div>
            </div>
        </nav>
    `;
}

// Toggle dropdown function
window.toggleDropdown = function(id) {
    event.stopPropagation();
    const dropdown = document.getElementById(id);
    
    // Close all other dropdowns
    document.querySelectorAll('.dropdown-content').forEach(dd => {
        if (dd.id !== id) dd.classList.remove('show');
    });
    
    // Toggle this dropdown
    dropdown.classList.toggle('show');
};

// Toggle profile dropdown
window.toggleDashProfileDropdown = function() {
    event.stopPropagation();
    const dropdown = document.getElementById('dashProfileDropdown');
    if (dropdown) {
        dropdown.classList.toggle('show');
    }
};

// Close dropdowns when clicking outside
document.addEventListener('click', (e) => {
    if (!e.target.closest('.dropdown') && !e.target.closest('.profile-dropdown')) {
        document.querySelectorAll('.dropdown-content, .profile-dropdown-content').forEach(dd => {
            dd.classList.remove('show');
        });
    }
});
// Save form data to localStorage
function saveToLocalStorage() {
    const formData = {
        vestTitle: document.getElementById('vestTitle')?.value || '',
        vestDescription: document.getElementById('vestDescription')?.value || '',
        keywords: keywords,
        startupStage: document.getElementById('startupStage')?.value || '',
        category: document.getElementById('category')?.value || '',
        startupName: document.getElementById('startupName')?.value || '',
        startupDescription: document.getElementById('startupDescription')?.value || '',
        fundingAmount: document.getElementById('fundingAmount')?.value || '',
        founderName: document.getElementById('founderName')?.value || '',
        currentStep: currentStep
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(formData));
}

// Load form data from localStorage
function loadFromLocalStorage() {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (!saved) return;
    
    const data = JSON.parse(saved);
    
    if (data.vestTitle) document.getElementById('vestTitle').value = data.vestTitle;
    if (data.vestDescription) document.getElementById('vestDescription').value = data.vestDescription;
    if (data.keywords) {
        keywords = data.keywords;
        updateTagsDisplay();
    }
    if (data.startupStage) document.getElementById('startupStage').value = data.startupStage;
    if (data.category) document.getElementById('category').value = data.category;
    if (data.startupName) document.getElementById('startupName').value = data.startupName;
    if (data.startupDescription) document.getElementById('startupDescription').value = data.startupDescription;
    if (data.fundingAmount) document.getElementById('fundingAmount').value = data.fundingAmount;
    if (data.founderName) document.getElementById('founderName').value = data.founderName;
    if (data.currentStep) {
        currentStep = data.currentStep;
        updateStepDisplay();
    }
}
    let isInitialLoad = true;
    let currentStep = 1;
    let keywords = [];
    let uploadedFiles = {
        startupLogo: null,
        pitchDeck: null,
        transactionProof: null
    };
 let isNewUser = false; 
let cachedFounderData = null;
let cachedStartupData = null;
window.nextStep = function() {
    if (currentStep === 1) {
        const hook = document.getElementById('vestHook').value;
        if (!hook) { 
            alert("Please enter a Vest Hook."); 
            document.getElementById('vestHook').focus();
            return; 
        }
    }

    if (currentStep < 6) {
        currentStep++;
        updateStepDisplay();
        
        // Use correct hash based on mode
        const hashPrefix = isEditMode ? 'vest_edit_step' : 'vest_step';
        window.history.pushState(null, null, `#${hashPrefix}${currentStep}`);
        window.scrollTo(0, 0);
        
        // Update buttons if in edit mode
        if (isEditMode) {
            updateButtonsForEditMode();
        }
    }
};

window.previousStep = function() {
    if (currentStep > 1) {
        currentStep--;
        updateStepDisplay();
        
        const hashPrefix = isEditMode ? 'vest_edit_step' : 'vest_step';
        window.history.pushState(null, null, `#${hashPrefix}${currentStep}`);
        window.scrollTo(0, 0);
        
        if (isEditMode) {
            updateButtonsForEditMode();
        }
    }
};
function updateStepDisplay() {
    // Hide all content
    document.querySelectorAll('.step-content').forEach(el => {
        el.classList.remove('active');
        el.style.display = 'none'; // Force hide
    });

    // Show current content
    const currentContent = document.querySelector(`.step-content[data-step="${currentStep}"]`);
    if(currentContent) {
        currentContent.classList.add('active');
        currentContent.style.display = 'block'; // Force show
    }

    // Update Top Circles
    document.querySelectorAll('.step-indicator').forEach((el, index) => {
        const stepNum = index + 1;
        el.classList.remove('active', 'completed');
        
        if (stepNum === currentStep) {
            el.classList.add('active');
        } else if (stepNum < currentStep) {
            el.classList.add('completed');
        }
    });
}
window.checkWordCount = function(input, maxWords, counterId) {
    const words = input.value.trim().split(/\s+/).filter(word => word.length > 0);
    const count = words.length;
    document.getElementById(counterId).innerText = `${count}/${maxWords} words`;
    
    if (count > maxWords) {
        // Trim extra words
        input.value = words.slice(0, maxWords).join(" ");
        document.getElementById(counterId).style.color = 'red';
        document.getElementById(counterId).innerText = `${maxWords}/${maxWords} words (Limit Reached)`;
    } else {
        document.getElementById(counterId).style.color = '#888';
    }
};

// New File Listeners
const pdInput = document.getElementById('newPitchDeck');
if(pdInput) pdInput.addEventListener('change', (e) => {
    if (e.target.files[0]) document.getElementById('newPitchDeckName').textContent = 'âœ“ ' + e.target.files[0].name;
});

const vidInput = document.getElementById('newDemoVideo');
if(vidInput) vidInput.addEventListener('change', (e) => {
    if (e.target.files[0]) document.getElementById('newDemoVideoName').textContent = 'âœ“ ' + e.target.files[0].name;
});

 async function uploadFileToStorage(file, folder) {
        if (!file || !currentUser) return null;
        const fileName = `${folder}/${currentUser.uid}/${Date.now()}_${file.name}`;
        const fileRef = storageRef(storage, fileName);
        try {
            await uploadBytes(fileRef, file);
            return await getDownloadURL(fileRef);
        } catch (error) {
            console.error('Upload error:', error);
            return null;
        }
    }
// Thumbnail Preview Logic
const thumbInput = document.getElementById('vestThumbnailInput');
if(thumbInput) {
    thumbInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            // Show filename
            document.getElementById('thumbFileName').textContent = 'âœ“ ' + file.name;
            
            // Show Image Preview
            const reader = new FileReader();
            reader.onload = function(event) {
                document.getElementById('imgPreview').src = event.target.result;
                document.getElementById('thumbPreview').style.display = 'block';
                document.getElementById('uploadPlaceholder').style.opacity = '0.3';
            }
            reader.readAsDataURL(file);
        }
    });
}
async function processNewFiles() {
    const deckFile = document.getElementById('newPitchDeck')?.files[0];
    const videoFile = document.getElementById('newDemoVideo')?.files[0];
    const thumbFile = document.getElementById('vestThumbnailInput')?.files[0]; // New
    
    let deckUrl = '';
    let videoUrl = '';
    let thumbUrl = ''; 

    if (deckFile) deckUrl = await uploadFileToStorage(deckFile, 'pitch-decks');
    if (videoFile) videoUrl = await uploadFileToStorage(videoFile, 'demo-videos');
    if (thumbFile) thumbUrl = await uploadFileToStorage(thumbFile, 'vest-thumbnails'); 
    return { deckUrl, videoUrl, thumbUrl };
}

    // 5. Data Collection & Saving
window.collectNewVestData = function(deckUrl, videoUrl, thumbUrl) {
    // Determine Co-Founder Data
    const cfCount = document.getElementById('fpCoFounderCount')?.value || '0';
    const cfDetails = document.getElementById('fpCoFoundersDetails')?.value || '';
    
    // Logic: If inputs are empty, assume Solo Founder
    const coFounderString = (cfCount > 0) 
        ? `${cfCount} Co-Founders: ${cfDetails}` 
        : "Solo Founder";

    return {
        MainVest: {
            thumbnailUrl: thumbUrl || '',
            hook: document.getElementById('vestHook').value || '',
            description: document.getElementById('vestDesc').value || '',
            problem: document.getElementById('vestProblem').value || '',
            solution: document.getElementById('vestSolution').value || '',
            advantage: document.getElementById('vestAdvantage').value || '',
            equityOffered: document.getElementById('vestEquity').value || '',
            fundAsk: document.getElementById('vestAsk').value || ''
        },
        StartupDetails: {
            name: document.getElementById('stName').value || '',
            description: document.getElementById('stDesc').value || '',
            category: document.getElementById('stCategory').value || '',
            stage: document.getElementById('stStage').value || '',
            revenue: document.getElementById('stRevenue').value || '',
            valuation: document.getElementById('stValuation').value || '',
            pitchDeckUrl: deckUrl || ''
        },
        Audit: {
            scalability: document.getElementById('auditScale').value || '',
            marketShare: document.getElementById('auditMarket').value || '',
            competitors: document.getElementById('auditCompetitors').value || '',
            differentiation: document.getElementById('auditDifferent').value || '',
            monetization: document.getElementById('auditMoney').value || ''
        },
        Roadmap: {
            fundUsage: document.getElementById('roadFundUsage').value || '',
            yearGoal: document.getElementById('roadYearGoal').value || '',
            threeYearVision: document.getElementById('roadVision').value || '',
            strategy: document.getElementById('roadStrategy').value || ''
        },
        FounderPresence: {
            founderName: document.getElementById('fpName').value || '',
            // UPDATED HERE:
            coFounders: coFounderString, 
            responsibilities: document.getElementById('fpWork').value || '',
            demoVideoUrl: videoUrl || ''
        },
        createdAt: new Date().toISOString(),
        userId: currentUser ? currentUser.uid : 'anonymous'
    };
};


// 4. Save Draft Function (New Structure)
window.saveNewVestAsDraft = async function() {
    if (!currentUser) return;
    const btn = event.currentTarget;
    btn.innerHTML = 'Saving...';
    
    try {
      const { deckUrl, videoUrl, thumbUrl } = await processNewFiles();
      const vestData = collectNewVestData(deckUrl, videoUrl, thumbUrl);
        vestData.status = 'draft'; // Mark as draft

        // Save to Firebase under Vests/UID/VestID
        const vestRef = ref(db, `Vests/${currentUser.uid}`);
        await push(vestRef, vestData);

        // Redirect to Dashboard
        alert("Draft Saved!");
        window.location.hash = 'founder_dashboard';
    } catch (error) {
        console.error("Draft Save Error", error);
        alert("Error saving draft.");
    } finally {
        btn.innerHTML = 'Save Draft';
    }
};

// 5. Launch Vest Function (New Structure + Profile Update)
window.launchNewVest = async function() {
    if (!currentUser) return;
    const btn = event.currentTarget;
    btn.innerHTML = 'Launching...';
    btn.disabled = true;

    try {
        // 1. Upload Files
        const { deckUrl, videoUrl, thumbUrl } = await processNewFiles();

        // 2. Collect Data
      const vestData = collectNewVestData(deckUrl, videoUrl, thumbUrl);
        vestData.status = 'active'; // Mark as active

        // 3. Save to Vests Node
        const vestRef = ref(db, `Vests/${currentUser.uid}`);
        await push(vestRef, vestData);

        // 4. Update Founder Profile (Active Vests Count)
        const profileRef = ref(db, `founderProfile/${currentUser.uid}`);
        const snapshot = await get(profileRef);
        let currentCount = 0;
        
        if (snapshot.exists()) {
            const data = snapshot.val();
            // Handle case where activeVestscount might not exist yet
            currentCount = data.activeVestsCount ? parseInt(data.activeVestsCount) : 0;
        }

        await update(profileRef, {
            activeVestsCount: currentCount + 1
        });
         clearFormStorage();
        // 5. Redirect to Dashboard
        alert("Vest Launched Successfully!");
        window.location.hash = 'founder_dashboard';

    } catch (error) {
        console.error("Launch Error", error);
        alert("Error launching vest.");
        btn.innerHTML = 'Launch Vest';
        btn.disabled = false;
    }
};
// ============================================
// 1. ROADMAP NAVIGATION
// ============================================
window.goToStep = function(stepNum) {
    currentStep = stepNum;
    updateStepDisplay();
    window.location.hash = `vest_step${currentStep}`;
    window.scrollTo(0, 0);
};

// ============================================
// 2. LOCAL STORAGE PERSISTENCE
// ============================================
const FORM_STORAGE_KEY = 'scalevest_draft_inputs';

// List of all text/number/textarea IDs to track
const inputIds = [
    'vestHook', 'vestDesc', 'vestProblem', 'vestSolution', 'vestAdvantage', 'vestEquity', 'vestAsk',
    'stName', 'stDesc', 'stCategory', 'stStage', 'stRevenue', 'stValuation',
    'auditScale', 'auditMarket', 'auditCompetitors', 'auditDifferent', 'auditMoney',
    'roadFundUsage', 'roadYearGoal', 'roadVision', 'roadStrategy',
    'fpName', 'fpWork', 'fpCoFounderCount', 'fpCoFoundersDetails'
];

// Save to Local Storage on every keystroke
document.addEventListener('input', (e) => {
    if (inputIds.includes(e.target.id)) {
        const formData = {};
        inputIds.forEach(id => {
            const el = document.getElementById(id);
            if (el) formData[id] = el.value;
        });
        localStorage.setItem(FORM_STORAGE_KEY, JSON.stringify(formData));
    }
});

// Load from Local Storage on Page Load
window.addEventListener('DOMContentLoaded', () => {
    const saved = localStorage.getItem(FORM_STORAGE_KEY);
    if (saved) {
        const formData = JSON.parse(saved);
        inputIds.forEach(id => {
            const el = document.getElementById(id);
            if (el && formData[id]) {
                el.value = formData[id];
            }
        });
        // Special check: If co-founder details exist, open the section
        if (formData['fpCoFounderCount'] || formData['fpCoFoundersDetails']) {
            toggleCoFounders(true);
        }
    }
});

// Clear Storage (Call this after successful launch)
window.clearFormStorage = function() {
    localStorage.removeItem(FORM_STORAGE_KEY);
    inputIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
    });
    console.log("Form storage cleared.");
};

// ============================================
// 3. CO-FOUNDER TOGGLE LOGIC
// ============================================
window.toggleCoFounders = function(hasCoFounders) {
    const section = document.getElementById('coFounderSection');
    const btnYes = document.getElementById('btnYesCF');
    const btnNo = document.getElementById('btnNoCF');

    if (hasCoFounders) {
        section.style.display = 'block';
        // Style Buttons
        btnYes.style.background = 'linear-gradient(135deg, #ff006e, #8338ec)';
        btnYes.style.border = 'none';
        btnNo.style.background = '#222';
        btnNo.style.border = '1px solid #333';
    } else {
        section.style.display = 'none';
        // Clear values if they selected No
        document.getElementById('fpCoFounderCount').value = '';
        document.getElementById('fpCoFoundersDetails').value = '';
        
        // Style Buttons
        btnNo.style.background = '#333'; // Active state look
        btnNo.style.border = '1px solid #fff';
        btnYes.style.background = '#222';
        btnYes.style.border = '1px solid #333';
    }
};



// 1. FOUNDER EMERGENCE (CASH SHOP)
window.showFounderEmergence = async function() {
    const tokens = await getLiveTokens();
    const container = document.getElementById('dashboardContainer');
    document.title = "Founder Emergence Plans | ScaleVest";
    container.style.display = 'block';
    document.querySelector('.vest-container').style.display = 'none';

    container.innerHTML = `
      
        <div class="emergence-page shop-bw">
            ${getShopHeaderHTML(tokens, 'emergence')}
            
            <div class="emergence-header">
                <div class="release-tag">PREMIUM OUTREACH</div>
                <h1>Founder Emergence Plans</h1>
                <p>Get your startup in front of the right eyes. Our algorithms match your Funding Application with investors who specialize in your specific category.</p>
            </div>

            <div class="emergence-grid">
                <div class="emergence-card bundle-card">
                    <div class="plan-badge" style="background:#fff; color:#000;">50% OFF</div>
                    <div class="bundle-image-wrapper">
                        <img src="alpha.svg" alt="Alpha Plan" class="chest-img">
                    </div>
                    <h2 class="plan-title">Emerge: Alpha</h2>
                    <p class="plan-desc">The essential entry point. We send your application to <strong>7 interested investors</strong> who actively fund startups in your category.</p>
                    <div class="price-section">
                        <div class="price-row"><span class="old-price">â‚¹300</span><span class="discount-pill">Launch OFF</span></div>
                        <span class="new-price">â‚¹150</span>
                    </div>
                    <button class="buy-btn-premium">Choose Alpha</button>
                </div>

                <div class="emergence-card bundle-card featured">
                    <div class="plan-badge" style="background:#fff; color:#000;">50% OFF</div>
                    <div class="most-popular">MOST POPULAR</div>
                    <div class="plan-icon" style="margin: 0 auto 20px auto;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5" width="60" height="60">
                            <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path>
                        </svg>
                    </div>
                    <h2 class="plan-title">Emerge: Steady</h2>
                    <p class="plan-desc">Our most balanced plan. Take your funding application to <strong>12 interested investors</strong> with high-intent matching.</p>
                    <div class="price-section">
                        <div class="price-row"><span class="old-price">â‚¹400</span><span class="discount-pill">Launch OFF</span></div>
                        <span class="new-price">â‚¹200</span>
                    </div>
                    <button class="buy-btn-premium">Choose Steady</button>
                </div>

                <div class="emergence-card bundle-card">
                    <div class="plan-badge" style="background:#fff; color:#000;">50% OFF</div>
                    <div class="bundle-image-wrapper">
                        <img src="critical.svg" alt="Critical Plan" class="chest-img">
                    </div>
                    <h2 class="plan-title">Emerge: Super Critical</h2>
                    <p class="plan-desc">The ultimate outreach powerhouse. Send your application to <strong>18 top-tier investors</strong> for maximum visibility.</p>
                    <div class="price-section">
                        <div class="price-row"><span class="old-price">â‚¹699</span><span class="discount-pill">Launch OFF</span></div>
                        <span class="new-price">â‚¹350</span>
                    </div>
                    <button class="buy-btn-premium">Go Super Critical</button>
                </div>
            </div>
        </div>
    `;
};

window.showScaleShop = async function() {
    const tokens = await getLiveTokens();
    const container = document.getElementById('dashboardContainer');
    document.title = "Scale Shop | ScaleVest";

    container.innerHTML = `
           <div class="emergence-page shop-bw">
            ${getShopHeaderHTML(tokens, 'scale')}
            
            <div class="emergence-header">
                <h1>Scale Shop</h1>
                <p>Redeem your Scale Tokens to boost your outreach without spending cash.</p>
            </div>

            <div class="emergence-grid">
                <div class="emergence-card bundle-card">
                    <div class="bundle-image-wrapper">
                        <img src="token1.svg" alt="Tiny Token" class="chest-img">
                    </div>
                    <h2 class="plan-title">Emergence: Tiny</h2>
                    <p class="plan-desc">The FREE entry point. Send your application to <strong>3 interested investors</strong>.</p>
                    <div class="token-cost">100 Tokens</div>
                    <button class="buy-btn-premium" onclick="window.handleTokenRedeem(100, 'Tiny')">Redeem Tiny</button>
                </div>

                <div class="emergence-card bundle-card featured">
                    <div class="bundle-image-wrapper">
                        <img src="token2.svg" alt="Small Token" class="chest-img">
                    </div>
                    <h2 class="plan-title">Emergence: Small</h2>
                    <p class="plan-desc">Our most helpful free plan. Take your funding application to <strong>6 interested investors</strong>.</p>
                    <div class="token-cost">200 Tokens</div>
                    <button class="buy-btn-premium" onclick="window.handleTokenRedeem(200, 'Small')">Redeem Small</button>
                </div>

                <div class="emergence-card bundle-card">
                    <div class="bundle-image-wrapper">
                        <img src="token3.svg" alt="Medium Token" class="chest-img">
                    </div>
                    <h2 class="plan-title">Emergence: Medium</h2>
                    <p class="plan-desc">Strategic boost. Take your funding application to <strong>10 interested investors</strong>.</p>
                    <div class="token-cost">320 Tokens</div>
                    <button class="buy-btn-premium" onclick="window.handleTokenRedeem(320, 'Medium')">Redeem Medium</button>
                </div>
            </div>
        </div>
    `;
};
// 3. TOKEN SHOP (BUY SCALE TOKENS)
window.showTokenShop = async function() {
    const tokens = await getLiveTokens();
    const container = document.getElementById('dashboardContainer');
    document.title = "Buy Scale Tokens | ScaleVest";

    container.innerHTML = `
      
        <div class="emergence-page shop-bw">
            ${getShopHeaderHTML(tokens, 'tokens')}
            
            <div class="emergence-header">
                <h1>Token Shop</h1>
                <p>Choose a bundle to refill your Scale balance.</p>
            </div>

            <div class="emergence-grid">
                <div class="emergence-card bundle-card">
                    <div class="bundle-image-wrapper">
                        <img src="chest1.svg" alt="Small Chest" class="chest-img">
                    </div>
                    <h2 class="plan-title">Small Bundle</h2>
                    <div class="token-amount">80 Scale Tokens</div>
                    <div class="price-section"><span class="new-price">â‚¹50</span></div>
                    <button class="buy-btn-premium" onclick="window.addTokensToDB(80)">Buy Now</button>
                </div>

                <div class="emergence-card bundle-card featured">
                    <div class="bundle-image-wrapper">
                        <img src="chest2.svg" alt="Medium Chest" class="chest-img">
                    </div>
                    <h2 class="plan-title">Medium Bundle</h2>
                    <div class="token-amount">180 Scale Tokens</div>
                    <div class="price-section"><span class="new-price">â‚¹150</span></div>
                    <button class="buy-btn-premium" onclick="window.addTokensToDB(180)">Buy Now</button>
                </div>

                <div class="emergence-card bundle-card">
                    <div class="bundle-image-wrapper">
                        <img src="chest3.svg" alt="Large Chest" class="chest-img">
                    </div>
                    <h2 class="plan-title">Large Bundle</h2>
                    <div class="token-amount">500 Scale Tokens</div>
                    <div class="price-section"><span class="new-price">â‚¹400</span></div>
                    <button class="buy-btn-premium" onclick="window.addTokensToDB(500)">Buy Now</button>
                </div>
            </div>
        </div>
    `;
};
async function showManageVests() {
    // â­ ADD THIS CHECK AT THE VERY START
    if (!currentUser) {
        window.location.href = 'login2.html';
        return;
    }
    
    // Check verification status
    const founderRef = ref(db, `founderProfile/${currentUser.uid}`);
    const snapshot = await get(founderRef);
    
    if (snapshot.exists()) {
        const data = snapshot.val();
        
        if (data.isVerified === false) {
            showVerificationBlockPopup('manage your vests');
            return;
        }
    }
    

    document.title = "Manage Your Vests | ScaleVest";
    const container = document.getElementById('dashboardContainer');
    container.style.display = 'block';
    document.querySelector('.vest-container').style.display = 'none';

    // 1. Fetch Data
    const vestsRef = ref(db, `Vests/${currentUser.uid}`);

    const vestsData = snapshot.val() || {};

    // 2. Count Stats
    const activeVests = Object.values(vestsData).filter(v => v.status === 'active');
    const inactiveVests = Object.values(vestsData).filter(v => v.status === 'inactive' || v.status === 'draft');

    container.innerHTML = `
        <div class="manage-vests-page">
            <div class="header-row">
                <a href="#founder_dashboard" class="back-to-dash">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                    Back
                </a>
                <h1 style="margin:0;">Manage Vests</h1>
                <button class="btn-create-white" onclick="window.location.hash='vest_step1'">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    Create New Vest
                </button>
            </div>

            <div class="vest-stats-grid">
                <div class="stat-card">
                    <span class="stat-label">Active Vests</span>
                    <span class="stat-count active-text">${activeVests.length}</span>
                </div>
                <div class="stat-card">
                    <span class="stat-label">Inactive / Drafts</span>
                    <span class="stat-count draft-text">${inactiveVests.length}</span>
                </div>
            </div>

            <div class="vest-cards-grid">
                ${Object.keys(vestsData).length > 0 ? 
                    Object.entries(vestsData).map(([id, vest]) => {
                        let statusClass = 'status-draft';
                        let statusText = 'Draft';
                        let toggleBtnText = 'Activate';
                        let toggleBtnClass = 'btn-reactivate';

                        if (vest.status === 'active') {
                            statusClass = 'status-active';
                            statusText = 'Active';
                            toggleBtnText = 'Shutdown';
                            toggleBtnClass = 'btn-shutdown';
                        } else if (vest.status === 'inactive') {
                            statusClass = 'status-inactive';
                            statusText = 'Not Active';
                            toggleBtnText = 'Re-Activate';
                            toggleBtnClass = 'btn-reactivate';
                        }

                        return `
                        <div class="vest-gig-card">
                            <div class="vest-thumb-wrapper">
                                <img src="${vest.MainVest?.thumbnailUrl || 'https://via.placeholder.com/400x225?text=No+Thumbnail'}" alt="Thumbnail">
                                <div class="status-badge ${statusClass}">
                                    ${statusText}
                                </div>
                            </div>
                            <div class="vest-card-content">
                                <h3 class="vest-hook-text">${vest.MainVest?.hook || 'No Hook Line'}</h3>
                                <p class="vest-desc-text">${vest.MainVest?.description?.substring(0, 80) || 'No description...'}...</p>
                                
                                <div class="vest-card-footer">
                                    <span class="startup-label">${vest.StartupDetails?.name || 'Startup'}</span>
                                    <span class="equity-tag">${vest.MainVest?.equityOffered || '0'}% Equity</span>
                                </div>

                                <div class="card-actions">
                                    <!-- â­ NEW EDIT BUTTON -->
                                    <button class="action-btn btn-edit" 
                                        onclick="window.editVest('${id}', '${vest.status}')">
                                        Edit
                                    </button>
                                    
                                    <button class="action-btn ${toggleBtnClass}" 
                                        onclick="window.toggleVestStatus('${id}', '${vest.status}')">
                                        ${toggleBtnText}
                                    </button>
                                    
                                    <button class="action-btn btn-delete" 
                                        onclick="window.deleteVest('${id}')">
                                        Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                        `;
                    }).join('') 
                : `<div class="empty-state" style="grid-column: 1/-1; text-align:center; padding: 40px; color:#666;">
                        <p>No vests found.</p>
                   </div>`}
            </div>
        </div>
    `;
}
// Global variable to track if we're in edit mode
let isEditMode = false;
let currentEditVestId = null;

window.editVest = async function(vestId, vestStatus) {
    // Set edit mode flags
    isEditMode = true;
    currentEditVestId = vestId;
    
    try {
        // Fetch the vest data
        const vestRef = ref(db, `Vests/${currentUser.uid}/${vestId}`);
        const snapshot = await get(vestRef);
        
        if (!snapshot.exists()) {
            alert("Vest not found!");
            return;
        }
        
        const vestData = snapshot.val();
        
        // Store vest status for button logic
        sessionStorage.setItem('editVestStatus', vestStatus);
        sessionStorage.setItem('editVestId', vestId);
        sessionStorage.setItem('editVestData', JSON.stringify(vestData));
        
        // Navigate to step 1
        window.location.hash = 'vest_edit_step1';
        
        // Load the vest data into form
        setTimeout(() => loadVestDataIntoForm(vestData), 100);
        
    } catch (error) {
        console.error("Error loading vest:", error);
        alert("Failed to load vest data");
    }
};

// Load vest data into form inputs
function loadVestDataIntoForm(vestData) {
    // Step 1 - Main Vest
    if (vestData.MainVest) {
        document.getElementById('vestHook').value = vestData.MainVest.hook || '';
        document.getElementById('vestDesc').value = vestData.MainVest.description || '';
        document.getElementById('vestProblem').value = vestData.MainVest.problem || '';
        document.getElementById('vestSolution').value = vestData.MainVest.solution || '';
        document.getElementById('vestAdvantage').value = vestData.MainVest.advantage || '';
        document.getElementById('vestEquity').value = vestData.MainVest.equityOffered || '';
        document.getElementById('vestAsk').value = vestData.MainVest.fundAsk || '';
        
        // Show thumbnail preview if exists
        if (vestData.MainVest.thumbnailUrl) {
            document.getElementById('imgPreview').src = vestData.MainVest.thumbnailUrl;
            document.getElementById('thumbPreview').style.display = 'block';
            document.getElementById('uploadPlaceholder').style.opacity = '0.3';
            document.getElementById('thumbFileName').textContent = 'âœ“ Current thumbnail';
        }
    }
    
    // Step 2 - Startup Details
    if (vestData.StartupDetails) {
        document.getElementById('stName').value = vestData.StartupDetails.name || '';
        document.getElementById('stDesc').value = vestData.StartupDetails.description || '';
        document.getElementById('stCategory').value = vestData.StartupDetails.category || '';
        document.getElementById('stStage').value = vestData.StartupDetails.stage || '';
        document.getElementById('stRevenue').value = vestData.StartupDetails.revenue || '';
        document.getElementById('stValuation').value = vestData.StartupDetails.valuation || '';
        
        if (vestData.StartupDetails.pitchDeckUrl) {
            document.getElementById('newPitchDeckName').textContent = 'âœ“ Pitch deck uploaded';
        }
    }
    
    // Step 3 - Audit
    if (vestData.Audit) {
        document.getElementById('auditScale').value = vestData.Audit.scalability || '';
        document.getElementById('auditMarket').value = vestData.Audit.marketShare || '';
        document.getElementById('auditCompetitors').value = vestData.Audit.competitors || '';
        document.getElementById('auditDifferent').value = vestData.Audit.differentiation || '';
        document.getElementById('auditMoney').value = vestData.Audit.monetization || '';
    }
    
    // Step 4 - Roadmap
    if (vestData.Roadmap) {
        document.getElementById('roadFundUsage').value = vestData.Roadmap.fundUsage || '';
        document.getElementById('roadYearGoal').value = vestData.Roadmap.yearGoal || '';
        document.getElementById('roadVision').value = vestData.Roadmap.threeYearVision || '';
        document.getElementById('roadStrategy').value = vestData.Roadmap.strategy || '';
    }
    
    // Step 5 - Founder Presence
    if (vestData.FounderPresence) {
        document.getElementById('fpName').value = vestData.FounderPresence.founderName || '';
        document.getElementById('fpWork').value = vestData.FounderPresence.responsibilities || '';
        
        // Handle co-founders
        const coFounders = vestData.FounderPresence.coFounders || '';
        if (coFounders && coFounders !== 'Solo Founder') {
            const match = coFounders.match(/^(\d+) Co-Founders: (.+)$/);
            if (match) {
                document.getElementById('fpCoFounderCount').value = match[1];
                document.getElementById('fpCoFoundersDetails').value = match[2];
                toggleCoFounders(true);
            }
        }
        
        if (vestData.FounderPresence.demoVideoUrl) {
            document.getElementById('newDemoVideoName').textContent = 'âœ“ Demo video uploaded';
        }
    }
}
// --- DELETE VEST ---
window.deleteVest = async function(vestId) {
    if(!currentUser) return;
    if(!confirm("Are you sure you want to PERMANENTLY delete this vest? This cannot be undone.")) return;

    try {
        // 1. Remove from Database
        await set(ref(db, `Vests/${currentUser.uid}/${vestId}`), null);
        
        // 2. Refresh UI
        alert("Vest Deleted.");
        showManageVests(); // Refresh the list
    } catch(e) {
        console.error(e);
        alert("Error deleting vest.");
    }
};

// --- TOGGLE SHUTDOWN / RE-ACTIVATE ---
window.toggleVestStatus = async function(vestId, currentStatus) {
    if(!currentUser) return;

    let newStatus = 'active';
    let message = "Vest Re-Activated!";

    // Logic: If it's active, we shut it down (make it inactive)
    if (currentStatus === 'active') {
        newStatus = 'inactive';
        message = "Vest Shutdown (Not Active).";
    }

    try {
        // 1. Update Database Status
        await update(ref(db, `Vests/${currentUser.uid}/${vestId}`), {
            status: newStatus
        });

        // 2. Update Profile Counts (Optional but recommended)
        // If shutting down, decrement active count. If activating, increment.
        const profileRef = ref(db, `founderProfile/${currentUser.uid}`);
        const snap = await get(profileRef);
        if(snap.exists()) {
            let count = parseInt(snap.val().activeVestsCount) || 0;
            if (newStatus === 'inactive') count = Math.max(0, count - 1);
            else count = count + 1;
            
            await update(profileRef, { activeVestsCount: count });
        }
        
        // 3. Refresh UI
        alert(message);
        showManageVests(); // Refresh the list
    } catch(e) {
        console.error(e);
        alert("Error updating status.");
    }
};
// Buy Tokens Logic
window.addTokensToDB = async function(amount) {
    if (!currentUser) return;
    try {
        const currentTokens = await getLiveTokens();
        const newTotal = currentTokens + amount;
        
        await update(ref(db, `founderProfile/${currentUser.uid}`), {
            scaleTokens: newTotal
        });
        
        alert(`âœ… Success! Added ${amount} tokens. New balance: ${newTotal}`);
        showScaleShop(); // Take user to use their new tokens
    } catch (e) {
        console.error(e);
        alert("Transaction failed. Check connection.");
    }
};

// Use Tokens Logic
window.handleTokenRedeem = async function(cost, planName) {
    const currentTokens = await getLiveTokens();
    if (currentTokens < cost) {
        alert("âŒ Not enough tokens!");
        return;
    }
    
    if (confirm(`Redeem ${cost} tokens for the ${planName} plan?`)) {
        try {
            await update(ref(db, `founderProfile/${currentUser.uid}`), {
                scaleTokens: currentTokens - cost
            });
            alert(`ðŸš€ ${planName} Plan Activated! We are sending your application now.`);
            showScaleShop(); // Refresh UI balance
        } catch (e) {
            alert("Error processing redemption.");
        }
    }
};

// --- DATABASE HELPER ---
async function getLiveTokens() {
    if (!currentUser) return 0;
    try {
        const tokenRef = ref(db, `founderProfile/${currentUser.uid}/scaleTokens`);
        const snapshot = await get(tokenRef);
        return snapshot.exists() ? snapshot.val() : 0;
    } catch (error) {
        console.error("Error fetching tokens:", error);
        return 0;
    }
}

// --- UI HEADER HELPER ---
function getShopHeaderHTML(tokenCount, activeTab) {
    let navButtons = '';

    if (activeTab === 'emergence') {
        navButtons = `
            <button class="shop-nav-btn" onclick="window.showScaleShop()">Scale Shop</button>
            <a href="#founder_dashboard" class="shop-nav-btn" style="text-decoration:none;">Dashboard</a>
        `;
    } else if (activeTab === 'scale') {
        navButtons = `
            <button class="shop-nav-btn" onclick="window.showFounderEmergence()">Emergence Shop</button>
            <button class="shop-nav-btn" onclick="window.showTokenShop()">Buy Scale Tokens</button>
            <a href="#founder_dashboard" class="shop-nav-btn" style="text-decoration:none;">Dashboard</a>
        `;
    } else if (activeTab === 'tokens') {
        navButtons = `
            <button class="shop-nav-btn" onclick="window.showScaleShop()">Scale Shop</button>
            <a href="#founder_dashboard" class="shop-nav-btn" style="text-decoration:none;">Dashboard</a>
        `;
    }

    return `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 50px;">
        <div class="currency-display">
            <div class="s-logo-wrapper">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5">
                    <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
                </svg>
                <div class="surfing-bar" style="background:#fff;"></div>
            </div>
            <span id="tokenCountDisplay">${tokenCount}</span>
            <button class="plus-token-btn" onclick="window.showTokenShop()">+</button>
        </div>
        <div style="display: flex; gap: 15px;">${navButtons}</div>
    </div>`;
}



window.showApplicationsList = async function() {
    const container = document.getElementById('dashboardContainer');
    document.querySelector('.vest-container').style.display = 'none';
    container.style.display = 'block';
    
    // Show a centered loader while fetching
    container.innerHTML = `<div class="loading-box"><div class="spinner"></div><p>Fetching Applications...</p></div>`;

    const appRef = ref(db, `Applications/${currentUser.uid}`);
    const snapshot = await get(appRef);
    const apps = snapshot.val() || {};

    container.innerHTML = `
        <div class="manage-vests-page">
            <div class="header-row">
                <a href="#founder_dashboard" class="back-to-dash">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                    Dashboard
                </a>
                <h1>My Funding Applications</h1>
            </div>
            
            <div class="vest-cards-grid">
                ${Object.entries(apps).length > 0 ? 
                    Object.entries(apps).map(([id, app]) => {
                        // Check if status is incomplete (Draft)
                        const isDraft = app.status === 'incomplete';
                        
                        // Logic: Drafts open the Editor, Completed opens the Viewer
                        const clickAction = isDraft 
                            ? `window.renderApplicationForm('${id}', '${app.appName || "Draft"}')` 
                            : `window.location.hash='view_application_${id}'`;

                        return `
                        <div class="vest-gig-card application-doc-card">
                            <div class="delete-app-wrapper" onclick="event.stopPropagation(); window.deleteApplication('${id}')" style="position:absolute; top:10px; right:10px; z-index:100; cursor:pointer;">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#ff4d4d" stroke-width="2">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                            </div>
                            
                            <div onclick="${clickAction}" style="cursor:pointer;">
                                <div class="app-screenshot-preview">
                                    <div class="mini-white-sheet">
                                        <div class="mini-title-box">${app.appName || 'Document'}</div>
                                        <div class="mini-line header"></div>
                                        <div class="mini-line"></div>
                                        <div class="mini-line"></div>
                                    </div>
                                    <div class="status-pill-overlay ${isDraft ? 'pill-draft' : 'pill-completed'}">
                                        ${isDraft ? 'DRAFT' : 'COMPLETED'}
                                    </div>
                                </div>

                                <div class="vest-card-content">
                                    <h3 class="vest-hook-text">${app.appHook || 'New Funding Proposal'}</h3>
                                    <div class="vest-card-footer">
                                        <span class="startup-label">${app.founderName || 'Founder'}</span>
                                        <span class="doc-date">${new Date(app.updatedAt).toLocaleDateString()}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        `;
                    }).join('') : `<p style="color:#666; text-align:center; width:100%;">No applications found.</p>`}
            </div>
            <div style="text-align:center; margin-top:40px;">
                <button class="buy-btn-premium" onclick="window.promptNewApplication()">+ Create New Application</button>
            </div>
        </div>
    `;
};

window.deleteApplication = async function(appId) {
    if (!confirm("Are you sure you want to delete this application? This cannot be undone.")) return;

    // Capture the container to avoid repeated DOM lookups
    const container = document.getElementById('dashboardContainer');
    
    try {
        // 1. Show centered loading state immediately
        container.innerHTML = `
            <div class="loading-box">
                <div class="spinner"></div>
                <p style="color: #fff; margin-top: 15px; font-weight: 600; letter-spacing: 0.5px;">
                    REMOVING DOCUMENT...
                </p>
            </div>`;

        // 2. Fetch the current count carefully
        const profileRef = ref(db, `founderProfile/${currentUser.uid}`);
        const snap = await get(profileRef);
        
        let currentCount = 0;
        if (snap.exists()) {
            currentCount = parseInt(snap.val().applicationsCount) || 0;
        }

        // 3. Prepare the atomic update
        // We set the application to null to delete it and decrement the count
        const updates = {};
        updates[`Applications/${currentUser.uid}/${appId}`] = null;
        updates[`founderProfile/${currentUser.uid}/applicationsCount`] = Math.max(0, currentCount - 1);

        // 4. Execute the update
        await update(ref(db), updates);

        // 5. Success Notification
        if (window.showSuccessToast) {
            window.showSuccessToast("Application Deleted Permanently");
        }

        // 6. Refresh the list
        // Wrapped in a tiny timeout to ensure Firebase local cache synchronizes
        setTimeout(() => {
            window.showApplicationsList();
        }, 100);

    } catch (error) {
        console.error("Delete Error:", error);
        alert("Critical Error: Could not delete application.");
        // Attempt to reload the list to restore UI
        window.showApplicationsList();
    }
};
window.promptNewApplication = function() {
    // Create the modal overlay
    const modal = document.createElement('div');
    modal.className = 'edit-modal show';
    modal.id = 'appNameModal';
    modal.style.background = "rgba(0,0,0,0.85)"; // Deep dark backdrop
    
    modal.innerHTML = `
        <div class="special-app-popup">
            <button class="close-x" onclick="this.closest('.edit-modal').remove()">Ã—</button>
            
            <div class="app-popup-header">
                <div class="logo-mini">SV</div>
            </div>
            
            <div class="app-popup-content">
                <h2>Application Identity</h2>
                <p>Assign a professional title to this funding request. This title will be the primary reference for investors.</p>
                
                <div class="input-wrapper-op">
                    <label>APPLICATION NAME</label>
                    <input type="text" id="newAppNameInput" placeholder="e.g. Series A Equity Proposal - 2026">
                </div>
            </div>

            <div class="app-popup-footer">
                <button class="btn-cancel-op" onclick="this.closest('.edit-modal').remove()">Discard</button>
                <button class="btn-confirm-op" onclick="window.confirmApplicationName()">
                    <span>Initialize Document</span>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M5 12h14M12 5l7 7-7 7"/>
                    </svg>
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    
    // Auto-focus the input for speed
    setTimeout(() => document.getElementById('newAppNameInput').focus(), 200);
};

// --- Logic to handle the "Initialize" click ---
window.confirmApplicationName = async function() {
    const input = document.getElementById('newAppNameInput');
    const appName = input.value.trim();
    
    if (!appName) {
        input.style.borderColor = "#ff006e";
        return;
    }

    // Remove the popup immediately
    document.getElementById('appNameModal').remove();

    try {
        // Prepare Firebase Path
        const profileRef = ref(db, `founderProfile/${currentUser.uid}`);
        const snap = await get(profileRef);
        const currentCount = (snap.exists() && snap.val().applicationsCount) ? parseInt(snap.val().applicationsCount) : 0;

        // Create new Application entry
        const newAppRef = push(ref(db, `Applications/${currentUser.uid}`));
        const appId = newAppRef.key;

        // Save initial node
        await update(ref(db), {
            [`founderProfile/${currentUser.uid}/applicationsCount`]: currentCount + 1,
            [`Applications/${currentUser.uid}/${appId}/appName`]: appName,
            [`Applications/${currentUser.uid}/${appId}/status`]: 'incomplete', // Marked as Draft
            [`Applications/${currentUser.uid}/${appId}/updatedAt`]: Date.now()
        });
        
        // Show success and Open Editor directly
        if (window.showSuccessToast) window.showSuccessToast(" Opening Editor...");
        window.renderApplicationForm(appId, appName);
        
    } catch (error) {
        console.error("Critical Error:", error);
        alert("Failed to initialize. Check your Firebase Rules.");
    }
};
window.showSuccessToast = function(message) {
    const toast = document.createElement('div');
    toast.className = 'success-toast';
    toast.innerHTML = `
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
            <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
        <span>${message}</span>
    `;
    document.body.appendChild(toast);

    // Auto-remove after 3.5 seconds
    setTimeout(() => {
        toast.classList.add('toast-exit');
        setTimeout(() => toast.remove(), 400);
    }, 3500);
};
window.renderApplicationForm = async function(appId, appName) {
    const container = document.getElementById('dashboardContainer');
    
    // Show loader
    container.innerHTML = '<div class="loading-box"><div class="spinner"></div><p>Loading Editor...</p></div>';

    // 1. Fetch existing data (if any) to pre-fill
    const appRef = ref(db, `Applications/${currentUser.uid}/${appId}`);
    const snapshot = await get(appRef);
    const appData = snapshot.val() || {};
    
    // Use the passed appName if available, otherwise fall back to DB
    const currentAppName = appName || appData.appName || "Untitled Application";

    // Check vest status
    let attachedVestText = "";
    if (appData.vestId) {
        attachedVestText = "âœ“ Vest Attached"; 
    }

    // 2. Render HTML
    container.innerHTML = `
        <div class="app-form-overlay" style="background:#f4f4f4; min-height:100vh; padding: 40px 20px; color:#000;">
            
<div class="app-editor-nav">
    <button class="editor-back-mini"
        onclick="window.saveApplicationDraft('${appId}', true)">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none"
             stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
        Back & Save
    </button>

    <div class="draft-badge">Draft Mode</div>
</div>


            <div class="white-paper-form" style="background:#fff; max-width:800px; margin:0 auto; padding:60px; border-radius:4px; box-shadow: 0 20px 60px rgba(0,0,0,0.1);">
                
                <div style="border-bottom:2px solid #000; padding-bottom:20px; margin-bottom:40px;">
                    <h1 id="displayAppName" style="margin:0; font-size:2rem; font-weight:800; letter-spacing:-1px;">${currentAppName}</h1>
                    <p style="color:#666; margin-top:5px; font-size:0.9rem;">Official Funding Application</p>
                </div>

                <div class="form-group-white">
                    <label>Application Hook Line</label>
                    <input type="text" id="appHook" value="${appData.appHook || ''}" placeholder="The one-liner that grabs attention..." oninput="window.limitWords(this, 50)">
                </div>

                <div class="form-group-white">
                    <label>Starting Content (The Intro)</label>
                    <textarea id="appStarting" placeholder="Introduce the opportunity..." style="height:120px;" oninput="window.limitWords(this, 100)">${appData.startingContent || ''}</textarea>
                </div>

                <div class="form-group-white">
                    <label>Main Proportion (The Core Details)</label>
                    <textarea id="appMain" style="height:200px;" placeholder="The main proposal content..." oninput="window.limitWords(this, 300)">${appData.mainContent || ''}</textarea>
                </div>

                <div class="form-group-white">
                    <label>Ending Hooks (Call to Action)</label>
                    <textarea id="appEnding" placeholder="How should they reach back?..." style="height:100px;" oninput="window.limitWords(this, 50)">${appData.endingContent || ''}</textarea>
                </div>

                <div class="form-group-white">
                    <label>Founder Name</label>
                    <input type="text" id="appFounderName" value="${appData.founderName || cachedFounderData?.founderUsername || ''}">
                </div>

                <div class="form-group-white">
                    <label>Link Startup Vest</label>
                    <button class="attach-btn" onclick="window.openVestPicker()" style="width:100%; border:2px dashed #ccc; background:#fafafa; padding:15px;">
                        ${attachedVestText || '+ Click to Attach Your Vest'}
                    </button>
                    <div id="attachedVestName" style="margin-top:10px; font-weight:bold; color:#10b981; text-align:center;">
                        ${attachedVestText}
                    </div>
                    <input type="hidden" id="selectedVestId" value="${appData.vestId || ''}">
                </div>

                <div class="form-actions-footer">
                    <button class="btn-save-draft" onclick="window.saveApplicationDraft('${appId}', false)">
                        Save Progress
                    </button>
                    <button class="btn-submit-app" onclick="window.submitApplication('${appId}')">
                        Submit Application
                    </button>
                </div>
                
                <div class="app-footer" style="text-align:center; margin-top:50px; border-top:1px solid #eee; padding-top:20px; opacity:0.6;">
                    <p style="font-size:12px; color:#000;"><strong>ScaleVest</strong> | StartUp</p>
                </div>
            </div>
        </div>
    `;
};

window.saveApplicationDraft = async function(appId, isBackAction) {
    let submitBtn = null;
    let originalText = "";
    
    // UX: Change button text if clicked explicitly
    if (!isBackAction && event) {
        submitBtn = event.currentTarget;
        originalText = submitBtn.innerText;
        submitBtn.innerText = "Saving...";
    }

    // 1. Get Name Safely
    const nameEl = document.getElementById('displayAppName');
    const safeName = nameEl ? nameEl.innerText : "Untitled Application";

    // 2. Collect Data
    const data = {
        appName: safeName, 
        appHook: document.getElementById('appHook').value,
        startingContent: document.getElementById('appStarting').value,
        mainContent: document.getElementById('appMain').value,
        endingContent: document.getElementById('appEnding').value,
        founderName: document.getElementById('appFounderName').value,
        vestId: document.getElementById('selectedVestId').value,
        status: 'incomplete', // Keeps it as Draft
        updatedAt: Date.now()
    };

    try {
        // 3. Update Firebase
        await update(ref(db, `Applications/${currentUser.uid}/${appId}`), data);

        // 4. Handle Navigation
        if (isBackAction) {
            if (window.showSuccessToast) window.showSuccessToast("Draft Saved");
            window.location.hash = 'applications';
            // Force reload list to show updates
            if(window.showApplicationsList) window.showApplicationsList();
        } else {
            if (window.showSuccessToast) window.showSuccessToast("Progress Saved");
            if(submitBtn) {
                submitBtn.innerText = "Saved âœ“";
                setTimeout(() => { submitBtn.innerText = originalText; }, 1500);
            }
        }
    } catch (error) {
        console.error("Draft Error:", error);
        alert("Error saving draft.");
        if(submitBtn) submitBtn.innerText = originalText;
    }
};
// --- 4. ATTACHMENT: PICKER POPUP ---
window.openVestPicker = async function() {
    const snap = await get(ref(db, `Vests/${currentUser.uid}`));
    const vests = snap.val();
    if(!vests) return alert("No vests found. Create a vest first!");

    let pickerHtml = `
        <div class="picker-modal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:100000; display:flex; align-items:center; justify-content:center;">
            <div class="picker-content" style="background:#111; padding:40px; border-radius:15px; width:90%; max-width:450px; border:1px solid #333;">
                <h3 style="color:#fff; margin-bottom:20px;">Attach a Startup Vest</h3>
                <div style="max-height:300px; overflow-y:auto; margin-bottom:20px;">
                    ${Object.entries(vests).map(([id, v]) => `
                        <div class="picker-item" style="padding:15px; border-bottom:1px solid #222; cursor:pointer; color:#fff;" 
                             onclick="window.selectVestForApp('${id}', '${v.MainVest.hook}')">
                             ${v.MainVest.hook}
                        </div>
                    `).join('')}
                </div>
                <button class="card-btn" onclick="this.parentElement.parentElement.remove()">Cancel</button>
            </div>
        </div>`;
    
    const div = document.createElement('div');
    div.id = "tempPicker";
    div.innerHTML = pickerHtml;
    document.body.appendChild(div);
};

window.selectVestForApp = function(id, hook) {
    document.getElementById('selectedVestId').value = id;
    document.getElementById('attachedVestName').innerText = "âœ“ Attached: " + hook;
    document.getElementById('tempPicker').remove();
};

window.submitApplication = async function(appId) {
    const vestId = document.getElementById('selectedVestId').value;
    const submitBtn = event.currentTarget; 

    if(!vestId) return alert("Please attach a vest before completing!");
    if(!document.getElementById('appHook').value) return alert("Please add a Hook Line.");

    submitBtn.disabled = true;
    submitBtn.innerText = "Processing...";

    const nameEl = document.getElementById('displayAppName');
    const safeName = nameEl ? nameEl.innerText : "Untitled Application";

    const data = {
        appName: safeName,
        appHook: document.getElementById('appHook').value,
        startingContent: document.getElementById('appStarting').value,
        mainContent: document.getElementById('appMain').value,
        endingContent: document.getElementById('appEnding').value,
        founderName: document.getElementById('appFounderName').value,
        vestId: vestId,
        status: 'completed', // MARK AS COMPLETED
        updatedAt: Date.now()
    };

    try {
        await update(ref(db, `Applications/${currentUser.uid}/${appId}`), data);
        
        // Show success
        const container = document.getElementById('dashboardContainer');
        container.innerHTML = '<div style="text-align:center; padding:100px;"><div class="spinner"></div><p>Application Submitted!</p></div>';

        window.location.hash = 'applications';
        if (window.showApplicationsList) await window.showApplicationsList();
        if (window.showSuccessToast) window.showSuccessToast("Application Completed!");
        
    } catch (error) {
        console.error("Submit Error:", error);
        submitBtn.disabled = false;
        submitBtn.innerText = "Submit Application";
        alert("Failed to save.");
    }
};
// --- 6. REVIEW: THE "MEGA OP" FINAL DOCUMENT PAGE ---
window.renderFullApplicationPage = async function(appId) {
    const container = document.getElementById('dashboardContainer');
    container.style.display = 'block'; 
    
    // 1. Show CENTERED BLACK loading spinner while data is fetching
    container.innerHTML = `
        <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex; flex-direction: column; align-items: center; gap: 15px; z-index: 9999;">
            <div style="width: 40px; height: 40px; border: 4px solid rgba(0,0,0,0.1); border-top: 4px solid #000; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <p style="color: #000; font-family: sans-serif; font-size: 14px; font-weight: 600;">Loading Application...</p>
        </div>
        <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>
    `;

    document.body.style.background = "#f4f4f4";
    
    // 2. Fetch Application and Vest Data
    const snap = await get(ref(db, `Applications/${currentUser.uid}/${appId}`));
    const app = snap.val();
    
    if(!app) {
        alert("Application not found");
        window.location.hash = 'applications';
        return;
    }

    let vest = null;
    if (app.vestId) {
        const vestSnap = await get(ref(db, `Vests/${currentUser.uid}/${app.vestId}`));
        vest = vestSnap.val();
    }

    // 3. Fetch Startup Logo from: startupProfile/${currentUser.uid}/logo
    const startupLogoRef = ref(db, `startupProfile/${currentUser.uid}/logo`);
    const logoSnap = await get(startupLogoRef);
    const logoUrl = logoSnap.exists() ? logoSnap.val() : ''; 

    // 4. Direct PDF Generation Function (No Print Dialog)
    window.downloadApplicationPDF = function(appName) {
        if (typeof html2pdf === 'undefined') {
            alert("PDF Library is still loading. Please wait a moment.");
            return;
        }
        const element = document.getElementById('printableDocument');
        const cleanName = appName.replace(/[^a-z0-9]/gi, '_');
        
        const opt = {
            margin:       0.5,
            filename:     `ScaleVest_${cleanName}.pdf`,
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2, useCORS: true },
            jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
        };

        html2pdf().set(opt).from(element).save();
    };

    // 5. Render Main Content
    container.innerHTML = `
        <style>
            /* BUTTONS: Equal size, no stretching */
            .nav-row-container {
                max-width: 850px; 
                margin: 0 auto 20px auto; 
                display: flex; 
                justify-content: flex-start; 
                gap: 15px;
            }

            .premium-nav-btn {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                padding: 10px 20px;
                font-size: 13px;
                width: 180px; /* Fixed equal width */
                border-radius: 6px;
                cursor: pointer;
                text-decoration: none;
                font-family: sans-serif;
                font-weight: 700;
                transition: all 0.3s ease;
                border: 1.5px solid #000;
                background: #fff;
                color: #000;
                white-space: nowrap;
            }

            .premium-nav-btn.black {
                background: #000;
                color: #fff;
            }

            .premium-nav-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            }

            /* Watermark: Rounded & Extreme Top Right inside paper */
            .doc-watermark {
                position: absolute;
                top: 20px;
                right: 20px;
                width: 75px;
                height: 75px;
                border-radius: 50%;
                overflow: hidden;
                background: #fff;
                border: 1px solid #eee;
                z-index: 10;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .doc-watermark img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }
        </style>

        <div class="full-app-view" style="padding: 30px 20px;">
            
            <div class="nav-row-container">
                <a href="#applications" class="premium-nav-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                    Back
                </a>

                <button onclick="window.downloadApplicationPDF('${app.appName || 'Funding_Proposal'}')" class="premium-nav-btn black">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                    Download Application
                </button>
            </div>

            <div id="printableDocument">
                <div class="white-paper-card" style="background:#fff; max-width:850px; margin:0 auto; padding:80px; box-shadow: 0 20px 50px rgba(0,0,0,0.1); border-radius: 2px; position: relative; border: 1px solid #eee; min-height: 1050px; color: #000; font-family: 'Times New Roman', serif;">
                    
                    ${logoUrl ? `<div class="doc-watermark"><img src="${logoUrl}"></div>` : ''}

                    <div style="display: flex; justify-content: flex-start; align-items: flex-start; margin-bottom: 60px;">
                        <div style="text-align: left; color: #888; font-size: 12px; letter-spacing: 1px; line-height: 1.5; font-family: sans-serif; text-transform: uppercase; font-weight: 600;">
                            OFFICIAL FUNDING APPLICATION<br>
                           
                        </div>
                    </div>

                    <h1 style="font-size: 38px; line-height: 1.2; margin-bottom: 40px; border-left: 5px solid #000; padding-left: 25px; font-family: sans-serif; font-weight: 800;">
                        ${app.appHook}
                    </h1>
                    
                    <div style="font-size: 19px; line-height: 1.8; color: #333; margin-bottom: 30px; text-align: justify;">
                        ${app.startingContent}
                    </div>

                    <div style="font-size: 19px; line-height: 1.8; color: #333; margin-bottom: 30px; text-align: justify; font-weight: 500;">
                        ${app.mainContent}
                    </div>

                    <div style="font-size: 19px; line-height: 1.8; color: #333; margin-bottom: 50px; text-align: justify; font-style: italic;">
                        ${app.endingContent}
                    </div>

                    <div style="margin-top: 60px; border-top: 1px solid #eee; padding-top: 30px;">
                        <p style="font-family: sans-serif; font-size: 14px; color: #888; margin-bottom: 5px;">Respectfully submitted by,</p>
                        <h2 style="font-size: 26px; font-weight: 700; margin: 0;">${app.founderName}</h2>
                    </div>

                   ${vest ? `
<div style="margin-top: 70px; background: #000; color: #fff; padding: 40px; border-radius: 4px; font-family: sans-serif;">
    <p style="font-size: 10px; letter-spacing: 3px; color: #666; margin-bottom: 15px; text-transform: uppercase;">Linked Startup Identity</p>
    <h3 style="font-size: 24px; margin-bottom: 10px;">${vest.MainVest?.hook || 'Startup Vest'}</h3>
    
    <div style="margin-bottom: 25px;">
        <p style="font-size: 12px; color: #888; margin-bottom: 4px; font-weight: 700;">VEST LINK:</p>
        <a href="https://upscalevest.site/vest-details.html?id=${app.vestId}&owner=${currentUser.uid}" 
           target="_blank" 
           style="color: #3a86ff; text-decoration: none; font-size: 13px; font-family: monospace; word-break: break-all;">
           https://upscalevest.site/vest-details.html?id=${app.vestId}&owner=${currentUser.uid}
        </a>
    </div>

    <p style="font-size: 14px; color: #aaa; margin-bottom: 25px; line-height: 1.5;">${vest.MainVest?.description?.substring(0, 180)}...</p>
    
    <div style="display: flex; gap: 40px; border-top: 1px solid #333; padding-top: 20px;">
        <div>
            <small style="color: #666; display: block; margin-bottom: 5px;">FUNDING ASK</small>
            <span style="font-size: 1.2rem; font-weight: 800;">$${vest.MainVest?.fundAsk || '0'}</span>
        </div>
        <div>
            <small style="color: #666; display: block; margin-bottom: 5px;">EQUITY OFFER</small>
            <span style="font-size: 1.2rem; font-weight: 800;">${vest.MainVest?.equityOffered || '0'}%</span>
        </div>
    </div>
</div>
` : ''}
                </div>
            </div>
        </div>
    `;
};
// --- 7. HELPER: WORD LIMITER ---
window.limitWords = function(element, limit) {
    const words = element.value.trim().split(/\s+/).filter(w => w.length > 0);
    if (words.length > limit) {
        element.value = words.slice(0, limit).join(" ");
        alert(`Professional Guard: Maximum ${limit} words allowed per section.`);
    }
};
// Global tracking for listeners
window.presenceListeners = window.presenceListeners || [];

window.showInvestorChatList = async function () {
    try {
        const container = document.getElementById('dashboardContainer');

        // 1. CLEANUP: Remove old listeners to prevent memory leaks/duplicates
        if (window.presenceListeners.length > 0) {
            window.presenceListeners.forEach(unsub => unsub());
            window.presenceListeners = [];
        }

        // Toggle containers
        if (document.querySelector('.vest-container')) {
            document.querySelector('.vest-container').style.display = 'none';
        }
        container.style.display = 'block';

        // Loader
        container.innerHTML = `
            <div class="loading-box">
                <div class="spinner"></div>
                <p style="color:#888;">Syncing with Investor Network...</p>
            </div>`;

        // -----------------------------
        // 2. FETCH CHATS & PROFILES
        // -----------------------------
        const chatsRef = ref(db, 'Chats');
        const snapshot = await get(chatsRef);
        const allChats = snapshot.val() || {};

        const chatMap = new Map();

        // Process Chats
        Object.keys(allChats).forEach(roomKey => {
            if (!roomKey.includes(currentUser.uid)) return;

            const messages = Object.values(allChats[roomKey])
                .filter(m => m && m.sender && m.timestamp);

            if (!messages.length) return;

            // Sort messages to get the last one
            messages.sort((a, b) => a.timestamp - b.timestamp);
            const lastMsg = messages[messages.length - 1];

            const parts = roomKey.split('_');
            const otherUid = parts.find(p => p !== 'chat' && p !== currentUser.uid);
            if (!otherUid) return;

            chatMap.set(otherUid, {
                roomKey,
                otherUid,
                lastMessage: lastMsg.text?.trim() || "Sent an attachment",
                isAttachment: !lastMsg.text,
                timestamp: lastMsg.timestamp,
                isUnread: !lastMsg.readBy || !lastMsg.readBy[currentUser.uid]
            });
        });

        const myChats = Array.from(chatMap.values()).sort((a, b) => b.timestamp - a.timestamp);

        // Fetch Profiles
        const profileMap = {};
        await Promise.all(
            myChats.map(async chat => {
                const uid = chat.otherUid;
                let snap = await get(ref(db, `investorProfiles/${uid}`));
                if (!snap.exists()) snap = await get(ref(db, `founderProfile/${uid}`));

                profileMap[uid] = snap.exists()
                    ? snap.val()
                    : { fullName: "Investor", photoURL: null };
            })
        );

        // -----------------------------
        // 3. RENDER UI (Defaulting to Offline initially)
        // -----------------------------
        let listHtml = `
        <div class="chat-list-container">
            <div class="chat-header-row">
                <div style="display:flex; align-items:center; gap:12px;">
<button onclick="window.location.hash='founder_dashboard'"
                        style="
                            background: #000;
                            color: #fff;
                            border: 1px solid #333;
                            border-radius: 12px;
                            padding: 10px 20px;
                            cursor: pointer;
                            font-weight: 700;
                            font-size: 0.9rem;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            margin-right: 25px; /* Moves title more to the right */
                            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
                            transition: transform 0.2s ease;
                        "
                        onmouseover="this.style.transform='translateY(-2px)'"
                        onmouseout="this.style.transform='translateY(0)'">
                        
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="19" y1="12" x2="5" y2="12"></line>
                            <polyline points="12 19 5 12 12 5"></polyline>
                        </svg>
                        Back
                    </button>
                    <div>
                        <h1 style="font-size:1.9rem;font-weight:800;margin:0;">Investor Inbox</h1>
                        <p style="color:#6b7280;margin-top:4px;font-size:0.9rem;">
                            Manage your funding conversations
                        </p>
                    </div>
                </div>
                <div class="inbox-count" id="liveOnlineCounter">
                    <span style="color:#6b7280;">â—</span> 0 Online
                </div>
            </div>
        `;

        if (!myChats.length) {
            listHtml += `
                <div class="empty-state-box">
                    <p>No messages yet</p>
                </div>`;
        } else {
            const chatHtml = myChats.map(chat => {
                const profile = profileMap[chat.otherUid] || {};
                const displayName = profile.fullName || profile.founderUsername || profile.name || "Investor";
                const displayPhoto = profile.photoURL || profile.logo;
                
                const date = new Date(chat.timestamp);
                const timeDisplay = new Date().toDateString() === date.toDateString()
                    ? date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                    : date.toLocaleDateString();

                // Unique ID for the Status Dot
                const statusDotId = `status-dot-${chat.otherUid}`;

                return `
                    <div class="chat-item" onclick="openChat('${chat.otherUid}', '${chat.roomKey}', this)">
                        <div class="chat-avatar">
                            ${displayPhoto
                                ? `<img src="${displayPhoto}" onerror="this.style.display='none'">`
                                : displayName.charAt(0).toUpperCase()}
                            
                            <div id="${statusDotId}" class="status-indicator status-offline"></div>
                        </div>

                        <div class="chat-info">
                            <div class="chat-name">${displayName}</div>
                            <div class="chat-preview ${chat.isUnread ? 'unread-text' : ''}">
                                ${chat.isUnread ? '<strong>â—</strong> ' : ''}${chat.lastMessage}
                            </div>
                        </div>

                        <div class="chat-meta">
                            <div class="time-text">${timeDisplay}</div>
                            ${chat.isUnread ? '<div class="unread-pill">NEW</div>' : ''}
                            <button class="delete-chat-btn"
                                onclick="deleteConversation('${chat.roomKey}', event)" 
                                onkeydown="event.stopPropagation()"
                                title="Delete Conversation"
                                style="
                                    background: transparent;
                                    border: none;
                                    padding: 0;
                                    margin-top: 8px;
                                    cursor: pointer;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    opacity: 0.7;
                                    transition: opacity 0.2s, transform 0.2s;
                                    color: #ef4444; /* Bright Red */
                                "
                                onmouseover="this.style.opacity='1'; this.style.transform='scale(1.2)'"
                                onmouseout="this.style.opacity='0.7'; this.style.transform='scale(1)'"
                            >
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                            </button>
                        </div>
                    </div>`;
            }).join('');

            listHtml += chatHtml;
        }

        listHtml += `</div>`;
        container.innerHTML = listHtml;

        // -----------------------------
        // 4. ATTACH REAL-TIME PRESENCE LISTENERS
        // -----------------------------
        if (myChats.length > 0) {
            
            // Helper function to update the header count
            const updateOnlineCount = () => {
                const totalOnline = document.querySelectorAll('.status-online').length;
                const counterEl = document.getElementById('liveOnlineCounter');
                if (counterEl) {
                    counterEl.innerHTML = `<span style="color:${totalOnline ? '#10b981' : '#6b7280'};">â—</span> ${totalOnline} Online`;
                }
            };

            myChats.forEach(chat => {
                const uid = chat.otherUid;
                const presenceRef = ref(db, `presence/${uid}`);

                // Real-time listener for THIS specific user
                const unsubscribe = onValue(presenceRef, (snap) => {
                    const isOnline = snap.exists() && snap.val().online === true;
                    console.log(`User ${uid} is ${isOnline ? 'Online' : 'Offline'}`); // Debug log

                    // 1. Find the dot
                    const dotEl = document.getElementById(`status-dot-${uid}`);
                    if (dotEl) {
                        // 2. Update Class
                        dotEl.className = `status-indicator ${isOnline ? 'status-online' : 'status-offline'}`;
                        // 3. Update Global Counter
                        updateOnlineCount();
                    }
                });

                // Store listener so we can clean it up later
                window.presenceListeners.push(unsubscribe);
            });
        }

    } catch (e) {
        console.error("Inbox Error:", e);
        document.getElementById('dashboardContainer').innerHTML = `
            <div style="text-align:center;padding:4rem;color:#ff4d4d;">
                <h3>Error loading messages</h3>
            </div>`;
    }
};
// --- HELPER FUNCTIONS ---

window.openChat = async function(uid, roomKey, element) {
    // UI cleanup (instant feedback)
    element.querySelector('.unread-pill')?.remove();
    element.querySelector('.unread-dot')?.remove();
    element.querySelector('.chat-preview')?.classList.remove('unread-text');

    // ðŸ”¥ MARK ALL MESSAGES AS READ IN FIREBASE
    const roomRef = ref(db, `Chats/${roomKey}`);
    const snap = await get(roomRef);

    if (snap.exists()) {
        const updates = {};
        
        Object.entries(snap.val()).forEach(([msgId, msg]) => {
            // Only mark messages sent by others as read
            if (msg.sender !== currentUser.uid) {
                // Set readBy flag to true for current user
                updates[`${msgId}/readBy/${currentUser.uid}`] = true;
            }
        });

        // Apply all updates at once
        if (Object.keys(updates).length > 0) {
            await update(roomRef, updates);
            console.log(`âœ… Marked ${Object.keys(updates).length} messages as read`);
        }
    }

    // Navigate to chat
    window.location.href = `chat.html?recipient=${uid}`;
};

window.deleteConversation = async function(roomKey, event) {
    event.stopPropagation(); 
    if(!confirm("Are you sure you want to delete this conversation?")) return;

    try {
        const chatRef = ref(db, `Chats/${roomKey}`);
        await remove(chatRef);
        window.showInvestorChatList(); // Refresh
    } catch(err) {
        console.error("Error deleting chat:", err);
    }
}
function startNotificationListener() {
    const chatsRef = ref(db, 'Chats');
    
    onValue(chatsRef, (snapshot) => {
        if (!snapshot.exists()) {
            globalUnreadCount = 0; // Update global
            updateNotificationBadge(0);
            return;
        }

        const allChats = snapshot.val();
        let unreadCount = 0;

        Object.keys(allChats).forEach(roomKey => {
            if (roomKey.includes(currentUser.uid)) {
                const messages = allChats[roomKey];
                Object.values(messages).forEach(msg => {
                    if (msg && msg.recipient === currentUser.uid && msg.read !== true) {
                        unreadCount++;
                    }
                });
            }
        });

        // 1. SAVE TO GLOBAL VARIABLE
        globalUnreadCount = unreadCount; 
        
        // 2. TRY TO UPDATE UI (If elements exist)
        updateNotificationBadge(unreadCount);
    });
}
function updateNotificationBadge(count) {
    const bell = document.getElementById('navBellBadge');
    const msg = document.getElementById('navMsgBadge');
    
    if (count > 0) {
        if(bell) { 
            bell.classList.add('active'); 
            bell.innerText = ''; // Just a dot
        }
        if(msg) { 
            msg.classList.add('active'); 
            msg.innerText = ''; 
        }
    } else {
        // Remove badge when count is zero
        if(bell) bell.classList.remove('active');
        if(msg) msg.classList.remove('active');
    }
    
    console.log(`ðŸ“¬ Unread messages: ${count}`); // Debug log
}

function timeSince(date) {
    const seconds = Math.floor((new Date() - date) / 1000);
    let interval = seconds / 31536000;

    if (interval > 1) return Math.floor(interval) + "y ago";
    interval = seconds / 2592000;
    if (interval > 1) return Math.floor(interval) + "mo ago";
    interval = seconds / 86400;
    if (interval > 1) return Math.floor(interval) + "d ago";
    interval = seconds / 3600;
    if (interval > 1) return Math.floor(interval) + "h ago";
    interval = seconds / 60;
    if (interval > 1) return Math.floor(interval) + "m ago";
    return "Just now";
}
// --- PASTE AFTER timeSince function ---
// Track which replies we've already shown popups for (persist across page refreshes)
let shownPopups = new Set(JSON.parse(localStorage.getItem('shownReplyPopups') || '[]'));

function startApplicationReplyListener() {
    if (!currentUser) return;

    const repliesRef = ref(db, 'ApplicationReplies');

    onValue(repliesRef, async (snapshot) => {
        if (!snapshot.exists()) {
            updateReplyBadge(0);
            return;
        }

        const allReplies = snapshot.val() || {};
        let unreadCount = 0;

        // Find unread replies for this user
        for (const [replyId, reply] of Object.entries(allReplies)) {
            // âœ… ONLY process replies for THIS user
            if (reply.founderId === currentUser.uid) {
                
                // Count unread replies
                if (reply.read === false) {
                    unreadCount++;
                    
                    // âœ… Show popup ONLY if:
                    // 1. Reply is unread (read: false)
                    // 2. We haven't shown popup for this reply before
                    // 3. User is on dashboard
                    if (!shownPopups.has(replyId)) {
                        const isDashboard = window.location.hash === '#founder_dashboard' || window.location.hash === '';
                        
                        if (isDashboard) {
                            // Mark as shown IMMEDIATELY to prevent duplicates
                            shownPopups.add(replyId);
                            localStorage.setItem('shownReplyPopups', JSON.stringify([...shownPopups]));
                            
                            // Fetch investor name
                            let investorName = 'An Investor';
                            try {
                                const investorSnap = await get(ref(db, `angelProfiles/${reply.investorId}/fullName`));
                                if (investorSnap.exists()) {
                                    investorName = investorSnap.val();
                                }
                            } catch (e) {
                                console.error("Error fetching investor:", e);
                            }
                            
                            // Fetch application name
                            let appName = 'Your Application';
                            try {
                                const appSnap = await get(ref(db, `Applications/${currentUser.uid}/${reply.applicationId}/appName`));
                                if (appSnap.exists()) {
                                    appName = appSnap.val();
                                }
                            } catch (e) {
                                console.error("Error fetching app name:", e);
                            }
                            
                            // Show the popup
                            showNewReplyPopup(reply, investorName, appName, replyId);
                        }
                    }
                }
                
                // âœ… IMPORTANT: If reply is now read, remove from shown list
                // This allows popup to show again if status changes back to unread
                if (reply.read === true && shownPopups.has(replyId)) {
                    shownPopups.delete(replyId);
                    localStorage.setItem('shownReplyPopups', JSON.stringify([...shownPopups]));
                }
            }
        }

        updateReplyBadge(unreadCount);
    });
}
function showNewReplyPopup(replyData, investorName, appName, replyId) {
    // Prevent duplicate popups
    if (document.getElementById('newReplyPopup')) return;
    
    // Create popup overlay
    const popup = document.createElement('div');
    popup.id = 'newReplyPopup';
    popup.innerHTML = `
        <style>
            .new-reply-popup-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.95);
                backdrop-filter: blur(10px);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 999999;
                animation: popupFadeIn 0.4s ease;
            }
            
            @keyframes popupFadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            
            .new-reply-popup-box {
                background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
                border: 2px solid #333;
                border-radius: 24px;
                width: 90%;
                max-width: 520px;
                position: relative;
                overflow: hidden;
                box-shadow: 0 30px 60px rgba(0, 0, 0, 0.8);
                animation: popupSlideUp 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            }
            
            @keyframes popupSlideUp {
                from { 
                    transform: translateY(50px) scale(0.9);
                    opacity: 0;
                }
                to { 
                    transform: translateY(0) scale(1);
                    opacity: 1;
                }
            }
            
            .popup-content-area {
                padding: 50px 40px;
                text-align: center;
            }
            
            .popup-new-tag {
                display: inline-block;
                background: linear-gradient(135deg, #ff006e, #ff4d94);
                color: #fff;
                padding: 8px 20px;
                border-radius: 20px;
                font-size: 0.75rem;
                font-weight: 800;
                text-transform: uppercase;
                letter-spacing: 1.5px;
                margin-bottom: 2rem;
                animation: tagPulse 1.5s infinite;
            }
            
            @keyframes tagPulse {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.05); }
            }
            
            .popup-main-title {
                font-size: 2rem;
                font-weight: 800;
                color: #fff;
                margin-bottom: 2rem;
                line-height: 1.3;
            }
            
            .popup-message-text {
                color: #bbb;
                font-size: 1.1rem;
                line-height: 1.8;
                margin-bottom: 3rem;
            }
            
            .popup-app-highlight {
                color: #ff006e;
                font-weight: 700;
            }
            
            .popup-investor-highlight {
                color: #8338ec;
                font-weight: 700;
            }
            
            .popup-action-btn {
                background: linear-gradient(135deg, #ff006e, #8338ec);
                color: #fff;
                border: none;
                padding: 18px 50px;
                border-radius: 12px;
                font-weight: 800;
                font-size: 1rem;
                text-transform: uppercase;
                letter-spacing: 1.5px;
                cursor: pointer;
                transition: all 0.3s;
                box-shadow: 0 10px 30px rgba(255, 0, 110, 0.4);
                width: 100%;
            }
            
            .popup-action-btn:hover {
                transform: translateY(-3px);
                box-shadow: 0 15px 40px rgba(255, 0, 110, 0.6);
            }
            
            .popup-action-btn:active {
                transform: translateY(-1px);
            }
        </style>
        
        <div class="new-reply-popup-overlay" onclick="closeNewReplyPopup('${replyId}')">
            <div class="new-reply-popup-box" onclick="event.stopPropagation()">
                
                <div class="popup-content-area">
                    
                    <div class="popup-new-tag">ðŸ”” NEW REPLY</div>
                    
                    <h2 class="popup-main-title">
                        Application Reply Received!
                    </h2>
                    
                    <p class="popup-message-text">
                        <strong class="popup-investor-highlight">${investorName}</strong> has responded to your application 
                        <strong class="popup-app-highlight">"${appName}"</strong>
                        <br><br>
                        Please check the <strong>Application Replies Inbox</strong> to view the full details.
                    </p>
                    
                    <button class="popup-action-btn" onclick="closeNewReplyPopup('${replyId}')">
                        OK, Got It!
                    </button>
                    
                </div>
                
            </div>
        </div>
    `;
    
    document.body.appendChild(popup);
}

// Close popup function
window.closeNewReplyPopup = function(replyId) {
    const popup = document.getElementById('newReplyPopup');
    if (popup) {
        popup.style.animation = 'popupFadeIn 0.3s ease reverse';
        setTimeout(() => popup.remove(), 300);
    }
};
function updateReplyBadge(count) {
    const badge = document.getElementById('replyNotifBadge');
    const countEl = document.getElementById('replyCount');
    if (badge && countEl) {
        if (count > 0) {
            badge.style.display = 'block';
            countEl.textContent = count;
        } else {
            badge.style.display = 'none';
        }
    }
}
import {
  onDisconnect,
  serverTimestamp,
  runTransaction
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

async function setUserPresence(user) {
    // 1. Manage Real-time Presence
    const presenceRef = ref(db, `presence/${user.uid}`);
    set(presenceRef, { 
        online: true, 
        lastSeen: serverTimestamp() 
    });
    
    // Ensure they show as offline when they disconnect
    onDisconnect(presenceRef).set({ 
        online: false, 
        lastSeen: serverTimestamp() 
    });

    // 2. Update Login Stats (Streak & Today's Status)
    const statsRef = ref(db, `users/${user.uid}/stats`);
    
    try {
        await runTransaction(statsRef, (currentData) => {
            const now = new Date();
            const todayStr = now.toISOString().split('T')[0]; // e.g., "2026-01-16"
            
            if (!currentData) {
                return { todayLogin: true, loginStreak: 1, lastLoginDate: todayStr };
            }

            // If they already logged in today, don't change the streak
            if (currentData.lastLoginDate === todayStr) {
                return { ...currentData, todayLogin: true };
            }

            // Check if they logged in yesterday to continue the streak
            const yesterday = new Date();
            yesterday.setDate(now.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];

            let newStreak = currentData.loginStreak || 0;
            if (currentData.lastLoginDate === yesterdayStr) {
                newStreak += 1;
            } else {
                newStreak = 1; // Streak broken, reset to 1
            }

            return {
                todayLogin: true,
                loginStreak: newStreak,
                lastLoginDate: todayStr
            };
        });
    } catch (error) {
        console.error("Streak update failed:", error);
    }
}
window.handleBellClick = async function() {
    // 1. Instant UI Feedback (Remove the dot immediately)
    updateNotificationBadge(0);
    
    // 2. Navigate to the chat list immediately (for speed)
    window.location.hash = 'investor_chatlist';

    // 3. Perform Database Cleanup in the background
    if (!currentUser) return;

    try {
        // Fetch all chats
        const chatsRef = ref(db, 'Chats');
        const snapshot = await get(chatsRef);

        if (snapshot.exists()) {
            const updates = {};
            const allChats = snapshot.val();

            // Loop through all rooms
            Object.keys(allChats).forEach(roomKey => {
                // Only look at rooms I am part of
                if (roomKey.includes(currentUser.uid)) {
                    const messages = allChats[roomKey];

                    // Loop through messages in that room
                    Object.keys(messages).forEach(msgId => {
                        const msg = messages[msgId];
                        
                        // CONDITION: Message is for ME and is NOT Read
                        if (msg && 
                            msg.recipient === currentUser.uid && 
                            msg.read !== true) {
                            
                            // Add to bulk update list
                            updates[`Chats/${roomKey}/${msgId}/read`] = true;
                        }
                    });
                }
            });

            // Execute Bulk Update if there are messages to mark
            if (Object.keys(updates).length > 0) {
                await update(ref(db), updates);
                console.log(`âœ… Marked ${Object.keys(updates).length} messages as read.`);
            }
        }
    } catch (error) {
        console.error("Error clearing notifications:", error);
    }
};
// --- FORCE USERNAME SETUP LOGIC ---

// --- FORCE USERNAME SETUP LOGIC (Redesigned) ---

async function showUsernameSetupModal() {
    // Check if modal already exists
    if (document.getElementById('usernameSetupModal')) return;

    const modal = document.createElement('div');
    modal.id = 'usernameSetupModal';
    // We use inline flex style to center it perfectly
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(15px);
        display: flex; align-items: center; justify-content: center;
        z-index: 999999; opacity: 0; transition: opacity 0.4s ease;
    `;

    // Inject CSS for animations and internal styling
    const style = document.createElement('style');
    style.innerHTML = `
        @keyframes modalSlideUp {
            from { transform: translateY(30px) scale(0.95); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }
.sv-modal-card {
            background: #050505;
            border: 1px solid #222;
            border-radius: 16px;
            width: 90%;
            max-width: 380px;
            padding: 40px 30px;
            text-align: center;
            box-shadow: 0 30px 60px rgba(0,0,0,0.8);
            animation: modalSlideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            position: relative;
        }
        .sv-modal-icon {
            width: 64px; height: 64px;
            background: #fff; 
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            margin: 0 auto 20px auto;
            box-shadow: 0 0 25px rgba(255,255,255,0.15);
            overflow: hidden;
            border: 2px solid #fff;
        }
        .sv-modal-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .sv-input-group {
            margin: 25px 0;
            text-align: left;
        }
        .sv-input {
            width: 100%;
            background: transparent;
            border: none;
            border-bottom: 2px solid #333;
            color: #fff;
            font-size: 1.1rem;
            padding: 10px 5px;
            font-family: inherit;
            transition: border-color 0.3s;
            border-radius: 0;
        }
        .sv-input:focus {
            outline: none;
            border-bottom-color: #fff;
        }
        .sv-hint {
            font-size: 0.75rem;
            color: #666;
            margin-top: 8px;
            display: block;
        }
        .sv-btn-small {
            background: #fff;
            color: #000;
            border: none;
            padding: 10px 24px;
            font-size: 0.85rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            width: auto;
            display: inline-block;
        }
        .sv-btn-small:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255,255,255,0.2);
        }
        .sv-btn-small:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
    `;
    document.head.appendChild(style);

    modal.innerHTML = `
<div class="sv-modal-card">
            <div class="sv-modal-icon">
                <img src="ScaleVestLogo.png" alt="ScaleVest Logo">
            </div>
            
            <h2 style="color: #fff; font-size: 1.5rem; margin-bottom: 10px; font-weight: 700;">Identity Setup</h2>
            <p style="color: #888; font-size: 0.9rem; line-height: 1.5;">
                Welcome to the network. Please establish your unique <strong>Founder Username</strong> to continue.
            </p>

            <div class="sv-input-group">
                <label style="color: #fff; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">Username</label>
                <input type="text" id="newUsernameInput" class="sv-input" placeholder="Enter username..." autocomplete="off">
                <span class="sv-hint">Minimum 6 characters. No spaces or symbols.</span>
            </div>

            <button class="sv-btn-small" onclick="saveNewUsername()">Confirm Identity</button>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Trigger Fade In
    setTimeout(() => { modal.style.opacity = '1'; }, 10);
    
    // Trap focus
    setTimeout(() => document.getElementById('newUsernameInput').focus(), 100);
}

window.saveNewUsername = async function() {
    const input = document.getElementById('newUsernameInput');
    const btn = document.querySelector('#usernameSetupModal button');
    const rawName = input.value.trim();
    
    // 1. Validation (Strict 6 char limit)
    if (!rawName || rawName.length < 6) {
        input.style.borderBottomColor = "#ff4d4d"; // Red error indication
        alert("âŒ Username must be at least 6 characters long.");
        return;
    }
    
    // Regex: Only letters and numbers allowed
    if (!/^[a-zA-Z0-9]+$/.test(rawName)) {
        input.style.borderBottomColor = "#ff4d4d";
        alert("âŒ Usernames can only contain letters and numbers (No spaces).");
        return;
    }

    // 2. Processing UI
    const originalText = btn.innerText;
    btn.innerText = "Processing...";
    btn.disabled = true;
    input.style.borderBottomColor = "#fff"; // Reset color

    try {
        // 3. Save to Firebase
        await update(ref(db, `founderProfile/${currentUser.uid}`), {
            founderUsername: rawName,
            // Fallback for userId if it doesn't exist
            userId: cachedFounderData?.userId || `USER_${Date.now()}` 
        });

        // 4. Update Local Cache
        if(cachedFounderData) {
            cachedFounderData.founderUsername = rawName;
        }

        // 5. Success Animation
        btn.innerText = "Success âœ“";
        setTimeout(() => {
             const modal = document.getElementById('usernameSetupModal');
             if(modal) {
                 modal.style.opacity = '0'; // Fade out
                 setTimeout(() => {
                     modal.remove();
                     // 6. Reload Dashboard
                     window.location.reload(); 
                 }, 400);
             }
        }, 800);

    } catch (error) {
        console.error("Error saving username:", error);
        alert("Error saving username. Please try again.");
        btn.innerText = originalText;
        btn.disabled = false;
    }
};

// ==========================================
// APPLICATION REPLIES INBOX
// ==========================================

window.showApplicationReplies = async function() {
let userReplies = {};

    const container = document.getElementById('dashboardContainer');
    document.querySelector('.vest-container').style.display = 'none';
    container.style.display = 'block';
    document.title = "Application Replies | ScaleVest";
    
    // Show loading
    container.innerHTML = `
        <div class="loading-box">
            <div class="spinner"></div>
            <p>Loading Replies...</p>
        </div>`;
    
    try {
        // 1. Fetch replies
        const repliesRef = ref(db, `ApplicationReplies`);
        const snapshot = await get(repliesRef);
        
        if (!snapshot.exists()) {
            container.innerHTML = `
                <div class="manage-vests-page">
                    <a href="#founder_dashboard" class="back-to-dash">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 12H5M12 19l-7-7 7-7"/>
                        </svg>
                        Back
                    </a>
                    <h1>Application Replies</h1>
                    <div class="empty-state-box">
                        <p>No replies found yet.</p>
                    </div>
                </div>
            `;
            return;
        }
        
const allReplies = snapshot.val() || {};

userReplies = Object.fromEntries(
  Object.entries(allReplies).filter(
    ([_, reply]) => reply.founderId === currentUser.uid
  )
);

        
        // 2. Build reply cards HTML FIRST
        let repliesHTML = '';
        
        for (const [replyId, reply] of Object.entries(userReplies
)) {
            // Fetch investor name
            let investorName = 'Unknown Investor';
            try {
                const investorSnap = await get(ref(db, `angelProfiles/${reply.investorId}/fullName`));
                if (investorSnap.exists()) {
                    investorName = investorSnap.val();
                }
            } catch (e) {
                console.error("Error fetching investor:", e);
            }
            
            // Fetch application name
            let appName = 'Your Application';
            try {
                const appSnap = await get(ref(db, `Applications/${currentUser.uid}/${reply.applicationId}/appName`));
                if (appSnap.exists()) {
                    appName = appSnap.val();
                }
            } catch (e) {
                console.error("Error fetching app name:", e);
            }
            
            // Determine status styling
            let statusClass = '';
            let statusText = '';
            let statusIcon = '';
            
            if (reply.status === 'YES') {
                statusClass = 'status-accepted';
                statusText = 'Accepted';
                statusIcon = 'âœ“';
            } else if (reply.status === 'LATER') {
                statusClass = 'status-postponed';
                statusText = 'Postponed';
                statusIcon = 'â¸';
            } else {
                statusClass = 'status-rejected';
                statusText = 'Rejected';
                statusIcon = 'âœ•';
            }
            
            const isUnread = !reply.read;
            
            repliesHTML += `
                <div class="reply-card ${isUnread ? 'unread-card' : ''}" id="reply-${replyId}">
                    <button class="delete-reply-btn" onclick="deleteReply('${replyId}', event)" title="Delete Reply">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                    </button>
                    
                    <div onclick="markReplyAsReadOnly('${replyId}')" style="cursor: pointer;">
                        <div class="reply-status-badge ${statusClass}">
                            <span class="status-icon">${statusIcon}</span>
                            <span>${statusText}</span>
                        </div>
                        
                        <div class="reply-card-content">
                            <h3 class="reply-app-title">${appName}</h3>
                            
                            <div class="investor-info">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#ff006e" stroke-width="2">
                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="12" cy="7" r="4"></circle>
                                </svg>
                                <span>From: <strong>${investorName}</strong></span>
                            </div>
                            
                            ${reply.comment ? `
                                <div class="investor-comment">
                                    <p class="comment-label">Investor's Message:</p>
                                    <p class="comment-text">"${reply.comment}"</p>
                                </div>
                            ` : ''}
                            
                            <div class="reply-timestamp">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <polyline points="12 6 12 12 16 14"></polyline>
                                </svg>
                                ${formatTimestamp(reply.timestamp)}
                            </div>
                        </div>
                        
                        ${isUnread ? '<div class="unread-indicator">NEW</div>' : ''}
                    </div>
                </div>
            `;
        }
        
        clearReplyBadge();
        
        // 3. Render the full page HTML
        container.innerHTML = `
            <style>
                .reply-card {
                    background: #0f0f0f;
                    border: 1px solid #222;
                    border-radius: 16px;
                    padding: 2rem;
                    margin-bottom: 1.5rem;
                    position: relative;
                    transition: all 0.3s ease;
                }
                
                .reply-card:hover {
                    border-color: #444;
                    transform: translateY(-4px);
                    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
                }
                
                .unread-card {
                    border-left: 4px solid #ff006e;
                    background: rgba(255, 0, 110, 0.05);
                }
                
                .delete-reply-btn {
                    position: absolute;
                    top: 15px;
                    right: 15px;
                    width: 36px;
                    height: 36px;
                    border-radius: 8px;
                    background: rgba(239, 68, 68, 0.1);
                    border: 1px solid rgba(239, 68, 68, 0.3);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    z-index: 10;
                }
                
                .delete-reply-btn svg {
                    stroke: #ef4444;
                }
                
                .delete-reply-btn:hover {
                    background: #ef4444;
                    border-color: #ef4444;
                    transform: scale(1.1);
                }
                
                .delete-reply-btn:hover svg {
                    stroke: #fff;
                }
                
                .reply-status-badge {
                    display: inline-flex;
                    align-items: center;
                    gap: 8px;
                    padding: 8px 16px;
                    border-radius: 20px;
                    font-weight: 700;
                    font-size: 0.85rem;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                    margin-bottom: 1.5rem;
                }
                
                .status-accepted {
                    background: rgba(16, 185, 129, 0.15);
                    color: #10b981;
                    border: 1px solid #10b981;
                }
                
                .status-rejected {
                    background: rgba(239, 68, 68, 0.15);
                    color: #ef4444;
                    border: 1px solid #ef4444;
                }
                
                .status-postponed {
                    background: rgba(251, 191, 36, 0.15);
                    color: #fbbf24;
                    border: 1px solid #fbbf24;
                }
                
                .status-icon {
                    font-size: 1.2rem;
                }
                
                .reply-card-content {
                    padding-left: 0.5rem;
                }
                
                .reply-app-title {
                    font-size: 1.3rem;
                    font-weight: 700;
                    color: #fff;
                    margin-bottom: 1rem;
                }
                
                .investor-info {
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    color: #aaa;
                    margin-bottom: 1.5rem;
                    font-size: 0.95rem;
                }
                
                .investor-info strong {
                    color: #fff;
                }
                
                .investor-comment {
                    background: #000;
                    border-left: 3px solid #333;
                    padding: 1rem;
                    border-radius: 8px;
                    margin-bottom: 1rem;
                }
                
                .comment-label {
                    color: #666;
                    font-size: 0.8rem;
                    text-transform: uppercase;
                    letter-spacing: 1px;
                    margin-bottom: 0.5rem;
                }
                
                .comment-text {
                    color: #ccc;
                    font-style: italic;
                    line-height: 1.6;
                }
                
                .reply-timestamp {
                    display: flex;
                    align-items: center;
                    gap: 6px;
                    color: #555;
                    font-size: 0.85rem;
                }
                
                .unread-indicator {
                    position: absolute;
                    top: 60px;
                    right: 20px;
                    background: #ff006e;
                    color: #fff;
                    padding: 4px 12px;
                    border-radius: 12px;
                    font-size: 0.7rem;
                    font-weight: 800;
                    letter-spacing: 1px;
                }
                
                /* Popup Styles */
                .reply-popup-overlay {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100vw;
                    height: 100vh;
                    background: rgba(0, 0, 0, 0.95);
                    backdrop-filter: blur(10px);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 999999;
                    animation: fadeIn 0.3s ease;
                }
                
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                
                @keyframes fadeOut {
                    from { opacity: 1; }
                    to { opacity: 0; }
                }
                
                .reply-popup {
                    background: #0f0f0f;
                    border: 1px solid #333;
                    border-radius: 20px;
                    padding: 3rem;
                    max-width: 500px;
                    width: 90%;
                    text-align: center;
                    position: relative;
                    animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
                }
                
                @keyframes slideUp {
                    from { transform: translateY(50px); opacity: 0; }
                    to { transform: translateY(0); opacity: 1; }
                }
                
                .popup-icon {
                    width: 80px;
                    height: 80px;
                    margin: 0 auto 1.5rem;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 2.5rem;
                }
                
                .popup-icon.accepted {
                    background: rgba(16, 185, 129, 0.2);
                    color: #10b981;
                }
                
                .popup-icon.rejected {
                    background: rgba(239, 68, 68, 0.2);
                    color: #ef4444;
                }
                
                .popup-icon.postponed {
                    background: rgba(251, 191, 36, 0.2);
                    color: #fbbf24;
                }
                
                .popup-title {
                    font-size: 1.8rem;
                    font-weight: 800;
                    margin-bottom: 1rem;
                    color: #fff;
                }
                
                .popup-message {
                    color: #aaa;
                    line-height: 1.7;
                    margin-bottom: 2rem;
                    font-size: 1.05rem;
                }
                
                .popup-investor {
                    color: #ff006e;
                    font-weight: 700;
                }
                
                .popup-btn {
                    background: linear-gradient(135deg, #ff006e, #8338ec);
                    color: #fff;
                    border: none;
                    padding: 14px 32px;
                    border-radius: 10px;
                    font-weight: 700;
                    font-size: 1rem;
                    cursor: pointer;
                    transition: all 0.3s;
                }
                
                .popup-btn:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 10px 30px rgba(255, 0, 110, 0.3);
                }
            </style>
            
            <div class="manage-vests-page">
                <div class="header-row">
                    <a href="#founder_dashboard" class="back-to-dash">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 12H5M12 19l-7-7 7-7"/>
                        </svg>
                        Back
                    </a>
                    <h1>Application Replies</h1>
                </div>
                
                <div style="max-width: 900px; margin: 0 auto;">
                    ${repliesHTML || `
                        <div class="empty-state-box">
                            <p style="color: #666;">No replies yet.</p>
                        </div>
                    `}
                </div>
            </div>
        `;
        
        // 4. NOW check for unread and show popup AFTER page is rendered
        const unreadReplies = Object.entries(userReplies
).filter(([id, reply]) => !reply.read);
        
        if (unreadReplies.length > 0) {
            // Small delay to let the page render first
            setTimeout(async () => {
                const [firstReplyId, firstReply] = unreadReplies[0];
                await showReplyPopup(firstReplyId, firstReply);
            }, 300);
        }
        
    } catch (error) {
        console.error("Error loading replies:", error);
        container.innerHTML = `<p style="color:red; text-align:center; padding:2rem;">Error loading replies</p>`;
    }
};

// Delete reply function
window.deleteReply = async function(replyId, event) {
    event.stopPropagation(); // Prevent card click
    
    if (!confirm("Are you sure you want to delete this reply? This action cannot be undone.")) {
        return;
    }
    
    try {
        // Show deleting state
        const card = document.getElementById(`reply-${replyId}`);
        if (card) {
            card.style.opacity = '0.5';
            card.style.pointerEvents = 'none';
        }
        
        // Delete from Firebase
        await remove(ref(db, `ApplicationReplies/${replyId}`));
        
        // Animate removal
        if (card) {
            card.style.transform = 'translateX(100%)';
            card.style.opacity = '0';
            setTimeout(() => {
                card.remove();
                
                // Check if there are any cards left
                const remainingCards = document.querySelectorAll('.reply-card');
                if (remainingCards.length === 0) {
                    const container = document.querySelector('.manage-vests-page > div:last-child');
                    if (container) {
                        container.innerHTML = `
                            <div class="empty-state-box">
                                <p style="color: #666;">No replies yet.</p>
                            </div>
                        `;
                    }
                }
            }, 300);
        }
        
        // Show success toast
        if (window.showSuccessToast) {
            window.showSuccessToast("Reply deleted successfully");
        }
        
    } catch (error) {
        console.error("Error deleting reply:", error);
        alert("Failed to delete reply. Please try again.");
        
        // Restore card state
        const card = document.getElementById(`reply-${replyId}`);
        if (card) {
            card.style.opacity = '1';
            card.style.pointerEvents = 'auto';
        }
    }
};

// Function to show popup for new reply
async function showReplyPopup(replyId, reply) {
    // Fetch investor name
    let investorName = 'An Investor';
    try {
        const investorSnap = await get(ref(db, `angelProfiles/${reply.investorId}/fullName`));
        if (investorSnap.exists()) {
            investorName = investorSnap.val();
        }
    } catch (e) {
        console.error("Error fetching investor:", e);
    }
    
    // Determine message based on status
    let icon = '';
    let iconClass = '';
    let title = '';
    let message = '';
    
    if (reply.status === 'YES') {
        icon = 'âœ“';
        iconClass = 'accepted';
        title = 'Application Accepted!';
        message = `Your application has been <strong>accepted</strong> by <span class="popup-investor">${investorName}</span>! They may have sent you a message in chat. Check your inbox to continue the conversation.`;
    } else if (reply.status === 'LATER') {
        icon = 'â¸';
        iconClass = 'postponed';
        title = 'Application Postponed';
        message = `Your application is currently being <strong>postponed</strong> by <span class="popup-investor">${investorName}</span>. They may want you to try again after gaining some more traction. Don't give up!`;
    } else {
        icon = 'âœ•';
        iconClass = 'rejected';
        title = 'Application Status Update';
        message = `Unfortunately, your application has been <strong>rejected</strong> by <span class="popup-investor">${investorName}</span>. This doesn't mean your startup isn't goodâ€”it can be a path to another investor. Many big ideas failed many times before finding success!`;
    }
    
    // Create popup
    const popup = document.createElement('div');
    popup.className = 'reply-popup-overlay';
    popup.innerHTML = `
        <div class="reply-popup">
            <div class="popup-icon ${iconClass}">
                ${icon}
            </div>
            <h2 class="popup-title">${title}</h2>
            <p class="popup-message">${message}</p>
            <button class="popup-btn" onclick="closeReplyPopupAndMarkRead('${replyId}')">
                Got It
            </button>
        </div>
    `;
    
    document.body.appendChild(popup);
}

// Close popup and mark as read WITHOUT reloading
window.closeReplyPopupAndMarkRead = async function(replyId) {
    try {
        // Mark as read in Firebase
        await update(ref(db, `ApplicationReplies/${replyId}`), { read: true });
        
        // Remove popup
        const popup = document.querySelector('.reply-popup-overlay');
        if (popup) {
            popup.style.animation = 'fadeOut 0.3s ease';
            setTimeout(() => popup.remove(), 300);
        }
        
        // Update UI: Remove the NEW badge and unread styling from the card
        const card = document.getElementById(`reply-${replyId}`);
        if (card) {
            card.classList.remove('unread-card');
            const badge = card.querySelector('.unread-indicator');
            if (badge) badge.remove();
        }
        
    } catch (error) {
        console.error("Error marking as read:", error);
    }
};

// Mark individual card as read when clicked
window.markReplyAsReadOnly = async function(replyId) {
    try {
        await update(ref(db, `ApplicationReplies/${replyId}`), {
            read: true
        });
        
        // Update UI without reload
        const card = document.getElementById(`reply-${replyId}`);
        if (card) {
            card.classList.remove('unread-card');
            const badge = card.querySelector('.unread-indicator');
            if (badge) badge.remove();
        }
        
    } catch (error) {
        console.error("Error marking as read:", error);
    }
};
// Clear notification badge
function clearReplyBadge() {
    const badge = document.getElementById('replyNotifBadge');
    if (badge) badge.style.display = 'none';
}

// Format timestamp helper
function formatTimestamp(timestamp) {
    if (!timestamp) return 'Unknown';
    const date = new Date(timestamp);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffMins < 1440) return `${Math.floor(diffMins / 60)}h ago`;
    return date.toLocaleDateString();
}
// Auto-Reply Functions
window.openAutoReplySetup = async function() {
    const modal = document.getElementById('autoReplyModal');
    if (!modal) {
        alert("Auto-reply feature is loading...");
        return;
    }
    
    // Load existing auto-reply if it exists
    try {
        const autoReplyRef = ref(db, `founderProfile/${currentUser.uid}/autoReply`);
        const snapshot = await get(autoReplyRef);
        
        if (snapshot.exists()) {
            const data = snapshot.val();
            document.getElementById('autoReplyTextarea').value = data.message || '';
            document.getElementById('autoReplyEnabled').checked = data.enabled || false;
        } else {
            // Set default message
            document.getElementById('autoReplyTextarea').value = 
                "";
            document.getElementById('autoReplyEnabled').checked = true;
        }
    } catch (error) {
        console.error("Error loading auto-reply:", error);
    }
    
    modal.classList.add('show');
};

window.closeAutoReplyModal = function() {
    const modal = document.getElementById('autoReplyModal');
    if (modal) {
        modal.classList.remove('show');
    }
};

window.saveAutoReply = async function() {
    const message = document.getElementById('autoReplyTextarea').value.trim();
    const enabled = document.getElementById('autoReplyEnabled').checked;
    
    if (!message) {
        alert("âŒ Please enter an auto-reply message");
        return;
    }
    
    if (message.length > 500) {
        alert("âŒ Message is too long. Please keep it under 500 characters.");
        return;
    }
    
    const saveBtn = document.querySelector('#autoReplyModal .modal-btn-save');
    const originalText = saveBtn.innerText;
    saveBtn.innerText = 'Saving...';
    saveBtn.disabled = true;
    
    try {
        const autoReplyData = {
            message: message,
            enabled: enabled,
            updatedAt: Date.now()
        };
        
        await update(ref(db, `founderProfile/${currentUser.uid}`), {
            autoReply: autoReplyData
        });
        
        // Update cache
        if (cachedFounderData) {
            cachedFounderData.autoReply = autoReplyData;
        }
        
        closeAutoReplyModal();
        alert("âœ… Auto-reply saved successfully!");
        
    } catch (error) {
        console.error("Error saving auto-reply:", error);
        alert("âŒ Failed to save auto-reply");
        saveBtn.innerText = originalText;
        saveBtn.disabled = false;
    }
};

// Close modal when clicking outside
document.addEventListener('click', (e) => {
    const modal = document.getElementById('autoReplyModal');
    if (e.target === modal) {
        closeAutoReplyModal();
    }
});

// ==========================================
// FOUNDER AVAILABILITY MANAGEMENT
// ==========================================

// Show availability detail section
window.showAvailabilityDetail = function(sectionId) {
    document.getElementById('modalMenu').style.display = 'none';
    document.getElementById(sectionId).style.display = 'block';
};

// Reset modal to main menu
window.resetModal = function() {
    document.getElementById('dateSection').style.display = 'none';
    document.getElementById('statusSection').style.display = 'none';
    document.getElementById('modalMenu').style.display = 'block';
};

// Save Availability Status - CORRECTED VERSION
// --- GLOBAL UI HELPER FOR NAVBAR ---
window.updateNavStatusUI = function(status) {
    const pill = document.getElementById('navStatusPill');
    const text = document.getElementById('navStatusText');
    if (pill && text) {
        // Switch between 'active' and 'busy' classes for the Noir theme
        pill.className = `status-pill-nav ${status === 'busy' ? 'busy' : 'active'}`;
        text.innerText = `Status: ${status === 'busy' ? 'Busy' : 'Active'}`;
    }
};

// Add this updated saveStatus function to replace the existing one:

window.saveStatus = async function() {
    if (!currentUser) return;
    
    const statusSelect = document.getElementById('status');
    const dateInput = document.getElementById('unavailableDate');
    
    if (!statusSelect) {
        console.error("âŒ Status select not found");
        return;
    }
    
    const selectedStatus = statusSelect.value; // 'active' or 'busy'
    const unavailableDate = dateInput ? dateInput.value : null;
    
    try {
        // 1. Fetch current vests to perform bulk update
        const vestsRef = ref(db, `Vests/${currentUser.uid}`);
        const vestsSnapshot = await get(vestsRef);
        
        const updates = {};
        let activeCount = 0;
        
        if (vestsSnapshot.exists()) {
            const vestIds = Object.keys(vestsSnapshot.val());
            const newVestStatus = selectedStatus === 'active' ? 'active' : 'inactive';
            
            // Loop through all vests to change their individual visibility
            vestIds.forEach(vestId => {
                updates[`Vests/${currentUser.uid}/${vestId}/status`] = newVestStatus;
                if (newVestStatus === 'active') activeCount++;
            });
        }
        
        // 2. Update Founder Profile (Status + Active Count + Optional Date)
        updates[`founderProfile/${currentUser.uid}/availabilityStatus`] = selectedStatus;
        updates[`founderProfile/${currentUser.uid}/activeVestsCount`] = activeCount;
        
        // **NEW: Save the unavailability date if provided**
        if (unavailableDate) {
            const selectedDate = new Date(unavailableDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (selectedDate < today) {
                alert("âŒ Please select a future date.");
                return;
            }

            updates[`founderProfile/${currentUser.uid}/scheduledUnavailability`] = {
                date: unavailableDate,
                scheduledAt: Date.now(),
                targetStatus: 'busy' // When this date arrives, set status to busy
            };
        }

        // 3. Execute all database changes in one trip
        await update(ref(db), updates);
        
        // 4. Update Local Cache for immediate UI feedback
        if (cachedFounderData) {
            cachedFounderData.availabilityStatus = selectedStatus;
            cachedFounderData.activeVestsCount = activeCount;
            if (unavailableDate) {
                cachedFounderData.scheduledUnavailability = {
                    date: unavailableDate,
                    scheduledAt: Date.now(),
                    targetStatus: 'busy'
                };
            }
        }

        // 5. Update the Navbar Status Pill immediately
        window.updateNavStatusUI(selectedStatus);
        
        // 6. Build success message
        let statusMessage = selectedStatus === 'active' 
            ? `âœ… All vests activated! (${activeCount} live)` 
            : `â¸ï¸ System set to BUSY. All vests are now hidden.`;
        
        if (unavailableDate) {
            statusMessage += `\nðŸ“… Scheduled unavailability on ${unavailableDate}`;
        }
        
        alert(statusMessage);
        
        // 7. Close modal and reset
        document.getElementById('availabilityModal').style.display = 'none';
        resetModal(); // Clear the form
        
        // 8. Refresh the Dashboard View
        if (window.location.hash === '#founder_dashboard' || window.location.hash === '') {
            if (typeof createDashboard === 'function') {
                createDashboard(); 
            } else if (typeof showDashboard === 'function') {
                await showDashboard();
            }
        }
        
    } catch (error) {
        console.error("âŒ Sync Error:", error);
        alert("âŒ Failed to update status: " + error.message);
    }
};

// Add this function to check and apply scheduled unavailability
async function checkScheduledAvailability() {
    if (!currentUser) return;
    
    try {
        const profileRef = ref(db, `founderProfile/${currentUser.uid}/scheduledUnavailability`);
        const snapshot = await get(profileRef);
        
        if (snapshot.exists()) {
            const scheduled = snapshot.val();
            const targetDate = new Date(scheduled.date);
            const now = new Date();
            now.setHours(0, 0, 0, 0);
            targetDate.setHours(0, 0, 0, 0);
            
            // â­ CHECK IF DATE HAS PASSED (not just equals)
            if (now >= targetDate) {
                console.log("â° Applying scheduled unavailability...");
                
                const vestsRef = ref(db, `Vests/${currentUser.uid}`);
                const vestsSnapshot = await get(vestsRef);
                
                if (vestsSnapshot.exists()) {
                    const updates = {};
                    Object.keys(vestsSnapshot.val()).forEach(vestId => {
                        updates[`Vests/${currentUser.uid}/${vestId}/status`] = 'inactive';
                    });
                    
                    updates[`founderProfile/${currentUser.uid}/activeVestsCount`] = 0;
                    updates[`founderProfile/${currentUser.uid}/availabilityStatus`] = 'busy';
                    updates[`founderProfile/${currentUser.uid}/scheduledUnavailability`] = null;
                    
                    await update(ref(db), updates);
                    
                    console.log("âœ… Scheduled unavailability applied");
                    
                    // â­ SHOW ALERT TO USER
                    alert("ðŸ”’ Your scheduled unavailability has been applied. All vests are now inactive.");
                    
                    if (window.updateNavStatusUI) {
                        window.updateNavStatusUI('busy');
                    }
                    
                    // â­ REFRESH DASHBOARD
                    if (window.location.hash === '#founder_dashboard' || !window.location.hash) {
                        window.location.reload();
                    }
                }
            }
        }
    } catch (error) {
        console.error("Error checking scheduled availability:", error);
    }
}
// Update the modal reset function to clear inputs
window.resetModal = function() {
    // Hide sub-sections
    document.getElementById('dateSection').style.display = 'none';
    document.getElementById('statusSection').style.display = 'none';
    
    // Show main menu
    document.getElementById('modalMenu').style.display = 'block';
    
    // **NEW: Clear the form inputs**
    const dateInput = document.getElementById('unavailableDate');
    const statusSelect = document.getElementById('status');
    
    if (dateInput) dateInput.value = '';
    if (statusSelect) statusSelect.value = 'active'; // Reset to default
};
// Event listeners for modal
document.addEventListener('DOMContentLoaded', function() {
    // Open modal button
    const openModalBtn = document.getElementById('openModal');
    if (openModalBtn) {
        openModalBtn.addEventListener('click', function() {
            const modal = document.getElementById('availabilityModal');
            if (modal) {
                modal.style.display = 'block';
                resetModal();
            }
        });
    }
    
    // Close modal button
    const closeBtn = document.querySelector('.close-btn');
    if (closeBtn) {
        closeBtn.addEventListener('click', function() {
            const modal = document.getElementById('availabilityModal');
            if (modal) {
                modal.style.display = 'none';
            }
        });
    }
    
    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
        const modal = document.getElementById('availabilityModal');
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });
});
// Add this function to load current status when modal opens
window.openAvailabilityModal = async function() {
    const modal = document.getElementById('availabilityModal');
    if (!modal) return;
    
    // Show modal
    modal.style.display = 'block';
    resetModal(); // Reset to main menu
    
    // **Load current status from database/cache**
    if (cachedFounderData && cachedFounderData.availabilityStatus) {
        const statusSelect = document.getElementById('status');
        if (statusSelect) {
            statusSelect.value = cachedFounderData.availabilityStatus;
        }
    }
    
    // **Load scheduled date if exists**
    if (cachedFounderData && cachedFounderData.scheduledUnavailability) {
        const dateInput = document.getElementById('unavailableDate');
        if (dateInput && cachedFounderData.scheduledUnavailability.date) {
            dateInput.value = cachedFounderData.scheduledUnavailability.date;
        }
    }
};

// Update the existing event listener to use the new function
document.addEventListener('click', function (e) {
    const modal = document.getElementById("availabilityModal");

    // 1. Open Modal - Use new function
    if (e.target && e.target.id === 'openModal') {
        openAvailabilityModal(); // Changed from inline code
        return;
    }

    // 2. Close Modal (X button)
    if (e.target && e.target.classList.contains('close-btn')) {
        modal.style.display = "none";
    }

    // 3. Close if clicking outside the box
    if (e.target === modal) {
        modal.style.display = "none";
    }
});

// ==========================================
// REFERRAL PAGE LOGIC
// ==========================================

window.showReferralsPage = async function() {
    const container = document.getElementById('dashboardContainer');
    document.querySelector('.vest-container').style.display = 'none';
    container.style.display = 'block';
    
    // Check if user already has a ReferURL in Firebase
    let existingUrl = null;
    try {
        const snap = await get(ref(db, `founderProfile/${currentUser.uid}/ReferURL`));
        if (snap.exists()) {
            existingUrl = snap.val();
        }
    } catch (e) {
        console.error("Error fetching referral:", e);
    }

    // Determine HTML Content
    const contentHTML = existingUrl 
        ? getReferralResultHTML(existingUrl) // User HAS a code
        : getReferralGenerateHTML();         // User needs to generate

    container.innerHTML = `
        <div class="ref-page-container">
            <a href="#founder_dashboard" class="back-link-abs">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                Dashboard
            </a>

            <div class="ref-bg-shapes">
                <div class="ref-shape ref-shape-1"></div>
                <div class="ref-shape ref-shape-2"></div>
                <div class="ref-shape ref-shape-3"></div>
            </div>

            <div class="ref-card" id="referralCardContent">
                <h1 class="ref-title">Invite & Earn</h1>
                <p class="ref-subtitle">
                    Refer other founders or investors to ScaleVest. <br>
                    Earn <strong>+10 Scale Tokens</strong> for every click.
                </p>
                ${contentHTML}
            </div>
        </div>
    `;
};

// HTML State 1: Generate Button
function getReferralGenerateHTML() {
    return `
        <div style="margin-top: 40px;">
            <div style="margin-bottom: 30px;">
                <img src="ScaleVestLogo.png" style="width: 80px; height: 80px; border-radius: 50%; box-shadow: 0 0 30px rgba(255,255,255,0.2);">
            </div>
            <button class="btn-generate-ref" onclick="generateReferralLink()">
                Generate Your Referral URL
            </button>
        </div>
    `;
}

// HTML State 2: Result (Input + Share Buttons)
function getReferralResultHTML(url) {
    const encodedUrl = encodeURIComponent(url);
    const text = encodeURIComponent("Check out ScaleVest! The best platform for Startups, Investors and BusinessOwners");

    return `
        <div class="ref-result-box">
            <div class="ref-input-group">
                <input type="text" class="ref-input" value="${url}" id="refUrlInput" readonly>
                <button class="ref-btn-copy" onclick="copyReferralUrl()">COPY</button>
            </div>

            <span class="share-label">Share via</span>
            
            <div class="share-row">
                <a href="https://wa.me/?text=${text}%20${encodedUrl}" target="_blank" class="share-icon-btn share-whatsapp">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
                </a>
                
                <a href="https://twitter.com/intent/tweet?text=${text}&url=${encodedUrl}" target="_blank" class="share-icon-btn share-x">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                </a>

                <a href="https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}" target="_blank" class="share-icon-btn share-facebook">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M9.101 23.691v-7.98H6.627v-3.667h2.474v-1.58c0-4.085 1.848-5.978 5.858-5.978.401 0 .955.042 1.468.103a8.68 8.68 0 0 1 1.141.195v3.325a8.623 8.623 0 0 0-.653-.036c-2.148 0-2.797 1.603-2.797 2.87v1.12h5.392l-.502 3.668h-4.89v7.98c0 .038-.1.022-.1.095h-5.02c0-.053.097-.037.097-.124z"/></svg>
                </a>
            </div>
        </div>
    `;
}

// Logic: Generate URL
window.generateReferralLink = async function() {
    if (!currentUser || !cachedFounderData) return alert("Please wait for profile data to load.");
    
    // Create Button Loading Effect
    const btn = document.querySelector('.btn-generate-ref');
    btn.innerHTML = "Generating...";
    btn.style.opacity = "0.7";

    try {
        // 1. Create Unique Code
        // Remove spaces from username and add 4 digit random
        const cleanName = cachedFounderData.founderUsername.replace(/\s+/g, ''); 
        const randomID = Date.now().toString().slice(-4);
        const refCode = `${cleanName}_Scalevest${randomID}`;
        
        // 2. Build URL (Pointing to upscalevest.site with parameters)
        // We pass ?ref for the code and ?uid so the landing page knows WHO to pay
        const finalUrl = `https://upscalevest.site?ref=${refCode}&uid=${currentUser.uid}`;

        // 3. Save to Firebase
        await update(ref(db, `founderProfile/${currentUser.uid}`), {
            ReferURL: finalUrl
        });

        // 4. Update UI
        const contentDiv = document.getElementById('referralCardContent');
        // Keep the title/subtitle, replace the button with the result
        // We re-render the whole page for simplicity to ensure state is clean
        window.showReferralsPage();

    } catch (e) {
        console.error("Ref Gen Error:", e);
        alert("Failed to generate link. Try again.");
        btn.innerHTML = "Generate Your Referral URL";
    }
};

// Logic: Copy URL
window.copyReferralUrl = function() {
    const input = document.getElementById('refUrlInput');
    input.select();
    input.setSelectionRange(0, 99999);
    navigator.clipboard.writeText(input.value);

    const btn = document.querySelector('.ref-btn-copy');
    const original = btn.innerText;
    btn.innerText = "COPIED!";
    btn.style.background = "#fff";
    btn.style.color = "#000";

    setTimeout(() => {
        btn.innerText = original;
        btn.style.background = "#222";
        btn.style.color = "#fff";
    }, 2000);
};
async function showAnalytics() {
    document.title = "Analytics Dashboard | ScaleVest";
    const container = document.getElementById('dashboardContainer');
    document.querySelector('.vest-container').style.display = 'none';
    container.style.display = 'block';
    
    container.innerHTML = `
        <div class="loading-box">
            <div class="spinner"></div>
            <p style="color:#888;">Loading Analytics Dashboard...</p>
        </div>`;
    
    try {
        const vestsRef = ref(db, `Vests/${currentUser.uid}`);
        const snapshot = await get(vestsRef);
        
        if (!snapshot.exists()) {
            container.innerHTML = `
             
                <div style="max-width:800px; margin:0 auto; padding:4rem; text-align:center;">
                    <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="2" style="margin-bottom:2rem;">
                        <line x1="12" y1="20" x2="12" y2="10"></line>
                        <line x1="18" y1="20" x2="18" y2="4"></line>
                        <line x1="6" y1="20" x2="6" y2="16"></line>
                    </svg>
                    <h2 style="color:#fff; margin-bottom:1rem;">No Analytics Data</h2>
                    <p style="color:#666;">Create a vest to start tracking performance metrics</p>
                    <button class="buy-btn-premium" onclick="window.location.hash='vest_step1'" style="margin-top:2rem; max-width:300px;">
                        Create Your First Vest
                    </button>
                </div>`;
            return;
        }
        
        const vests = snapshot.val();
        
        container.innerHTML = `
           
            
            <style>
                .analytics-page {
                    max-width: 1400px;
                    margin: 0 auto;
                    padding: 3rem;
                    background: #000;
                    min-height: 100vh;
                }
                
                .analytics-header {
                    margin-bottom: 3rem;
                    padding-bottom: 2rem;
                    border-bottom: 1px solid #1a1a1a;
                }
                
                .analytics-title {
                    font-size: 2.5rem;
                    font-weight: 800;
                    color: #fff;
                    margin-bottom: 0.5rem;
                    letter-spacing: -0.5px;
                }
                
                .analytics-subtitle {
                    color: #666;
                    font-size: 1rem;
                    line-height: 1.6;
                }
                
                .vest-selection-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
                    gap: 2rem;
                }
                
                .vest-analytics-card {
                    background: #0a0a0a;
                    border: 1px solid #1a1a1a;
                    border-radius: 12px;
                    overflow: hidden;
                    cursor: pointer;
                    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                }
                
                .vest-analytics-card:hover {
                    border-color: #333;
                    transform: translateY(-4px);
                    box-shadow: 0 12px 40px rgba(0,0,0,0.4);
                }
                
                .vest-analytics-thumb {
                    width: 100%;
                    height: 200px;
                    background: #111;
                    position: relative;
                    overflow: hidden;
                }
                
                .vest-analytics-thumb img {
                    width: 100%;
                    height: 100%;
                    object-fit: cover;
                    transition: transform 0.3s;
                }
                
                .vest-analytics-card:hover .vest-analytics-thumb img {
                    transform: scale(1.05);
                }
                
                .vest-analytics-content {
                    padding: 1.5rem;
                }
                
                .vest-analytics-hook {
                    font-size: 1.1rem;
                    font-weight: 700;
                    color: #fff;
                    margin-bottom: 0.5rem;
                    line-height: 1.4;
                    display: -webkit-box;
                    -webkit-line-clamp: 2;
                    -webkit-box-orient: vertical;
                    overflow: hidden;
                }
                
                .vest-analytics-startup {
                    color: #666;
                    font-size: 0.9rem;
                    margin-bottom: 1.5rem;
                }
                
                .vest-mini-stats {
                    display: grid;
                    grid-template-columns: repeat(2, 1fr);
                    gap: 1rem;
                    margin-bottom: 1.5rem;
                }
                
                .vest-mini-stat {
                    background: #000;
                    padding: 0.75rem;
                    border-radius: 8px;
                    border: 1px solid #1a1a1a;
                }
                
                .vest-mini-stat-label {
                    color: #666;
                    font-size: 0.75rem;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                    margin-bottom: 0.25rem;
                }
                
                .vest-mini-stat-value {
                    color: #fff;
                    font-size: 1.25rem;
                    font-weight: 700;
                }
                
                .vest-analytics-btn {
                    width: 100%;
                    padding: 0.875rem;
                    background: #fff;
                    color: #000;
                    border: none;
                    border-radius: 8px;
                    font-weight: 700;
                    font-size: 0.9rem;
                    letter-spacing: 0.5px;
                    cursor: pointer;
                    transition: all 0.2s;
                    text-transform: uppercase;
                }
                
                .vest-analytics-btn:hover {
                    background: #f0f0f0;
                    transform: translateY(-1px);
                }
            </style>
            
            <div class="analytics-page">
                <a href="#founder_dashboard" class="back-to-dash">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                    Dashboard
                </a>
                
                <div class="analytics-header">
                    <h1 class="analytics-title">Performance Analytics</h1>
                    <p class="analytics-subtitle">
                        Monitor your vest performance with real-time metrics and insights. 
                        Track engagement, clicks, and investor interest across all your active campaigns.
                    </p>
                </div>
                
                <div class="vest-selection-grid" id="vestSelectionGrid">
                    <div style="text-align:center; padding:2rem;">
                        <div class="spinner"></div>
                        <p style="color:#666; margin-top:1rem;">Loading vests...</p>
                    </div>
                </div>
            </div>
        `;
        

// Fetch analytics for each vest
const vestCards = await Promise.all(
    Object.entries(vests).map(async ([vestId, vest]) => {
        // Analytics is inside the vest object
        const analytics = vest.analytics || {};
        
        return {
            vestId,
            vest,
            analytics
        };
    })
);

const gridContainer = document.getElementById('vestSelectionGrid');
gridContainer.innerHTML = vestCards.map(({ vestId, vest, analytics }) => `
    <div class="vest-analytics-card" onclick="window.location.hash='vest_analytics_${vestId}'">
        <div class="vest-analytics-thumb">
            <img src="${vest.MainVest?.thumbnailUrl || 'https://via.placeholder.com/400x225?text=No+Image'}" 
                 alt="Vest Thumbnail"
                 onerror="this.src='https://via.placeholder.com/400x225?text=No+Image'">
        </div>
        <div class="vest-analytics-content">
            <h3 class="vest-analytics-hook">${vest.MainVest?.hook || 'Vest Campaign'}</h3>
            <p class="vest-analytics-startup">${vest.StartupDetails?.name || 'Startup'}</p>
            
            <div class="vest-mini-stats">
                <div class="vest-mini-stat">
                    <div class="vest-mini-stat-label">Total Clicks</div>
                    <div class="vest-mini-stat-value">${analytics.totalClicks || 0}</div>
                </div>
                <div class="vest-mini-stat">
                    <div class="vest-mini-stat-label">Impressions</div>
                    <div class="vest-mini-stat-value">${analytics.totalImpressions || 0}</div>
                </div>
            </div>
            
            <button class="vest-analytics-btn">View Full Analytics</button>
        </div>
    </div>
`).join('');
        
    } catch (error) {
        console.error("Analytics Error:", error);
        container.innerHTML = `
           
            <div style="text-align:center; padding:4rem; color:#ef4444;">
                <h3>Error Loading Analytics</h3>
                <p style="color:#666; margin-top:1rem;">${error.message}</p>
            </div>`;
    }
}
async function showVestAnalytics(vestId) {
    const container = document.getElementById('dashboardContainer');
    
    container.innerHTML = `
        <div class="loading-box">
            <div class="spinner"></div>
            <p style="color:#888;">Loading Analytics...</p>
        </div>`;
    
try {
    // Fetch vest data
    const vestRef = ref(db, `Vests/${currentUser.uid}/${vestId}`);
    const vestSnap = await get(vestRef);
    const vest = vestSnap.val();
    
    if (!vest) {
        throw new Error('Vest not found');
    }
    
    // Analytics is inside the vest
    const analytics = vest.analytics || {
        totalClicks: 0,
        totalImpressions: 0,
        totalTimeSpent: 0,
        totalInterestedToFund: 0,
        todayClicks: 0,
        todayImpressions: 0,
        todayTimeSpent: 0,
        todayInterestedToFund: 0,
        yesterdayClicks: 0,
        yesterdayImpressions: 0,
        yesterdayTimeSpent: 0
    };        
        // Calculate changes
        const clickChange = analytics.yesterdayClicks > 0 
            ? ((analytics.todayClicks - analytics.yesterdayClicks) / analytics.yesterdayClicks * 100).toFixed(1)
            : analytics.todayClicks > 0 ? 100 : 0;
            
        const impressionChange = analytics.yesterdayImpressions > 0
            ? ((analytics.todayImpressions - analytics.yesterdayImpressions) / analytics.yesterdayImpressions * 100).toFixed(1)
            : analytics.todayImpressions > 0 ? 100 : 0;
            
        const timeChange = analytics.yesterdayTimeSpent > 0
            ? ((analytics.todayTimeSpent - analytics.yesterdayTimeSpent) / analytics.yesterdayTimeSpent * 100).toFixed(1)
            : analytics.todayTimeSpent > 0 ? 100 : 0;
        
        // Format time
        const formatTime = (seconds) => {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return mins > 0 ? `${mins}m ${secs}s` : `${secs}s`;
        };
        
        container.innerHTML = `
           
            
            <style>
                .analytics-detail-page {
                    max-width: 1200px;
                    margin: 0 auto;
                    padding: 3rem;
                    background: #000;
                    min-height: 100vh;
                }
                
                .analytics-vest-header {
                    background: #0a0a0a;
                    border: 1px solid #1a1a1a;
                    border-radius: 12px;
                    padding: 2rem;
                    margin-bottom: 3rem;
                    display: flex;
                    align-items: center;
                    gap: 2rem;
                }
                
                .analytics-vest-thumb-small {
                    width: 120px;
                    height: 120px;
                    border-radius: 8px;
                    overflow: hidden;
                    flex-shrink: 0;
                    background: #111;
                }
                
                .analytics-vest-thumb-small img {
                    width: 100%;
                    height: 100%;
                    object-fit: cover;
                }
                
                .analytics-vest-info h2 {
                    font-size: 1.5rem;
                    font-weight: 700;
                    color: #fff;
                    margin-bottom: 0.5rem;
                }
                
                .analytics-vest-info p {
                    color: #666;
                    font-size: 0.95rem;
                }
                
                .analytics-section {
                    margin-bottom: 3rem;
                }
                
                .analytics-section-title {
                    font-size: 1.25rem;
                    font-weight: 700;
                    color: #fff;
                    margin-bottom: 1.5rem;
                    padding-bottom: 0.75rem;
                    border-bottom: 1px solid #1a1a1a;
                    text-transform: uppercase;
                    letter-spacing: 1px;
                    font-size: 0.95rem;
                }
                
                .stat-grid-analytics {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
                    gap: 1.5rem;
                }
                
                .stat-card-pro {
                    background: #0a0a0a;
                    border: 1px solid #1a1a1a;
                    border-radius: 12px;
                    padding: 1.75rem;
                    transition: all 0.3s;
                }
                
                .stat-card-pro:hover {
                    border-color: #333;
                    transform: translateY(-2px);
                }
                
                .stat-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: flex-start;
                    margin-bottom: 1rem;
                }
                
                .stat-label-pro {
                    color: #888;
                    font-size: 0.8rem;
                    text-transform: uppercase;
                    letter-spacing: 1px;
                    font-weight: 600;
                }
                
                .stat-icon {
                    width: 32px;
                    height: 32px;
                    border-radius: 6px;
                    background: #111;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }
                
                .stat-value-pro {
                    font-size: 2.25rem;
                    font-weight: 800;
                    color: #fff;
                    margin-bottom: 0.75rem;
                    line-height: 1;
                }
                
                .stat-comparison {
                    display: flex;
                    align-items: center;
                    gap: 0.5rem;
                    font-size: 0.85rem;
                    font-weight: 600;
                }
                
                .stat-comparison.positive {
                    color: #10b981;
                }
                
                .stat-comparison.negative {
                    color: #ef4444;
                }
                
                .stat-comparison.neutral {
                    color: #888;
                }
                
                .stat-arrow {
                    display: inline-flex;
                    align-items: center;
                    justify-content: center;
                    width: 20px;
                    height: 20px;
                    border-radius: 4px;
                    font-weight: 700;
                }
                
                .stat-arrow.up {
                    background: rgba(16, 185, 129, 0.15);
                }
                
                .stat-arrow.down {
                    background: rgba(239, 68, 68, 0.15);
                }
                
                .comparison-detail {
                    color: #666;
                    font-size: 0.75rem;
                    margin-top: 0.25rem;
                }
            </style>
            
            <div class="analytics-detail-page">
                <a href="#analytics" class="back-to-dash">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                    Back to Analytics
                </a>
                
<div class="analytics-vest-header">
    <div class="analytics-vest-thumb-small">
        <img src="${vest?.MainVest?.thumbnailUrl || 'https://via.placeholder.com/120?text=No+Image'}" 
             alt="Vest"
             onerror="this.src='https://via.placeholder.com/120?text=No+Image'">
    </div>
    <div class="analytics-vest-info">
        <h2>${vest?.MainVest?.hook || 'Vest Analytics'}</h2>
        <p>${vest?.StartupDetails?.name || 'Startup'} â€¢ Last updated: ${new Date().toLocaleDateString()}</p>
    </div>
</div>
                
                <!-- Lifetime Performance -->
                <div class="analytics-section">
                    <h3 class="analytics-section-title">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:inline-block; vertical-align:middle; margin-right:0.5rem;">
                            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                        </svg>
                        Lifetime Performance
                    </h3>
                    <div class="stat-grid-analytics">
                        <div class="stat-card-pro">
                            <div class="stat-header">
                                <div class="stat-label-pro">Total Clicks</div>
                                <div class="stat-icon">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2">
                                        <path d="M9 11l3 3L22 4"></path>
                                        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="stat-value-pro">${analytics.totalClicks || 0}</div>
                            <div class="comparison-detail">All-time vest clicks</div>
                        </div>
                        
                        <div class="stat-card-pro">
                            <div class="stat-header">
                                <div class="stat-label-pro">Total Impressions</div>
                                <div class="stat-icon">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                        <circle cx="12" cy="12" r="3"></circle>
                                    </svg>
                                </div>
                            </div>
                            <div class="stat-value-pro">${analytics.totalImpressions || 0}</div>
                            <div class="comparison-detail">Total views</div>
                        </div>
                        
                        <div class="stat-card-pro">
                            <div class="stat-header">
                                <div class="stat-label-pro">Time Spent</div>
                                <div class="stat-icon">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <polyline points="12 6 12 12 16 14"></polyline>
                                    </svg>
                                </div>
                            </div>
                            <div class="stat-value-pro">${formatTime(analytics.totalTimeSpent || 0)}</div>
                            <div class="comparison-detail">Total engagement time</div>
                        </div>
                        
                        <div class="stat-card-pro">
                            <div class="stat-header">
                                <div class="stat-label-pro">Interested</div>
                                <div class="stat-icon">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2">
                                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="stat-value-pro">${analytics.totalInterestedToFund || 0}</div>
                            <div class="comparison-detail">Total interested investors</div>
                        </div>
                    </div>
                </div>
                
                <!-- Today's Performance -->
                <div class="analytics-section">
                    <h3 class="analytics-section-title">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:inline-block; vertical-align:middle; margin-right:0.5rem;">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                        Today's Performance
                    </h3>
                    <div class="stat-grid-analytics">
                        <div class="stat-card-pro">
                            <div class="stat-header">
                                <div class="stat-label-pro">Clicks Today</div>
                                <div class="stat-icon">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2">
                                        <path d="M9 11l3 3L22 4"></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="stat-value-pro">${analytics.todayClicks || 0}</div>
                            <div class="stat-comparison ${parseFloat(clickChange) > 0 ? 'positive' : parseFloat(clickChange) < 0 ? 'negative' : 'neutral'}">
                                <span class="stat-arrow ${parseFloat(clickChange) > 0 ? 'up' : 'down'}">
                                    ${parseFloat(clickChange) > 0 ? 'â†‘' : parseFloat(clickChange) < 0 ? 'â†“' : 'â€”'}
                                </span>
                                ${Math.abs(clickChange)}% vs yesterday
                            </div>
                            <div class="comparison-detail">Yesterday: ${analytics.yesterdayClicks || 0} clicks</div>
                        </div>
                        
                        <div class="stat-card-pro">
                            <div class="stat-header">
                                <div class="stat-label-pro">Impressions</div>
                                <div class="stat-icon">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="stat-value-pro">${analytics.todayImpressions || 0}</div>
                            <div class="stat-comparison ${parseFloat(impressionChange) > 0 ? 'positive' : parseFloat(impressionChange) < 0 ? 'negative' : 'neutral'}">
                                <span class="stat-arrow ${parseFloat(impressionChange) > 0 ? 'up' : 'down'}">
                                    ${parseFloat(impressionChange) > 0 ? 'â†‘' : parseFloat(impressionChange) < 0 ? 'â†“' : 'â€”'}
                                </span>
                                ${Math.abs(impressionChange)}% vs yesterday
                            </div>
                            <div class="comparison-detail">Yesterday: ${analytics.yesterdayImpressions || 0} views</div>
                        </div>
                        
                        <div class="stat-card-pro">
                            <div class="stat-header">
                                <div class="stat-label-pro">Time Spent</div>
                                <div class="stat-icon">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <polyline points="12 6 12 12 16 14"></polyline>
                                    </svg>
                                </div>
                            </div>
                            <div class="stat-value-pro">${formatTime(analytics.todayTimeSpent || 0)}</div>
                            <div class="stat-comparison ${parseFloat(timeChange) > 0 ? 'positive' : parseFloat(timeChange) < 0 ? 'negative' : 'neutral'}">
                                <span class="stat-arrow ${parseFloat(timeChange) > 0 ? 'up' : 'down'}">
                                    ${parseFloat(timeChange) > 0 ? 'â†‘' : parseFloat(timeChange) < 0 ? 'â†“' : 'â€”'}
                                </span>
                                ${Math.abs(timeChange)}% vs yesterday
                            </div>
                            <div class="comparison-detail">Yesterday: ${formatTime(analytics.yesterdayTimeSpent || 0)}</div>
                        </div>
                        
                        <div class="stat-card-pro">
                            <div class="stat-header">
                                <div class="stat-label-pro">New Interest</div>
                                <div class="stat-icon">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2">
                                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="stat-value-pro">${analytics.todayInterestedToFund || 0}</div>
                            <div class="comparison-detail">New interested investors today</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
    } catch (error) {
        console.error("Vest Analytics Error:", error);
        container.innerHTML = `
           
            <div style="text-align:center; padding:4rem; color:#ef4444;">
                <h3>Error Loading Analytics</h3>
                <p style="color:#666; margin-top:1rem;">${error.message}</p>
                <button class="buy-btn-premium" onclick="window.location.hash='analytics'" style="margin-top:2rem;">
                    Back to Analytics
                </button>
            </div>`;
    }
}
// ==========================================
// VERIFICATION PAGE
// ==========================================

async function showVerificationPage() {
    const container = document.getElementById('dashboardContainer');
    document.querySelector('.vest-container').style.display = 'none';
    container.style.display = 'block';
    document.title = "Verify Your Account | ScaleVest";
    
    // Check if verification line already exists
    const founderRef = ref(db, `founderProfile/${currentUser.uid}`);
    const snapshot = await get(founderRef);
    const founderData = snapshot.val() || {};
    const existingLine = founderData.verificationLine || null;
    
    container.innerHTML = `
        <style>
            .verify-page {
                max-width: 800px;
                margin: 0 auto;
                padding: 3rem;
                min-height: 100vh;
            }
            
            .verify-header {
                text-align: center;
                margin-bottom: 3rem;
            }
            
            .verify-title {
                font-size: 2.5rem;
                font-weight: 800;
                color: #fff;
                margin-bottom: 1rem;
            }
            
            .verify-subtitle {
                color: #888;
                font-size: 1.1rem;
                line-height: 1.6;
            }
            
            .verify-card {
                background: #0a0a0a;
                border: 1px solid #222;
                border-radius: 16px;
                padding: 3rem;
                margin-bottom: 2rem;
            }
            
            .verify-option-btn {
                background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
                border: 2px solid #333;
                color: #fff;
                padding: 2rem;
                border-radius: 12px;
                cursor: pointer;
                transition: all 0.3s;
                width: 100%;
                text-align: left;
                margin-bottom: 1.5rem;
                display: flex;
                align-items: center;
                gap: 1.5rem;
            }
            
            .verify-option-btn:hover {
                border-color: #ff006e;
                transform: translateX(10px);
                box-shadow: 0 10px 30px rgba(255, 0, 110, 0.2);
            }
            
            .verify-icon {
                width: 60px;
                height: 60px;
                background: rgba(255, 0, 110, 0.1);
                border-radius: 12px;
                display: flex;
                align-items: center;
                justify-content: center;
                flex-shrink: 0;
            }
            
            .verify-option-content h3 {
                font-size: 1.3rem;
                margin-bottom: 0.5rem;
            }
            
            .verify-option-content p {
                color: #888;
                font-size: 0.95rem;
                line-height: 1.5;
            }
            
           .verify-step-content {
    display: block !important;
    color: #fff;
    flex: 1;
}

.verification-steps {
    margin-top: 30px;
    background: #0f0f0f;
    border: 1px solid #333;
    border-radius: 12px;
    padding: 30px;
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.4s ease;
}

.verification-steps.active {
    opacity: 1;
    transform: translateY(0);
}

.step-item {
    display: flex;
    gap: 20px;
    margin-bottom: 30px;
    border-bottom: 1px solid #222;
    padding-bottom: 30px;
}

.step-item:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.step-number {
    width: 35px;
    height: 35px;
    background: #ff006e;
    color: #fff;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    flex-shrink: 0;
}

.verify-btn {
    background: linear-gradient(135deg, #ff006e, #8338ec);
    color: #fff;
    border: none;
    padding: 12px 25px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    margin-top: 15px;
}

.verify-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* Initially hidden elements */
.verification-line-box, .upload-section {
    display: none;
    margin-top: 20px;
}

.verification-line-box.active, .upload-section.active {
    display: block;
    animation: fadeIn 0.5s ease;
}

.verification-line-text {
    font-family: monospace;
    font-size: 1.4rem;
    font-weight: bold;
    color: #fff;
    background: #1a1a1a;
    padding: 15px;
    border-radius: 8px;
    border: 1px dashed #555;
    margin: 10px 0;
}

.upload-box {
    border: 2px dashed #444;
    border-radius: 10px;
    padding: 40px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    background: #0a0a0a;
    margin-bottom: 20px;
}

.upload-box:hover {
    border-color: #ff006e;
    background: #111;
}

.upload-box.has-file {
    border-style: solid;
    border-color: #10b981;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
            
            .verify-btn {
                background: linear-gradient(135deg, #ff006e, #8338ec);
                color: #fff;
                border: none;
                padding: 1rem 2rem;
                border-radius: 10px;
                font-weight: 700;
                cursor: pointer;
                transition: all 0.3s;
                margin-top: 1.5rem;
                width: 100%;
            }
            
            .verify-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 30px rgba(255, 0, 110, 0.3);
            }
            
            .verify-btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }
        </style>
        
 
        
       <div class="verify-page">
    <a href="#founder_dashboard" class="back-to-dash">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
        Back to Dashboard
    </a>
    
    <div class="verify-header">
        <h1 class="verify-title">Founder Verification</h1>
        <p class="verify-subtitle">
            Complete verification to unlock full access to ScaleVest features
        </p>
    </div>
    
    <div class="verify-card">
        <button class="verify-option-btn" onclick="startVideoVerification()">
            <div class="verify-icon">
                <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="#ff006e" stroke-width="2">
                    <polygon points="23 7 16 12 23 17 23 7"></polygon>
                    <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
                </svg>
            </div>
            <div class="verify-option-content">
                <h3>ScaleVest Video Script Verification</h3>
                <p>Record a 30-second video speaking your unique verification line to prove you're a real founder</p>
            </div>
        </button>
    </div>
    
    <div class="verification-steps" id="verificationSteps" style="display: none;">
        <div class="step-item">
            <div class="step-number">1</div>
            
            <div class="verify-step-content">
                <h4>Generate Your Verification Line</h4>
                <p>Click the button below to get your unique verification phrase. This is a one-time generated line that you'll need to speak in your video.</p>
                
                <button class="verify-btn" onclick="generateVerificationLine()" id="generateLineBtn">
                    Generate Verification Line
                </button>
                
                <div class="verification-line-box" id="verificationLineBox">
                    <p style="color: #888; margin-bottom: 1rem;">Your Verification Line:</p>
                    <div class="verification-line-text" id="verificationLineText">
                        </div>
                    <p style="color: #666; font-size: 0.85rem; margin-top: 1rem;">
                        âš ï¸ You must speak this exact line in your video
                    </p>
                </div>
            </div>
        </div>
        
        <div class="step-item">
            <div class="step-number">2</div>
            
            <div class="verify-step-content">
                <h4>Create Your Demo Video</h4>
                <p>Record a 30-second video talking about your startup. <strong>Remember to speak the verification line shown above in your video.</strong></p>
                
                <div class="upload-section" id="uploadSection">
                    <div class="upload-box" id="uploadBox" onclick="document.getElementById('videoUpload').click()">
                        <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2" style="margin-bottom: 1rem;">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        <p style="color: #888; font-size: 1.1rem; margin-bottom: 0.5rem;" id="uploadText">Click to Upload Video</p>
                        <small style="color: #555;">Max 100MB â€¢ MP4, MOV, AVI</small>
                        <input type="file" id="videoUpload" accept="video/*" style="display: none;" onchange="handleVideoUpload(event)">
                    </div>
                    
                    <button class="verify-btn" id="submitVerifyBtn" onclick="submitVideoVerification()" disabled>
                        Submit for Verification
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
    `;
}

window.startVideoVerification = function() {
const stepsSection = document.getElementById('verificationSteps');
    if (stepsSection) {
        // 1. Show the section
        stepsSection.style.display = 'block';
        
        // 2. Add active class for animation (optional CSS)
        // Small timeout ensures the browser registers display:block before adding opacity
        setTimeout(() => {
            stepsSection.classList.add('active');
        }, 10);

        // 3. Scroll to it smoothly
        stepsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    } else {
        console.error("Error: verificationSteps element not found!");
    }
};
// ==========================================
// VERIFICATION LINE GENERATION (Updated for Gemini)
// ==========================================

window.generateVerificationLine = async function() {
    const btn = document.getElementById('generateLineBtn');
    if (!btn) return;
    
    btn.innerHTML = 'Generating...';
    btn.disabled = true;
    
    try {
        // âœ… 1. FIXED URL: Using your specific Vercel domain
        const response = await fetch('https://gemini-sigma-plum.vercel.app/api/videogemini', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'generateLine'
            })
        });
        
        // 2. Read the response
        const result = await response.json();
        console.log("API Response:", result); // Debugging log

        if (!result.success) {
            // This will tell us if the error is from the Vercel side
            throw new Error(result.error || 'Failed to generate line');
        }
        
        const verificationLine = result.verificationLine;
        
        // 3. Save to Firebase
        if (currentUser) {
            await update(ref(db, `founderProfile/${currentUser.uid}`), {
                verificationLine: verificationLine,
                verificationLineCreatedAt: Date.now()
            });
        }
        
        // 4. Update UI
        document.getElementById('verificationLineText').textContent = verificationLine;
        document.getElementById('verificationLineBox').classList.add('active');
        document.getElementById('uploadSection').classList.add('active');
        btn.style.display = 'none';
        
        alert('âœ… Verification line generated! Please speak this line in your video.');
        
    } catch (error) {
        console.error('Error generating line:', error);
        // Show the ACTUAL error message to the user
        alert(`Failed: ${error.message}`); 
        btn.innerHTML = 'Generate Verification Line';
        btn.disabled = false;
    }
};

// ==========================================
// VIDEO UPLOAD & VERIFICATION (Updated for Gemini)
// ==========================================

let uploadedVideoFile = null;

window.handleVideoUpload = function(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Check file size (100MB limit)
    if (file.size > 100 * 1024 * 1024) {
        alert('âŒ Video file must be under 100MB');
        return;
    }
    
    // Check file type
    const validTypes = ['video/mp4', 'video/quicktime', 'video/x-msvideo', 'video/webm'];
    if (!validTypes.includes(file.type)) {
        alert('âŒ Please upload a valid video file (MP4, MOV, AVI, WEBM)');
        return;
    }
    
    uploadedVideoFile = file;
    
    // Update UI
    const uploadBox = document.getElementById('uploadBox');
    const uploadText = document.getElementById('uploadText');
    
    uploadBox.classList.add('has-file');
    uploadText.innerHTML = `âœ“ ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
    
    // Enable submit button
    document.getElementById('submitVerifyBtn').disabled = false;
};

// ==========================================
// VIDEO VERIFICATION PROCESSING (Updated for Gemini)
// ==========================================

window.submitVideoVerification = async function() {
    if (!uploadedVideoFile) {
        alert('âŒ Please upload a video first');
        return;
    }
    
    const btn = document.getElementById('submitVerifyBtn');
    btn.innerHTML = 'Processing...';
    btn.disabled = true;
    
    showVerificationLoader();
    
    try {
        // Step 1: Upload to Firebase Storage
        // This handles large files easily (up to 50MB+)
        updateVerificationLoader('Uploading to secure storage...', 30);
        const videoUrl = await uploadFileToStorage(uploadedVideoFile, 'verification-videos');
        
        // Step 2: Get verification line
        const founderRef = ref(db, `founderProfile/${currentUser.uid}`);
        const snapshot = await get(founderRef);
        const verificationLine = snapshot.val().verificationLine;
        
        // Step 3: Call Vercel API with the URL (NOT the base64 string)
        updateVerificationLoader('AI is analyzing your video...', 60);
        
        const response = await fetch('https://gemini-sigma-plum.vercel.app/api/videogemini', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'verifyVideo',
                data: {
                    videoUrl: videoUrl, // Send URL here
                    expectedLine: verificationLine
                }
            })
        });
        
        const result = await response.json();
        
        if (!result.success) throw new Error(result.error || 'Verification failed');
        
        // Step 4: Handle Result
        if (result.containsVerificationLine && result.matchPercentage >= 80) {
            await update(ref(db, `founderProfile/${currentUser.uid}`), {
                isVerified: true,
                verifiedAt: Date.now(),
                verificationVideoUrl: videoUrl,
                verificationTranscript: result.transcript
            });
            hideVerificationLoader();
            showVerificationSuccess();
        } else {
            hideVerificationLoader();
            showVerificationFailed(verificationLine, result.transcript, result.matchPercentage);
        }
        
    } catch (error) {
        console.error('Verification error:', error);
        hideVerificationLoader();
        alert('âŒ Error: ' + error.message);
        btn.innerHTML = 'Submit for Verification';
        btn.disabled = false;
    }
};
// Helper: Convert file to base64
async function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const video = document.createElement('video');
        const reader = new FileReader();

        reader.onload = (e) => {
            video.src = e.target.result;
            video.onloadedmetadata = () => {
                // If file is already small (< 4MB), don't compress
                if (file.size < 4 * 1024 * 1024) {
                    resolve(e.target.result.split(',')[1]);
                    return;
                }
                
                // If it's large, we alert the user for now 
                // because browser-side video transcoding is complex.
                alert("Video is too large. Please record a shorter video (under 5 seconds) or use lower resolution.");
                reject("File too large");
            };
        };
        reader.readAsDataURL(file);
    });
}

// ==========================================
// VERIFICATION LOADER UI
// ==========================================

function showVerificationLoader() {
    const loader = document.createElement('div');
    loader.id = 'verificationLoader';
    loader.innerHTML = `
        <style>
            .verification-loader-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.95);
                backdrop-filter: blur(15px);
                z-index: 999999;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .verification-loader-box {
                background: #0a0a0a;
                border: 1px solid #333;
                border-radius: 20px;
                padding: 3rem;
                max-width: 500px;
                text-align: center;
            }
            
            .verification-spinner {
                width: 100px;
                height: 100px;
                margin: 0 auto 2rem;
                position: relative;
            }
            
            .spinner-ring {
                width: 100%;
                height: 100%;
                border: 8px solid #1a1a1a;
                border-top: 8px solid #ff006e;
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }
            
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            
            .verification-loader-text {
                font-size: 1.5rem;
                font-weight: 700;
                color: #fff;
                margin-bottom: 1rem;
            }
            
            .verification-loader-subtext {
                color: #888;
                font-size: 1rem;
                margin-bottom: 2rem;
            }
            
            .verification-progress-bar {
                width: 100%;
                height: 8px;
                background: #1a1a1a;
                border-radius: 10px;
                overflow: hidden;
            }
            
            .verification-progress-fill {
                height: 100%;
                background: linear-gradient(90deg, #ff006e, #8338ec);
                width: 0%;
                transition: width 0.5s ease;
            }
            
            .verification-percentage {
                color: #ff006e;
                font-size: 1.2rem;
                font-weight: 700;
                margin-top: 1rem;
            }
        </style>
        
        <div class="verification-loader-overlay">
            <div class="verification-loader-box">
                <div class="verification-spinner">
                    <div class="spinner-ring"></div>
                </div>
                
                <div class="verification-loader-text" id="loaderText">Initializing...</div>
                <div class="verification-loader-subtext" id="loaderSubtext">Please wait while we verify your video</div>
                
                <div class="verification-progress-bar">
                    <div class="verification-progress-fill" id="progressFill"></div>
                </div>
                
                <div class="verification-percentage" id="progressPercent">0%</div>
            </div>
        </div>
    `;
    
    document.body.appendChild(loader);
}

function updateVerificationLoader(text, percentage) {
    const loaderText = document.getElementById('loaderText');
    const progressFill = document.getElementById('progressFill');
    const progressPercent = document.getElementById('progressPercent');
    
    if (loaderText) loaderText.textContent = text;
    if (progressFill) progressFill.style.width = percentage + '%';
    if (progressPercent) progressPercent.textContent = percentage + '%';
}

function hideVerificationLoader() {
    const loader = document.getElementById('verificationLoader');
    if (loader) {
        loader.style.opacity = '0';
        loader.style.transition = 'opacity 0.3s ease';
        setTimeout(() => loader.remove(), 300);
    }
}

// ==========================================
// VERIFICATION SUCCESS SCREEN
// ==========================================

function showVerificationSuccess() {
    const success = document.createElement('div');
    success.id = 'verificationSuccess';
    success.innerHTML = `
        <style>
            .verification-success-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.95);
                backdrop-filter: blur(15px);
                z-index: 999999;
                display: flex;
                align-items: center;
                justify-content: center;
                animation: fadeIn 0.5s ease;
            }
            
            .verification-success-box {
                background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
                border: 2px solid #10b981;
                border-radius: 20px;
                padding: 3rem;
                max-width: 550px;
                text-align: center;
                box-shadow: 0 0 50px rgba(16, 185, 129, 0.3);
                animation: slideUp 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            }
            
            @keyframes slideUp {
                from { transform: translateY(50px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
            
            .success-checkmark {
                width: 120px;
                height: 120px;
                margin: 0 auto 2rem;
                background: rgba(16, 185, 129, 0.15);
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                position: relative;
                animation: scaleIn 0.6s ease;
            }
            
            @keyframes scaleIn {
                0% { transform: scale(0); }
                50% { transform: scale(1.1); }
                100% { transform: scale(1); }
            }
            
            .success-checkmark svg {
                width: 60px;
                height: 60px;
                stroke: #10b981;
                stroke-width: 3;
                animation: drawCheck 0.8s ease 0.3s forwards;
                stroke-dasharray: 100;
                stroke-dashoffset: 100;
            }
            
            @keyframes drawCheck {
                to { stroke-dashoffset: 0; }
            }
            
            .success-title {
                font-size: 2.5rem;
                font-weight: 800;
                color: #fff;
                margin-bottom: 1rem;
                background: linear-gradient(135deg, #10b981, #34d399);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
            }
            
            .success-message {
                color: #aaa;
                font-size: 1.1rem;
                line-height: 1.8;
                margin-bottom: 2rem;
            }
            
            .success-badge {
                display: inline-block;
                background: rgba(16, 185, 129, 0.15);
                border: 1px solid #10b981;
                color: #10b981;
                padding: 0.75rem 1.5rem;
                border-radius: 50px;
                font-weight: 700;
                margin-bottom: 2rem;
                font-size: 0.9rem;
                letter-spacing: 1px;
            }
            
            .success-btn {
                background: linear-gradient(135deg, #10b981, #34d399);
                color: #fff;
                border: none;
                padding: 1rem 2.5rem;
                border-radius: 10px;
                font-weight: 700;
                font-size: 1rem;
                cursor: pointer;
                transition: all 0.3s;
                box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
            }
            
            .success-btn:hover {
                transform: translateY(-3px);
                box-shadow: 0 15px 40px rgba(16, 185, 129, 0.5);
            }
            
            .confetti {
                position: absolute;
                width: 10px;
                height: 10px;
                background: #10b981;
                animation: confettiFall 3s linear infinite;
            }
            
            @keyframes confettiFall {
                0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
                100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
            }
        </style>
        
        <div class="verification-success-overlay">
            ${generateConfetti()}
            
            <div class="verification-success-box">
                <div class="success-checkmark">
                    <svg viewBox="0 0 24 24" fill="none">
                        <path d="M20 6L9 17l-5-5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                
                <h2 class="success-title">Successfully Verified!</h2>
                
                <div class="success-badge">âœ“ FOUNDER VERIFIED</div>
                
                <p class="success-message">
                    Congratulations! Your founder account has been verified. 
                    All your vests have been reactivated and you now have full access to ScaleVest.
                </p>
                
                <button class="success-btn" onclick="closeSuccessAndRedirect()">
                    Go to Dashboard
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(success);
}

function generateConfetti() {
    let confetti = '';
    const colors = ['#10b981', '#34d399', '#6ee7b7', '#a7f3d0'];
    
    for (let i = 0; i < 50; i++) {
        const left = Math.random() * 100;
        const delay = Math.random() * 3;
        const color = colors[Math.floor(Math.random() * colors.length)];
        
        confetti += `<div class="confetti" style="left: ${left}%; animation-delay: ${delay}s; background: ${color};"></div>`;
    }
    
    return confetti;
}

window.closeSuccessAndRedirect = async function() {  
    const success = document.getElementById('verificationSuccess');
    if (success) success.remove();
    
    // Remove verification banner if exists
    const banner = document.getElementById('verificationBanner');
    if (banner) {
        banner.remove();
        document.body.style.paddingTop = '0';
    }
    
    // â­ AUTO-ACTIVATE ALL VESTS
    try {
        const vestsRef = ref(db, `Vests/${currentUser.uid}`);
        const vestsSnap = await get(vestsRef);
        
        if (vestsSnap.exists()) {
            const vests = vestsSnap.val();
            const updates = {};
            let activeCount = 0;
            
            // Set all vests to active
            Object.keys(vests).forEach(vestId => {
                updates[`Vests/${currentUser.uid}/${vestId}/status`] = 'active';
                activeCount++;
            });
            
            // Update active vests count in profile
            updates[`founderProfile/${currentUser.uid}/activeVestsCount`] = activeCount;
            
            // Execute bulk update
            await update(ref(db), updates);
            
            console.log(`âœ… Activated ${activeCount} vests automatically`);
        }
    } catch (error) {
        console.error("Error auto-activating vests:", error);
    }
    
    window.location.hash = 'founder_dashboard';
    window.location.reload();
};

// ==========================================
// VERIFICATION FAILED SCREEN
// ==========================================

function showVerificationFailed(expectedLine, transcript, matchPercentage) {
    const failed = document.createElement('div');
    failed.id = 'verificationFailed';
    failed.innerHTML = `
        <style>
            .verification-failed-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.95);
                backdrop-filter: blur(15px);
                z-index: 999999;
                display: flex;
                align-items: center;
                justify-content: center;
                animation: fadeIn 0.5s ease;
            }
            
            .verification-failed-box {
                background: linear-gradient(135deg, #0a0a0a 0%, #1a0a0a 100%);
                border: 2px solid #ef4444;
                border-radius: 20px;
                padding: 3rem;
                max-width: 600px;
                text-align: center;
                box-shadow: 0 0 50px rgba(239, 68, 68, 0.3);
                animation: shake 0.5s ease;
            }
            
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-10px); }
                75% { transform: translateX(10px); }
            }
            
            .failed-icon {
                width: 120px;
                height: 120px;
                margin: 0 auto 2rem;
                background: rgba(239, 68, 68, 0.15);
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .failed-icon svg {
                width: 60px;
                height: 60px;
                stroke: #ef4444;
                stroke-width: 3;
            }
            
            .failed-title {
                font-size: 2.5rem;
                font-weight: 800;
                color: #ef4444;
                margin-bottom: 1rem;
            }
            
            .failed-message {
                color: #aaa;
                font-size: 1.1rem;
                line-height: 1.8;
                margin-bottom: 2rem;
            }
            
            .failed-details {
                background: #000;
                border: 1px solid #333;
                border-radius: 12px;
                padding: 1.5rem;
                margin-bottom: 2rem;
                text-align: left;
            }
            
            .detail-row {
                margin-bottom: 1rem;
                padding-bottom: 1rem;
                border-bottom: 1px solid #222;
            }
            
            .detail-row:last-child {
                margin-bottom: 0;
                padding-bottom: 0;
                border-bottom: none;
            }
            
            .detail-label {
                color: #666;
                font-size: 0.85rem;
                text-transform: uppercase;
                letter-spacing: 1px;
                margin-bottom: 0.5rem;
            }
            
            .detail-value {
                color: #fff;
                font-family: monospace;
                font-size: 0.95rem;
                line-height: 1.6;
            }
            
            .match-percentage {
                display: inline-block;
                background: rgba(239, 68, 68, 0.15);
                border: 1px solid #ef4444;
                color: #ef4444;
                padding: 0.5rem 1rem;
                border-radius: 20px;
                font-weight: 700;
                font-size: 1.2rem;
            }
            
            .failed-buttons {
                display: flex;
                gap: 1rem;
            }
            
            .failed-btn {
                flex: 1;
                padding: 1rem 2rem;
                border-radius: 10px;
                font-weight: 700;
                font-size: 1rem;
                cursor: pointer;
                transition: all 0.3s;
                border: none;
            }
            
            .btn-retry {
                background: linear-gradient(135deg, #ff006e, #8338ec);
                color: #fff;
            }
            
            .btn-retry:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 30px rgba(255, 0, 110, 0.3);
            }
            
            .btn-cancel-verify {
                background: #222;
                color: #888;
            }
            
            .btn-cancel-verify:hover {
                background: #333;
                color: #fff;
            }
        </style>
        
        <div class="verification-failed-overlay">
            <div class="verification-failed-box">
                <div class="failed-icon">
                    <svg viewBox="0 0 24 24" fill="none">
                        <circle cx="12" cy="12" r="10" stroke-linecap="round"/>
                        <line x1="15" y1="9" x2="9" y2="15" stroke-linecap="round"/>
                        <line x1="9" y1="9" x2="15" y2="15" stroke-linecap="round"/>
                    </svg>
                </div>
                
                <h2 class="failed-title">Verification Failed</h2>
                
                <p class="failed-message">
                    We couldn't detect the verification line in your video. 
                    Please make sure you speak the exact verification phrase clearly.
                </p>
                
                <div class="failed-details">
                    <div class="detail-row">
                        <div class="detail-label">Expected Line</div>
                        <div class="detail-value">${expectedLine}</div>
                    </div>
                    
                    ${transcript ? `
                        <div class="detail-row">
                            <div class="detail-label">What We Heard</div>
                            <div class="detail-value">${transcript || 'No speech detected'}</div>
                        </div>
                    ` : ''}
                    
                    <div class="detail-row">
                        <div class="detail-label">Match Score</div>
                        <div class="match-percentage">${matchPercentage || 0}%</div>
                        <div style="color: #666; font-size: 0.85rem; margin-top: 0.5rem;">
                            (Need 80% or higher to pass)
                        </div>
                    </div>
                </div>
                
                <div class="failed-buttons">
                    <button class="failed-btn btn-cancel-verify" onclick="closeFailedScreen()">
                        Cancel
                    </button>
                    <button class="failed-btn btn-retry" onclick="retryVerification()">
                        Try Again
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(failed);
}

window.closeFailedScreen = function() {
    const failed = document.getElementById('verificationFailed');
    if (failed) failed.remove();
    
    window.location.hash = 'founder_dashboard';
};

window.retryVerification = function() {
    const failed = document.getElementById('verificationFailed');
    if (failed) failed.remove();
    
    // Reset upload
    uploadedVideoFile = null;
    document.getElementById('uploadBox').classList.remove('has-file');
    document.getElementById('uploadText').innerHTML = 'Click to Upload Video';
    document.getElementById('submitVerifyBtn').disabled = true;
    document.getElementById('submitVerifyBtn').innerHTML = 'Submit for Verification';
    
    // Scroll to upload section
    document.getElementById('uploadSection').scrollIntoView({ behavior: 'smooth' });
};
window.handleBrowseAngels = async function() {
    if (!currentUser) {
        window.location.href = 'login2.html';
        return;
    }
    
    // Check verification status
    const founderRef = ref(db, `founderProfile/${currentUser.uid}`);
    const snapshot = await get(founderRef);
    
    if (snapshot.exists()) {
        const data = snapshot.val();
        
        if (data.isVerified === false) {
            showVerificationBlockPopup('browse angel profiles');
            return;
        }
    }
    
    // If verified, allow access
    window.location.href = 'angelbrowse.html';
};

function updateButtonsForEditMode() {
    const vestStatus = sessionStorage.getItem('editVestStatus');
    const isActive = vestStatus === 'active';
    
    // Update all step content buttons
    document.querySelectorAll('.step-content').forEach((stepEl, index) => {
        const stepNum = index + 1;
        const buttonsDiv = stepEl.querySelector('.buttons');
        
        if (!buttonsDiv) return;
        
        // Clear existing buttons
        buttonsDiv.innerHTML = '';
        
        // Add Back button (except step 1)
        if (stepNum > 1) {
            const backBtn = document.createElement('button');
            backBtn.className = 'btn-back';
            backBtn.textContent = 'Previous';
            backBtn.onclick = previousStep;
            buttonsDiv.appendChild(backBtn);
        }
        
        // Add Cancel button
        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'btn-draft';
        cancelBtn.textContent = 'Cancel';
        cancelBtn.onclick = () => {
            if (confirm('Cancel editing? Unsaved changes will be lost.')) {
                isEditMode = false;
                currentEditVestId = null;
                sessionStorage.removeItem('editVestStatus');
                sessionStorage.removeItem('editVestId');
                sessionStorage.removeItem('editVestData');
                window.location.hash = 'manage_vests';
            }
        };
        buttonsDiv.appendChild(cancelBtn);
        
        // Different buttons for last step
        if (stepNum === 6) {
            if (isActive) {
                // Active vest: only Save Changes
                const saveBtn = document.createElement('button');
                saveBtn.className = 'btn-launch';
                saveBtn.textContent = 'Save Changes';
                saveBtn.onclick = saveVestChanges;
                buttonsDiv.appendChild(saveBtn);
            } else {
                // Draft vest: Save as Draft + Launch
                const draftBtn = document.createElement('button');
                draftBtn.className = 'btn-draft';
                draftBtn.textContent = 'Save as Draft';
                draftBtn.onclick = saveVestChanges;
                buttonsDiv.appendChild(draftBtn);
                
                const launchBtn = document.createElement('button');
                launchBtn.className = 'btn-launch';
                launchBtn.textContent = 'Launch Vest';
                launchBtn.onclick = launchEditedVest;
                buttonsDiv.appendChild(launchBtn);
            }
        } else {
            // Middle steps: Save Changes + Next
            const saveBtn = document.createElement('button');
            saveBtn.className = 'btn-draft';
            saveBtn.textContent = 'Save Changes';
            saveBtn.onclick = saveVestChanges;
            buttonsDiv.appendChild(saveBtn);
            
            const nextBtn = document.createElement('button');
            nextBtn.className = 'btn-next';
            nextBtn.textContent = 'Next Step';
            nextBtn.onclick = nextStep;
            buttonsDiv.appendChild(nextBtn);
        }
    });
}

window.saveVestChanges = async function() {
    if (!currentEditVestId) return;
    
    const btn = event.currentTarget;
    const originalText = btn.innerHTML;
    btn.innerHTML = 'Saving...';
    btn.disabled = true;
    
    try {
        // Upload new files if changed
        const { deckUrl, videoUrl, thumbUrl } = await processNewFiles();
        
        // Collect current form data
        const vestData = collectNewVestData(deckUrl, videoUrl, thumbUrl);
        
        // Keep existing URLs if no new files uploaded
        const existingData = JSON.parse(sessionStorage.getItem('editVestData'));
        if (!thumbUrl && existingData.MainVest?.thumbnailUrl) {
            vestData.MainVest.thumbnailUrl = existingData.MainVest.thumbnailUrl;
        }
        if (!deckUrl && existingData.StartupDetails?.pitchDeckUrl) {
            vestData.StartupDetails.pitchDeckUrl = existingData.StartupDetails.pitchDeckUrl;
        }
        if (!videoUrl && existingData.FounderPresence?.demoVideoUrl) {
            vestData.FounderPresence.demoVideoUrl = existingData.FounderPresence.demoVideoUrl;
        }
        
        // Keep the original status
        vestData.status = sessionStorage.getItem('editVestStatus');
        vestData.updatedAt = new Date().toISOString();
        
        // Update in Firebase
        await update(ref(db, `Vests/${currentUser.uid}/${currentEditVestId}`), vestData);
        
        // Update session storage
        sessionStorage.setItem('editVestData', JSON.stringify(vestData));
        
        // â­ CHANGED: Redirect to dashboard instead of showing "Saved"
        alert('âœ… Changes saved successfully!');
        
        // Clear edit mode
        isEditMode = false;
        currentEditVestId = null;
        sessionStorage.removeItem('editVestStatus');
        sessionStorage.removeItem('editVestId');
        sessionStorage.removeItem('editVestData');
        
        // Redirect to dashboard
        window.location.hash = 'founder_dashboard';
        
    } catch (error) {
        console.error("Save error:", error);
        alert("âŒ Failed to save changes");
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
};
window.launchEditedVest = async function() {
    if (!currentEditVestId) return;
    
    const btn = event.currentTarget;
    btn.innerHTML = 'Launching...';
    btn.disabled = true;
    
    try {
        // Save changes first
        const { deckUrl, videoUrl, thumbUrl } = await processNewFiles();
        const vestData = collectNewVestData(deckUrl, videoUrl, thumbUrl);
        
        // Set status to active
        vestData.status = 'active';
        vestData.updatedAt = new Date().toISOString();
        
        // Update in Firebase
        await update(ref(db, `Vests/${currentUser.uid}/${currentEditVestId}`), vestData);
        
        // Update profile active count
        const profileRef = ref(db, `founderProfile/${currentUser.uid}`);
        const snapshot = await get(profileRef);
        let currentCount = 0;
        if (snapshot.exists()) {
            currentCount = parseInt(snapshot.val().activeVestsCount) || 0;
        }
        await update(profileRef, { activeVestsCount: currentCount + 1 });
        
        // Clear edit mode
        isEditMode = false;
        currentEditVestId = null;
        sessionStorage.removeItem('editVestStatus');
        sessionStorage.removeItem('editVestId');
        sessionStorage.removeItem('editVestData');
        
        alert('ðŸš€ Vest launched successfully!');
        window.location.hash = 'manage_vests';
        
    } catch (error) {
        console.error("Launch error:", error);
        alert("âŒ Failed to launch vest");
        btn.innerHTML = 'Launch Vest';
        btn.disabled = false;
    }
};
window.showVestAnalytics = showVestAnalytics;



onAuthStateChanged(auth, async (user) => {
    if (user) {
        currentUser = user;
        setUserPresence(user);
        isInitialLoad = false;
        startNotificationListener();
        startApplicationReplyListener();
        document.getElementById('loadingScreen').classList.remove('hidden');
        
        try {
            const [vestsSnapshot, founderSnapshot, startupSnapshot] = await Promise.all([
                get(ref(db, `Vests/${user.uid}`)),
                get(ref(db, `founderProfile/${user.uid}`)),
                get(ref(db, `startupProfile/${user.uid}`))
            ]);
            
            if (!founderSnapshot.exists()) {
                const email = user.email || 'user@scalevest.com';
                const username = email.split('@')[0];
                const firstLetter = email.charAt(0).toUpperCase();
                
                cachedFounderData = {
                    founderUsername: username,
                    founderImage: firstLetter,
                    email: email,
                    title: '',
                    about: '',
                    createdAt: new Date().toISOString(),
                    isVerified: false 
                };
                
                await update(ref(db, `founderProfile/${user.uid}`), cachedFounderData);
                
                // Show Banner immediately for new user
                showVerificationBanner();

                document.getElementById('loadingScreen').classList.add('hidden');
                showUserIdSetupModal();
                return;
            } else {
                cachedFounderData = founderSnapshot.val();
                
                // â­ 1. Ensure isVerified exists
                if (cachedFounderData.isVerified === undefined) {
                    cachedFounderData.isVerified = false;
                    await update(ref(db, `founderProfile/${user.uid}`), { isVerified: false });
                }
                
                // â­ 2. Handle Verification UI Logic
                if (cachedFounderData.isVerified === false) {
                    // Show the top banner immediately
                    showVerificationBanner();
                    
                    console.log("âš ï¸ Unverified: Blocking popup will trigger in 10 seconds.");
                    setTimeout(() => {
                        checkAndBlockUnverifiedUser(user.uid);
                    }, 1000); 
                } else {
                    // Remove banner if they are already verified
                    const banner = document.getElementById('verificationBanner');
                    if (banner) {
                        banner.remove();
                        document.body.style.paddingTop = '0';
                    }
                }
                
                if (!cachedFounderData.founderUsername) {
                    document.getElementById('loadingScreen').classList.add('hidden');
                    showUsernameSetupModal(); 
                    return;
                }
                
                if (!cachedFounderData.userId) {
                    document.getElementById('loadingScreen').classList.add('hidden');
                    showUserIdSetupModal();
                    return;
                }
            }
            
            if (startupSnapshot.exists()) {
                cachedStartupData = startupSnapshot.val();
            } else {
                cachedStartupData = null;
            }
            
            isNewUser = !vestsSnapshot.exists();
            document.getElementById('loadingScreen').classList.add('hidden');
            
            const hash = window.location.hash.slice(1);
            if (!hash) {
                window.location.hash = isNewUser ? 'vest_step1' : 'founder_dashboard';
            } else {
                handleHashChange();
            }
            
        } catch (error) {
            console.error('Data loading error:', error);
            document.getElementById('loadingScreen').classList.add('hidden');
        }
    } else {
        if (!isInitialLoad) {
            window.location.href = 'login2.html';
        } else {
            setTimeout(() => {
                if (!auth.currentUser) window.location.href = 'login2.html';
            }, 2000);
            isInitialLoad = false;
        }
    }
});
async function globalScheduleChecker() {
    if (!currentUser) return;
    
    try {
        await checkScheduledAvailability();
    } catch (error) {
        console.error("Background check error:", error);
    }
}

// Run check every hour (3600000ms)
setInterval(globalScheduleChecker, 3600000);

// Also run on visibility change (when user returns to tab)
document.addEventListener('visibilitychange', () => {
    if (!document.hidden && currentUser) {
        checkScheduledAvailability();
    }
});
// =========================================================
// 1. GLOBAL VARIABLES & MODAL SYSTEM (FIXED)
// =========================================================

// Global variable to store the logic to run when "Save" is clicked in the generic modal
let currentEditAction = null;

/**
 * Creates and displays the dark-mode edit modal.
 * CRITICAL FIX: The 'if (callback)' check prevents overwriting currentEditAction with null.
 */
function createEditModal(title, val, ph, isArea, callback) {
    // [FIX] Only overwrite the global action if a new callback is actually provided.
    // This allows functions like editUsername to define the action EXTERNALLY before calling this.
    if (callback) {
        currentEditAction = callback;
    }

    // Remove any existing modals to prevent duplicates
    const existing = document.querySelector('.edit-modal');
    if (existing) existing.remove();

    const m = document.createElement('div');
    m.className = 'edit-modal show'; 
    m.innerHTML = `
        <div class="edit-modal-content">
            <div class="edit-modal-header">
                <h3>${title}</h3>
                <button class="modal-close" onclick="closeEditModal()">Ã—</button>
            </div>
            <div class="edit-modal-body">
                ${isArea 
                    ? `<textarea id="editInput" rows="5" placeholder="${ph}">${val}</textarea>` 
                    : `<input type="text" id="editInput" value="${val}" placeholder="${ph}">`}
            </div>
            <div class="edit-modal-footer">
                <button class="modal-btn-cancel" onclick="closeEditModal()">Cancel</button>
                <button class="modal-btn-save" onclick="saveEditModal()">Save</button>
            </div>
        </div>`;
    
    document.body.appendChild(m);
    
    // Focus the input automatically for better UX
    setTimeout(() => {
        const input = document.getElementById('editInput');
        if (input) input.focus();
    }, 100);
}

// Triggered when the user clicks "Save" inside the generic modal
window.saveEditModal = function() {
    const input = document.getElementById('editInput');
    if (!input) return;

    const value = input.value.trim();
    
    if (currentEditAction) {
        currentEditAction(value); // Execute the stored function
    } else {
        console.error("âŒ Critical Error: No save action defined.");
    }
    
    closeEditModal();
};

// Closes the modal
window.closeEditModal = function() {
    const modal = document.querySelector('.edit-modal');
    if (modal) modal.remove();
};


// =========================================================
// 2. PROFILE EDITING FUNCTIONS (Standard)
// =========================================================

window.editUsername = function() {
    // 1. Define the logic FIRST
    currentEditAction = async (newValue) => {
        if (!newValue || newValue === cachedFounderData?.founderUsername) return;
        
        try {
            const firstLetter = newValue.charAt(0).toUpperCase();
            const updates = {
                founderUsername: newValue,
                founderImage: firstLetter
            };
            
            // Update Firebase
            await update(ref(db, `founderProfile/${currentUser.uid}`), updates);
            
            // Update Local Cache
            cachedFounderData = { ...cachedFounderData, ...updates };
            
            alert('âœ… Username updated successfully!');
            showEditProfile(); // Refresh the profile view
        } catch (error) {
            console.error('Error updating username:', error);
            alert('âŒ Failed to update username');
        }
    };
    
    // 2. Open Modal (Callback argument is empty, so logic above is PRESERVED)
    createEditModal('Edit Username', cachedFounderData?.founderUsername || '', 'Enter your username');
};

window.editTitle = function() {
    currentEditAction = async (newValue) => {
        if (newValue === cachedFounderData?.title) return;
        
        try {
            const updates = { title: newValue };
            await update(ref(db, `founderProfile/${currentUser.uid}`), updates);
            cachedFounderData = { ...cachedFounderData, ...updates };
            
            alert('âœ… Title updated successfully!');
            showEditProfile();
        } catch (error) {
            console.error('Error updating title:', error);
            alert('âŒ Failed to update title');
        }
    };
    
    createEditModal('Edit Title', cachedFounderData?.title || '', 'e.g., CEO & Founder');
};

window.editAbout = function() {
    currentEditAction = async (newValue) => {
        if (newValue === cachedFounderData?.about) return;
        
        try {
            const updates = { about: newValue };
            await update(ref(db, `founderProfile/${currentUser.uid}`), updates);
            cachedFounderData = { ...cachedFounderData, ...updates };
            
            alert('âœ… About section updated successfully!');
            showEditProfile();
        } catch (error) {
            console.error('Error updating about:', error);
            alert('âŒ Failed to update about section');
        }
    };
    
    // Pass 'true' for the 4th argument to make it a Textarea
    createEditModal('About Yourself', cachedFounderData?.about || '', 'Tell investors about yourself...', true);
};


// =========================================================
// 3. CO-FOUNDER FUNCTIONS (Custom Modal)
// =========================================================

window.addCoFounder = function() {
    const modal = document.createElement('div');
    modal.className = 'edit-modal';
    modal.innerHTML = `
        <div class="edit-modal-content">
            <div class="edit-modal-header">
                <h3>Add Co-Founder</h3>
                <button class="modal-close" onclick="closeEditModal()">Ã—</button>
            </div>
            <div class="edit-modal-body">
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Co-Founder Name</label>
                    <input type="text" id="cofounderName" placeholder="Enter name" style="width: 100%; padding: 0.75rem; background: #0a0a0a; border: 1px solid #333; border-radius: 8px; color: #fff;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Description (Optional)</label>
                    <textarea id="cofounderDesc" placeholder="e.g., CTO, 10 years in tech..." rows="3" style="width: 100%; padding: 0.75rem; background: #0a0a0a; border: 1px solid #333; border-radius: 8px; color: #fff;"></textarea>
                </div>
            </div>
            <div class="edit-modal-footer">
                <button class="modal-btn-cancel" onclick="closeEditModal()">Cancel</button>
                <button class="modal-btn-save" onclick="saveCoFounder()">Add Co-Founder</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    setTimeout(() => modal.classList.add('show'), 10);
};

window.saveCoFounder = async function() {
    const name = document.getElementById('cofounderName').value.trim();
    const description = document.getElementById('cofounderDesc').value.trim();
    
    if (!name) {
        alert('âŒ Name is required');
        return;
    }
    
    try {
        const coFounders = cachedFounderData?.coFounders || {};
        const newId = `founder_${Object.keys(coFounders).length}`; 
        coFounders[newId] = { name, description };
        
        const updates = { coFounders };
        await update(ref(db, `founderProfile/${currentUser.uid}`), updates);
        cachedFounderData = { ...cachedFounderData, ...updates };
        
        closeEditModal();
        alert('âœ… Co-Founder added successfully!');
        showEditProfile();
    } catch (error) {
        console.error('Error adding co-founder:', error);
        alert('âŒ Failed to add co-founder');
    }
};


// =========================================================
// 4. STARTUP EDIT FUNCTIONS (Custom Modal)
// =========================================================

window.editStartup = function() {
    const modal = document.createElement('div');
    modal.className = 'edit-modal';
    modal.innerHTML = `
        <div class="edit-modal-content">
            <div class="edit-modal-header">
                <h3>Edit Startup Details</h3>
                <button class="modal-close" onclick="closeEditModal()">Ã—</button>
            </div>
            <div class="edit-modal-body">
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Startup Name</label>
                    <input type="text" id="startupNameInput" placeholder="Enter startup name" value="${cachedStartupData?.startupName || ''}" style="width: 100%; padding: 0.75rem; background: #0a0a0a; border: 1px solid #333; border-radius: 8px; color: #fff;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Description</label>
                    <textarea id="startupDescInput" placeholder="Describe your startup..." rows="4" style="width: 100%; padding: 0.75rem; background: #0a0a0a; border: 1px solid #333; border-radius: 8px; color: #fff;">${cachedStartupData?.description || ''}</textarea>
                </div>
            </div>
            <div class="edit-modal-footer">
                <button class="modal-btn-cancel" onclick="closeEditModal()">Cancel</button>
                <button class="modal-btn-save" onclick="saveStartupEdit()">Save Changes</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    setTimeout(() => modal.classList.add('show'), 10);
};

window.saveStartupEdit = async function() {
    const newName = document.getElementById('startupNameInput').value;
    const newDesc = document.getElementById('startupDescInput').value;
    
    if (!newName) {
        alert('âŒ Startup name is required');
        return;
    }
    
    try {
        const updates = {
            startupName: newName,
            description: newDesc
        };
        
        await update(ref(db, `startupProfile/${currentUser.uid}`), updates);
        cachedStartupData = { ...cachedStartupData, ...updates };
        
        closeEditModal();
        alert('âœ… Startup info updated successfully!');
        showEditProfile();
    } catch (error) {
        console.error('Error updating startup:', error);
        alert('âŒ Failed to update startup');
    }
};


// =========================================================
// 5. ASSET UPLOAD FUNCTIONS (Photo & Video)
// =========================================================

window.editProfilePhoto = async function() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    
    input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        if (file.size > 10 * 1024 * 1024) {
            alert('âŒ Image must be under 10MB');
            return;
        }
        
        // Show uploading overlay
        const overlay = document.createElement('div');
        overlay.className = 'upload-overlay';
        overlay.innerHTML = `
            <div class="upload-spinner"></div>
            <div class="upload-text">Uploading Photo...</div>
            <div class="upload-subtext">Please wait while we upload your photo</div>
            <div class="upload-progress-bar">
                <div class="upload-progress-fill" id="uploadProgressFill"></div>
            </div>
        `;
        document.body.appendChild(overlay);
        
        // Simulate progress animation
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += Math.random() * 15;
            if (progress > 90) progress = 90;
            document.getElementById('uploadProgressFill').style.width = progress + '%';
        }, 200);
        
        try {
            const photoURL = await uploadFileToStorage(file, 'profile-photos');
            
            clearInterval(progressInterval);
            document.getElementById('uploadProgressFill').style.width = '100%';
            
            const updates = { photoURL };
            await update(ref(db, `founderProfile/${currentUser.uid}`), updates);
            cachedFounderData = { ...cachedFounderData, ...updates };
            
            // Show success animation
            overlay.innerHTML = `
                <svg width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2" style="margin-bottom: 1rem;">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="16 8 10 14 8 12"></polyline>
                </svg>
                <div class="upload-text" style="color: #10b981;">Photo Uploaded!</div>
                <div class="upload-subtext">Refreshing your profile...</div>
            `;
            
            setTimeout(() => {
                overlay.remove();
                showEditProfile();
            }, 1500);
            
        } catch (error) {
            clearInterval(progressInterval);
            console.error('Error uploading photo:', error);
            
            overlay.innerHTML = `
                <svg width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="#ff006e" stroke-width="2" style="margin-bottom: 1rem;">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="15" y1="9" x2="9" y2="15"></line>
                    <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
                <div class="upload-text" style="color: #ff006e;">Upload Failed</div>
                <div class="upload-subtext">Please try again</div>
            `;
            
            setTimeout(() => overlay.remove(), 2000);
        }
    };
    
    input.click();
};

window.uploadVideo = async function() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'video/*';
    
    input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        if (file.size > 50 * 1024 * 1024) {
            alert('âŒ Video must be under 50MB');
            return;
        }
        
        const overlay = document.createElement('div');
        overlay.className = 'upload-overlay';
        overlay.innerHTML = `
            <div class="upload-spinner"></div>
            <div class="upload-text">Uploading Video...</div>
            <div class="upload-subtext">This may take a minute for larger files</div>
            <div class="upload-progress-bar">
                <div class="upload-progress-fill" id="uploadProgressFill"></div>
            </div>
        `;
        document.body.appendChild(overlay);
        
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += Math.random() * 10;
            if (progress > 90) progress = 90;
            document.getElementById('uploadProgressFill').style.width = progress + '%';
        }, 300);
        
        try {
            const videoUrl = await uploadFileToStorage(file, 'intro-videos');
            
            clearInterval(progressInterval);
            document.getElementById('uploadProgressFill').style.width = '100%';
            
            const updates = { introVideo: videoUrl };
            await update(ref(db, `founderProfile/${currentUser.uid}`), updates);
            cachedFounderData = { ...cachedFounderData, ...updates };
            
            overlay.innerHTML = `
                <svg width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2" style="margin-bottom: 1rem;">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="16 8 10 14 8 12"></polyline>
                </svg>
                <div class="upload-text" style="color: #10b981;">Video Uploaded!</div>
                <div class="upload-subtext">Refreshing your profile...</div>
            `;
            
            setTimeout(() => {
                overlay.remove();
                showEditProfile();
            }, 1500);
            
        } catch (error) {
            clearInterval(progressInterval);
            console.error('Error uploading video:', error);
            
            overlay.innerHTML = `
                <svg width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="#ff006e" stroke-width="2" style="margin-bottom: 1rem;">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="15" y1="9" x2="9" y2="15"></line>
                    <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
                <div class="upload-text" style="color: #ff006e;">Upload Failed</div>
                <div class="upload-subtext">Please try again</div>
            `;
            
            setTimeout(() => overlay.remove(), 2000);
        }
    };
    
    input.click();
};


// =========================================================
// 6. LOCATION & LANGUAGE FUNCTIONS
// =========================================================

window.editLocation = function() {
    const currentLocation = cachedStartupData?.location || { country: '', state: '', city: '' };
    
    const modal = document.createElement('div');
    modal.className = 'edit-modal';
    modal.innerHTML = `
        <div class="edit-modal-content">
            <div class="edit-modal-header">
                <h3>Edit Location</h3>
                <button class="modal-close" onclick="closeEditModal()">Ã—</button>
            </div>
            <div class="edit-modal-body">
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Country</label>
                    <input type="text" id="locationCountry" placeholder="e.g., United States" value="${currentLocation.country}" style="width: 100%; padding: 0.75rem; background: #0a0a0a; border: 1px solid #333; border-radius: 8px; color: #fff;">
                </div>
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">State/Province</label>
                    <input type="text" id="locationState" placeholder="e.g., California" value="${currentLocation.state}" style="width: 100%; padding: 0.75rem; background: #0a0a0a; border: 1px solid #333; border-radius: 8px; color: #fff;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">City</label>
                    <input type="text" id="locationCity" placeholder="e.g., San Francisco" value="${currentLocation.city}" style="width: 100%; padding: 0.75rem; background: #0a0a0a; border: 1px solid #333; border-radius: 8px; color: #fff;">
                </div>
            </div>
            <div class="edit-modal-footer">
                <button class="modal-btn-cancel" onclick="closeEditModal()">Cancel</button>
                <button class="modal-btn-save" onclick="saveLocation()">Save Location</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    setTimeout(() => modal.classList.add('show'), 10);
};

window.saveLocation = async function() {
    const country = document.getElementById('locationCountry').value.trim();
    const state = document.getElementById('locationState').value.trim();
    const city = document.getElementById('locationCity').value.trim();
    
    try {
        const updates = {
            location: { country, state, city }
        };
        
        await update(ref(db, `startupProfile/${currentUser.uid}`), updates);
        cachedStartupData = { ...cachedStartupData, ...updates };
        
        closeEditModal();
        alert('âœ… Location updated!');
        showEditProfile();
    } catch (error) {
        console.error('Error updating location:', error);
        alert('âŒ Failed to update location');
    }
};

window.addLanguage = function() {
    const modal = document.createElement('div');
    modal.className = 'edit-modal';
    modal.innerHTML = `
        <div class="edit-modal-content">
            <div class="edit-modal-header">
                <h3>Add Language</h3>
                <button class="modal-close" onclick="closeEditModal()">Ã—</button>
            </div>
            <div class="edit-modal-body">
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Language</label>
                    <input type="text" id="languageName" placeholder="e.g., English, Spanish, Hindi" style="width: 100%; padding: 0.75rem; background: #0a0a0a; border: 1px solid #333; border-radius: 8px; color: #fff;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Proficiency Level</label>
                    <select id="languageLevel" style="width: 100%; padding: 0.75rem; background: #0a0a0a; border: 1px solid #333; border-radius: 8px; color: #fff;">
                        <option value="Beginner">Beginner</option>
                        <option value="Intermediate">Intermediate</option>
                        <option value="Fluent">Fluent</option>
                        <option value="Expert">Expert</option>
                    </select>
                </div>
            </div>
            <div class="edit-modal-footer">
                <button class="modal-btn-cancel" onclick="closeEditModal()">Cancel</button>
                <button class="modal-btn-save" onclick="saveLanguage()">Add Language</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    setTimeout(() => modal.classList.add('show'), 10);
};

window.saveLanguage = async function() {
    const name = document.getElementById('languageName').value.trim();
    const level = document.getElementById('languageLevel').value;
    
    if (!name) {
        alert('âŒ Language name is required');
        return;
    }
    
    try {
        const languages = cachedFounderData?.languages || [];
        
        if (languages.some(lang => lang.name.toLowerCase() === name.toLowerCase())) {
            alert('âŒ Language already added');
            return;
        }
        
        languages.push({ name, level });
        
        const updates = { languages };
        await update(ref(db, `founderProfile/${currentUser.uid}`), updates);
        cachedFounderData = { ...cachedFounderData, ...updates };
        
        closeEditModal();
        alert('âœ… Language added!');
        showEditProfile();
    } catch (error) {
        console.error('Error adding language:', error);
        alert('âŒ Failed to add language');
    }
};

window.removeLanguage = async function(languageName) {
    if (!confirm(`Remove ${languageName}?`)) return;
    
    try {
        const languages = cachedFounderData?.languages?.filter(lang => lang.name !== languageName) || [];
        
        const updates = { languages };
        await update(ref(db, `founderProfile/${currentUser.uid}`), updates);
        cachedFounderData = { ...cachedFounderData, ...updates };
        
        alert('âœ… Language removed!');
        showEditProfile();
    } catch (error) {
        console.error('Error removing language:', error);
        alert('âŒ Failed to remove language');
    }
};


// =========================================================
// 7. EDUCATION & WORK EXPERIENCE
// =========================================================

window.addEducation = function() {
    const modal = document.createElement('div');
    modal.className = 'edit-modal';
    modal.innerHTML = `
        <div class="edit-modal-content">
            <div class="edit-modal-header">
                <h3>Add Education</h3>
                <button class="modal-close" onclick="closeEditModal()">Ã—</button>
            </div>
            <div class="edit-modal-body">
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">School/University</label>
                    <input type="text" id="eduSchool" placeholder="e.g., Stanford University" style="width: 100%; padding: 0.75rem; background: #0a0a0a; border: 1px solid #333; border-radius: 8px; color: #fff;">
                </div>
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Degree/Course</label>
                    <input type="text" id="eduDegree" placeholder="e.g., B.Tech Computer Science" style="width: 100%; padding: 0.75rem; background: #0a0a0a; border: 1px solid #333; border-radius: 8px; color: #fff;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Year</label>
                    <input type="text" id="eduYear" placeholder="e.g., 2018-2022" style="width: 100%; padding: 0.75rem; background: #0a0a0a; border: 1px solid #333; border-radius: 8px; color: #fff;">
                </div>
            </div>
            <div class="edit-modal-footer">
                <button class="modal-btn-cancel" onclick="closeEditModal()">Cancel</button>
                <button class="modal-btn-save" onclick="saveEducation()">Add Education</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    setTimeout(() => modal.classList.add('show'), 10);
};

window.saveEducation = async function() {
    const school = document.getElementById('eduSchool').value.trim();
    const degree = document.getElementById('eduDegree').value.trim();
    const year = document.getElementById('eduYear').value.trim();
    
    if (!school || !degree) {
        alert('âŒ School and degree are required');
        return;
    }
    
    try {
        const education = cachedFounderData?.education || [];
        education.push({ school, degree, year });
        
        const updates = { education };
        await update(ref(db, `founderProfile/${currentUser.uid}`), updates);
        cachedFounderData = { ...cachedFounderData, ...updates };
        
        closeEditModal();
        alert('âœ… Education added successfully!');
        showEditProfile();
    } catch (error) {
        console.error('Error adding education:', error);
        alert('âŒ Failed to add education');
    }
};

window.addWorkExperience = function() {
    const modal = document.createElement('div');
    modal.className = 'edit-modal';
    modal.innerHTML = `
        <div class="edit-modal-content">
            <div class="edit-modal-header">
                <h3>Add Work Experience</h3>
                <button class="modal-close" onclick="closeEditModal()">Ã—</button>
            </div>
            <div class="edit-modal-body">
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Company Name</label>
                    <input type="text" id="workCompany" placeholder="e.g., Google" style="width: 100%; padding: 0.75rem; background: #0a0a0a; border: 1px solid #333; border-radius: 8px; color: #fff;">
                </div>
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Position/Role</label>
                    <input type="text" id="workPosition" placeholder="e.g., Software Engineer" style="width: 100%; padding: 0.75rem; background: #0a0a0a; border: 1px solid #333; border-radius: 8px; color: #fff;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Duration</label>
                    <input type="text" id="workDuration" placeholder="e.g., 2020-2023" style="width: 100%; padding: 0.75rem; background: #0a0a0a; border: 1px solid #333; border-radius: 8px; color: #fff;">
                </div>
            </div>
            <div class="edit-modal-footer">
                <button class="modal-btn-cancel" onclick="closeEditModal()">Cancel</button>
                <button class="modal-btn-save" onclick="saveWorkExperience()">Add Experience</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    setTimeout(() => modal.classList.add('show'), 10);
};

window.saveWorkExperience = async function() {
    const company = document.getElementById('workCompany').value.trim();
    const position = document.getElementById('workPosition').value.trim();
    const duration = document.getElementById('workDuration').value.trim();
    
    if (!company || !position) {
        alert('âŒ Company and position are required');
        return;
    }
    
    try {
        const workExperience = cachedFounderData?.workExperience || [];
        workExperience.push({ company, position, duration });
        
        const updates = { workExperience };
        await update(ref(db, `founderProfile/${currentUser.uid}`), updates);
        cachedFounderData = { ...cachedFounderData, ...updates };
        
        closeEditModal();
        alert('âœ… Work experience added successfully!');
        showEditProfile();
    } catch (error) {
        console.error('Error adding work experience:', error);
        alert('âŒ Failed to add work experience');
    }
};


   // ========================================
    // SECTION 2: PLACE HASH CHANGE HANDLER HERE
    // ========================================
    
    // Handle hash navigation
    window.addEventListener('hashchange', handleHashChange);

    // ==========================================
// 1. ROUTING GATEKEEPER (Strict Custom Check)
// ==========================================
 async function handleHashChange() {
    // 1. DATA CHECK
    if (!currentUser || !cachedFounderData) {
        console.log("Waiting for data...");
        // If we have no data, show the loading screen instead of a blank page
        document.getElementById('loadingScreen').classList.remove('hidden');
        return;
    }

    const currentId = cachedFounderData.userId;
    const firebaseUid = currentUser.uid;

    // 2. GATEKEEPER: Ensure User has a Custom ID
    // Added check: Only show modal if we aren't already looking at it
    if (!currentId || currentId === firebaseUid) {
        console.log("Redirecting to ID setup...");
        if (!document.querySelector('.userid-modal')) {
            showUserIdSetupModal(); 
        }
        return; 
    }

    // 3. UI RESET & PREP
    const hash = window.location.hash.slice(1);
    const container = document.getElementById('dashboardContainer');
    const vestStepContainer = document.querySelector('.vest-container');

    // Ensure main loader is hidden once we pass the gatekeeper
    document.getElementById('loadingScreen').classList.add('hidden');

    // 4. ROUTING LOGIC
 if (hash.startsWith('vest_edit_step')) {
        // EDIT MODE
        if (container) container.style.display = 'none';
        if (vestStepContainer) {
            vestStepContainer.style.display = 'block';
            const stepNum = parseInt(hash.replace('vest_edit_step', '')) || 1;
            currentStep = stepNum;
            updateStepDisplay();
            
            // Update buttons for edit mode
            updateButtonsForEditMode();
        }
    } else if (hash.startsWith('vest_step')) {
        // CREATE MODE (existing logic)
        if (container) container.style.display = 'none';
        if (vestStepContainer) {
            vestStepContainer.style.display = 'block';
            const stepNum = parseInt(hash.replace('vest_step', '')) || 1;
            currentStep = stepNum;
            updateStepDisplay();
            
            // Reset edit mode
            isEditMode = false;
            currentEditVestId = null;
        }
    } else {
        // --- DYNAMIC DASHBOARD VIEWS ---
        if (vestStepContainer) vestStepContainer.style.display = 'none';
        if (container) {
            container.style.display = 'block';
            // Only clear if the view is actually changing to prevent flickering
            container.innerHTML = '<div class="spinner-container" style="text-align:center; padding:50px;"><div class="spinner"></div></div>';
        }

        // Apply page-specific backgrounds and render functions
        if (hash === 'founder_dashboard' || hash === '') {
            document.body.style.background = "linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%)";
            showDashboard();
        } 
        else if (hash === 'applications') {
        const canAccess = await checkVerificationForApplications();
    if (!canAccess) return; 
            document.body.style.background = "#000";
            window.showApplicationsList(); 
        } 
        else if (hash === 'scalevest_verify') {
    document.body.style.background = "#000";
    showVerificationPage();
}
        else if (hash.startsWith('view_application_')) {
            const appId = hash.replace('view_application_', '');
            document.body.style.background = "#f4f4f4"; // Document feel
            window.renderFullApplicationPage(appId);
        }
        else if (hash === 'application_replies') {
    document.body.style.background = "#000";
    showApplicationReplies();
}
else if (hash === 'analytics') {
    document.body.style.background = "#000";
    showAnalytics();
}
else if (hash.startsWith('vest_analytics_')) {
    const vestId = hash.replace('vest_analytics_', '');
    document.body.style.background = "#000";
    showVestAnalytics(vestId);
}
        else if (hash === 'edit_founderprofile') {
            document.body.style.background = "#000";
            showEditProfile();
        } 
        else if (hash === 'investor_chatlist') {
            document.body.style.background = "#000";
          
            if (typeof window.showInvestorChatList === 'function') {
                window.showInvestorChatList(); 
            } else {
                console.error("Error: showInvestorChatList function not loaded yet.");
                container.innerHTML = `<p style="text-align:center; padding:2rem; color:red;">Error: Chat module not loaded. Please refresh.</p>`;
            }
        }
else if (hash === 'ScaleVEST_Refers') {
    document.body.style.background = "#000";
    showReferralsPage();
}
        else if (hash === 'founder_emergence') {
            document.body.style.background = "#000";
            showFounderEmergence();
        } 
        else if (hash === 'manage_vests') {
            document.body.style.background = "#000";
            showManageVests();
        } 
        else if (hash === 'edit_startup') {
            document.body.style.background = "#000";
            showEditStartup();
        } 
        else {
            // Default Fallback
            window.location.hash = 'founder_dashboard';
        }
    }
}
// ==========================================
// VERIFICATION SYSTEM
// ==========================================

// Check and block unverified users after 1 minute
async function checkAndBlockUnverifiedUser(uid) {
    const founderRef = ref(db, `founderProfile/${uid}`);
    const snapshot = await get(founderRef);
    
    if (snapshot.exists()) {
        const data = snapshot.val();
        
        // If still not verified after 1 minute
        if (data.isVerified === false) {
            // Block all vests
            const vestsRef = ref(db, `Vests/${uid}`);
            const vestsSnap = await get(vestsRef);
            
            if (vestsSnap.exists()) {
                const vests = vestsSnap.val();
                const updates = {};
                
                Object.keys(vests).forEach(vestId => {
                    updates[`Vests/${uid}/${vestId}/status`] = 'inactive';
                });
                
                await update(ref(db), updates);
            }
            
            // Show mega alert
            showVerificationAlert();
        }
    }
}

function showVerificationAlert() {
    const alert = document.createElement('div');
    alert.id = 'verificationMegaAlert';
    alert.innerHTML = `
        <style>
            .verification-mega-alert {
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.95);
                backdrop-filter: blur(10px);
                z-index: 999999;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .verification-alert-box {
                background: #0a0a0a;
                border: 2px solid #ef4444; /* â­ RED BORDER */
                border-radius: 20px;
                padding: 3rem;
                max-width: 500px;
                text-align: center;
                box-shadow: 0 0 50px rgba(239, 68, 68, 0.5); /* â­ RED GLOW */
            }
            
            .verification-alert-icon {
                width: 80px;
                height: 80px;
                margin: 0 auto 2rem;
                background: rgba(239, 68, 68, 0.15); /* â­ RED BACKGROUND */
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .verification-alert-title {
                font-size: 2rem;
                font-weight: 800;
                color: #ef4444; /* â­ RED TITLE */
                margin-bottom: 1rem;
            }
            
            .verification-alert-text {
                color: #aaa;
                line-height: 1.8;
                margin-bottom: 2rem;
            }
            
            .verification-alert-buttons {
                display: flex;
                gap: 1rem;
            }
            
            .verification-btn {
                flex: 1;
                padding: 1rem 2rem;
                border-radius: 10px;
                font-weight: 700;
                cursor: pointer;
                transition: all 0.3s;
                border: none;
            }
            
            .btn-verify-now {
                background: linear-gradient(135deg, #ef4444, #dc2626); /* â­ RED GRADIENT */
                color: #fff;
            }
            
            .btn-verify-now:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 30px rgba(239, 68, 68, 0.4); /* â­ RED SHADOW */
            }
            
            .btn-cancel {
                background: #222;
                color: #888;
            }
            
            .btn-cancel:hover {
                background: #333;
            }
        </style>
        
        <div class="verification-mega-alert">
            <div class="verification-alert-box">
                <div class="verification-alert-icon">
                    <svg width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                        <line x1="12" y1="9" x2="12" y2="13"></line>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                </div>
                
                <h2 class="verification-alert-title">All Vests Blocked!</h2>
                
                <p class="verification-alert-text">
                    Your vests have been deactivated because you haven't verified your founder account yet. 
                    Please complete verification to continue using ScaleVest.
                </p>
                
                <div class="verification-alert-buttons">
                    <button class="verification-btn btn-cancel" onclick="dismissVerificationAlert()">Cancel</button>
                    <button class="verification-btn btn-verify-now" onclick="startVerification()">Verify Now</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(alert);
}
window.dismissVerificationAlert = function() {
    const alert = document.getElementById('verificationMegaAlert');
    if (alert) alert.remove();
    
    // Show banner instead
    showVerificationBanner();
};

function showVerificationBanner() {
    const existing = document.getElementById('verificationBanner');
    if (existing) existing.remove();

    const banner = document.createElement('div');
    banner.id = 'verificationBanner';
    banner.innerHTML = `
    <style>
        .verification-banner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: #ef4444;
            z-index: 10000;
            padding: 18px 32px;           /* âœ… MUCH WIDER */
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-family: Inter, system-ui, sans-serif;
            box-shadow: 0 6px 18px rgba(0,0,0,0.25);
        }

        .verify-left {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .verify-icon {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.18);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .verify-text {
            color: #000;                 /* âœ… BLACK TEXT */
            font-size: 1rem;
            font-weight: 700;
            line-height: 1.2;
        }

        .verify-text span {
            display: block;
            margin-top: 4px;
            font-size: 0.85rem;
            font-weight: 500;
            color: #111;                 /* âœ… BLACK / DARK */
            opacity: 0.9;
        }

        /* âœ… FORCE SMALL BUTTON (NO STRETCH) */
        .banner-verify-btn {
            background: #ffffff;
            color: #ef4444;
            border: none;
            height: 34px;
            padding: 0 14px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex: 0 0 auto;              /* ðŸ”¥ KEY FIX */
            width: auto;                 /* ðŸ”¥ KEY FIX */
            white-space: nowrap;
        }

        .banner-verify-btn:hover {
            background: #fee2e2;
        }

        @media (max-width: 640px) {
            .verify-text span {
                display: none;
            }
        }
    </style>

    <div class="verification-banner">
        <div class="verify-left">
            <div class="verify-icon">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                    <line x1="12" y1="9" x2="12" y2="13"></line>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
            </div>

            <div class="verify-text">
                Account not verified
                <span>Verification required to continue using ScaleVest</span>
            </div>
        </div>

        <button class="banner-verify-btn" onclick="startVerification()">Verify</button>
    </div>
    `;

    document.body.prepend(banner);
    document.body.style.paddingTop = '72px';   /* âœ… matches height */
}

// Block unverified users from browsing vests
window.checkVerificationForBrowse = async function() {
    if (!currentUser) return false;
    
    const founderRef = ref(db, `founderProfile/${currentUser.uid}`);
    const snapshot = await get(founderRef);
    
    if (snapshot.exists()) {
        const data = snapshot.val();
        
        if (data.isVerified === false) {
            showVerificationBlockPopup('explore vests');
            return false;
        }
    }
    
    return true;
};

window.checkVerificationForApplications = async function() {
    if (!currentUser) return false;
    
    const founderRef = ref(db, `founderProfile/${currentUser.uid}`);
    const snapshot = await get(founderRef);
    
    if (snapshot.exists()) {
        const data = snapshot.val();
        
        if (data.isVerified === false) {
            showVerificationBlockPopup('create funding applications');
            return false;
        }
    }
    
    return true;
};

function showVerificationBlockPopup(feature) {
    const popup = document.createElement('div');
    popup.id = 'verifyBlockModal';
    popup.className = 'verify-modal-overlay';
    popup.innerHTML = `
        <div class="verify-modal-container">
            <button class="verify-modal-close" onclick="handleCancelVerification(this)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
            
            <div class="verify-modal-content">
                <div class="verify-icon-wrapper">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="url(#gradient)" stroke-width="2">
                        <defs>
                            <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" stop-color="#ff006e" />
                                <stop offset="100%" stop-color="#8338ec" />
                            </linearGradient>
                        </defs>
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                        <path d="M9 12l2 2 4-4"></path>
                    </svg>
                </div>
                
                <h3>Verification Required</h3>
                <p>To <strong>${feature}</strong>, we need to confirm you're a real founder. This keeps ScaleVest secure for everyone.</p>
                
                <div class="verify-modal-actions">
                    <button class="btn-secondary" onclick="handleCancelVerification(this)">Maybe Later</button>
                    <button class="btn-primary" onclick="this.closest('.verify-modal-overlay').remove(); startVerification();">Verify Now</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(popup);
}

// âœ… Added: Navigation Handler
window.handleCancelVerification = function(element) {
    element.closest('.verify-modal-overlay').remove();
    // Redirects user back to the founder dashboard hash
    window.location.hash = 'founder_dashboard';
};
// ==========================================
// 2. SAVE CUSTOM ID
// ==========================================
window.saveCustomUserId = async function() {
    const input = document.getElementById('customUserIdInput');
    const saveBtn = document.querySelector('.modal-btn-save');
    const rawId = input.value.trim();
    
    // VALIDATION
    if (!rawId) return alert("âŒ Please type a User ID.");
    if (rawId.length < 4) return alert("âŒ Too short (min 4 chars).");
    if (/\s/.test(rawId)) return alert("âŒ No spaces allowed.");
    
    // Prevent them from saving the Firebase UID again
    if (rawId === currentUser.uid) {
        return alert("âŒ You cannot use your system ID. Please choose a custom name.");
    }

    saveBtn.innerHTML = "Saving...";
    saveBtn.disabled = true;

    try {
        const updates = {};
        // Save the NEW custom ID
        updates[`founderProfile/${currentUser.uid}/userId`] = rawId;
        
        // Sync username if missing
        if (!cachedFounderData.founderUsername || cachedFounderData.founderUsername === currentUser.uid) {
            updates[`founderProfile/${currentUser.uid}/founderUsername`] = rawId;
        }

        await update(ref(db), updates);

        // CRITICAL: Update local cache so the Gatekeeper lets us in immediately
        cachedFounderData.userId = rawId;
        if (updates[`founderProfile/${currentUser.uid}/founderUsername`]) {
            cachedFounderData.founderUsername = rawId;
        }

        // Close and Refresh
        document.querySelector('.userid-modal').remove();
        handleHashChange(); // Retry navigation

    } catch (error) {
        console.error("Error:", error);
        alert("Save failed. Check connection.");
        saveBtn.innerHTML = "Set ID";
        saveBtn.disabled = false;
    }
};

    function showVestForm() {
        document.title = "Create Your Vest | ScaleVest"; 
        document.querySelector('.vest-container').style.display = 'block';
        const dashContainer = document.getElementById('dashboardContainer');
        if (dashContainer) {
            dashContainer.style.display = 'none';
        }
    }

    function showDashboard() {
        document.title = "Founder Dashboard | ScaleVest";
        document.querySelector('.vest-container').style.display = 'none';
        
        let container = document.getElementById('dashboardContainer');
        if (!container) {
            container = document.createElement('div');
            container.id = 'dashboardContainer';
            document.body.appendChild(container);
        }
        
        container.style.display = 'block';
        createDashboard();
        checkScheduledAvailability();
    }

    // ========================================
    // SECTION 3: ADD NEW STARTUP PROFILE SAVE FUNCTION HERE
    // ========================================
    
async function saveStartupProfile(vestData) {
    if (!currentUser) return;
    
    const startupProfileRef = ref(db, `startupProfile/${currentUser.uid}`);
    
    // Check if startupProfile already exists
    const existingProfile = await get(startupProfileRef);
    
    const startupData = {
        startupName: vestData.startupName,
        logo: vestData.startupLogoUrl,
        description: vestData.startupDescription,
        stage: vestData.startupStage,
        category: vestData.category,
        founderId: currentUser.uid,
        updatedAt: new Date().toISOString()
    };
    
    // Only generate startupId if it doesn't exist (PERMANENT)
    if (!existingProfile.exists() || !existingProfile.val()?.startupId) {
        startupData.startupId = generateStartupId();
        startupData.createdAt = new Date().toISOString();
    }
    
    await update(startupProfileRef, startupData); 
    
    return startupData;
}
    // ========================================
    // SECTION 4: UPDATE createDashboard FUNCTION
    // ========================================
    
async function createDashboard() {
    if (!currentUser) return;

    // =========================================================
    // 1. FETCH ALL DATA FIRST (Blocking Operations)
    // =========================================================
    
    // Use cached data if available, otherwise fetch
    let founderData = cachedFounderData;
    let startupData = cachedStartupData;
    let vestsData = {};
    
    // Fetch Founder Profile
    if (!founderData) {
        const founderProfileRef = ref(db, `founderProfile/${currentUser.uid}`);
        const founderSnap = await get(founderProfileRef);
        founderData = founderSnap.val();
        cachedFounderData = founderData;
    }
    
    // Handle Profile Format
    if (founderData && !founderData.founderUsername) {
        founderData.founderUsername = founderData.firstName 
            ? `${founderData.firstName} ${founderData.lastName || ''}`.trim()
            : (founderData.email || 'User').split('@')[0];
        
        founderData.founderImage = founderData.firstName 
            ? founderData.firstName.charAt(0).toUpperCase()
            : (founderData.email || 'U').charAt(0).toUpperCase();
    }
    
    // Fetch Startup Profile
    if (!startupData) {
        const startupProfileRef = ref(db, `startupProfile/${currentUser.uid}`);
        const startupSnap = await get(startupProfileRef);
        if (startupSnap.exists()) {
            startupData = startupSnap.val();
            cachedStartupData = startupData;
        }
    }
    
    // Fetch Vests
    const vestsRef = ref(db, `Vests/${currentUser.uid}`);
    const vestsSnap = await get(vestsRef);
    if (vestsSnap.exists()) {
        vestsData = vestsSnap.val();
    }    
    console.log('Dashboard loaded with:', { founderData, startupData, vestsData });
    
    const draftCount = Object.values(vestsData).filter(v => v.status === 'draft').length;
    const activeCount = Object.values(vestsData).filter(v => v.status === 'live').length;
  const appRef = ref(db, `Applications/${currentUser.uid}`);
onValue(appRef, (snapshot) => {
    if (!snapshot.exists()) return;
    
    const apps = snapshot.val();
    let totalUnread = 0;
    
    // Count unread replies
    Object.values(apps).forEach(app => {
        if (app.replies) {
            Object.values(app.replies).forEach(reply => {
                if (!reply.read) totalUnread++;
            });
        }
    });
    
    // Update badge
    const badge = document.getElementById('replyNotifBadge');
    const countEl = document.getElementById('replyCount');
    
    if (badge && countEl) {
        if (totalUnread > 0) {
            badge.style.display = 'block';
            countEl.textContent = `+${totalUnread}`;
        } else {
            badge.style.display = 'none';
        }
    }
});
    
    const dashboardHTML = `
       <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000;
            color: #fff;
            min-height: 100vh;
        }

        /* Top Navigation */
        .top-nav {
            background: #0a0a0a;
            padding: 1.2rem 3rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #222;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .logo {
            font-size: 2rem;
            font-weight: 700;
            color: #fff;
            cursor: pointer;
            letter-spacing: 1px;
            transition: all 0.3s;
        }

        .logo:hover {
            transform: scale(1.05);
        }
.reply-notif-badge {
    position: absolute;
    top: 15px;
    right: 15px;
    background: linear-gradient(135deg, #ff006e, #ff4d94);
    color: #fff;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    box-shadow: 0 4px 15px rgba(255, 0, 110, 0.4);
    animation: pulseBadge 2s infinite;
    z-index: 10;
}

@keyframes pulseBadge {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

.reply-item {
    background: #111;
    border: 1px solid #222;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    transition: all 0.3s;
    position: relative;
}

.reply-item:hover {
    border-color: #444;
    transform: translateY(-2px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.reply-item.unread {
    border-left: 4px solid #ff006e;
    background: rgba(255, 0, 110, 0.05);
}

.reply-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #222;
}

.reply-app-name {
    font-size: 1.1rem;
    font-weight: 700;
    color: #fff;
}

.reply-timestamp {
    color: #666;
    font-size: 0.85rem;
}

.reply-content {
    color: #aaa;
    line-height: 1.6;
    margin-bottom: 1rem;
}

.reply-footer {
    display: flex;
    gap: 10px;
}

.btn-view-app, .btn-mark-read {
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    border: none;
}

.btn-view-app {
    background: #fff;
    color: #000;
}

.btn-view-app:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(255,255,255,0.3);
}

.btn-mark-read {
    background: #1a1a1a;
    color: #888;
    border: 1px solid #333;
}

.btn-mark-read:hover {
    border-color: #fff;
    color: #fff;
}
        .nav-links {
            display: flex;
            gap: 2.5rem;
            align-items: center;
        }

        .nav-link {
            color: #fff;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s;
            position: relative;
            cursor: pointer;
            font-size: 0.95rem;
        }

        .nav-link::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 0;
            height: 2px;
            background: #fff;
            transition: width 0.3s;
        }

        .nav-link:hover::after {
            width: 100%;
        }

        .dropdown {
            position: relative;
        }
/* --- NOTIFICATION BADGE --- */
.nav-icon-wrapper {
    position: relative;
    display: inline-block;
    cursor: pointer;
}

.notif-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    width: 10px;
    height: 10px;
    background-color: #ff006e;
    border-radius: 50%;
    border: 2px solid #0a0a0a;
    display: none; /* Hidden by default */
    z-index: 10;
}

.notif-badge.active {
    display: block;
}

/* --- INBOX / CHAT LIST SCREEN --- */
.chat-list-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 2rem;
    color: #fff;
}

.chat-item {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    background: #111;
    border: 1px solid #222;
    padding: 1.5rem;
    border-radius: 12px;
    margin-bottom: 1rem;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
}

.chat-item:hover {
    background: #161616;
    border-color: #444;
    transform: translateX(5px);
}

.chat-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: #333;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1.2rem;
    color: #fff;
    border: 2px solid #000;
}

.chat-info {
    flex: 1;
}

.chat-name {
    font-size: 1.1rem;
    font-weight: 700;
    margin-bottom: 0.3rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

.chat-preview {
    color: #888;
    font-size: 0.9rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 500px;
}

.time-ago {
    color: #555;
    font-size: 0.8rem;
    white-space: nowrap;
}

.unread-pill {
    background: #10b981;
    color: #fff;
    font-size: 0.7rem;
    padding: 2px 8px;
    border-radius: 10px;
    font-weight: 800;
    text-transform: uppercase;
}
.dropdown-content {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    background: #1a1a1a;
    min-width: 220px;
    border-radius: 12px;
    margin-top: 1rem;
    box-shadow: 0 10px 40px rgba(255, 255, 255, 0.1);
    border: 1px solid #333;
    overflow: hidden;
    z-index: 1000;
}


.dropdown-content.show {
    display: block !important;
    animation: fadeIn 0.3s;
}

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .dropdown-item {
            padding: 1rem 1.5rem;
            color: #fff;
            text-decoration: none;
            display: block;
            transition: all 0.3s;
            cursor: pointer;
            border-left: 3px solid transparent;
        }

        .dropdown-item:hover {
            background: #222;
            border-left-color: #fff;
            padding-left: 2rem;
        }

        .top-nav-right {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }

        .icon-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: #1a1a1a;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            border: 1px solid #222;
        }

        .icon-btn:hover {
            background: #fff;
            border-color: #fff;
            transform: translateY(-3px) scale(1.1);
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.2);
        }

        .icon-btn:hover svg {
            stroke: #000;
        }

        .profile-dropdown {
            position: relative;
        }

        .profile-dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: #1a1a1a;
            min-width: 300px;
            border-radius: 12px;
            margin-top: 1rem;
            box-shadow: 0 10px 40px rgba(255, 255, 255, 0.1);
            border: 1px solid #333;
            padding: 1rem;
            animation: fadeIn 0.3s;
        }

        .profile-dropdown-content.show {
            display: block;
        }

        .profile-info {
            padding: 1rem;
            border-bottom: 1px solid #333;
            margin-bottom: 1rem;
        }

        .profile-username {
            font-weight: 600;
            font-size: 1.2rem;
        }

        .profile-userid {
            color: #888;
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }

        .switch-btn {
            background: #fff;
            color: #000;
            border: none;
            padding: 0.9rem;
            width: 100%;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            margin-bottom: 1rem;
            transition: all 0.3s;
            font-size: 0.95rem;
        }

        .switch-btn:hover {
            background: #ddd;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.3);
        }

        .profile-section {
            padding: 0.5rem 0;
        }
/* ===== SVG ICON FIX (GLOBAL) ===== */
svg {
    display: inline-block;
    vertical-align: middle;
    flex-shrink: 0;
}

/* Prevent stroke distortion */
svg path,
svg circle,
svg polyline,
svg rect,
svg line {
    vector-effect: non-scaling-stroke;
}

/* Banner + Card icons sizing */
.banner h3 svg,
.dash-card-title svg,
.welcome-text svg {
    width: 24px;
    height: 24px;
    stroke-width: 2;
}

/* Right-side big icons */
.banner-icon svg {
    width: 56px;
    height: 56px;
    opacity: 0.9;
}

        .profile-link {
            padding: 0.9rem 1rem;
            display: block;
            color: #fff;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s;
            cursor: pointer;
            font-weight: 500;
        }

        .profile-link:hover {
            background: #222;
            padding-left: 1.5rem;
        }

        /* Main Content */
        .container {
            padding: 3rem 3rem;
            display: flex;
            gap: 3rem;
            max-width: 1800px;
            margin: 0 auto;
        }

        .left-section {
            width: 380px;
            flex-shrink: 0;
        }

        .right-section {
            flex: 1;
max-width: 1100px;
        }

        .welcome-section {
            margin-bottom: 3rem;
        }

        .welcome-text {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(90deg, #fff 0%, #888 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .welcome-subtext {
            color: #888;
            font-size: 1.1rem;
        }

        /* Left Cards Section */
        .left-cards {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .card {
            background: #0a0a0a;
            border-radius: 16px;
            padding: 2.5rem;
            border: 1px solid #222;
            transition: all 0.4s;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, #fff 0%, #666 100%);
            transform: scaleX(0);
            transition: transform 0.4s;
        }

        .card:hover::before {
            transform: scaleX(1);
        }

        .card:hover {
            border-color: #444;
            transform: translateY(-5px);
            box-shadow: 0 10px 40px rgba(255, 255, 255, 0.1);
        }

        .profile-avatar {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            background: #fff;
            color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: 800;
            margin: 0 auto 1.5rem;
            box-shadow: 0 5px 20px rgba(255, 255, 255, 0.2);
        }

        .card-title {
            text-align: center;
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .card-subtitle {
            text-align: center;
            color: #888;
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
        }

        .card-btn {
            background: transparent;
            color: #fff;
            border: 2px solid #fff;
            padding: 0.9rem 1.5rem;
            width: 100%;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.3s;
            font-size: 0.95rem;
        }

        .card-btn:hover {
            background: #fff;
            color: #000;
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(255, 255, 255, 0.3);
        }

        .startup-logo {
            width: 90px;
            height: 90px;
            border-radius: 16px;
            margin: 0 auto 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #1a1a1a;
            overflow: hidden;
            border: 2px solid #333;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
        }

        .startup-logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .availability-indicator {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            margin: 0 auto 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fff;
            box-shadow: 0 5px 20px rgba(255, 255, 255, 0.2);
        }

        .card-description {
            text-align: center;
            color: #aaa;
            font-size: 0.85rem;
            margin-top: 1.5rem;
            line-height: 1.6;
        }

        /* Banners Section */
        .banners-section {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .banner {
            background: #0a0a0a;
            border-radius: 16px;
            padding: 3rem;
            border: 1px solid #222;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.4s;
            position: relative;
            overflow: hidden;
        }

        .banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: #fff;
            transform: scaleY(0);
            transition: transform 0.4s;
        }

        .banner:hover::before {
            transform: scaleY(1);
        }
/* Dark Modal Styling */
#availabilityModal .modal-content {
    background-color: #0f0f0f; 
    border: 1px solid #333;
    color: #ffffff;
    max-width: 450px;
    padding: 40px 30px 30px 30px; /* Extra top padding for the button space */
    position: relative;           /* Required to anchor the close button */
    border-radius: 16px;
}

/* BIG Close Button at TOP RIGHT */
#availabilityModal .close-btn {
    position: absolute;
    top: 15px;
    right: 20px;
    color: #888;
    font-size: 32px;             /* Bigger size */
    font-weight: 300;
    cursor: pointer;
    line-height: 1;
    transition: all 0.2s;
}

#availabilityModal .close-btn:hover {
    color: #ff006e;              /* ScaleVest Pink on hover */
    transform: scale(1.2);
}

/* Options & Buttons */
.modal-option-btn {
    background: #1a1a1a;
    color: #fff;
    border: 1px solid #333;
    padding: 15px;
    width: 100%;
    margin-bottom: 12px;
    border-radius: 10px;
    cursor: pointer;
    text-align: left;
    font-weight: 600;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.3s;
}

.modal-option-btn:hover {
    border-color: #8338ec;
    background: #222;
}
/* Hidden Sections */
.availability-sub-section {
    display: none;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #222;
    animation: fadeIn 0.3s ease;
}

#availabilityModal input, #availabilityModal select {
    background: #000;
    color: #fff;
    border: 1px solid #444;
    margin-top: 10px;
}
        .banner:hover {
            border-color: #444;
            transform: translateX(10px);
            box-shadow: 0 10px 40px rgba(255, 255, 255, 0.1);
        }

        .banner-content h3 {
            font-size: 1.8rem;
            margin-bottom: 1rem;
            font-weight: 700;
        }

        .banner-content p {
            color: #aaa;
            line-height: 1.8;
            font-size: 1.05rem;
        }

        .banner-icon {
            width: 100px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #1a1a1a;
            border-radius: 20px;
            border: 2px solid #333;
            flex-shrink: 0;
            margin-left: 2rem;
        }

        .vests-header {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 1rem;
        }

        .vests-tabs {
            display: flex;
            gap: 0.5rem;
        }
.reply-notif-badge {
    position: absolute;
    top: 16px;
    right: 18px;

    background: #ff006e;
    color: #fff;

    padding: 6px 10px;
    border-radius: 999px;

    font-size: 0.7rem;
    font-weight: 900;
    letter-spacing: 0.5px;

    box-shadow: 0 6px 18px rgba(255, 0, 110, 0.35);
    z-index: 10;
}

        .vest-tab {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            font-size: 0.9rem;
            background: transparent;
            border: 1px solid #333;
        }

        .vest-tab.active {
            background: #fff;
            color: #000;
            border-color: #fff;
        }

        .vest-tab:hover:not(.active) {
            background: #222;
            border-color: #444;
        }

        /* Footer */
        .footer {
            background: #0a0a0a;
            border-top: 1px solid #222;
            padding: 3rem;
            margin-top: 4rem;
        }

        .footer-content {
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .footer-logo {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .footer-logo-text {
            font-size: 2rem;
            font-weight: 700;
            color: #fff;
        }

        .footer-company {
            color: #fff;
            font-size: 0.9rem;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5),
                         0 0 20px rgba(255, 255, 255, 0.3),
                         0 0 30px rgba(255, 255, 255, 0.2);
            font-weight: 500;
        }

        .footer-links {
            display: flex;
            gap: 2rem;
        }

        .footer-link {
            color: #888;
            text-decoration: none;
            transition: all 0.3s;
            font-weight: 500;
        }

        .footer-link:hover {
            color: #fff;
        }

        .inbox-card {
            max-height: 300px;
            overflow-y: auto;
        }

        .inbox-card::-webkit-scrollbar {
            width: 6px;
        }

        .inbox-card::-webkit-scrollbar-track {
            background: #1a1a1a;
            border-radius: 10px;
        }

        .inbox-card::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 10px;
        }
.inbox-card {
    transition: all 0.3s ease;
    cursor: pointer;
}

.inbox-card:hover {
    border-color: #ff006e !important; /* ScaleVest Pink */
    transform: translateY(-5px);
    background: #111 !important;
}

.inbox-card:active {
    transform: scale(0.98);
}
        .inbox-message {
            padding: 1rem;
            margin-bottom: 0.75rem;
            background: #1a1a1a;
            border-radius: 8px;
            border-left: 3px solid #fff;
        }

        @media (max-width: 1024px) {
            .container {
                flex-direction: column;
                padding: 2rem 1.5rem;
                gap: 2rem;
            }

            .left-section {
                width: 100%;
            }

            .top-nav {
                padding: 1rem 1.5rem;
                flex-wrap: wrap;
            }

            .logo {
                font-size: 1.5rem;
            }

            .nav-links {
                display: none;
            }

            .welcome-text {
                font-size: 1.8rem;
            }

            .banner {
                padding: 2rem;
                flex-direction: column;
                text-align: center;
            }

            .banner-icon {
                margin-left: 0;
                margin-top: 1.5rem;
            }

            .banner-content h3 {
                font-size: 1.4rem;
            }

            .card {
                padding: 2rem;
            }

            .footer {
                padding: 2rem 1.5rem;
            }

            .footer-content {
                flex-direction: column;
                gap: 2rem;
                text-align: center;
            }

            .vests-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .vests-tabs {
                width: 100%;
                justify-content: center;
            }
        }
/* --- LOGO STYLING --- */
.logo {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 1.8rem; /* Adjusted slightly for alignment */
    font-weight: 700;
    color: #fff;
    cursor: pointer;
    text-shadow: none; /* Optional: Cleaner look */
}

.nav-logo-img {
    width: 40px;
    height: 40px;
    border-radius: 50%; /* Makes image circular */
    object-fit: cover;
    border: 2px solid rgba(255, 255, 255, 0.2);
}

.btn-browse-angels {
    /* Background & Text */
    background-color: #ffffff;
    color: #000000;
    .reply-notif-badge {
    position: absolute;
    top: 16px;
    right: 18px;

    background: #ff006e;
    color: #fff;

    padding: 6px 10px;
    border-radius: 999px;

    font-size: 0.7rem;
    font-weight: 900;
    letter-spacing: 0.5px;

    box-shadow: 0 6px 18px rgba(255, 0, 110, 0.35);
    z-index: 10;
}

    /* Font: Clean, modern sans-serif with tight tracking */
    font-family: 'Inter', -apple-system, system-ui, sans-serif;
    font-size: 0.72rem; 
    font-weight: 800; /* Extra bold for that modern "sticker" look */
    letter-spacing: 0.02em; 
    text-transform: uppercase;
    
    /* Sizing: Tight and compact */
    border: none;
    padding: 6px 14px; 
    width: fit-content; 
    display: inline-flex;
    align-items: center;
    justify-content: center;
    
    /* Shape: Perfect Pill */
    border-radius: 999px; 
    cursor: pointer;
    white-space: nowrap;
    margin-left: 15px;
    
    /* Modern Depth & Border */
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    
    /* Interactions */
    transition: all 0.2s ease;
}

.btn-browse-angels:hover {
    background-color: #000000;
    color: #ffffff;
    border-color: #000000;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.btn-browse-angels:active {
    transform: translateY(0);
    opacity: 0.8;
}
/* --- EXISTING NAV LINKS ALIGNMENT --- */
.nav-links {
    display: flex;
    align-items: center;
    gap: 2rem;
}
        @media (max-width: 480px) {
            .top-nav {
                padding: 0.75rem 1rem;
            }

            .container {
                padding: 1.5rem 1rem;
            }

            .welcome-text {
                font-size: 1.5rem;
            }

            .banner {
                padding: 1.5rem;
            }
@media (max-width: 768px) {
    .top-nav {
        padding: 1rem;
        flex-wrap: nowrap;
        overflow-x: auto;
    }
    .card-title {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 700;
    font-size: 1.1rem;
    margin-bottom: 15px;
    color: #fff;
}

.inbox-card:hover {
    border-color: #fff;
    transform: translateY(-2px);
    transition: all 0.3s ease;
}
    .logo {
        font-size: 1.5rem;
    }
    
    .nav-links {
        display: none;
    }
    
    .top-nav-right {
        gap: 0.75rem;
    }
    
    .icon-btn {
        width: 36px;
        height: 36px;
    }
    
    .container {
        padding: 1.5rem 1rem;
    }
}
            .banner-content h3 {
                font-size: 1.2rem;
            }

            .banner-content p {
                font-size: 0.95rem;
            }

            .card {
                padding: 1.5rem;
            }
            .profile-avatar, .startup-logo, .availability-indicator {
                width: 70px;
                height: 70px;
            }

            .card-title {
                font-size: 1.1rem;
            }

            .vest-tab {
                padding: 0.5rem 0.75rem;
                font-size: 0.85rem;
            }

            .footer {
                padding: 1.5rem 1rem;
            }
        }
    </style>


       <!-- Top Navigation -->
<nav class="top-nav">
    <div class="logo" onclick="window.location.hash='founder_dashboard'">
        <img src="ScaleVestLogo.png" alt="ScaleVest Logo" class="nav-logo-img">
        <span>ScaleVest</span>
    </div>
    <div class="nav-links">
        <a href="#founder_dashboard" class="nav-link">Dashboard</a>
        <a href="vests.html#edit_startup" class="nav-link">My Startup</a>
       <a href="#analytics" class="nav-link">Analytics</a>

        <div class="dropdown">
            <span class="nav-link" onclick="toggleDropdown('scaleDropdown'); event.stopPropagation();">
                Scale and Elevate â–¾
            </span>
            <div class="dropdown-content" id="scaleDropdown">
                <a href="#founder_emergence" class="dropdown-item">Founder Emergence</a>
                <a href="#ScaleVEST_Refers" class="dropdown-item">Referrals</a>
                
                <a href="#applications" class="dropdown-item">My Applications</a>
            </div>
        </div>

<button class="btn-browse-angels" onclick="handleBrowseAngels()">
    Browse Angel Profiles
</button>
    </div>
<div id="navStatusPill" class="status-pill-nav ${founderData?.availabilityStatus === 'busy' ? 'busy' : 'active'}">
            <span class="dot-indicator"></span>
            <span id="navStatusText">Status: ${founderData?.availabilityStatus === 'busy' ? 'Busy' : 'Active'}</span>
        </div>
    </div>
</div>
    <div class="top-nav-right">
        <div class="nav-icon-wrapper" onclick="window.handleBellClick()">
            <div class="icon-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                </svg>
            </div>
            <div class="notif-badge" id="navBellBadge"></div>
        </div>

        <div class="profile-dropdown">
<div class="icon-btn" onclick="toggleDashProfileDropdown()">
    ${founderData?.photoURL 
        ? `<img src="${founderData.photoURL}" alt="Profile" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">` 
        : `<div style="font-size:1.2rem;font-weight:600;">${founderData.founderImage || 'U'}</div>`}
</div>

            <div class="profile-dropdown-content" id="dashProfileDropdown">
                <div class="profile-info">
                    <div class="profile-username">${founderData?.founderUsername || 'Username'}</div>
                    <div class="profile-userid">${founderData?.userId || 'USER_ID'}</div>
                </div>

                <button class="switch-btn">Switch to Browse</button>

                <div class="profile-section">
                    <a href="#" class="profile-link">Refer a Friend</a>
                    <a href="#" class="profile-link">Profile</a>
                    <a href="#" class="profile-link" onclick="auth.signOut();return false;">Log Out</a>
                </div>
            </div>
        </div>
    </div>
</nav>

<!-- MAIN DASHBOARD -->
<div class="container">

    <!-- LEFT -->
    <div class="left-section">
        <div class="left-cards">

            <div class="card">
              <div class="profile-avatar">${founderData?.photoURL 
    ? `<img src="${founderData.photoURL}" alt="Profile" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">` 
    : (founderData?.founderImage || 'U')}</div>

                <div class="card-title">${founderData?.founderUsername || 'Username'}</div>
                <div class="card-subtitle">${founderData?.userId || 'USER_ID'}</div>
               <button class="card-btn" onclick="window.location.hash='edit_founderprofile'">View Profile</button>
            </div>

             <div class="card">
            <div class="startup-logo">
                ${startupData?.logo
                    ? `<img src="${startupData.logo}" alt="Startup Logo">`
                    : `
                    <svg width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5z"></path>
                        <path d="M2 17l10 5 10-5"></path>
                        <path d="M2 12l10 5 10-5"></path>
                    </svg>`}
            </div>

            <div class="card-title">${startupData?.startupName || 'My Startup'}</div>
            <div class="card-subtitle">${startupData?.startupId || ''}</div>
            <button class="card-btn" onclick="window.location.hash='edit_startup'">View Startup</button>
        </div>

<div class="card">
    <div class="availability-indicator">
        <svg width="35" height="35" viewBox="0 0 24 24"
             fill="none" stroke="black" stroke-width="3">
            <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
    </div>

    <div class="card-title">Founder Availability</div>

   <button class="card-btn" onclick="openAvailabilityModal()">Set Availability</button>

    <p class="card-description">
        Control when you're available.
    </p>
</div>



<div class="card inbox-card" onclick="window.handleBellClick()" style="cursor:pointer;">
    <div class="card-title">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;">
            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
            <polyline points="22,6 12,13 2,6"></polyline>
        </svg>
        
        <div style="display: flex; align-items: center; gap: 10px;">
            Inbox
            <img src="email.svg" alt="Email Icon" style="width: 20px; height: 20px; object-fit: contain;">
        </div>
    </div>

    <div id="inbox-preview-content" class="inbox-message" style="border-left: 3px solid #333; padding: 12px; background: transparent;">
        <p style="color:#666; font-style:italic;">Loading messages...</p>
    </div>
</div>
    </div>
</div>
<!-- RIGHT -->
<div class="right-section">

    <!-- WELCOME -->
    <div class="welcome-section">
        <h1 class="welcome-text">
            Welcome, ${founderData?.founderUsername || 'Founder'}!
            <svg width="35" height="35" viewBox="0 0 24 24" fill="none"
                 stroke="white" stroke-width="2"
                 style="vertical-align:middle;margin-left:.5rem;">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
            </svg>
        </h1>

        <p class="welcome-subtext">
            Let's make today count and connect with potential investors
        </p>
    </div>

    <!-- BANNERS -->
    <div class="banners-section">

        <div class="banner" onclick="window.location.hash='founder_emergence'" style="cursor: pointer;">
            <div class="banner-content">
                <h3>
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none"
                         stroke="white" stroke-width="2"
                         style="vertical-align:middle;margin-right:.5rem;">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                    Start Founder Emergence
                </h3>
                <p>Launch your Founder Emergence campaign and reach investors faster.</p>
            </div>

            <div class="banner-icon">
                <svg width="60" height="60" viewBox="0 0 24 24" fill="none"
                     stroke="white" stroke-width="2">
                    <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27"></path>
                </svg>
            </div>
        </div>

<div class="banner" onclick="openAutoReplySetup()" style="cursor: pointer;">
    <div class="banner-content">
        <h3>
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none"
                 stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"
                 style="vertical-align:middle;margin-right:.5rem;">
                <path d="M12 8V4H8"></path>
                <rect x="5" y="8" width="14" height="12" rx="2"></rect>
                <path d="M9 12v2"></path>
                <path d="M15 12v2"></path>
            </svg>
            Setup Auto Reply for Investors
        </h3>
        <p>Respond instantly to investor messages with smart auto replies.</p>
    </div>

    <div class="banner-icon">
        <svg width="60" height="60" viewBox="0 0 24 24" fill="none"
             stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"></path>
            <path d="m13 8-2 4h4l-2 4"></path>
        </svg>
    </div>
</div>


<div class="banner" onclick="window.location.hash='manage_vests'" style="cursor: pointer;">
    <div class="banner-content">
        <h3>
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none"
                 stroke="white" stroke-width="2"
                 style="vertical-align:middle;margin-right:.5rem;">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
            Manage Vests
        </h3>
        <p>Manage your investor outreach campaigns.</p>
    </div>

    <div class="banner-icon">
        <svg width="60" height="60" viewBox="0 0 24 24" fill="none"
             stroke="white" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2"></rect>
        </svg>
    </div>
</div>
<div class="banner" onclick="window.location.hash='application_replies'" style="cursor: pointer; position: relative;">
    <div class="banner-content">
        <h3>
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none"
                 stroke="white" stroke-width="2"
                 style="vertical-align:middle;margin-right:.5rem;">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
            Application Replies Inbox
        </h3>
        <p>View and manage investor responses to your funding applications.</p>
    </div>

    <div class="banner-icon">
        <svg width="60" height="60" viewBox="0 0 24 24" fill="none"
             stroke="white" stroke-width="2">
            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
            <polyline points="22,6 12,13 2,6"></polyline>
        </svg>
    </div>
    
</div>

</div>

</div>


</div> 
</div> <footer class="footer">
    <div class="footer-content">
        <div>
            <div class="footer-logo-text">ScaleVest</div>
            <div class="footer-company">UnioraX Private Limited</div>
        </div>
        <div class="footer-links">

        </div>
    </div>
</footer>

    `;
    
// Inject and Show
    const container = document.getElementById('dashboardContainer');
    container.innerHTML = dashboardHTML;
    container.style.display = 'block';
    
    // Initialize Notification Badge (Global Count)
    updateNotificationBadge(globalUnreadCount);

    // =========================================================
    // 3. START REAL-TIME LISTENERS (Now that DOM is Ready!)
    // =========================================================
    const chatsRef = ref(db, 'Chats');
    
    onValue(chatsRef, async (snapshot) => {
    // Default Display
    let displayData = { 
        title: "Welcome to ScaleVest!", 
        text: "No New Messages Yet.", 
        timeAgo: "",
        isUnread: false,
        hasAttachment: false // â­ NEW
    };

    if (snapshot.exists()) {
        const allChats = snapshot.val();
        let newestUnreadMsg = null;

        // Search for Unread Messages
        Object.keys(allChats).forEach(roomKey => {
            if (roomKey.includes(currentUser.uid)) {
                const roomData = allChats[roomKey];
                const msgs = Object.values(roomData).filter(m => m && typeof m === 'object' && m.timestamp);
                
                msgs.forEach(msg => {
                    // Priority Check: Is it for me? Is it specifically unread?
                    if (msg.recipient === currentUser.uid && msg.read === false) {
                        if (!newestUnreadMsg || msg.timestamp > newestUnreadMsg.timestamp) {
                            newestUnreadMsg = msg;
                        }
                    }
                });
            }
        });

        // If we found a priority unread message, display it
        if (newestUnreadMsg) {
            try {
                let senderName = "An Investor";
                const investorSnap = await get(ref(db, `investorProfiles/${newestUnreadMsg.sender}`));
                
                if (investorSnap.exists()) {
                    senderName = investorSnap.val().fullName;
                } else {
                    const founderSnap = await get(ref(db, `founderProfile/${newestUnreadMsg.sender}`));
                    if(founderSnap.exists()) senderName = founderSnap.val().founderUsername || "User";
                }

                // â­ CHECK FOR ATTACHMENT
                const hasAttachment = !newestUnreadMsg.text && (newestUnreadMsg.fileUrl || newestUnreadMsg.videoUrl || newestUnreadMsg.imageUrl);
                const messageText = newestUnreadMsg.text || (hasAttachment ? "ðŸ“Ž Sent an attachment" : "Sent a message");

                displayData = {
                    title: `${senderName} sent a message:`,
                    text: messageText,
                    timeAgo: timeSince(newestUnreadMsg.timestamp),
                    isUnread: true,
                    hasAttachment: hasAttachment // â­ NEW
                };
            } catch (e) {
                console.error("Error fetching name:", e);
            }
        }
    }

    // UPDATE UI ELEMENT
    const inboxElement = document.getElementById('inbox-preview-content');
    if (inboxElement) {
        const opacity = displayData.isUnread ? "1" : "0.5";
        const border = displayData.isUnread ? "3px solid #ff006e" : "3px solid #333";
        
        // â­ ATTACHMENT ICON (if exists)
        const attachmentIcon = displayData.hasAttachment 
            ? `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ff006e" stroke-width="2" style="display:inline-block; vertical-align:middle; margin-right:4px;">
                <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
               </svg>`
            : '';

        inboxElement.style.borderLeft = border;
        inboxElement.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px;">
                <strong style="color: #fff; font-size: 0.9rem; line-height:1.2;">${displayData.title}</strong>
                <span style="color: #ff006e; font-size: 0.7rem; font-weight: 800; white-space:nowrap; margin-left:10px;">${displayData.timeAgo}</span>
            </div>
            <p style="color: #888; font-size: 0.85rem; line-height: 1.4; font-style: italic; opacity:${opacity};">
                ${attachmentIcon}"${displayData.text}"
            </p>
        `;
    }
});

// Function to show sub-sections
window.showAvailabilityDetail = function(sectionId) {
    document.getElementById('modalMenu').style.display = 'none';
    document.getElementById(sectionId).style.display = 'block';
}

// Function to go back to main modal menu
window.resetModal = function() {
    document.getElementById('dateSection').style.display = 'none';
    document.getElementById('statusSection').style.display = 'none';
    document.getElementById('modalMenu').style.display = 'block';
}

// Updated Event Listener to handle opening/closing
document.addEventListener('click', function (e) {
    const modal = document.getElementById("availabilityModal");

    // 1. Open Modal
    if (e.target && e.target.id === 'openModal') {
        modal.style.display = "block";
        resetModal(); // Ensure it starts at the menu
    }

    // 2. Close Modal (X button)
    if (e.target && e.target.classList.contains('close-btn')) {
        modal.style.display = "none";
    }

    // 3. Close if clicking outside the box
    if (e.target === modal) {
        modal.style.display = "none";
    }
});



    // Add dropdown interaction after DOM is loaded
    setTimeout(() => {
        window.toggleDashProfileDropdown = function() {
            const dropdown = document.getElementById('dashProfileDropdown');
            if (dropdown) {
                dropdown.classList.toggle('show');
            }
        };
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.dash-profile-dropdown')) {
                const dropdown = document.getElementById('dashProfileDropdown');
                if (dropdown) dropdown.classList.remove('show');
            }
        });
    }, 100);
}

// Close dropdowns when clicking outside
document.addEventListener('click', (e) => {
    if (!e.target.closest('.dropdown')) {
        document.querySelectorAll('.dropdown-content').forEach(dd => {
            dd.classList.remove('show');
        });
    }
});
function generateUserId(baseString) {
    // Generate PERMANENT userId that NEVER changes
    const timestamp = Date.now().toString().slice(-4);
    const randomNum = Math.floor(Math.random() * 900 + 100);
    return `USER_${timestamp}${randomNum}`;
}

// Show User ID Setup Modal
async function showUserIdSetupModal() {
    const modal = document.createElement('div');
    modal.className = 'edit-modal show';
    modal.style.zIndex = '99999';
    modal.innerHTML = `
        <div class="edit-modal-content">
            <div class="edit-modal-header">
                <h3>âš¡ Set Your User ID</h3>
            </div>
            <div class="edit-modal-body">
                <p style="color: #aaa; margin-bottom: 1.5rem;">Choose a unique User ID that will identify you on ScaleVest</p>
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">User ID</label>
                    <input type="text" id="userIdInput" placeholder="e.g., USER_1234" style="width: 100%; padding: 0.75rem; background: #0a0a0a; border: 2px solid #333; border-radius: 8px; color: #fff; font-size: 1rem;">
                    <small style="color: #888; display: block; margin-top: 0.5rem;">This cannot be changed later</small>
                </div>
            </div>
            <div class="edit-modal-footer">
                <button class="modal-btn-save" onclick="saveUserId()" style="width: 100%;">Continue</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    document.getElementById('userIdInput').focus();
}

window.saveUserId = async function() {
    const input = document.getElementById('userIdInput');
    const userId = input.value.trim();
    
    if (!userId || userId.length < 5) {
        alert('âŒ User ID must be at least 5 characters');
        return;
    }
    
    try {
        await update(ref(db, `founderProfile/${currentUser.uid}`), { userId });
        
        // 1. Update the cache so the Gatekeeper sees the new ID
        cachedFounderData.userId = userId;
        
        // 2. Remove the modal
        const modal = document.querySelector('.edit-modal');
        if (modal) modal.remove();

        // 3. TRIGGER ROUTER IMMEDIATELY
        handleHashChange(); 
        
    } catch (error) {
        console.error('Error saving userId:', error);
    }
};
async function showEditProfile() {
    document.title = "Edit Profile | ScaleVest";
    
    // Hide other containers
    if (document.querySelector('.vest-container')) {
        document.querySelector('.vest-container').style.display = 'none';
    }

    let container = document.getElementById('dashboardContainer');
    if (!container) {
        container = document.createElement('div');
        container.id = 'dashboardContainer';
        document.body.appendChild(container);
    }
    
    container.style.display = 'block';

    // -----------------------------------------------------
    // ðŸ›¡ï¸ SAFETY FETCH: Ensure data exists on Refresh
    // -----------------------------------------------------
    if (!cachedFounderData || !cachedStartupData) {
        // Show a temporary loading spinner while we fetch
        container.innerHTML = `
            <div style="height:100vh; display:flex; align-items:center; justify-content:center;">
                <div class="spinner"></div>
            </div>`;
        
        try {
            const [founderSnap, startupSnap] = await Promise.all([
                get(ref(db, `founderProfile/${currentUser.uid}`)),
                get(ref(db, `startupProfile/${currentUser.uid}`))
            ]);

            if (founderSnap.exists()) cachedFounderData = founderSnap.val();
            if (startupSnap.exists()) cachedStartupData = startupSnap.val();
            
        } catch (e) {
            console.error("Profile Fetch Error:", e);
        }
    }

    // Assign data variables after the safety fetch
    let founderData = cachedFounderData || {};
    let startupData = cachedStartupData || {}; // Changed from const to let just in case
    
    // -----------------------------------------------------
    // DATA NORMALIZATION (Fixing old data formats)
    // -----------------------------------------------------
    if (!founderData.languages) {
        founderData.languages = [];
    } else if (typeof founderData.languages === 'string') {
        // Old format: "HINDI" -> New format: [{name: "Hindi", level: "Fluent"}]
        const oldLang = founderData.languages.trim();
        founderData.languages = oldLang ? [{name: oldLang, level: 'Fluent'}] : [];
        // Save updated format to Firebase silently
        update(ref(db, `founderProfile/${currentUser.uid}`), { languages: founderData.languages });
    } else if (!Array.isArray(founderData.languages)) {
        founderData.languages = [];
    }
    
    // Fetch location data from startupProfile
    const locationData = startupData?.location || { country: '', state: '', city: '' };
    
    // Calculate profile completion
    const fields = [
        founderData.founderUsername,
        founderData.photoURL,
        founderData.title,
        founderData.about,
        founderData.education?.length > 0,
        founderData.workExperience?.length > 0,
        founderData.coFounders && Object.keys(founderData.coFounders).length > 0,
        founderData.languages?.length > 0
    ];
    const filledFields = fields.filter(f => f && f !== '').length;
    const completionPercent = Math.round((filledFields / fields.length) * 100);    container.innerHTML = `
        <style>
        .top-nav {
            background: #0a0a0a;
            padding: 1.2rem 3rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #222;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .logo {
            font-size: 2rem;
            font-weight: 700;
            color: #fff;
            cursor: pointer;
            letter-spacing: 1px;
            transition: all 0.3s;
        }

        .nav-links {
            display: flex;
            gap: 2.5rem;
            align-items: center;
        }

        .nav-link {
            color: #fff;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s;
            position: relative;
            cursor: pointer;
            font-size: 0.95rem;
        }

        .nav-link::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 0;
            height: 2px;
            background: #fff;
            transition: width 0.3s;
        }

        .nav-link:hover::after {
            width: 100%;
        }

        .dropdown {
            position: relative;
        }
@media (max-width: 768px) {
    .edit-profile-container {
        padding: 1rem;
    }
    
    .profile-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .profile-header-card {
        flex-direction: column;
        text-align: center;
    }
    
    .profile-avatar-large {
        width: 80px;
        height: 80px;
        font-size: 2rem;
    }
    
    .profile-name {
        font-size: 1.5rem;
    }
    
    .profile-card {
        padding: 1.5rem;
    }
    
    .dual-section {
        grid-template-columns: 1fr;
    }
    
    .edit-modal-content {
        width: 95%;
        max-height: 90vh;
    }
    
    .back-btn {
        padding: 0.6rem 1rem;
        font-size: 0.9rem;
    }
    
    .action-buttons {
        flex-direction: column;
        width: 100%;
    }
    
    .preview-btn, .share-btn {
        width: 100%;
    }
}
        .dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: #1a1a1a;
            min-width: 220px;
            border-radius: 12px;
            margin-top: 1rem;
            box-shadow: 0 10px 40px rgba(255, 255, 255, 0.1);
            border: 1px solid #333;
            overflow: hidden;
            z-index: 1000;
        }

        .dropdown-content.show {
            display: block !important;
            animation: fadeInDropdown 0.3s;
        }

        @keyframes fadeInDropdown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .dropdown-item {
            padding: 1rem 1.5rem;
            color: #fff;
            text-decoration: none;
            display: block;
            transition: all 0.3s;
            cursor: pointer;
            border-left: 3px solid transparent;
        }

        .dropdown-item:hover {
            background: #222;
            border-left-color: #fff;
            padding-left: 2rem;
        }

        .top-nav-right {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }

        .icon-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: #1a1a1a;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            border: 1px solid #222;
        }

        .icon-btn:hover {
            background: #fff;
            border-color: #fff;
            transform: translateY(-3px) scale(1.1);
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.2);
        }

        .icon-btn:hover svg {
            stroke: #000;
        }

        .profile-dropdown {
            position: relative;
        }

        .profile-dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: #1a1a1a;
            min-width: 300px;
            border-radius: 12px;
            margin-top: 1rem;
            box-shadow: 0 10px 40px rgba(255, 255, 255, 0.1);
            border: 1px solid #333;
            padding: 1rem;
            z-index: 1000;
        }

        .profile-dropdown-content.show {
            display: block;
            animation: fadeInDropdown 0.3s;
        }

        .profile-info {
            padding: 1rem;
            border-bottom: 1px solid #333;
            margin-bottom: 1rem;
        }

        .profile-username {
            font-weight: 600;
            font-size: 1.2rem;
        }

        .profile-userid {
            color: #888;
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }

        .switch-btn {
            background: #fff;
            color: #000;
            border: none;
            padding: 0.9rem;
            width: 100%;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            margin-bottom: 1rem;
            transition: all 0.3s;
            font-size: 0.95rem;
        }

        .switch-btn:hover {
            background: #ddd;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.3);
        }

        .profile-section {
            padding: 0.5rem 0;
        }

        .profile-link {
            padding: 0.9rem 1rem;
            display: block;
            color: #fff;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s;
            cursor: pointer;
            font-weight: 500;
        }

        .profile-link:hover {
            background: #222;
            padding-left: 1.5rem;
        }
            .edit-profile-container {
                max-width: 1400px;
                margin: 0 auto;
                padding: 2rem 3rem;
                background: #000;
                min-height: 100vh;
            }
            
            .profile-grid {
                display: grid;
                grid-template-columns: 1fr 300px;
                gap: 2rem;
                margin-top: 2rem;
            }
            
            .profile-main {
                display: flex;
                flex-direction: column;
                gap: 2rem;
            }
            
            .profile-sidebar {
                display: flex;
                flex-direction: column;
                gap: 2rem;
            }
            
            .profile-card {
                background: #0a0a0a;
                border: 1px solid #222;
                border-radius: 16px;
                padding: 2.5rem;
                transition: all 0.3s;
            }
            
            .profile-card:hover {
                border-color: #444;
                box-shadow: 0 10px 40px rgba(255, 255, 255, 0.05);
            }
            
            .profile-header-card {
                display: flex;
                align-items: center;
                gap: 2rem;
            }
            
            .profile-avatar-large {
                width: 120px;
                height: 120px;
                border-radius: 50%;
                background: #fff;
                color: #000;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 3rem;
                font-weight: 800;
                flex-shrink: 0;
            }
            
            .profile-header-info {
                flex: 1;
            }
            
            .profile-name-row {
                display: flex;
                align-items: center;
                gap: 1rem;
                margin-bottom: 0.5rem;
            }
            
            .profile-name {
                font-size: 2rem;
                font-weight: 700;
            }
            
.edit-icon-btn {
    width: 26px;        
    height: 26px;        
    flex-shrink: 0;     
    flex-grow: 0;            
     margin-left: auto; 
    border-radius: 4px;
    background: #1a1a1a;
    border: 1px solid #555;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s;
    padding: 0;
}

.edit-icon-btn svg {
    width: 14px;
    height: 14px;
    stroke: #fff;
    flex-shrink: 0;
}

.edit-icon-btn:hover {
    background: #fff;
    border-color: #fff;
    transform: scale(1.05);
}

.edit-icon-btn:hover svg {
    stroke: #000;
}

.back-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: #1a1a1a;
    color: #fff;
    border: 2px solid #333;
    padding: 0.75rem 1.5rem;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
    text-decoration: none;
    margin-bottom: 1.5rem;
}

.back-btn:hover {
    background: #fff;
    color: #000;
    border-color: #fff;
    transform: translateX(-5px);
}

.action-buttons {
    display: flex;
    gap: 0.75rem;
    margin-top: 0.5rem;
}

.preview-btn, .share-btn {
    padding: 0.6rem 1.2rem;
    border-radius: 8px;
    border: 2px solid #333;
    background: #1a1a1a;
    color: #fff;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
    font-size: 0.9rem;
}

.preview-btn:hover, .share-btn:hover {
    background: #fff;
    color: #000;
    border-color: #fff;
    transform: translateY(-2px);
}

.location-info, .language-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-top: 1rem;
    padding: 1rem;
    background: #000;
    border-radius: 10px;
    border: 1px solid #222;
}

.location-info svg, .language-info svg {
    width: 20px;
    height: 20px;
    flex-shrink: 0;
}

.info-content {
    flex: 1;
    color: #aaa;
}

.language-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.5rem;
}

.language-tag {
    background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
    border: 1px solid #444;
    color: #fff;
    padding: 0.4rem 0.8rem;
    border-radius: 20px;
    font-size: 0.85rem;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.language-level {
    background: rgba(255, 255, 255, 0.15);
    padding: 0.2rem 0.5rem;
    border-radius: 10px;
    font-size: 0.75rem;
    color: #aaa;
}

.lang-remove-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: #fff;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
}

.lang-remove-btn:hover {
    background: rgba(255, 255, 255, 0.4);
}

.profile-avatar-large {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    background: #fff;
    color: #000;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3rem;
    font-weight: 800;
    flex-shrink: 0;
    position: relative;
    cursor: pointer;
    overflow: hidden;
}

.profile-avatar-large img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.avatar-edit-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s;
    gap: 0.5rem;
}

.profile-avatar-large:hover .avatar-edit-overlay {
    opacity: 1;
}

.avatar-edit-overlay svg {
    width: 30px;
    height: 30px;
    stroke: #fff;
}

.avatar-edit-overlay span {
    color: #fff;
    font-size: 0.85rem;
    font-weight: 600;
}            
            .profile-userid {
                color: #888;
                font-size: 1rem;
                margin-bottom: 1rem;
            }
            
            .profile-title {
                color: #aaa;
                font-size: 1.1rem;
                display: flex;
                align-items: center;
                gap: 0.75rem;
            }
            
            .section-title {
                font-size: 1.3rem;
                font-weight: 700;
                margin-bottom: 1.5rem;
            }
            
            .about-box {
                background: #000;
                border: 1px solid #222;
                border-radius: 12px;
                padding: 2rem;
                min-height: 150px;
                color: #aaa;
                line-height: 1.8;
                position: relative;
            }
            
            .about-box.empty {
                display: flex;
                align-items: center;
                justify-content: center;
                color: #666;
                font-style: italic;
            }
            
            .edit-details-btn {
                background: transparent;
                color: #fff;
                border: 2px solid #fff;
                padding: 0.9rem 2rem;
                border-radius: 10px;
                cursor: pointer;
                font-weight: 700;
                transition: all 0.3s;
                margin-top: 1.5rem;
                width: 100%;
            }
            
            .edit-details-btn:hover {
                background: #fff;
                color: #000;
                transform: translateY(-2px);
            }
            
            .startup-info-card {
                background: #000;
                border: 1px solid #222;
                border-radius: 12px;
                padding: 2rem;
                position: relative;
            }
            
            .startup-name {
                font-size: 1.4rem;
                font-weight: 700;
                margin-bottom: 1rem;
            }
            
            .startup-description {
                color: #aaa;
                line-height: 1.6;
            }
            
            .video-box {
                background: #000;
                border: 2px dashed #333;
                border-radius: 12px;
                padding: 3rem;
                text-align: center;
                min-height: 250px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                gap: 1.5rem;
            }
            
            .add-video-btn {
                background: linear-gradient(135deg, #ff006e, #8338ec);
                color: #fff;
                border: none;
                padding: 1rem 2.5rem;
                border-radius: 10px;
                cursor: pointer;
                font-weight: 700;
                transition: all 0.3s;
            }
            
            .add-video-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 30px rgba(255, 0, 110, 0.3);
            }
            
            .dual-section {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 2rem;
            }
            
            .empty-state {
                text-align: center;
                padding: 2rem;
                color: #666;
            }
            
            .add-item-btn {
                background: #1a1a1a;
                color: #fff;
                border: 2px solid #333;
                padding: 0.8rem 1.5rem;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                transition: all 0.3s;
                margin-top: 1rem;
            }
            
            .add-item-btn:hover {
                border-color: #fff;
                background: #222;
            }
            .experience-item {
    background: #000;
    border: 1px solid #222;
    border-radius: 10px;
    padding: 1.5rem;
    margin-bottom: 1rem;
}

.exp-title {
    font-size: 1.1rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.exp-subtitle {
    color: #aaa;
    font-size: 0.95rem;
    margin-bottom: 0.5rem;
}

/* --- FIXED MODAL & CLOSE BUTTON STYLES --- */

/* 1. The Black Background Overlay */
.edit-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.9); /* Dark black background */
    backdrop-filter: blur(5px);           /* Blur effect */
    z-index: 99999;
    
    /* This centers the popup vertically and horizontally */
    display: flex;
    align-items: center;
    justify-content: center;
    
    /* Animation states */
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease;
}

/* Show state */
.edit-modal.show {
    opacity: 1;
    visibility: visible;
}

/* 2. The Popup Box */
.edit-modal-content {
    position: relative; /* Crucial: Makes the Close Button stick to this box */
    background: #111;
    border: 1px solid #333;
    border-radius: 16px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.8);
    transform: translateY(20px);
    transition: transform 0.3s ease;
    display: flex;
    flex-direction: column;
}

/* Slide animation when opening */
.edit-modal.show .edit-modal-content {
    transform: translateY(0);
}

/* 3. The Header (Title) */
.edit-modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid #222;
    width: 100%;
}

.edit-modal-header h3 {
    margin: 0;
    font-size: 1.3rem;
    color: #fff;
}

/* 4. The Close Button (EXTREME TOP RIGHT) */
.modal-close {
    position: absolute; /* Takes it out of the layout flow */
    top: 15px;          /* Distance from top edge */
    right: 20px;        /* Distance from right edge */
    background: transparent;
    border: none;
    color: #888;
    font-size: 2rem;
    line-height: 1;
    cursor: pointer;
    transition: all 0.2s;
    z-index: 10;
}

.modal-close:hover {
    color: #fff;
    transform: scale(1.1);
}

/* Body & Footer adjustments */
.edit-modal-body {
    padding: 1.5rem;
    text-align: left;
}

.edit-modal-footer {
    padding: 1.5rem;
    border-top: 1px solid #222;
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    background: #161616;
    border-radius: 0 0 16px 16px;
}

.modal-btn-save {
    padding: 10px 24px;
    background: linear-gradient(135deg, #ff006e, #8338ec);
    border: none;
    color: #fff;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
}






.exp-duration {
    color: #666;
    font-size: 0.85rem;
}
            .quick-links-card {
                background: #0a0a0a;
                border: 1px solid #222;
                border-radius: 16px;
                padding: 2rem;
            }
            
            .quick-link-btn {
                background: #1a1a1a;
                color: #fff;
                border: 1px solid #333;
                padding: 1rem;
                border-radius: 10px;
                cursor: pointer;
                font-weight: 600;
                transition: all 0.3s;
                width: 100%;
                text-align: left;
                margin-bottom: 0.75rem;
            }
            
            .quick-link-btn:hover {
                background: #222;
                border-color: #fff;
                transform: translateX(5px);
            }
            /* Upload Loading Animation */
.upload-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    backdrop-filter: blur(10px);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 99999;
    animation: fadeIn 0.3s;
}

.upload-spinner {
    width: 80px;
    height: 80px;
    border: 6px solid #333;
    border-top: 6px solid #fff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 1.5rem;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.upload-text {
    color: #fff;
    font-size: 1.3rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.upload-subtext {
    color: #888;
    font-size: 0.95rem;
}
.quick-link-btn {
    display: flex;
    align-items: center;
    gap: 10px;
    width: 100%;
    padding: 12px 16px;
    margin-bottom: 8px;
    /* Reuse your existing button styles below */
}

.quick-link-btn svg {
    flex-shrink: 0;
}
.upload-progress-bar {
    width: 300px;
    height: 8px;
    background: #1a1a1a;
    border-radius: 10px;
    overflow: hidden;
    margin-top: 1.5rem;
}

.upload-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #ff006e, #8338ec);
    width: 0%;
    transition: width 0.3s;
    animation: progressPulse 1.5s ease-in-out infinite;
}

@keyframes progressPulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}
            .progress-card {
                background: #0a0a0a;
                border: 1px solid #222;
                border-radius: 16px;
                padding: 2rem;
            }
            
            .progress-bar {
                width: 100%;
                height: 12px;
                background: #1a1a1a;
                border-radius: 10px;
                overflow: hidden;
                margin: 1rem 0;
            }
       .cofounder-item {
    background: #000;
    border: 1px solid #222;
    border-radius: 10px;
    padding: 1.5rem;
    margin-bottom: 1rem;
}

.cofounder-name {
    font-size: 1.1rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.cofounder-desc {
    color: #aaa;
    font-size: 0.9rem;
}     
            .progress-fill {
                height: 100%;
                background: linear-gradient(90deg, #10b981, #3a86ff);
                transition: width 0.5s;
            }
            
            .progress-text {
                text-align: center;
                font-size: 2rem;
                font-weight: 700;
                color: #10b981;
            }
            
            @media (max-width: 1024px) {
                .profile-grid {
                    grid-template-columns: 1fr;
                }
                
                .dual-section {
                    grid-template-columns: 1fr;
                }
                
                .edit-profile-container {
                    padding: 2rem 1.5rem;
                }
            }
        </style>
        
        ${createNavBar()}
        
      <div class="edit-profile-container">
    <a href="#founder_dashboard" class="back-btn">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
        Back to Dashboard
    </a>
    
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <h1 class="welcome-text" style="margin: 0;">Edit Founder Profile</h1>
        <div class="action-buttons">
                      
        </div>
    </div>
            
            <div class="profile-grid">
                <!-- Main Column -->
                <div class="profile-main">
                    <!-- Header Card -->
                   <div class="profile-card profile-header-card">
    <div class="profile-avatar-large" onclick="editProfilePhoto()">
        ${founderData.photoURL 
            ? `<img src="${founderData.photoURL}" alt="Profile">` 
            : founderData.founderImage || 'U'}
        <div class="avatar-edit-overlay">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                <circle cx="12" cy="13" r="4"></circle>
            </svg>
            <span>Edit Photo</span>
        </div>
    </div>
    <div class="profile-header-info">
        <div class="profile-name-row">
            <span class="profile-name">${founderData.founderUsername || 'Username'}</span>
            <button class="edit-icon-btn" onclick="editUsername()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
            </button>
        </div>
        
                
        <div class="profile-userid">${founderData.userId || 'USER_ID'}</div>
        
        <div class="profile-title">
            <span>${founderData.title || 'No title'}</span>
            <button class="edit-icon-btn" onclick="editTitle()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
            </button>
        </div>
    </div>
</div>



<!-- Location & Language Info Cards -->
<div class="profile-card">
    <div class="location-info">
        <svg viewBox="0 0 24 24" fill="none" stroke="#ff006e" stroke-width="2">
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
            <circle cx="12" cy="10" r="3"></circle>
        </svg>
        <div class="info-content">
            <strong>Location:</strong> ${locationData.city || 'N/A'}, ${locationData.state || 'N/A'}, ${locationData.country || 'N/A'}
        </div>
        <button class="edit-icon-btn" onclick="editLocation()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
        </button>
    </div>
    
    <div class="language-info" style="margin-top: 1rem;">
        <svg viewBox="0 0 24 24" fill="none" stroke="#8338ec" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="2" y1="12" x2="22" y2="12"></line>
            <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
        </svg>
        <div class="info-content" style="flex: 1;">
            <strong>Languages:</strong>
            <div class="language-tags">
                ${founderData.languages && Array.isArray(founderData.languages) && founderData.languages.length > 0 
                    ? founderData.languages.map(lang => `
                        <span class="language-tag">
                            ${lang.name}
                            <span class="language-level">${lang.level}</span>
                            <button class="lang-remove-btn" onclick="removeLanguage('${lang.name}')">Ã—</button>
                        </span>
                    `).join('')
                    : '<span style="color: #666;">No languages added</span>'}
            </div>
        </div>
        <button class="edit-icon-btn" onclick="addLanguage()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
        </button>
    </div>
</div>
                    
                    <!-- About Me Card -->
                    <div class="profile-card">
                        <h3 class="section-title">About Me</h3>
                        <div class="about-box ${founderData.about ? '' : 'empty'}">
                            ${founderData.about || 'Tell investors about yourself...'}
                        </div>
                        <button class="edit-details-btn" onclick="editAbout()">Edit Details</button>
                    </div>
                    
                    <!-- Startup Info Card -->
                    ${startupData ? `
                    <div class="profile-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h3 class="section-title" style="margin: 0;">Startup</h3>
                            <button class="edit-icon-btn" onclick="editStartup()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="startup-info-card">
                            <div class="startup-name">${startupData.startupName || 'Startup Name'}</div>
                            <div class="startup-description">${startupData.description || 'No description available'}</div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Intro Video Card -->
<div class="profile-card">
                        <h3 class="section-title">Intro Video</h3>
                        
                        ${founderData.introVideo ? `
                            <div class="video-box" style="padding: 0; border: none; overflow: hidden; background: #000; min-height: auto;">
                                
                                <video controls style="width: 100%; max-height: 350px; border-radius: 12px 12px 0 0; background: #000; display: block;">
                                    <source src="${founderData.introVideo}" type="video/mp4">
                                    Your browser does not support the video tag.
                                </video>

                                <div style="padding: 1.5rem; border: 1px solid #222; border-top: none; border-radius: 0 0 12px 12px; text-align: center;">
                                    <button class="add-video-btn" onclick="uploadVideo()">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
                                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                            <polyline points="17 8 12 3 7 8"></polyline>
                                            <line x1="12" y1="3" x2="12" y2="15"></line>
                                        </svg>
                                        Replace Video
                                    </button>
                                </div>
                            </div>
                        ` : `
                            <div class="video-box">
                                <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2">
                                    <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                </svg>
                                <p style="color: #666;">No video yet</p>
                                <button class="add-video-btn" onclick="uploadVideo()">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 0.5rem;">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="17 8 12 3 7 8"></polyline>
                                        <line x1="12" y1="3" x2="12" y2="15"></line>
                                    </svg>
                                    Add Video
                                </button>
                            </div>
                        `}
                    </div>
                    
                  <!-- Education & Work Experience -->
<div class="dual-section">
                <div class="profile-card">
                    <h3 class="section-title">Education</h3>
                    ${founderData?.education?.length > 0 ? `
                        ${founderData.education.map(edu => `
                            <div class="experience-item">
                                <div class="exp-title">${edu.degree}</div>
                                <div class="exp-subtitle">${edu.school}</div>
                                <div class="exp-duration">${edu.year}</div>
                            </div>
                        `).join('')}
                        <button class="add-item-btn" onclick="addEducation()">+ Add More</button>
                    ` : `
                        <div class="empty-state">
                            <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2" style="margin-bottom: 1rem;">
                                <path d="M22 10v6M2 10l10-5 10 5-10 5z"></path>
                                <path d="M6 12v5c3 3 9 3 12 0v-5"></path>
                            </svg>
                            <p>No education added yet</p>
                            <button class="add-item-btn" onclick="addEducation()">+ Add Education</button>
                        </div>
                    `}
                </div>
                
                <div class="profile-card">
                    <h3 class="section-title">Past Work</h3>
                    ${founderData?.workExperience?.length > 0 ? `
                        ${founderData.workExperience.map(work => `
                            <div class="experience-item">
                                <div class="exp-title">${work.position}</div>
                                <div class="exp-subtitle">${work.company}</div>
                                <div class="exp-duration">${work.duration}</div>
                            </div>
                        `).join('')}
                        <button class="add-item-btn" onclick="addWorkExperience()">+ Add More</button>
                    ` : `
                        <div class="empty-state">
                            <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2" style="margin-bottom: 1rem;">
                                <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                                <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
                            </svg>
                            <p>No past work yet</p>
                            <button class="add-item-btn" onclick="addWorkExperience()">+ Add Experience</button>
                        </div>
                    `}
                </div>
            </div> </div> <div class="profile-sidebar">
            <div class="quick-links-card">
    <h3 class="section-title">Quick Links</h3>
    
    <button class="quick-link-btn" onclick="window.location.hash='founder_dashboard'">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="7" height="9"></rect>
            <rect x="14" y="3" width="7" height="5"></rect>
            <rect x="14" y="12" width="7" height="9"></rect>
            <rect x="3" y="16" width="7" height="5"></rect>
        </svg>
         Dashboard
    </button>

    <button class="quick-link-btn" onclick="window.location.hash='founder_emergence'">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path>
        </svg>
         Founder Emergence
    </button>

    <button class="quick-link-btn" onclick="window.location.hash='manage_vests'">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
            <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
        </svg>
         My Vests
    </button>

    <button class="quick-link-btn" onclick="window.location.hash='analytics'">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="20" x2="18" y2="10"></line>
            <line x1="12" y1="20" x2="12" y2="4"></line>
            <line x1="6" y1="20" x2="6" y2="14"></line>
        </svg>
         Analytics
    </button>
</div>
            
            <div class="progress-card">
                <h3 class="section-title">Profile Completion</h3>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${completionPercent}%"></div>
                </div>
                <div class="progress-text">${completionPercent}%</div>
                <p style="color: #888; font-size: 0.9rem; text-align: center; margin-top: 1rem;">
                    Complete your profile to attract more investors
                </p>
            </div>                
                    
            ${founderData?.coFounders ? (
                Array.isArray(founderData.coFounders) && founderData.coFounders.length > 0 ? `
                <div class="profile-card">
                    <h3 class="section-title">Co-Founders</h3>
                    ${founderData.coFounders.map(coFounder => `
                        <div class="cofounder-item">
                            <div class="cofounder-name">${coFounder.name || 'No name'}</div>
                            <div class="cofounder-desc">${coFounder.description || 'No description'}</div>
                        </div>
                    `).join('')}
                    <button class="add-item-btn" onclick="addCoFounder()">+ Add Co-Founder</button>
                </div>
                ` : (Object.keys(founderData.coFounders).length > 0 ? `
                <div class="profile-card">
                    <h3 class="section-title">Co-Founders</h3>
                    ${Object.entries(founderData.coFounders).map(([id, coFounder]) => `
                        <div class="cofounder-item">
                            <div class="cofounder-name">${coFounder.name || 'No name'}</div>
                            <div class="cofounder-desc">${coFounder.description || 'No description'}</div>
                        </div>
                    `).join('')}
                    <button class="add-item-btn" onclick="addCoFounder()">+ Add Co-Founder</button>
                </div>
                ` : `
                <div class="profile-card">
                    <h3 class="section-title">Co-Founders</h3>
                    <div class="empty-state" style="padding: 1.5rem;">
                        <p style="color: #666; margin-bottom: 1rem;">No co-founders added</p>
                        <button class="add-item-btn" onclick="addCoFounder()">+ Add Co-Founder</button>
                    </div>
                </div>
                `)
            ) : `
            <div class="profile-card">
                <h3 class="section-title">Co-Founders</h3>
                <div class="empty-state" style="padding: 1.5rem;">
                    <p style="color: #666; margin-bottom: 1rem;">No co-founders added</p>
                    <button class="add-item-btn" onclick="addCoFounder()">+ Add Co-Founder</button>
                </div>
            </div>
            `}
        </div> </div> `;
}
// ============================================
// EDIT PROFILE FUNCTIONS - ALL WORKING
// ============================================


// 4. Handle Save
document.getElementById("saveAvailability").onclick = function() {
  const date = document.getElementById("unavailableDate").value;
  const status = document.getElementById("status").value;
  
  alert("Availability Updated: " + status + " | Date: " + date);
  modal.style.display = "none";
}
function generateStartupId(startupName) {
    if (!startupName) return 'STARTUP_' + Math.floor(Math.random() * 9000 + 1000);
    
    // Clean startup name - take first 6 chars, convert to uppercase
    const cleanName = startupName.replace(/[^a-zA-Z0-9]/g, '').toUpperCase().slice(0, 6);
    
    // Generate unique number (timestamp-based + random)
    const uniqueNum = Date.now().toString().slice(-3) + Math.floor(Math.random() * 90 + 10);
    
    return `${cleanName}_${uniqueNum}`;
}


window.filterVests = function(type) {
    alert(`Filtering ${type} vests - feature coming soon!`);
};
    // 2. Tags/Keywords logic
    const keywordInput = document.getElementById('keywordInput');
    const tagsContainer = document.getElementById('tagsContainer');

    keywordInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const value = this.value.trim();
            if (value && keywords.length < 5 && !keywords.includes(value)) {
                keywords.push(value);
                addTagPill(value);
                this.value = '';
            } else if (keywords.length >= 5) {
                alert('Maximum 5 keywords allowed');
            }
        }
    });

    function addTagPill(keyword) {
        const pill = document.createElement('div');
        pill.className = 'tag-pill';
        pill.innerHTML = `${keyword} <button class="tag-remove" onclick="removeTag('${keyword}')">Ã—</button>`;
        tagsContainer.appendChild(pill);
    }

    window.removeTag = function(keyword) {
        keywords = keywords.filter(k => k !== keyword);
        updateTagsDisplay();
    };

function updateTagsDisplay() {
    tagsContainer.innerHTML = '';
    keywords.forEach(keyword => addTagPill(keyword));
}

// Auto-save on input change
document.addEventListener('input', (e) => {
    if (e.target.matches('input, textarea, select')) {
        saveToLocalStorage();
    }
});

// Load saved data on page load
window.addEventListener('load', () => {
    setTimeout(loadFromLocalStorage, 500);
});



   


    // 4. File Upload Logic
       function displaySummary() {
        const data = collectVestData();
        if (!data) return;
        document.getElementById('summary').innerHTML = `
            <p><strong>Vest Title:</strong> ${data.vestTitle || 'N/A'}</p>
            <p><strong>Startup:</strong> ${data.startupName || 'N/A'}</p>
            <p><strong>Amount:</strong> $${data.fundingAmount || '0'}</p>
            <p><strong>Founder:</strong> ${data.founderName || 'N/A'}</p>
        `;
    }

    // UI File listeners
    document.getElementById('pitchDeck').addEventListener('change', (e) => {
        if (e.target.files[0]) document.getElementById('pitchDeckName').textContent = 'âœ“ ' + e.target.files[0].name;
    });
    document.getElementById('transactionProof').addEventListener('change', (e) => {
        if (e.target.files[0]) document.getElementById('transactionProofName').textContent = 'âœ“ ' + e.target.files[0].name;
    });
window.toggleDropdown = function(id) {
    event.stopPropagation();
    const dropdown = document.getElementById(id);
    
    // Close all other dropdowns
    document.querySelectorAll('.dropdown-content').forEach(dd => {
        if (dd.id !== id) dd.classList.remove('show');
    });
    
    // Toggle this dropdown
    dropdown.classList.toggle('show');
};

async function showEditStartup() {
    document.title = "Edit Startup | ScaleVest";
    document.querySelector('.vest-container').style.display = 'none';

    let container = document.getElementById('dashboardContainer');
    if (!container) {
        container = document.createElement('div');
        container.id = 'dashboardContainer';
        document.body.appendChild(container);
    }
    container.style.display = 'block';

    let startupData = cachedStartupData || {};
    
    // Ensure startup data is loaded
    if (!startupData || !startupData.startupName) {
        const startupProfileRef = ref(db, `startupProfile/${currentUser.uid}`);
        const startupSnap = await get(startupProfileRef);
        if (startupSnap.exists()) {
            startupData = startupSnap.val();
            cachedStartupData = startupData;
        }
    }
const startupFields = [
        startupData.startupName,
        startupData.logo,
        startupData.hookPitch,
        startupData.description,        // Short description
        startupData.companyDescription, // Long description
        startupData.stage,
        startupData.yearEstablished,
        startupData.category,
        startupData.monetization,
        startupData.revenue,            // Number checks
        startupData.userCount,
        startupData.valuation,
        startupData.location?.country,
        startupData.introVideo,
        startupData.team && startupData.team.length > 0
    ];

    // Filter valid fields (checks for not null, not undefined, not empty string)
    const filledStartup = startupFields.filter(f => f !== null && f !== undefined && f !== '').length;
    const startupPercent = Math.round((filledStartup / startupFields.length) * 100);
    // --- GENERATE TEAM LIST HTML ---
    const teamListHTML = (startupData.team && startupData.team.length > 0) 
        ? startupData.team.map(member => `
            <div class="team-member-row">
                <div class="member-avatar-circle">
                    ${member.name.charAt(0).toUpperCase()}
                </div>
                <div class="member-details">
                    <span class="member-name">${member.name}</span>
                    <span class="member-role">${member.role}</span>
                </div>
                <button onclick="removeTeamMember(${member.id})" style="background:none; border:none; color:#666; cursor:pointer; font-size:1.5rem; line-height:1;">&times;</button>
            </div>
        `).join('')
        : `<div class="empty-state" style="border: 1px dashed #333; border-radius: 12px; padding: 1.5rem; text-align: center;">
               <p style="color: #555; font-size: 0.9rem;">No team members added yet.</p>
           </div>`;

    container.innerHTML = `
        <style>
        .edit-profile-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem 3rem;
            background: #000;
            min-height: 100vh;
        }
        
        .profile-grid {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 2rem;
            margin-top: 2rem;
            align-items: start;
        }
        
        .profile-main {
            display: flex;
            flex-direction: column;
            gap: 2rem;
            min-width: 0;
        }
        
        .profile-sidebar {
            display: flex;
            flex-direction: column;
            gap: 2rem;
            position: sticky;
            top: 100px;
        }
        
        .profile-card {
            background: #0a0a0a;
            border: 1px solid #222;
            border-radius: 16px;
            padding: 2.5rem;
            transition: all 0.3s;
        }
        
        .profile-card:hover {
            border-color: #444;
            box-shadow: 0 10px 40px rgba(255, 255, 255, 0.05);
        }

        /* TEAM STYLES */
        .team-member-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: #000;
            border: 1px solid #222;
            border-radius: 10px;
            margin-bottom: 0.75rem;
            transition: all 0.3s;
        }
        .team-member-row:hover { border-color: #444; }
        .member-avatar-circle {
            width: 40px; height: 40px; background: #1a1a1a; border: 1px solid #333;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            color: #fff; font-weight: 600; flex-shrink: 0;
        }
        .member-details { flex: 1; }
        .member-name { display: block; font-weight: 600; color: #fff; font-size: 1rem; }
        .member-role { display: block; color: #888; font-size: 0.85rem; }
        
        /* HEADER & INFO STYLES */
        .startup-header-card { display: flex; align-items: center; gap: 2rem; }
        .startup-logo-large { width: 120px; height: 120px; border-radius: 16px; background: #1a1a1a; display: flex; align-items: center; justify-content: center; flex-shrink: 0; position: relative; cursor: pointer; overflow: hidden; border: 2px solid #333; }
        .startup-logo-large img { width: 100%; height: 100%; object-fit: cover; }
        .logo-edit-overlay { position: absolute; inset: 0; background: rgba(0, 0, 0, 0.7); display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; gap: 0.5rem; }
        .startup-logo-large:hover .logo-edit-overlay { opacity: 1; }
        .logo-edit-overlay svg { width: 30px; height: 30px; stroke: #fff; }
        .logo-edit-overlay span { color: #fff; font-size: 0.85rem; font-weight: 600; }
        .startup-header-info { flex: 1; }
        .startup-name-row { display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem; }
 .top-nav {
            background: #0a0a0a;
            padding: 1.2rem 3rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #222;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .logo {
            font-size: 2rem;
            font-weight: 700;
            color: #fff;
            cursor: pointer;
            letter-spacing: 1px;
            transition: all 0.3s;
        }

        .nav-links {
            display: flex;
            gap: 2.5rem;
            align-items: center;
        }

        .nav-link {
            color: #fff;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s;
            position: relative;
            cursor: pointer;
            font-size: 0.95rem;
        }

        .nav-link::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 0;
            height: 2px;
            background: #fff;
            transition: width 0.3s;
        }

        .nav-link:hover::after {
            width: 100%;
        }

        .dropdown {
            position: relative;
        }
@media (max-width: 768px) {
    .edit-profile-container {
        padding: 1rem;
    }
    
    .profile-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .profile-header-card {
        flex-direction: column;
        text-align: center;
    }
    
    .profile-avatar-large {
        width: 80px;
        height: 80px;
        font-size: 2rem;
    }
    
    .profile-name {
        font-size: 1.5rem;
    }
    
    .profile-card {
        padding: 1.5rem;
    }
    
    .dual-section {
        grid-template-columns: 1fr;
    }
    
    .edit-modal-content {
        width: 95%;
        max-height: 90vh;
    }
    
    .back-btn {
        padding: 0.6rem 1rem;
        font-size: 0.9rem;
    }
    
    .action-buttons {
        flex-direction: column;
        width: 100%;
    }
    
    .preview-btn, .share-btn {
        width: 100%;
    }
}
        .dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: #1a1a1a;
            min-width: 220px;
            border-radius: 12px;
            margin-top: 1rem;
            box-shadow: 0 10px 40px rgba(255, 255, 255, 0.1);
            border: 1px solid #333;
            overflow: hidden;
            z-index: 1000;
        }

        .dropdown-content.show {
            display: block !important;
            animation: fadeInDropdown 0.3s;
        }

        @keyframes fadeInDropdown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
/* ========================================= */
/* GLOBAL POPUP / MODAL STYLES (FIXED)      */
/* ========================================= */
.edit-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.9); /* Darker backdrop */
    backdrop-filter: blur(5px);     /* Blur effect */
    display: flex;
    align-items: center;            /* Center Vertically */
    justify-content: center;        /* Center Horizontally */
    z-index: 999999;                /* On top of everything */
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}

.edit-modal.show {
    opacity: 1;
    visibility: visible;
}

.edit-modal-content {
position: relative;
    background: #111;
    border: 1px solid #333;
    border-radius: 16px;
    width: 90%;
    max-width: 450px;
    padding: 0;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.7);
    transform: translateY(20px);
    transition: transform 0.3s ease;
    overflow: hidden;
}

.edit-modal.show .edit-modal-content {
    transform: translateY(0);
}

.edit-modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid #222;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #161616;
}

.edit-modal-header h3 {
    margin: 0;
    font-size: 1.2rem;
    color: #fff;
}

.modal-close {
    position: absolute;
    top: 15px;        
    right: 20px;        
    background: transparent;
    border: none;
    color: #888;
    font-size: 2rem;
    line-height: 1;
    cursor: pointer;
    transition: all 0.2s;
    z-index: 10;
}

.modal-close:hover { color: #fff; }

.edit-modal-body {
    padding: 1.5rem;
}

.edit-modal-body label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: #ccc;
    font-size: 0.9rem;
}

.edit-modal-body input,
.edit-modal-body textarea,
.edit-modal-body select {
    width: 100%;
    padding: 12px;
    background: #0a0a0a;
    border: 1px solid #333;
    border-radius: 8px;
    color: #fff;
    font-size: 1rem;
    outline: none;
    margin-bottom: 1rem;
}

.edit-modal-body input:focus, 
.edit-modal-body textarea:focus {
    border-color: #ff006e;
}

.edit-modal-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid #222;
    background: #161616;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

.modal-btn-cancel {
    padding: 10px 20px;
    background: transparent;
    border: 1px solid #333;
    color: #ccc;
    border-radius: 8px;
    cursor: pointer;
}

.modal-btn-save {
    padding: 10px 24px;
    background: linear-gradient(135deg, #ff006e, #8338ec);
    border: none;
    color: #fff;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
}
        .dropdown-item {
            padding: 1rem 1.5rem;
            color: #fff;
            text-decoration: none;
            display: block;
            transition: all 0.3s;
            cursor: pointer;
            border-left: 3px solid transparent;
        }

        .dropdown-item:hover {
            background: #222;
            border-left-color: #fff;
            padding-left: 2rem;
        }

        .top-nav-right {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }

        .icon-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: #1a1a1a;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            border: 1px solid #222;
        }

        .icon-btn:hover {
            background: #fff;
            border-color: #fff;
            transform: translateY(-3px) scale(1.1);
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.2);
        }

        .icon-btn:hover svg {
            stroke: #000;
        }

        .profile-dropdown {
            position: relative;
        }

        .profile-dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: #1a1a1a;
            min-width: 300px;
            border-radius: 12px;
            margin-top: 1rem;
            box-shadow: 0 10px 40px rgba(255, 255, 255, 0.1);
            border: 1px solid #333;
            padding: 1rem;
            z-index: 1000;
        }

        .profile-dropdown-content.show {
            display: block;
            animation: fadeInDropdown 0.3s;
        }

        .profile-info {
            padding: 1rem;
            border-bottom: 1px solid #333;
            margin-bottom: 1rem;
        }

        .profile-username {
            font-weight: 600;
            font-size: 1.2rem;
        }

        .profile-userid {
            color: #888;
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }

        .switch-btn {
            background: #fff;
            color: #000;
            border: none;
            padding: 0.9rem;
            width: 100%;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            margin-bottom: 1rem;
            transition: all 0.3s;
            font-size: 0.95rem;
        }

        .switch-btn:hover {
            background: #ddd;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.3);
        }

        .profile-section {
            padding: 0.5rem 0;
        }

        .profile-link {
            padding: 0.9rem 1rem;
            display: block;
            color: #fff;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s;
            cursor: pointer;
            font-weight: 500;
        }

        .profile-link:hover {
            background: #222;
            padding-left: 1.5rem;
        }
            .edit-profile-container {
                max-width: 1400px;
                margin: 0 auto;
                padding: 2rem 3rem;
                background: #000;
                min-height: 100vh;
            }
            
            .profile-grid {
                display: grid;
                grid-template-columns: 1fr 300px;
                gap: 2rem;
                margin-top: 2rem;
            }
            
            .profile-main {
                display: flex;
                flex-direction: column;
                gap: 2rem;
            }
            
            .profile-sidebar {
                display: flex;
                flex-direction: column;
                gap: 2rem;
            }
            
            .profile-card {
                background: #0a0a0a;
                border: 1px solid #222;
                border-radius: 16px;
                padding: 2.5rem;
                transition: all 0.3s;
            }
            
            .profile-card:hover {
                border-color: #444;
                box-shadow: 0 10px 40px rgba(255, 255, 255, 0.05);
            }
            
            .profile-header-card {
                display: flex;
                align-items: center;
                gap: 2rem;
            }
            
            .profile-avatar-large {
                width: 120px;
                height: 120px;
                border-radius: 50%;
                background: #fff;
                color: #000;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 3rem;
                font-weight: 800;
                flex-shrink: 0;
            }
            
            .profile-header-info {
                flex: 1;
            }
            
            .profile-name-row {
                display: flex;
                align-items: center;
                gap: 1rem;
                margin-bottom: 0.5rem;
            }
            
            .profile-name {
                font-size: 2rem;
                font-weight: 700;
            }

        .startup-name-large { font-size: 2rem; font-weight: 700; }
        .startup-id { color: #888; font-size: 1rem; }
        .section-title { font-size: 1.3rem; font-weight: 700; margin-bottom: 1.5rem; }
        .info-row { display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: #000; border-radius: 10px; margin-bottom: 1rem; border: 1px solid #222; }
        .info-label { color: #888; font-size: 0.9rem; }
        .info-value { color: #fff; font-weight: 600; display: flex; align-items: center; gap: 0.75rem; }
        .not-set { color: #666; font-style: italic; }
        .edit-icon-btn {
    width: 26px;        
    height: 26px;        
    flex-shrink: 0;     
    flex-grow: 0;            
     margin-left: auto; 
    border-radius: 4px;
    background: #1a1a1a;
    border: 1px solid #555;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s;
    padding: 0;
}

.edit-icon-btn svg {
    width: 14px;
    height: 14px;
    stroke: #fff;
    flex-shrink: 0;
}

        .edit-icon-btn:hover { background: #fff; border-color: #fff; transform: scale(1.05); }
        .edit-icon-btn:hover svg { stroke: #000; }
        .back-btn { display: inline-flex; align-items: center; gap: 0.5rem; background: #1a1a1a; color: #fff; border: 2px solid #333; padding: 0.75rem 1.5rem; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.3s; text-decoration: none; margin-bottom: 1.5rem; }
        .back-btn:hover { background: #fff; color: #000; border-color: #fff; transform: translateX(-5px); }
        .pitch-box { background: #000; border: 1px solid #222; border-radius: 12px; padding: 2rem; min-height: 100px; }
        .pitch-text { color: #aaa; line-height: 1.8; font-size: 1.1rem; }
        .upload-section { background: #000; border: 2px dashed #333; border-radius: 12px; padding: 2rem; text-align: center; margin-top: 1rem; }
/* ============================================= */
/* FORCE FIXES (Paste at bottom of <style>)     */
/* ============================================= */

/* 1. FIX THE WIDE BUTTON */
/* The global 'button { flex: 1 }' was forcing this to stretch. */
/* We reset flex properties to stop it from growing. */
button.upload-btn, 
.upload-btn {
    flex: 0 0 auto !important;       /* Don't grow, don't shrink, auto width */
    width: auto !important;          /* Use text width */
    min-width: 0 !important;         /* Prevent overflow lock */
    display: inline-flex !important; /* Keep neat inline box */
    align-items: center;
    justify-content: center;
    align-self: flex-start !important; /* Prevent stretching in column flex */
    margin-left: auto;               /* If in a row, push to the right */
    padding: 0.6rem 1.2rem !important;
    border-radius: 8px !important;
    font-size: 0.9rem !important;
    max-width: 200px !important;     /* Hard limit just in case */
}

/* 2. FIX THE MODAL CLOSE BUTTON POSITION */
/* Forces the container to be the anchor, and pins button to top-right */
.edit-modal-content {
    position: relative !important;   /* Essential for absolute positioning */
}

.modal-close {
    position: absolute !important;   /* Take out of layout flow */
    top: 15px !important;            /* 15px from top */
    right: 15px !important;          /* 15px from right */
    left: auto !important;           /* Override any centering */
    transform: none !important;      /* Remove centering transforms */
    background: transparent !important;
    border: none !important;
    width: 30px !important;
    height: 30px !important;
    display: flex !important;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem !important;
    line-height: 1 !important;
    z-index: 50 !important;
    color: #888 !important;
    margin: 0 !important;            /* Remove interference margins */
}

.modal-close:hover {
    color: #fff !important;
    background: rgba(255,255,255,0.1) !important;
    border-radius: 50%;
}
        .pdf-viewer { width: 100%; height: 400px; border: 1px solid #333; border-radius: 10px; background: #000; margin-top: 1rem; }
        .progress-card, .quick-links-card { background: #0a0a0a; border: 1px solid #222; border-radius: 16px; padding: 2rem; }
        .progress-bar { width: 100%; height: 12px; background: #1a1a1a; border-radius: 10px; overflow: hidden; margin: 1rem 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #10b981, #3a86ff); transition: width 0.5s; }
        .progress-text { text-align: center; font-size: 2rem; font-weight: 700; color: #10b981; }
        .quick-link-btn { background: #1a1a1a; color: #fff; border: 1px solid #333; padding: 1rem; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.3s; width: 100%; text-align: left; margin-bottom: 0.75rem; }
        .quick-link-btn:hover { background: #222; border-color: #fff; transform: translateX(5px); }
        .description-box { background: #000; border: 1px solid #222; border-radius: 12px; padding: 2rem; min-height: 150px; color: #aaa; line-height: 1.8; }
        .photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; margin-top: 1rem; }
        .photo-item { width: 100%; height: 150px; border-radius: 10px; overflow: hidden; border: 1px solid #333; }
        .photo-item img { width: 100%; height: 100%; object-fit: cover; }
        
        @media (max-width: 1024px) {
            .profile-grid { grid-template-columns: 1fr; }
            .edit-profile-container { padding: 2rem 1.5rem; }
            .profile-sidebar { position: static; }
        }
        </style>
        
        ${createNavBar()}
        
        <div class="edit-profile-container">
            <a href="#founder_dashboard" class="back-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                Back to Dashboard
            </a>
            
            <h1 class="welcome-text" style="margin-bottom: 2rem;">Startup Profile</h1>
            
            <div class="profile-grid">
                
                <div class="profile-main">
                    
                    <div class="profile-card startup-header-card">
                        <div class="startup-logo-large" onclick="editStartupLogo()">
                            ${startupData.logo 
                                ? `<img src="${startupData.logo}" alt="Startup Logo">` 
                                : `<svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2">
                                    <path d="M12 2L2 7l10 5 10-5z"></path>
                                    <path d="M2 17l10 5 10-5"></path>
                                    <path d="M2 12l10 5 10-5"></path>
                                   </svg>`}
                            <div class="logo-edit-overlay">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                                    <circle cx="12" cy="13" r="4"></circle>
                                </svg>
                                <span>Edit Logo</span>
                            </div>
                        </div>
                        <div class="startup-header-info">
                            <div class="startup-name-row">
                                <span class="startup-name-large">${startupData.startupName || 'Startup Name'}</span>
                                <button class="edit-icon-btn" onclick="editStartupName()">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </button>
                            </div>
                            <div class="startup-id">${startupData.startupId || 'STARTUP_ID'}</div>
                        </div>
                    </div>
                    
                    <div class="profile-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h3 class="section-title" style="margin: 0;">Hook Pitch</h3>
                            <button class="edit-icon-btn" onclick="editHookPitch()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="pitch-box">
                            <p class="pitch-text ${!startupData.hookPitch ? 'not-set' : ''}">
                                ${startupData.hookPitch || 'Set your one-line hook pitch to grab investor attention...'}
                            </p>
                        </div>
                        
<div style="margin-top: 2rem;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                                <h4 style="font-size: 1.1rem; margin:0;">Pitch Deck</h4>
                                <button class="upload-btn" onclick="uploadPitchDeck()" style="margin:0; padding:0.5rem 1rem; font-size:0.85rem;">
                                    ${startupData.pitchDeckUrl ? 'Update Pitch' : 'Upload PDF'}
                                </button>
                            </div>

                            ${startupData.pitchDeckUrl 
                                ? `<div class="pitch-deck-row">
                                        <div class="pdf-thumbnail-container">
                                            <canvas id="pdf-thumb-canvas"></canvas>
                                        </div>
                                        <div class="pdf-details">
                                            <div class="pdf-filename">
                                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#ff006e" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                                                ${getFilenameFromUrl(startupData.pitchDeckUrl)}
                                            </div>
                                            <div class="pdf-filesize">PDF Document</div>
                                        </div>
                                        <button class="open-pitch-btn" onclick="openFullScreenPDF('${startupData.pitchDeckUrl}')">
                                            Open Pitch
                                        </button>
                                   </div>`
                                : `<div class="upload-section">
                                    <p style="color: #666;">No pitch deck uploaded yet</p>
                                   </div>`
                            }
                        </div>
                    </div>
                    
                    <div class="profile-card">
                        <h3 class="section-title">Startup Details</h3>
                        
                        <div class="description-box ${!startupData.description ? 'not-set' : ''}" style="margin-bottom: 1.5rem;">
                            ${startupData.description || 'Add a detailed description of your startup...'}
                        </div>
                        <button class="edit-icon-btn" onclick="editStartupDescription()" style="margin-bottom: 2rem;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </button>
                        
                        <div class="info-row">
                            <span class="info-label">Location</span>
                            <span class="info-value ${!startupData.location?.country ? 'not-set' : ''}">
                                ${startupData.location?.country 
                                    ? `${startupData.location.city || ''}, ${startupData.location.state || ''}, ${startupData.location.country}`
                                    : 'Not set'}
                            </span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">Year Established</span>
                            <span class="info-value ${!startupData.yearEstablished ? 'not-set' : ''}">
                                ${startupData.yearEstablished || 'Not set'}
                                ${startupData.yearEstablished ? '' : '<button class="edit-icon-btn" onclick="editYearEstablished()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>'}
                            </span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">Category</span>
                            <span class="info-value">
                                ${startupData.category || 'Not set'}
                            </span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">Stage</span>
                            <span class="info-value">
                                ${startupData.stage || 'Not set'}
                                <button class="edit-icon-btn" onclick="editStage()">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </button>
                            </span>
                        </div>
                    </div>
                    
                    <div class="profile-card">
                        <h3 class="section-title">Status & Metrics</h3>
                        
                        <div class="info-row">
                            <span class="info-label">Monetization Idea</span>
                            <span class="info-value ${!startupData.monetization ? 'not-set' : ''}">
                                ${startupData.monetization || 'Not set'}
                                <button class="edit-icon-btn" onclick="editMonetization()">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </button>
                            </span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">Revenue</span>
                            <span class="info-value ${startupData.revenue === undefined ? 'not-set' : ''}">
                                ${startupData.revenue !== undefined ? `$${startupData.revenue.toLocaleString()}` : 'Not set'}
                                <button class="edit-icon-btn" onclick="editRevenue()">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </button>
                            </span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">User Count</span>
                            <span class="info-value ${startupData.userCount === undefined ? 'not-set' : ''}">
                                ${startupData.userCount !== undefined ? startupData.userCount.toLocaleString() : 'Not set'}
                                <button class="edit-icon-btn" onclick="editUserCount()">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </button>
                            </span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">Valuation</span>
                            <span class="info-value ${startupData.valuation === undefined ? 'not-set' : ''}">
                                ${startupData.valuation !== undefined ? `$${startupData.valuation.toLocaleString()}` : 'Not set'}
                                <button class="edit-icon-btn" onclick="editValuation()">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </button>
                            </span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">Company Description</span>
                            <span class="info-value ${!startupData.companyDescription ? 'not-set' : ''}">
                                ${startupData.companyDescription || 'Not set'}
                                <button class="edit-icon-btn" onclick="editCompanyDescription()">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </button>
                            </span>
                        </div>
                    </div>

                  <div class="profile-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 class="section-title" style="margin-bottom: 0;">Interest Tracking Photos (Optional)</h3>
                            <button class="upload-btn" onclick="uploadTractionPhotos()" style="margin: 0; padding: 0.5rem 1rem; font-size: 0.85rem;">
                                ${startupData.tractionPhotos?.length > 0 ? 'Add More Photos' : 'Upload Photos'}
                            </button>
                        </div>

                        <p style="color: #888; margin-bottom: 1.5rem; font-size: 0.95rem;">
                            Upload screenshots of transactions, user growth, or any proof of traction
                        </p>
                        
                        ${startupData.tractionPhotos?.length > 0 
                            ? `<div class="photo-grid">
                                ${startupData.tractionPhotos.map(url => `
                                    <div class="photo-item">
                                        <img src="${url}" alt="Traction Photo">
                                    </div>
                                `).join('')}
                               </div>`
                            : `<div class="upload-section">
                                <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2" style="margin-bottom: 1rem;">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                    <polyline points="21 15 16 10 5 21"></polyline>
                                </svg>
                                <p style="color: #666;">No traction photos uploaded</p>
                               </div>`}
                    </div>

                    <div class="profile-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 class="section-title" style="margin-bottom: 0;">Team</h3>
                            <button class="edit-icon-btn" onclick="addTeamMember()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                            </button>
                        </div>
                        
                        <p style="color: #888; margin-bottom: 1.5rem; font-size: 0.95rem;">
                            Add co-founders and key team members to showcase your team's strength.
                        </p>

                        <div id="team-container">
                            ${teamListHTML}
                        </div>

                        <button class="add-item-btn" style="width: 100%; margin-top: 1.5rem;" onclick="addTeamMember()">
                            + Add Member
                        </button>
                    </div>

                </div> 
                <div class="profile-sidebar">

                    <div class="progress-card" style="margin-top: 2rem;">
                        <h3 class="section-title">Startup Profile Progress</h3>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${startupPercent}%"></div>
                        </div>
                        <div class="progress-text">${startupPercent}%</div>
                        <p style="color: #888; font-size: 0.9rem; text-align: center; margin-top: 1rem;">
                            A complete startup profile attracts 3x more investors
                        </p>
                    </div>
                    <div class="quick-links-card">
                        <h3 class="section-title">Quick Actions</h3>
                        
                        <button class="quick-link-btn" onclick="previewProfile('${currentUser.uid}')">
                            <span style="display: flex; align-items: center; gap: 0.75rem;">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                                Preview Public Profile
                            </span>
                        </button>

                        <button class="quick-link-btn" onclick="copyShareLink()">
                            <span style="display: flex; align-items: center; gap: 0.75rem;">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
                                    <polyline points="16 6 12 2 8 6"></polyline>
                                    <line x1="12" y1="2" x2="12" y2="15"></line>
                                </svg>
                                Share Profile Link
                            </span>
                        </button>
                        
                        <button class="quick-link-btn" onclick="contactSupport()">
                            <span style="display: flex; align-items: center; gap: 0.75rem;">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                                </svg>
                                Help & Support
                            </span>
                        </button>
                    </div>
                </div> 
                </div> </div>
    `;
if(startupData.pitchDeckUrl) {
        setTimeout(() => {
            renderPdfThumbnail(startupData.pitchDeckUrl);
        }, 500);
    }
}
// --- 4. Team Members ---

window.addTeamMember = function() {
    const modal = document.createElement('div');
    modal.className = 'edit-modal'; 
    
    modal.innerHTML = `
        <div class="edit-modal-content">
            <div class="edit-modal-header">
                <h3>Add Team Member</h3>
                <button class="modal-close" onclick="closeEditModal()">Ã—</button>
            </div>
            <div class="edit-modal-body">
                <div>
                    <label>Full Name</label>
                    <input type="text" id="tmName" placeholder="e.g. Sarah Smith">
                </div>
                <div>
                    <label>Role / Position</label>
                    <input type="text" id="tmRole" placeholder="e.g. CTO, Lead Marketing">
                </div>
                <div>
            </div>
            <div class="edit-modal-footer">
                <button class="modal-btn-cancel" onclick="closeEditModal()">Cancel</button>
                <button class="modal-btn-save" onclick="saveTeamMember()">Add Member</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Small delay to trigger the fade-in animation
    setTimeout(() => {
        modal.classList.add('show');
    }, 10);
    
    // Auto-focus the name field
    setTimeout(() => {
        document.getElementById('tmName').focus();
    }, 100);
};
window.saveTeamMember = async function() {
    const name = document.getElementById('tmName').value.trim();
    const role = document.getElementById('tmRole').value.trim();
    const link = document.getElementById('tmLink').value.trim();

    if (!name || !role) return alert("Name and Role are required");

    // Fetch existing team or initialize empty array
    let currentTeam = cachedStartupData?.team || [];
    
    // Add new member
    currentTeam.push({
        name: name,
        role: role,
        linkedin: link,
        addedAt: Date.now()
    });

    await updateStartupField({ team: currentTeam });
};
// ==========================================
//  STARTUP PROFILE EDIT LOGIC (Paste this!)
// ==========================================

// --- Helper: Save Changes to Firebase ---
async function updateStartupField(updates) {
    if (!currentUser) return;
    
    // Attempt to find the button that triggered the save to show loading state
    const saveBtn = document.querySelector('.modal-btn-save');
    const originalText = saveBtn ? saveBtn.innerHTML : 'Save';
    if(saveBtn) {
        saveBtn.innerHTML = 'Saving...';
        saveBtn.disabled = true;
    }

    try {
        // Update Firebase
        const startupRef = ref(db, `startupProfile/${currentUser.uid}`);
        await update(startupRef, updates);
        
        // Update Local Cache
        if (cachedStartupData) {
            cachedStartupData = { ...cachedStartupData, ...updates };
        } else {
            cachedStartupData = updates;
        }
        
        // Close Modal and Refresh View
        closeEditModal();
        showEditStartup(); 
        
    } catch (error) {
        console.error("Error updating startup profile:", error);
        alert("Failed to save changes. Please try again.");
        if(saveBtn) {
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
        }
    }
}

// --- 1. Basic Text Edits ---

window.editStartupName = function() {
    currentEditAction = (value) => {
        if(!value) return alert("Name cannot be empty");
        updateStartupField({ startupName: value });
    };
    createEditModal("Edit Startup Name", cachedStartupData?.startupName || "", "Enter startup name");
};

window.editStartupDescription = function() {
    currentEditAction = (value) => {
        updateStartupField({ description: value }); // Note: mapped to 'description'
    };
    createEditModal("Edit Description", cachedStartupData?.description || "", "Describe your startup...", true); // true = textarea
};

window.editHookPitch = function() {
    currentEditAction = (value) => {
        updateStartupField({ hookPitch: value });
    };
    createEditModal("Edit Hook Pitch", cachedStartupData?.hookPitch || "", "One-liner that grabs attention");
};

window.editCompanyDescription = function() {
    currentEditAction = (value) => {
        updateStartupField({ companyDescription: value });
    };
    createEditModal("Detailed Description", cachedStartupData?.companyDescription || "", "Full details about your company...", true);
};

window.editStage = function() {
    currentEditAction = (value) => {
        updateStartupField({ stage: value });
    };
    createEditModal("Startup Stage", cachedStartupData?.stage || "", "e.g., Idea, MVP, Pre-Seed, Series A");
};

window.editYearEstablished = function() {
    currentEditAction = (value) => {
        updateStartupField({ yearEstablished: value });
    };
    createEditModal("Year Established", cachedStartupData?.yearEstablished || "", "YYYY");
};

// --- 2. Financials & Metrics (Numbers) ---

window.editMonetization = function() {
    currentEditAction = (value) => {
        updateStartupField({ monetization: value });
    };
    createEditModal("Monetization Model", cachedStartupData?.monetization || "", "e.g., SaaS Subscription, Ads");
};

window.editRevenue = function() {
    currentEditAction = (value) => {
        // Strip currency symbols and commas before saving
        const cleanValue = value.replace(/[$,]/g, ''); 
        const numValue = parseFloat(cleanValue);
        if(isNaN(numValue)) return alert("Please enter a valid number");
        updateStartupField({ revenue: numValue });
    };
    createEditModal("Revenue (USD)", cachedStartupData?.revenue || "0", "Enter amount");
};

window.editUserCount = function() {
    currentEditAction = (value) => {
        const cleanValue = value.replace(/[,]/g, '');
        const numValue = parseInt(cleanValue);
        if(isNaN(numValue)) return alert("Please enter a valid number");
        updateStartupField({ userCount: numValue });
    };
    createEditModal("User Count", cachedStartupData?.userCount || "0", "Enter number of users");
};

window.editValuation = function() {
    currentEditAction = (value) => {
        const cleanValue = value.replace(/[$,]/g, '');
        const numValue = parseFloat(cleanValue);
        if(isNaN(numValue)) return alert("Please enter a valid number");
        updateStartupField({ valuation: numValue });
    };
    createEditModal("Valuation (USD)", cachedStartupData?.valuation || "0", "Enter amount");
};

// --- 3. File Upload Functions ---

window.editStartupLogo = function() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    
    input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        // Show simplified loading
        const btn = document.querySelector('.startup-logo-large');
        if(btn) btn.style.opacity = '0.5';

        try {
            const logoUrl = await uploadFileToStorage(file, 'startup-logos');
            await updateStartupField({ logo: logoUrl });
        } catch (error) {
            console.error(error);
            alert("Logo upload failed");
        } finally {
            if(btn) btn.style.opacity = '1';
        }
    };
    input.click();
};

window.uploadPitchDeck = function() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.pdf'; 
    
    input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        // SHOW SPECIAL ANIMATION
        showSpecialUploadAnimation("Uploading Pitch Deck...");

        try {
            const deckUrl = await uploadFileToStorage(file, 'pitch-decks');
            await updateStartupField({ pitchDeckUrl: deckUrl });
            hideSpecialUploadAnimation();
        } catch (error) {
            console.error(error);
            hideSpecialUploadAnimation();
            alert("Upload failed. Please try again.");
        }
    };
    input.click();
};
window.uploadTractionPhotos = function() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.multiple = true; 
    
    input.onchange = async (e) => {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;

        showSpecialUploadAnimation(`Uploading ${files.length} Photos...`);

        try {
            const uploadPromises = files.map(file => uploadFileToStorage(file, 'traction-photos'));
            const newUrls = await Promise.all(uploadPromises);
            
            const existingPhotos = cachedStartupData?.tractionPhotos || [];
            const updatedPhotos = [...existingPhotos, ...newUrls];
            
            await updateStartupField({ tractionPhotos: updatedPhotos });
            hideSpecialUploadAnimation();
        } catch (error) {
            console.error(error);
            hideSpecialUploadAnimation();
            alert("Photo upload failed");
        }
    };
    input.click();
};

function showSpecialUploadAnimation(text) {
    // Check if overlay exists, if not create it
    let overlay = document.getElementById('specialUploadOverlay');
    if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'specialUploadOverlay';
        overlay.className = 'special-upload-overlay';
        overlay.innerHTML = `
            <div class="pulse-ring">
                <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
            </div>
            <div class="upload-status-text" id="specialUploadText">${text}</div>
            <div style="color: #888; font-size: 0.9rem;">Please wait while we process...</div>
        `;
        document.body.appendChild(overlay);
    } else {
        document.getElementById('specialUploadText').textContent = text;
    }
    
    // Trigger Animation
    setTimeout(() => overlay.classList.add('active'), 10);
}

function hideSpecialUploadAnimation() {
    const overlay = document.getElementById('specialUploadOverlay');
    if (overlay) {
        overlay.classList.remove('active');
        setTimeout(() => overlay.remove(), 400);
    }
}
function getFilenameFromUrl(url) {
    try {
        // Decode URI to handle Firebase tokens and special chars
        const decoded = decodeURIComponent(url);
        // Extract content after the last slash
        const basename = decoded.split('/').pop().split('?')[0];
        // Remove timestamp prefix if you used one (e.g., 123456_file.pdf)
        return basename.replace(/^\d+_/, '');
    } catch(e) {
        return "Pitch Deck.pdf";
    }
}

// Render Thumbnail using PDF.js
async function renderPdfThumbnail(url) {
    const canvas = document.getElementById('pdf-thumb-canvas');
    if(!canvas) return;

    try {
        const loadingTask = pdfjsLib.getDocument(url);
        const pdf = await loadingTask.promise;
        const page = await pdf.getPage(1); // Get page 1

        const viewport = page.getViewport({ scale: 0.5 }); // Scale down
        const context = canvas.getContext('2d');
        canvas.height = viewport.height;
        canvas.width = viewport.width;

        const renderContext = {
            canvasContext: context,
            viewport: viewport
        };
        await page.render(renderContext).promise;
    } catch (error) {
        console.error("Error rendering PDF thumb:", error);
        // Fallback visual if rendering fails (e.g. CORS issue)
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#222';
        ctx.fillRect(0,0,canvas.width, canvas.height);
        ctx.fillStyle = '#fff';
        ctx.font = '10px Arial';
        ctx.fillText("PDF", 10, 50);
    }
}

// --- FULL SCREEN VIEWER ---
window.openFullScreenPDF = function(url) {
    // Create viewer container
    const viewer = document.createElement('div');
    viewer.className = 'full-screen-viewer';
    viewer.innerHTML = `
        <div class="viewer-header">
            <button class="viewer-back-btn" onclick="closeFullScreenPDF()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5"></path>
                    <polyline points="12 19 5 12 12 5"></polyline>
                </svg>
                Back
            </button>
            <span style="color:#fff; font-weight:600;">Pitch Deck Preview</span>
            <div style="width:60px;"></div> </div>
        <div class="viewer-content">
            <iframe src="${url}" style="width:100%; height:100%; border:none;"></iframe>
        </div>
    `;
    document.body.appendChild(viewer);
    
    // Animation in
    setTimeout(() => viewer.classList.add('active'), 10);
};

window.closeFullScreenPDF = function() {
    const viewer = document.querySelector('.full-screen-viewer');
    if (viewer) {
        viewer.classList.remove('active');
        setTimeout(() => viewer.remove(), 300);
    }
};


</script>
<!-- FOUNDER DASHBOARD -->
<div id="dashboardContainer" style="display: none;"></div>
<div id="autoReplyModal" class="edit-modal">
    <div class="edit-modal-content">
        <button class="modal-close" onclick="closeAutoReplyModal()" style="filter: invert(1);">Ã—</button>
        
        <div class="edit-modal-header">
            <h3>Auto-Response Settings</h3>
        </div>
        
        <div class="edit-modal-body" style="padding: 30px;">
            <p style="color: #666; margin-bottom: 25px; font-size: 0.85rem; line-height: 1.5; font-style: italic;">
                Set a professional tone. This message is automatically delivered to investors upon their first outreach.
            </p>
            
            <label style="display: block; margin-bottom: 10px; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1.5px; color: #fff; font-weight: 600;">
                Message Content
            </label>
            
            <textarea 
                id="autoReplyTextarea" 
                placeholder="Hi! Thanks for reaching out. I'm excited to discuss potential opportunities. I typically respond within 24 hours."
            ></textarea>
            
            <div class="status-card-lite">
                <input type="checkbox" id="autoReplyEnabled" style="width: 18px; height: 18px; accent-color: #fff; cursor: pointer;">
                <label for="autoReplyEnabled" style="margin: 0; cursor: pointer; font-size: 0.85rem; color: #ccc; letter-spacing: 0.5px;">
                    ENABLE AUTO-REPLY SYSTEM
                </label>
            </div>
        </div>
        
        <div class="edit-modal-footer" style="padding: 20px 30px; background: #050505; border-top: 1px solid #222;">
            <button class="modal-btn-cancel" onclick="closeAutoReplyModal()">Discard</button>
            <button class="modal-btn-save" onclick="saveAutoReply()">Save Changes</button>
        </div>
    </div>
</div>


</body>
</html>
